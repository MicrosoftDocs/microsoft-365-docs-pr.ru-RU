---
title: Аварийное восстановление SharePoint Server 2013 в Microsoft Azure
ms.author: bcarter
author: brendacarter
manager: laurawi
ms.date: 04/17/2018
audience: ITPro
ms.topic: article
ms.service: o365-solutions
localization_priority: Normal
search.appverid:
- MET150
ms.collection: Ent_O365
f1.keywords:
- CSH
ms.custom:
- Ent_Deployment
- seo-marvel-apr2020
ms.assetid: e9d14cb2-ff28-4a18-a444-cebf891880ea
description: В этой статье описано, как использовать Azure для создания среды аварийного восстановления для локальной фермы SharePoint.
ms.openlocfilehash: d1643f3fa0275ef9fbb01372869ca551b9fed495
ms.sourcegitcommit: 79065e72c0799064e9055022393113dfcf40eb4b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/14/2020
ms.locfileid: "46693083"
---
# <a name="sharepoint-server-2013-disaster-recovery-in-microsoft-azure"></a>Аварийное восстановление SharePoint Server 2013 в Microsoft Azure

 С помощью Azure вы можете создать среду аварийного восстановления для локальной фермы SharePoint. В этой статье описываются разработка и реализация этого решения.

 **Смотрите видео с обзором аварийного восстановления в SharePoint Server 2013**
> [!VIDEO https://www.microsoft.com/videoplayer/embed/1b73ec8f-29bd-44eb-aa3a-f7932784bfd9?autoplay=false]
  
 В случае возникновения аварии в локальной среде SharePoint вашей главной задачей является быстрое восстановление работы системы. Аварийное восстановление SharePoint выполняется быстрее и проще, если в Microsoft Azure уже запущена резервная среда. В этом видеоролике рассматриваются основные концепции "горячей" отработки отказов в SharePoint и дополняются подробные сведения, приведенные в этой статье.
  
Используйте эту статью вместе со следующей моделью решения: **Аварийное восстановление SharePoint в Microsoft Azure**.
  
[![Процесс аварийного восстановления SharePoint в Azure](../media/SP-DR-Azure.png)](https://go.microsoft.com/fwlink/p/?LinkId=392555)
  
 [PDF](https://go.microsoft.com/fwlink/p/?LinkId=392555) |  [Visio](https://go.microsoft.com/fwlink/p/?LinkId=392554)
  
## <a name="use-azure-infrastructure-services-for-disaster-recovery"></a>Использование служб инфраструктуры Azure для аварийного восстановления

Во многих организациях нет среды аварийного восстановления для SharePoint, создание и поддержка которой в локальной организации может требовать значительных затрат. Службы инфраструктуры Azure предоставляют удобные способы создания сред аварийного восстановления с большей гибкостью и меньшими затратами, чем в локальной организации.
  
Используя Службы инфраструктуры Azure, вы получаете следующие преимущества:
  
- **Меньшее количество дорогостоящих ресурсов** Поддерживайте и оплачивайте меньше ресурсов, чем в локальных средах аварийного восстановления. Количество ресурсов зависит от выбранного типа среды: с холодным или горячим резервированием либо горячей заменой.
    
- **Повышенная гибкость ресурсов** В случае аварии вы можете с легкостью развернуть ферму восстановления SharePoint в соответствии с требованиями к нагрузке. Когда необходимость в дополнительных ресурсах пропадет, вы можете свернуть ферму.
    
- **Меньшая зависимость от центров обработки данных** Используйте Службы инфраструктуры Azure, чтобы не вкладывать средства во вспомогательный центр обработки данных в другом регионе.
    
Для организаций, делающих первые шаги в подготовке аварийного восстановления, доступны простые варианты, а организации с высокими требованиями к надежности могут воспользоваться расширенными вариантами. Определения холодного и горячего резервирования, а также горячей замены немного отличаются в средах, которые размещаются на облачной платформе. В следующей таблице описываются среды для создания фермы восстановления SharePoint в Azure.
  
**Таблица. Среды восстановления**

|**Тип среды восстановления**|**Описание**|
|:-----|:-----|
|Горячая замена  <br/> |Полноразмерная ферма подготавливается, обновляется и работает в ждущем режиме.  <br/> |
|Горячее резервирование  <br/> |Создается ферма, а также работают и обновляются виртуальные машины.  <br/> Восстановление включает присоединение баз данных контента, подготовку приложений-служб и обход контента.  <br/> Эта ферма может быть уменьшенной версией рабочей фермы и расширяться для обслуживания всех пользователей.  <br/> |
|Холодное резервирование  <br/> |Ферма создается в полном масштабе, но виртуальные машины останавливаются.  <br/> Обслуживание среды включает запуск виртуальных машин по мере необходимости, а также исправление, обновление и проверку среды.  <br/> Полный запуск среды в случае сбоя.  <br/> |
   
Важно оценить целевое время восстановления (RTO) и целевую точку восстановления (RPO) для вашей организации. Эти требования определяют, какая среда будет наиболее подходящей.
  
В этой статье описывается реализация среды горячего резервирования. Ее также можно применять для создания среды холодного восстановления, выполнив соответствующие дополнительные действия. В этой статье не описывается реализация среды горячей замены.
  
Дополнительные сведения о решениях аварийного восстановления см. в статьях [High availability and disaster recovery concepts in SharePoint 2013](https://go.microsoft.com/fwlink/p/?LinkID=393114) и [Choose a disaster recovery strategy for SharePoint 2013](https://go.microsoft.com/fwlink/p/?linkid=203228).
  
## <a name="solution-description"></a>Описание решения

Для решения аварийного восстановления с горячим резервированием необходимы следующие компоненты среды:
  
- локальная рабочая ферма SharePoint;
    
- среда восстановления SharePoint в Azure;
    
- VPN-подключение типа "сеть-сеть" между двумя средами.
    
На следующем рисунке показаны эти три элемента.
  
**Рисунок. Элементы решения горячего резервирования в Azure**

![Элементы решения "горячего" резервирования SharePoint в Azure](../media/AZarch-AZWarmStndby.png)
  
Доставка журналов SQL Server с репликацией распределенной файловой системы (DFSR) используется для копирования резервных копий баз данных и журналов транзакций в ферму восстановления в Azure: 
  
- DFSR переносит журналы из рабочей среды в среду восстановления. В глобальной сети DFSR намного эффективнее, чем доставка журналов непосредственно на вспомогательный сервер в Azure.
    
- Журналы воспроизводятся на сервере SQL Server в среде восстановления Azure.
    
- Базы данных контента SharePoint с доставкой журналов присоединяются к среде только после восстановления.
    
Чтобы восстановить ферму, выполните следующие действия.
  
1. Остановите доставку журналов.
    
2. Остановите прием трафика основной фермы.
    
3. Воспроизведите журналы транзакций.
    
4. Присоедините базу данных контента к ферме.
    
5. Восстановите приложения-службы из служб реплицированных баз данных.
    
6. Измените записи системы доменных имен (DNS), чтобы они указывали на ферму восстановления.
    
7. Запустите полный обход.
    
Рекомендуем регулярно тренироваться выполнять эти действия и документировать их, чтобы обеспечить безотказное восстановление в случае настоящей аварии. Присоединение баз данных контента и восстановление приложений-служб могут занять некоторое время и обычно требуют настраивать некоторые параметры вручную.
  
После восстановления это решение предоставляет элементы, перечисленные в следующей таблице.
  
**Таблица. Цели восстановления решения**

|**Элемент**|**Описание**|
|:-----|:-----|
|Сайты и контент  <br/> |Сайты и контент доступны в среде восстановления.  <br/> |
|Новый экземпляр поиска  <br/> |В этом решении горячего резервирования поиск не восстанавливается из соответствующих баз данных. Компоненты поиска в ферме восстановления по мере возможности настраиваются аналогично рабочей ферме. После восстановления сайтов и контента запускается полный обход для восстановления индекса поиска. Чтобы сделать сайты и контент доступными, вам не придется дожидаться завершения обхода.  <br/> |
|Службы  <br/> | Службы, которые хранят данные в базах данных, восстанавливаются из баз данных с доставкой журналов. Службы, которые не хранят данные в базах данных, просто запускаются. <br/>  Не все службы с базами данных требуют восстановления. Перечисленные ниже службы не требуют восстановления, и их можно запустить после отработки отказа. <br/>  Приложение-служба сбора данных об использовании и работоспособности <br/>  Служба состояний <br/>  Служба автоматизации Word <br/>  Любая другая служба, которая не использует базу данных <br/> |
   
Вы можете сотрудничать со службами консультации Майкрософт (MCS) или партнерами, чтобы выполнять более сложные задачи восстановления. Эти задачи представлены в следующей статье.
  
**Таблица. Другие задачи, которые могут выполнить MCS или партнеры**

|**Элемент**|**Описание**|
|:-----|:-----|
|Синхронизация решений пользовательской фермы  <br/> |В идеальном случае конфигурация фермы восстановления идентична конфигурации рабочей фермы. Консультант или партнер может помочь вам определить, реплицируются ли решения пользовательской фермы и налажен ли процесс синхронизации двух сред.  <br/> |
|Подключения к локальным источникам данных  <br/> |Реплицировать подключения к серверным системам данных, например резервным контроллерам доменов (BDC) и источникам контента поиска, может быть нецелесообразно.  <br/> |
|Сценарии восстановления поиска  <br/> |Так как корпоративные среды поиска обычно являются довольно уникальными и сложными, восстановление поиска из баз данных требует больших инвестиций. Консультант или партнер может помочь вам определить и реализовать сценарии восстановления поиска, которые могут требоваться вашей организации.  <br/> |
   
В этой статье предполагается, что локальная ферма уже разработана и развернута.
  
## <a name="detailed-architecture"></a>Подробная архитектура

В идеальном случае конфигурация фермы восстановления в Azure идентична конфигурации локальной рабочей фермы, включая:
  
- одинаковое представление ролей серверов;
    
- одинаковую конфигурацию настроек;
    
- одинаковую конфигурацию компонентов поиска.
    
Среда в Azure может быть уменьшенной версией рабочей фермы. Если вы планируете развернуть ферму восстановления после отработки отказа, все роли серверов должны быть представлены изначально.
  
Некоторые конфигурации может быть нецелесообразно реплицировать в среде отработки отказа. Испытайте процедуры и среду отработки отказа, чтобы убедиться, что ферма отработки отказа предоставляет ожидаемый уровень обслуживания.
  
Это решение не требует определенной топологии фермы SharePoint. Фокус этого решения  использование Azure для фермы отработки отказа и реализация доставки журналов и DFSR между двумя средами.
  
### <a name="warm-standby-environments"></a>Среды горячего резервирования

В среде горячего резервирования запущены все виртуальные машины среды Azure. Среда готова к отработке пробного или настоящего отказа.
  
На следующем рисунке показано решение аварийного восстановления из локальной фермы SharePoint в ферму Azure, которая настроена как среда горячего резервирования.
  
**Рисунок. Топология и основные элементы рабочей фермы и фермы восстановления с горячим резервированием**

![Топология фермы SharePoint и фермы восстановления с "горячим" резервированием](../media/AZarch-AZWarmStndby.png)
  
На этой схеме:
  
- показаны две среды: локальная ферма SharePoint и ферма горячего резервирования в Azure;
    
- Каждая среда содержит общий файловый ресурс.
    
- каждая ферма состоит из четырех уровней. Для обеспечения высокой доступности каждый уровень включает два сервера или две виртуальные машины, которые одинаково настроены для определенной роли, например интерфейсных служб, службы распределенного кэша, внутренних служб или баз данных. На этой схеме конкретные компоненты не имеют значения. Две фермы настроены одинаково;
    
- четвертый уровень — это уровень баз данных. Доставка журналов используется для копирования журналов со вспомогательного сервера баз данных в локальной среде на общий файловый ресурс в той же среде;
    
- DFSR копирует файлы из общего файлового ресурса локальной среды на общий файловый ресурс среды Azure;
    
- доставка журналов воспроизводит журналы из общего файлового ресурса в среде Azure для основной реплики в группе доступности SQL Server AlwaysOn в среде восстановления.
    
### <a name="cold-standby-environments"></a>Среды холодного резервирования

В среде холодного резервирования большинство виртуальных машин SharePoint можно отключить (рекомендуем время от времени запускать виртуальные машины, например каждые две недели или раз в месяц, чтобы они синхронизировались с доменом). Чтобы обеспечить непрерывную работу доставки журналов и DFSR, в среде восстановления Azure должны быть всегда запущены следующие виртуальные машины:
  
- Общий файловый ресурс
    
- Основной сервер баз данных
    
- Как минимум одна виртуальная машина, на которой запущены доменные службы Windows Server Active Directory и DNS
    
На приведенном ниже рисунке показана среда отработки отказа Azure, в которой запущены виртуальные машины файловых ресурсов и виртуальная машина базы данных SharePoint. Все остальные виртуальные машины SharePoint остановлены. Виртуальная машина с Windows Server Active Directory и DNS не показана.
  
**Рисунок. Виртуальные машины, запущенные в ферме восстановления с холодным резервированием**

![Элементы решения холодного резервирования SharePoint в Azure](../media/AZarch-AZColdStndby.png)
  
После отработки отказа в среде с холодным резервированием запускаются все виртуальные машины и должен быть настроен метод обеспечения высокой доступности серверов баз данных, например группы доступности SQL Server AlwaysOn.
  
Если реализовано несколько групп хранения (базы данных распределены между несколькими группами высокой доступности SQL Server), должна быть запущена основная база данных для каждой группы хранения, чтобы получить журналы, связанные с соответствующей группой хранения.
  
### <a name="skills-and-experience"></a>Знания и опыт

В этом решении аварийного восстановления используется несколько технологий. Чтобы обеспечить надлежащую работу этих технологий, необходимо правильно установить и настроить каждый компонент среды Azure и локальной среды. Специалисту или команде специалистов, которые будут настраивать это решение, рекомендуется иметь богатые знания и навыки работы с технологиям, описанными в следующих статьях:
  
- [Службы репликации распределенной файловой системы (DFS)](https://go.microsoft.com/fwlink/p/?LinkId=392698)
    
- [Отказоустойчивая кластеризация Windows Server (WSFC) с SQL Server](https://go.microsoft.com/fwlink/p/?LinkId=392701)
    
- [Группы доступности AlwaysOn (SQL Server)](https://go.microsoft.com/fwlink/p/?LinkId=392725)
    
- [Резервное копирование и восстановление баз данных SQL Server](https://go.microsoft.com/fwlink/p/?LinkId=392728)
    
- [Установка SharePoint Server 2013 и развертывание в ферме](https://go.microsoft.com/fwlink/p/?LinkId=393119)
    
- [Microsoft Azure](https://go.microsoft.com/fwlink/p/?LinkId=392729)
    
Кроме того, рекомендуются навыки написания сценариев, которые помогут вам автоматизировать задачи, связанные с этими технологиями. Все задачи, описанные в этом решении, можно выполнить с помощью доступных пользовательских интерфейсов. Тем не менее, такой подход может занимать много времени и приводить к ошибкам, а также приносит непредсказуемые результаты.
  
Помимо Windows PowerShell, также доступны библиотеки Windows PowerShell для SQL Server, SharePoint Server и Azure. Не забывайте про запросы T-SQL, которые также помогут сократить время настройки и обслуживания среды аварийного восстановления.
  
## <a name="disaster-recovery-roadmap"></a>Схема аварийного восстановления

![Визуальное представление схемы аварийного восстановления SharePoint.](../media/Azure-DRroadmap.png)
  
Эта схема подразумевает, что рабочая ферма SharePoint Server 2013 уже развернута.
  
**Таблица. Схема аварийного восстановления**

|**Этап**|**Описание**|
|:-----|:-----|
|Этап 1  <br/> |Разработка среды аварийного восстановления.  <br/> |
|Этап 2  <br/> |Создание виртуальной сети Azure и VPN-подключения.  <br/> |
|Этап 3  <br/> |Развертывание Windows Active Directory и служб доменных имен в виртуальной сети Azure.  <br/> |
|Этап 4  <br/> |Развертывание фермы восстановления SharePoint в Azure.  <br/> |
|Этап 5  <br/> |Настройка DFSR между фермами.  <br/> |
|Этап 6  <br/> |Настройка доставки журналов в ферму восстановления.  <br/> |
|Этап 7  <br/> | Проверка решений для отработки отказа и восстановления. Она включает следующие процедуры и технологии: <br/>  остановка доставки журналов; <br/>  восстановление резервных копий; <br/>  обход контента; <br/>  восстановление служб; <br/>  управление записями DNS. <br/> |
   
## <a name="phase-1-design-the-disaster-recovery-environment"></a>Этап 1. Разработка среды аварийного восстановления

Следуйте указаниям из статьи [Microsoft Azure Architectures for SharePoint 2013](microsoft-azure-architectures-for-sharepoint-2013.md), чтобы разработать среду аварийного восстановления, включая ферму восстановления SharePoint. Вы можете использовать графические элементы [решения аварийного восстановления SharePoint в файле Azure](https://go.microsoft.com/fwlink/p/?LinkId=392554) Visio, чтобы начать процесс создания проекта. Рекомендуем полностью разработать среду, прежде чем приступать к работе в среде Azure.
  
Выполнив указания по разработке виртуальной сети, VPN-подключения, Active Directory и фермы SharePoint, приведенные в статье [Архитектуры Microsoft Azure для SharePoint 2013](microsoft-azure-architectures-for-sharepoint-2013.md), также необходимо добавить роль файлового ресурса в среду Azure.
  
Для поддержки доставки журналов в решении аварийного восстановления в подсеть, содержащую роли баз данных, добавлена виртуальная машина файлового ресурса. Файловый ресурс также выполняет роль третьего узла большинства узлов для группы доступности SQL Server AlwaysOn. Эта конфигурация рекомендуется для стандартной фермы SharePoint, которая использует группы доступности SQL Server AlwaysOn. 
  
> [!NOTE]
> Важно изучить необходимые условия для участия базы данных в группе доступности SQL Server AlwaysOn. Дополнительные сведения см. в статье [Предварительные требования, ограничения и рекомендации по использованию групп доступности AlwaysOn](https://go.microsoft.com/fwlink/p/?LinkId=510870). 
  
**Рисунок. Расположение файлового сервера, используемого решением для аварийного восстановления**

![Отображает общую папку виртуальной машины, добавленную в облачную службу, которая содержит роли сервера базы данных SharePoint.](../media/AZenv-FSforDFSRandWSFC.png)
  
На этой схеме в подсеть в Azure, содержащую роли серверов баз данных, добавлена виртуальная машина файлового ресурса. Не добавляйте эту виртуальную машину к группе доступности с другими ролями серверов, например ролей SQL Server.
  
Если вас интересует высокая доступность журналов, вы можете применить другой подход  [резервное копирование и восстановление SQL Server с помощью служб хранилища BLOB-объектов Azure](https://go.microsoft.com/fwlink/p/?LinkId=393113). Это новая функция Azure, которая сохраняет журналы непосредственно по URL-адресу хранилища BLOB-объектов. Это решение не включает указания по использованию этой функции.
  
При разработке фермы восстановления помните, что успешная среда аварийного восстановления точно отражает рабочую ферму, которую нужно восстановить. Размер фермы восстановления  не самая важная составляющая разработки, развертывания и тестирования фермы восстановления. Масштабы ферм в разных организациях отличаются и зависят от бизнес-требований. Вы можете использовать уменьшенную ферму во время короткого отключения питания или до тех пор, пока для достижения нужных производительности и емкости не потребуется масштабирование фермы.
  
По мере возможности настройте ферму восстановления идентично рабочей ферме, чтобы она соответствовала требованиям соглашения об уровне обслуживания (SLA) и предоставляла функции, необходимые для поддержки вашего предприятия. При разработке решения для аварийного восстановления также следует рассмотреть процесс управления изменениями для рабочей среды. Рекомендуем расширить процесс управления изменениями в среду восстановления, обновляя среду восстановления с теми же интервалами, что и рабочую среду. В ходе процесса управления изменениями рекомендуем вести подробный учет конфигурации фермы, приложений и пользователей. 
  
## <a name="phase-2-create-the-azure-virtual-network-and-vpn-connection"></a>Этап 2. Создание виртуальной сети Azure и VPN-подключения

В статье [Подключение локальной сети к виртуальной сети Microsoft Azure](connect-an-on-premises-network-to-a-microsoft-azure-virtual-network.md) показано, как планировать и развертывать виртуальную сеть Azure, а также создать VPN-подключение. Следуйте указаниям из этой статьи, чтобы выполнить следующие действия:
  
- Планирование пространства частных IP-адресов Виртуальная сеть.
    
- Планирование изменений инфраструктуры маршрутизации для Виртуальная сеть.
    
- Планирование правил брандмауэра для входящего и исходящего трафика на локальном устройстве VPN.
    
- Создание распределенной виртуальной сети в Azure.
    
- Настройка маршрутизации между локальной сетью и Виртуальная сеть.
    
## <a name="phase-3-deploy-active-directory-and-domain-name-services-to-the-azure-virtual-network"></a>Этап 3. Развертывание Active Directory и служб доменных имен в виртуальной сети Azure

Этот этап включает развертывание Windows Server Active Directory и DNS в Виртуальная сеть в гибридном сценарии, как описано в статье [Архитектуры Microsoft Azure для SharePoint 2013](microsoft-azure-architectures-for-sharepoint-2013.md) и показано на следующем рисунке:
  
**Рисунок. Гибридная конфигурация домена Active Directory**

![Две виртуальные машины, развернутые в виртуальной сети Azure, и подсеть фермы SharePoint — это реплики контроллеров домена и DNS-серверы.](../media/AZarch-HyADdomainConfig.png)
  
На этом рисунке в одной подсети развертываются две виртуальные машины. На каждой из этих виртуальных машин размещаются две роли: Active Directory и DNS.
  
Перед развертыванием Active Directory в Azure прочитайте [руководства по развертыванию Windows Server Active Directory на виртуальных машинах Azure](https://go.microsoft.com/fwlink/p/?linkid=392681). Эти указания помогут вам определить требуются ли для вашего решения другие параметры конфигурации.
  
Подробные указания по настройке контроллера домена в Azure см. в статье [Установка реплики контроллера домена Active Directory в виртуальных сетях Azure](https://go.microsoft.com/fwlink/p/?LinkId=392687).
  
До этого этапа вы не развертывали виртуальные машины в Виртуальная сеть. Скорее всего, виртуальные машины для размещения Active Directory и DNS  не самые большие виртуальные машины, необходимые для этого решения. Прежде чем развертывать эти виртуальные машины, создайте самую большую виртуальную машину, которую планируется использовать для Виртуальная сеть. Это поможет обеспечить, что решение попадет на тег Azure, в котором разрешается самый большой размер, который вам понадобится. В данный момент настраивать эту виртуальную машину не требуется. Просто создайте ее и приступайте к развертыванию. Если это не сделать, вы можете столкнуться с ограничением при попытке создать виртуальные машины большего размера. На момент написания данной статьи эта проблема актуальна 
  
## <a name="phase-4-deploy-the-sharepoint-recovery-farm-in-azure"></a>Этап 4. Развертывание фермы восстановления SharePoint в Azure

Разверните ферму SharePoint в своей виртуальной сети в соответствии с проектными планами. Рекомендуем ознакомиться со статьей [Планирование для SharePoint 2013 в службах инфраструктуры Azure](https://go.microsoft.com/fwlink/p/?LinkId=400984) перед развертыванием ролей SharePoint в Azure.
  
Ниже приводятся рекомендации, которые помогли нам при создании нашей экспериментальной среды:
  
- Создавайте виртуальные машины с помощью портала Azure или PowerShell.
    
- Azure и Hyper-V не поддерживают динамическую память. Убедитесь, что это учитывается в ваших планах производительности и емкости.
    
- Перезагружайте виртуальные машины через интерфейс Azure, а не с экрана входа. Интерфейс Azure более удобен и предсказуем.
    
- Если вам нужно завершить работу виртуальной машины в целях снижения затрат, используйте интерфейс Azure. Если завершить работу на экране входа виртуальной машины, проблемы начнут накапливаться.
    
- Используйте соглашение об именовании для виртуальных машин.
    
- Обращайте внимание на расположение центра обработки, в котором развертываются виртуальные машины.
    
- Функция автоматического масштабирования в Azure не поддерживается для ролей SharePoint.
    
- Не настраивайте элементы фермы, которые будут восстановлены, например семейства веб-сайтов. 
    
## <a name="phase-5-set-up-dfsr-between-the-farms"></a>Этап 5. Настройка DFSR между фермами

Чтобы настроить репликацию с помощью DFSR, используйте оснастку управления DNS. Тем не менее, перед настройкой DFSR необходимо войти на файловый сервер Azure и локальный файловый сервер, а затем включить службу в Windows.
  
На панели мониторинга диспетчера серверов выполните следующие действия.
  
- Настройте локальный сервер.
    
- Запустите **мастер добавления ролей и компонентов**.
    
- Откройте узел **Файловые службы и службы хранилища**.
    
- Выберите пункты **Пространства имен DFS** и **Репликация DFS**.
    
- Нажмите кнопку **Далее**, чтобы завершить работу мастера.
    
В приведенной ниже таблице представлены ссылки на справочные статьи и сообщения блогов, посвященные DFSR.
  
**Таблица. Справочные статьи, посвященные DFSR**

|**Название**|**Описание**|
|:-----|:-----|
|[Репликация](https://go.microsoft.com/fwlink/p/?LinkId=392732) <br/> |Статья по управлению DFS на сайте TechNet, включающая ссылки для репликации  <br/> |
|[Практические советы по репликации DFS](https://go.microsoft.com/fwlink/p/?LinkId=392737) <br/> |Вики-сайт со ссылками на сведения о DFS  <br/> |
|[Репликация DFS. Вопросы и ответы](https://go.microsoft.com/fwlink/p/?LinkId=392738) <br/> |Статья о репликации DFS на сайте TechNet  <br/> |
|[Блог Хосе Баррето (Jose Barreto)](https://go.microsoft.com/fwlink/p/?LinkId=392739) <br/> |Блог главного руководителя проекта из группы файловых серверов Майкрософт  <br/> |
|[Блог группы Майкрософт, ответственной за хранение](https://go.microsoft.com/fwlink/p/?LinkId=392740) <br/> |Блог, посвященный файловым службам и функциям хранения в Windows Server  <br/> |
   
## <a name="phase-6-set-up-log-shipping-to-the-recovery-farm"></a>Этап 6. Настройка доставки журналов в ферму восстановления

Доставка журналов  ключевой компонент настройки аварийного восстановления в этой среде. Вы можете использовать доставку журналов, чтобы автоматически отправлять файлы журналов транзакций из основной базы данных во вспомогательный экземпляр сервера баз данных. Сведения о настройке доставки журналов см. в статье [Configure log shipping in SharePoint 2013](https://docs.microsoft.com/sharepoint/administration/configure-log-shipping). 
  
> [!IMPORTANT]
> Поддержка доставки журналов в SharePoint Server ограничена определенными базами данных. Дополнительные сведения см. в статье [Поддерживаемые варианты обеспечения высокого уровня доступности и аварийного восстановления для баз данных SharePoint (SharePoint 2013)](https://go.microsoft.com/fwlink/p/?LinkId=393121). 
  
## <a name="phase-7-validate-failover-and-recovery"></a>Этап 7. Проверка отработки отказа и восстановления

Цель последнего этапа — проверить работу решения для восстановления. Для этого создайте сбой, который приводит к отключению рабочей фермы и запуску фермы восстановления. Вы можете запустить сценарий отработки отказа вручную или с помощью сценариев.
  
Для начала необходимо остановить входящие запросы пользователей к службам или контенту фермы. Это можно сделать, отключив записи DNS или отключив интерфейсные веб-серверы. После "сбоя" фермы вы можете выполнить переход на ферму восстановления.
  
### <a name="stop-log-shipping"></a>Остановка доставки журналов

Перед восстановлением фермы необходимо остановить доставку журналов. Сначала сделайте это на вспомогательном сервере в Azure, а затем — на основном локальном сервере. Используйте приведенный ниже сценарий, чтобы остановить доставку журналов сначала на вспомогательном сервере, а затем — на основном. Имена баз данных в сценарии могут отличаться от имен в вашей среде.
  
```
-- This script removes log shipping from the server.
-- Commands must be executed on the secondary server first and then on the primary server.

SET NOCOUNT ON
DECLARE  @PriDB nvarchar(max)
,@SecDB nvarchar(250)
,@PriSrv nvarchar(250)
,@SecSrv nvarchar(250)

Set @PriDB= ''
SET @PriDB = UPPER(@PriDB)
SET @PriDB = REPLACE(@PriDB, ' ', '')
SET @PriDB = '''' + REPLACE(@PriDB, ',', ''', ''') + ''''

Set @SecDB = @PriDB

Exec ( 'Select  ''exec master..sp_delete_log_shipping_secondary_database '' + '''''''' + prm.primary_database +  ''''''''   
from msdb.dbo.log_shipping_monitor_primary prm INNER JOIN msdb.dbo.log_shipping_primary_secondaries sec  ON  prm.primary_database=sec.secondary_database
where prm.primary_database in ( ' + @PriDB + ' )')

Exec ( 'Select  ''exec master..sp_delete_log_shipping_primary_secondary '' + '''''''' + prm.Primary_Database + '''''', '''''' + sec.Secondary_Server + '''''', '''''' + sec.Secondary_database + ''''''''   
from msdb.dbo.log_shipping_monitor_primary prm INNER JOIN msdb.dbo.log_shipping_primary_secondaries sec  ON  prm.primary_database=sec.secondary_database
where prm.primary_database in ( ' + @PriDB + ' )')

Exec ( 'Select  ''exec master..sp_delete_log_shipping_primary_database '' + '''''''' + prm.primary_database +  ''''''''   
from msdb.dbo.log_shipping_monitor_primary prm INNER JOIN msdb.dbo.log_shipping_primary_secondaries sec  ON  prm.primary_database=sec.secondary_database
where prm.primary_database in ( ' + @PriDB + ' )')

Exec ( 'Select  ''exec master..sp_delete_log_shipping_secondary_primary '' + '''''''' + prm.primary_server + '''''', '''''' + prm.primary_database +  ''''''''   
from msdb.dbo.log_shipping_monitor_primary prm INNER JOIN msdb.dbo.log_shipping_primary_secondaries sec  ON  prm.primary_database=sec.secondary_database
where prm.primary_database in ( ' + @PriDB + ' )')

```

### <a name="restore-the-backups"></a>Восстановление резервных копий

Восстанавливать резервные копии нужно в порядке их создания. Прежде чем восстанавливать резервную копию определенного журнала транзакций, необходимо восстановить следующие резервные копии без отката неподтвержденных транзакций (то есть с использованием  `WITH NORECOVERY`):
  
- Полное резервное копирование баз данных и последнее разностное резервное копирование  восстановите эти резервные копии (если они есть), созданные перед резервным копированием определенного журнала транзакций. До создания последней полной или разностной резервной копии базы данных в ней использовалась модель полного восстановления или модель восстановления с неполным протоколированием.
    
- Все резервные копии журналов транзакций  восстановите все резервные копии журналов транзакций, созданные после полного резервного копирования базы данных или разностного резервного копирования (если восстанавливалась эта копия) и до резервного копирования определенного журнала транзакций. Резервные копии журналов необходимо применять в порядке их создания, не пропуская журналы.
    
Чтобы восстановить базу данных контента на вспомогательном сервере для отображения сайтов, удалите все подключения баз данных перед восстановлением. Чтобы восстановить базу данных, используйте следующую инструкцию SQL:
  
```
restore database WSS_Content with recovery

```

> [!IMPORTANT]
> Если вы используете T-SQL в явной форме, укажите параметр **WITH NORECOVERY** или **WITH RECOVERY** в каждом операторе RESTORE, чтобы избежать неоднозначности  это очень важно при написании сценариев. После восстановления полных и разностных резервных копий можно восстановить журналы транзакций в SQL Server Management Studio. Кроме того, так как доставка журналов уже остановлена, база данных контента находится в состоянии ожидания, которое нужно изменить на полный доступ.
  
В SQL Server Management Studio щелкните базу данных **WSS_Content** правой кнопкой мыши, наведите указатель на пункт **Задачи** > **Восстановить** и выберите **Журнал транзакций** (если вы не восстанавливали полную резервную копию, эта команда недоступна). Дополнительные сведения см. в статье[Восстановление резервной копии журнала транзакций (SQL Server)](https://go.microsoft.com/fwlink/p/?LinkId=392778).
  
### <a name="crawl-the-content-source"></a>Обход источника контента

Чтобы восстановить службу поиска, необходимо запустить полный обход для каждого источника контента. Обратите внимание, что потеряются некоторые сведения аналитики из локальной фермы, например рекомендации поиска. Прежде чем запускать полный обход, используйте командлет Windows PowerShell **Restore-SPEnterpriseSearchServiceApplication** и укажите реплицированную базу данных администрирования поиска с доставкой журналов, **Search_Service__DB_<GUID>**. Этот командлет задает конфигурацию, схему, управляемые свойства и правила поиска, а также создает набор других компонентов по умолчанию.
  
Чтобы запустить полный обход, выполните следующие действия.
  
1. В Центр администрирования SharePoint 2013 откройте раздел **Управление приложениями** > **Приложения-службы** > **Управление приложениями-службами**, а затем щелкните приложение-службу поиска, обход которого нужно выполнить.
    
2. На странице **Администрирование поиска** нажмите **Источники контента**, наведите указатель на нужный источник контента, щелкните стрелку и нажмите **Начать полный обход**.
    
### <a name="recover-farm-services"></a>Восстановление служб фермы

В приведенной ниже таблице показано, как восстановить службы, в которых есть базы данных с доставкой журналов, службы, где есть базы данных, но не рекомендуется восстановление с доставкой журналов, и службы, в которых нет баз данных.
  
> [!IMPORTANT]
> При восстановлении локальной базы данных SharePoint в среде Azure не восстанавливаются службы SharePoint, которые еще не установлены в Azure вручную. 
  
**Таблица. Справка по базам данных приложений-служб**

|**Восстановление этих служб из баз данных с доставкой журналов**|**В этих службах есть базы данных, но их рекомендуется запускать без восстановления баз данных**|**Эти службы не хранят данные в базах данных. Запускайте их после отработки отказа**|
|:-----|:-----|:-----|
| Служба машинного перевода <br/>  Служба управляемых метаданных <br/>  Служба Secure Store <br/>  Служба профилей пользователей. (Поддерживаются только базы данных профилей и тегов. База данных синхронизации не поддерживается.) <br/>  Служба параметров подписки Microsoft SharePoint Foundation <br/> | Приложение-служба сбора данных об использовании и работоспособности <br/>  Служба состояний <br/>  Служба автоматизации Word <br/> | Службы Excel <br/>  PerformancePoint Services <br/>  Служба преобразования PowerPoint <br/>  Служба графики Visio <br/>  Служба управления работой <br/> |
   
На следующем примере показано, как восстановить службу управляемых метаданных из базы данных.
  
В этом примере использует существующая база данныхManaged_Metadata_DB. Эта база данных использует доставку журналов, но на вспомогательной ферме нет активных приложений-служб, поэтому ее нужно подключить после установки приложения-службы.
  
Для начала используйте команду  `New-SPMetadataServiceApplication` и укажите параметр `DatabaseName` с именем восстановленной базы данных.
  
Затем настройте новое приложение-службу управляемых метаданных на вспомогательном сервере, указав следующие параметры:
  
- Имя: служба управляемых метаданных
    
- Сервер базы данных: имя базы данных из доставленного журнала транзакций
    
- Имя базы данных:Managed_Metadata_DB
    
- Пул приложений: приложения-службы SharePoint 
    
### <a name="manage-dns-records"></a>Управление записями DNS

Необходимо вручную создать записи DNS, указывающие на ферму SharePoint.
  
В большинстве случаев, когда имеется несколько интерфейсных веб-серверов, будет целесообразно воспользоваться функцией балансировки сетевой нагрузки в Windows Server 2012 или устройством балансировки нагрузки, чтобы распределять запросы между интерфейсными веб-серверами фермы. Балансировка сетевой нагрузки также может снизить риск, распределяя запросы на другие серверы в случае сбоя одного из интерфейсных веб-серверов. 
  
Как правило, при настройке балансировки сетевой нагрузки кластеру назначается один IP-адрес. Затем необходимо создать у поставщика DNS для вашей сети запись узла DNS, которая указывает на кластер (для нашего проекта мы поместили DNS-сервер в Azure для повышения отказоустойчивости в случае сбоя локального центра обработки данных). Например, вы можете создать в диспетчере DNS службы Active Directory запись DNS с именем  `https://sharepoint.contoso.com`, которая указывает на IP-адрес кластера с балансировкой нагрузки.
  
Для внешнего доступа к ферме SharePoint можно создать запись узла на внешнем DNS-сервере с тем же URL-адресом, который клиенты используют в вашей интрасети (например, `https://sharepoint.contoso.com` ), который указывает на внешний IP-адрес в брандмауэре. (При использовании этого примера лучше всего настроить разделенный DNS, чтобы внутренний DNS-сервер был полномочным для `contoso.com` маршрутизации и направляет запросы непосредственно в кластер фермы SharePoint вместо маршрутизации DNS-запросов на внешний DNS-сервер.) Затем можно сопоставить внешний IP-адрес с внутренним IP-адресом локального кластера, чтобы клиенты могли найти нужные вам ресурсы.
  
После этого может возникнуть один из описанных ниже сценариев аварийного восстановления.
  
 **Пример сценария. Локальная ферма SharePoint недоступна по причине сбоя оборудования в локальной ферме SharePoint.** В этом случае после выполнения действий по отработке отказа в ферме Azure SharePoint вы можете настроить балансировку сетевой нагрузки на интерфейсных веб-серверах фермы SharePoint так же, как и на локальной ферме. Затем вы можете изменить запись узла у внутреннего поставщика DNS, чтобы она указывала на IP-адрес кластера фермы восстановления. Обратите внимание, что обновление кэшированных записей DNS в клиентах, чтобы они указывали на ферму восстановления, может занять некоторое время.
  
 **Пример сценария. Локальный центр обработки данных полностью потерян.** Этот сценарий может возникнуть в результате стихийного бедствия, например пожара или наводнения. Скорее всего, в этом случае в предприятии есть вспомогательный центр обработки данных, размещенный в другом регионе, а также подсеть Azure с собственными службами каталогов и DNS. Как и в предыдущем сценарии, вы можете изменить свои внутренние и внешние записи DNS, чтобы они указывали на ферму SharePoint в Azure. Помните, что распространение записей DNS может занять некоторое время.
  
Если вы используете семейства сайтов с именем на основе узла, как рекомендуется в [архитектуре и развертывании семейства сайтов с именем на основе узла (SharePoint 2013)](https://docs.microsoft.com/SharePoint/administration/host-named-site-collection-architecture-and-deployment), у вас может быть несколько семейств сайтов, размещенных в одном веб-приложении в ферме SharePoint, с УНИКАЛЬНЫМи DNS-именами (например, `https://sales.contoso.com` и `https://marketing.contoso.com` ). В этом случае вы можете создать для каждого семейства веб-сайтов записи DNS, указывающие на IP-адрес кластера. Когда запросы достигают интерфейсных веб-серверов SharePoint, эти серверы обрабатывают маршрутизацию запросов в соответствующие семейства веб-сайтов.
  
## <a name="microsoft-proof-of-concept-environment"></a>Экспериментальная среда Майкрософт

Мы разработали и испытали экспериментальную среду для этого решения. Целями проекта были развертывание и восстановление фермы SharePoint, которая может встретиться в среде клиента. Мы сделали несколько предположений, не забывая, что ферма должна предоставлять все стандартные функции без дополнительной настройки. Топология разработана для высокой доступности с использованием рекомендаций от группы разработки и тестирования продуктов.
  
В следующей таблице описываются виртуальные машины Hyper-V, созданные и настроенные для локальной тестовой среды.
  
**Таблица. Виртуальные машины для локального тестирования**

|**Имя сервера**|**Роль**|**Конфигурация**|
|:-----|:-----|:-----|
|DC1  <br/> |Контроллер домена с Active Directory.  <br/> |Два процессора  <br/> От 512 МБ до 4 ГБ ОЗУ  <br/> 1 жесткий диск объемом 127 ГБ  <br/> |
|RRAS  <br/> |Сервер, на котором настроена роль службы маршрутизации и удаленного доступа (RRAS).  <br/> |Два процессора  <br/> 2-8 ГБ ОЗУ  <br/> 1 жесткий диск объемом 127 ГБ  <br/> |
|FS1  <br/> |Файловый сервер с общими папками для резервных копий и конечной точкой для DFSR.  <br/> |Четыре процессора  <br/> 2-12 ГБ ОЗУ  <br/> 1 жесткий диск объемом 127 ГБ  <br/> 1 жесткий диск объемом 1 ТБ (SAN)  <br/> 1 жесткий диск объемом 750 ГБ  <br/> |
|SP-WFE1, SP-WFE2  <br/> |Интерфейсные веб-серверы.  <br/> |Четыре процессора  <br/> 16 ГБ ОЗУ  <br/> |
|SP-APP1, SP-APP2, SP-APP3  <br/> |Серверы приложений  <br/> |Четыре процессора  <br/> 2-16 ГБ ОЗУ  <br/> |
|SP-SQL-HA1, SP-SQL-HA2  <br/> |Серверы баз данных, на которых настроены группы доступности AlwaysOn SQL Server 2012, обеспечивающие высокую доступность. В этой конфигурации используются SP-SQL-HA1 и SP-SQL-HA2, основная и вспомогательная реплики.  <br/> |Четыре процессора  <br/> 2-16 ГБ ОЗУ  <br/> |
   
В следующей таблице описываются конфигурации дисков для виртуальных машин Hyper-V, которые мы создали и настроили для серверов приложений и интерфейсных веб-серверов в локальной тестовой среде.
  
**Таблица. Требования к дискам виртуальных машин для серверов приложений и интерфейсных веб-серверов в локальной тестовой среде**

|**Буква диска**|**Размер**|**Имя каталога**|**Путь**|
|:-----|:-----|:-----|:-----|
|C  <br/> |80  <br/> |Системный диск  <br/> |<DriveLetter>:\\Program Files\\Microsoft SQL Server\\  <br/> |
|E  <br/> |80  <br/> |Диск журналов (40 ГБ)  <br/> |<DriveLetter>:\\Program Files\\Microsoft SQL Server\\MSSQL10_50.MSSQLSERVER\\MSSQL\\DATA  <br/> |
|F  <br/> |80  <br/> |Диск файла подкачки (36 ГБ)  <br/> |<DriveLetter>:\\Program Files\\Microsoft SQL Server\\MSSQL\\DATA  <br/> |
   
В следующей статье представлены конфигурации дисков для виртуальных машин Hyper-V, созданных и настроенных как локальные серверы баз данных. На странице **Настройка компонента Database Engine** откройте вкладку **Каталоги данных**, чтобы задать и подтвердить параметры, показанные в следующей таблице.
  
**Таблица. Требования к диска виртуальных машин для сервера базы данных в локальной тестовой среде**

|**Буква диска**|**Размер**|**Имя каталога**|**Путь**|
|:-----|:-----|:-----|:-----|
|C  <br/> |80  <br/> |Корневой каталог данных  <br/> |<DriveLetter>:\\Program Files\\Microsoft SQL Server\\  <br/> |
|E  <br/> |500  <br/> |Каталог базы данных пользователей  <br/> |<DriveLetter>:\\Program Files\\Microsoft SQL Server\\MSSQL10_50.MSSQLSERVER\\MSSQL\\DATA  <br/> |
|F  <br/> |500  <br/> |Каталог журнала базы данных пользователей  <br/> |<DriveLetter>:\\Program Files\\Microsoft SQL Server\\MSSQL10_50.MSSQLSERVER\\MSSQL\\DATA  <br/> |
|Г  <br/> |500  <br/> |Временный каталог БД  <br/> |<DriveLetter>:\\Program Files\\Microsoft SQL Server\\MSSQL10_50.MSSQLSERVER\\MSSQL\\DATA  <br/> |
|H  <br/> |500  <br/> |Временный каталог журнала БД  <br/> |<DriveLetter>:\\Program Files\\Microsoft SQL Server\\MSSQL10_50.MSSQLSERVER\\MSSQL\\DATA  <br/> |
   
### <a name="setting-up-the-test-environment"></a>Настройка тестовой среды

В ходе разных этапов развертывания команда тестирования обычно работала сначала над локальной архитектурой, а затем  над соответствующей средой Azure. То же самое обычно происходит в реальных сценариях, где внутренние рабочие фермы уже запущены. Еще важнее знать текущую рабочую нагрузку, емкость и типичную производительностью. Создав модель аварийного восстановления, соответствующую бизнес-требованиям, следует изменить размеры ее серверов для минимального уровня обслуживания. Как правило, в средах с холодным или горячим резервированием ферма восстановления меньше рабочей фермы. Когда ферма восстановления будет находиться в стабильном рабочем состоянии, ее можно будет разворачивать и сворачивать в соответствии с требованиями к рабочей нагрузке.
  
Развертывание нашей тестовой среды выполнялось в три этапа:
  
- Настройка гибридной инфраструктуры
    
- Подготовка серверов
    
- Развертывание ферм SharePoint
    
#### <a name="set-up-the-hybrid-infrastructure"></a>Настройка гибридной инфраструктуры

Этот этап включает настройку доменной среды для локальной фермы и фермы восстановления в Azure. Помимо обычных задач, связанных с настройкой Active Directory, команда тестирования реализовала решение для маршрутизации и VPN-соединение между двумя средами.
  
#### <a name="provision-the-servers"></a>Подготовка серверов

Помимо серверов ферм, требовалось подготовить серверы для контроллеров доменов и настроить сервер для обработки RRAS и VPN типа "сеть-сеть". Для службы DFSR были подготовлены два файловых сервера, а для тестировщиков — несколько клиентских компьютеров.
  
#### <a name="deploy-the-sharepoint-farms"></a>Развертывание ферм SharePoint

Развертывание ферм SharePoint выполнялось в два этапа, чтобы упростить стабилизацию среды и устранение неполадок в случае необходимости. На первом этапе каждая ферма была развернута на минимальном количестве серверов для каждого уровня топологии, обеспечивая необходимые функции.
  
Мы создали серверы баз данных с установленным SQL Server, прежде чем создавать серверы SharePoint 2013. Так как это было новое развертывание, мы создали группы доступности перед развертыванием SharePoint. Мы создали три группы, следуя рекомендациям службы MCS. 
  
> [!NOTE]
> Создайте подстановочные базы данных, чтобы иметь возможность создать группы доступности перед установкой SharePoint. Дополнительные сведения см. в статье [Настройка групп обеспечения доступности SQL Server 2012 AlwaysOn для SharePoint 2013](https://go.microsoft.com/fwlink/p/?LinkId=517626).
  
Мы создали ферму и объединили дополнительные серверы в следующем порядке:
  
- Подготовка серверов SP-SQL-HA1 и SP-SQL-HA2.
    
- Настройка AlwaysOn и создание трех групп доступности для фермы. 
    
- Подготовка сервера SP-APP1 для размещения Центра администрирования.
    
- Подготовка серверов SP-WFE1 и SP-WFE2 для размещения распределенного кэша. 
    
Мы использовали параметр  _скипрегистерасдистрибутедкачехост_ при выполнении **psconfig.exe** в командной строке. Дополнительные сведения см. [в статье Plan for Feeds and Distributed Cache Service in SharePoint Server 2013](https://docs.microsoft.com/sharepoint/administration/plan-for-feeds-and-the-distributed-cache-service). 
  
В среде восстановления мы повторили следующие этапы:
  
- Подготовка серверов AZ-SQL-HA1 и AZ-SQL-HA2.
    
- Настройка AlwaysOn и создание трех групп доступности для фермы.
    
- Подготовка сервера AZ-APP1 для размещения Центра администрирования.
    
- Подготовка серверов AZ-WFE1 и AZ-WFE2 для размещения распределенного кэша.
    
Настроив распределенный кэш и добавив тестовых пользователей и тестовый контент, мы приступили ко второму этапу развертывания. Для этого потребовалось развернуть уровни и настроить серверы ферм для поддержки топологии высокой доступности, описанной в архитектуре фермы.
  
В следующей таблице описываются виртуальные машины, подсети и группы доступности, настроенные для фермы восстановления.
  
**Таблица. Инфраструктура фермы восстановления**

|**Имя сервера**|**Роль**|**Конфигурация**|**Подсеть**|**Группа доступности**|
|:-----|:-----|:-----|:-----|:-----|
|spDRAD  <br/> |Контроллер домена с Active Directory  <br/> |Два процессора  <br/> От 512 МБ до 4 ГБ ОЗУ  <br/> 1 жесткий диск объемом 127 ГБ  <br/> |sp-ADservers  <br/> ||
|AZ-SP-FS  <br/> |Файловый сервер с общими папками для резервных копий и конечной точкой службы DFSR  <br/> | Конфигурация A5: <br/>  Два процессора <br/>  14 ГБ ОЗУ <br/>  1 жесткий диск объемом 127 ГБ <br/>  1 жесткий диск объемом 135 ГБ <br/>  1 жесткий диск объемом 127 ГБ <br/>  1 жесткий диск объемом 150 ГБ <br/> |sp-databaseservers  <br/> |DATA_SET  <br/> |
|AZ-WFE1, AZ -WFE2  <br/> |Интерфейсные веб-серверы  <br/> | Конфигурация A5: <br/>  Два процессора <br/>  14 ГБ ОЗУ <br/>  1 жесткий диск объемом 127 ГБ <br/> |sp-webservers  <br/> |WFE_SET  <br/> |
|AZ -APP1, AZ -APP2, AZ -APP3  <br/> |Серверы приложений  <br/> | Конфигурация A5: <br/>  Два процессора <br/>  14 ГБ ОЗУ <br/>  1 жесткий диск объемом 127 ГБ <br/> |sp-applicationservers  <br/> |APP_SET  <br/> |
|AZ -SQL-HA1, AZ -SQL-HA2  <br/> |Серверы баз данных, основная и вспомогательная реплики для групп доступности AlwaysOn  <br/> | Конфигурация A5: <br/>  Два процессора <br/>  14 ГБ ОЗУ <br/> |sp-databaseservers  <br/> |DATA_SET  <br/> |
   
### <a name="operations"></a>Операции

Когда команда тестирования стабилизировала среды ферм и завершила функциональное тестирование, она приступила к следующим задачам, необходимым для настройки локальной среды восстановления:
  
- Настройка полных и разностных резервных копий.
    
- Настройка DFSR на файловых серверах, которые передают журналы транзакций между средой Azure и локальной средой.
    
- Настройка доставки журналов на основном сервере баз данных.
    
- Стабилизация, проверка и устранение неполадок доставки журналов по мере необходимости. Это включает определение и документирование действий, которые могут вызывать проблемы, например задержку сети, которая приводит к сбоям доставки журналов или синхронизации файлов DFSR.
    
### <a name="databases"></a>Databases

Наши испытания отработки отказа включали следующие базы данных: 
  
- WSS_Content
    
- ManagedMetadata
    
- БД профилей
    
- БД синхронизации
    
- БД социальных функций
    
- Концентратор типов контента (база данных для выделенного концентратора синдикации типов контента)
    
## <a name="troubleshooting-tips"></a>Советы по устранению неполадок

В этом разделе рассматриваются проблемы, с которыми мы столкнулись в ходе тестирования, и их решения. 
  
### <a name="using-the-term-store-management-tool-caused-the-error-the-managed-metadata-store-or-connection-is-currently-not-available"></a>При использовании средства управления банками терминов возникала ошибка "Хранилище управляемых метаданных или подключение в настоящий момент недоступно".

Убедитесь, что у учетной записи пула приложений, используемой веб-приложением, есть разрешение "Доступ на чтение в банк терминов".
  
### <a name="custom-term-sets-are-not-available-in-the-site-collection"></a>Пользовательские банки терминов недоступны в семействе веб-сайтов

Проверьте наличие связи между семейством веб-сайтов контента и концентратором типов контента. Кроме того, перейдите на экран свойств **Управляемые метаданные — подключение к <site collection name>** и убедитесь, что включен параметр **Это приложение-служба является используемым по умолчанию местом хранения для наборов терминов, определяемых столбцом**.
  
### <a name="the-get-adforest-windows-powershell-command-generates-the-error-the-term-get-adforest-is-not-recognized-as-the-name-of-a-cmdlet-function-script-file-or-operable-program"></a>Команда Windows PowerShell Get-ADForest вызывает ошибку "Имя "Get-ADForest" не распознано как имя командлета, функции, файла скрипта или выполняемой программы".

При настройке профилей пользователей необходимо имя леса Active Directory. Убедитесь, что в мастере добавления ролей и компонентов включен модуль Active Directory для Windows PowerShell (в разделе **Средства удаленного администрирования сервера>Средства администрирования ролей>Средства AD DS и AD LDS**). Кроме того, прежде чем использовать команду **Get-ADForest**, выполните следующие команды, чтобы обеспечить загрузку программных зависимостей.
  
```
Import-module servermanager
Import-module activedirectory

```

### <a name="availability-group-creation-fails-at-starting-the-alwayson_health-xevent-session-on-server-name"></a>Ошибка создания группы доступности на этапе запуска сеанса XEvent "AlwaysOn_health" на сервере <имя сервера>

Убедитесь, что оба узла отказоустойчивого кластера находятся в состоянии "Работает", а не "Приостановлен" или "Остановлен". 
  
### <a name="sql-server-log-shipping-job-fails-with-access-denied-error-trying-to-connect-to-the-file-share"></a>Задание доставки журналов SQL Server завершается с ошибкой отказа в доступе при попытке подключиться к общему файловому ресурсу

Убедитесь, что агент SQL Server работает с учетными данными сети, а не учетными данными по умолчанию.
  
### <a name="sql-server-log-shipping-job-indicates-success-but-no-files-are-copied"></a>Задание доставки журналов SQL Server завершается без ошибок, но файлы не копируются

Это вызвано тем, что по умолчанию для группы доступности выбран параметр резервного копирования **Предпочитать вторичную**. Убедитесь, что задание доставки журналов выполняется на вспомогательном, а не основном, сервере группы доступности. В противном случае оно не принесет результатов. 
  
### <a name="managed-metadata-service-or-other-sharepoint-service-fails-to-start-automatically-after-installation"></a>Служба управляемых метаданных (или другая служба SharePoint) не запускается автоматически после установки

Запуск служб может занять несколько минут в зависимости от производительности и текущей нагрузки на сервере SharePoint Server. Нажмите кнопку **Запустить** для службы и дайте ей достаточно времени для запуска, периодически обновляя экран "Службы на сервере" и проверяя ее состояние. Если служба останется остановленной, включите сбор данных диагностики SharePoint, снова попробуйте запустить службу и проверьте журнал на предмет ошибок. Дополнительные сведения см в статье [Настройка сбора данных диагностики в SharePoint 2013](https://docs.microsoft.com/sharepoint/administration/configure-diagnostic-logging)
  
### <a name="after-changing-dns-to-the-azure-failover-environment-client-browsers-continue-to-use-the-old-ip-address-for-the-sharepoint-site"></a>После настройки DNS для среды отработки отказа Azure браузеры клиентов продолжают использовать старый IP-адрес сайта SharePoint

Изменение DNS может не сразу стать видимым для всех клиентов. Выполните следующую команду из командной строки с повышенными полномочиями в тестовом клиенте и повторите попытку доступа к сайту.
  
```
Ipconfig /flushdns
```

## <a name="additional-resources"></a>Дополнительные ресурсы

[Поддерживаемые варианты обеспечения высокой доступности и аварийного восстановления для баз данных SharePoint](https://docs.microsoft.com/sharepoint/administration/supported-high-availability-and-disaster-recovery-options-for-sharepoint-databas)
  
[Настройка групп обеспечения доступности SQL Server 2012 AlwaysOn для SharePoint 2013](https://go.microsoft.com/fwlink/p/?LinkId=393122)
  
## <a name="see-also"></a>См. также

[Центр архитектуры и решений Microsoft 365](../solutions/solution-architecture-center.md)



