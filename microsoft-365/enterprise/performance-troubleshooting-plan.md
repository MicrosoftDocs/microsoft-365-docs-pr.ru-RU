---
title: План устранения неполадок с производительностью Office 365
ms.author: kvice
author: kelleyvice-msft
manager: laurawi
ms.date: 5/10/2019
audience: Admin
ms.topic: conceptual
ms.service: o365-administration
localization_priority: Normal
f1.keywords:
- CSH
ms.custom:
- Adm_O365
- seo-marvel-apr2020
search.appverid:
- MET150
- MOE150
- BCS160
ms.assetid: e241e5d9-b1d8-4f1d-a5c8-4106b7325f8c
ms.collection:
- M365-security-compliance
- Ent_O365
description: В этой статье можно устранить Office 365 проблемы с производительностью и даже устранить некоторые из наиболее распространенных проблем.
ms.openlocfilehash: 6ef459d6469881c71ea7d1da3a32eb42eb3ead6b
ms.sourcegitcommit: 48195345b21b409b175d68acdc25d9f2fc4fc5f1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/30/2021
ms.locfileid: "53229939"
---
# <a name="performance-troubleshooting-plan-for-office-365"></a>План устранения неполадок с производительностью Office 365

Необходимо ли знать, какие действия необходимо предпринять для выявления и устранения лагов, зависания и медленной производительности между SharePoint Online, OneDrive для бизнеса, Exchange Online или Skype для бизнеса Online и клиентского компьютера? Перед вызовом службы поддержки эта статья может помочь устранить Office 365 проблемы с производительностью и даже устранить некоторые из наиболее распространенных проблем.

В этой статье фактически используется пример плана действий, который можно использовать для захвата ценных данных о проблеме производительности при ее работе. Некоторые главные проблемы также включены в эту статью.

Если вы не знаете о производительности сети и хотите спланировать долгосрочный план мониторинга производительности между клиентской машиной и Office 365, взгляните на Office 365 настройки производительности и устранение неполадок — администрирование и [ИТ-Pro](performance-tuning-using-baselines-and-history.md).

## <a name="sample-performance-troubleshooting-action-plan"></a>Пример плана действий по устранению неполадок производительности

Этот план действий содержит две части; этап подготовки и этап ведения журнала. Если у вас есть проблемы с производительностью прямо сейчас, и вам необходимо сделать сбор данных, вы можете начать использовать этот план сразу.

### <a name="prepare-the-client-computer"></a>Подготовка клиентского компьютера

- Найдите клиентский компьютер, который может воспроизвести проблему производительности. Этот компьютер будет использоваться во время устранения неполадок.
- Запишите действия, которые приводят к проблеме производительности, чтобы вы были готовы, когда придет время для тестирования.
- Установите средства для сбора и записи сведений:
  - Установка [Netmon 3.4](https://www.microsoft.com/download/details.aspx?id=4865) (или использование эквивалентного средства отслеживания сети).
  - Установите бесплатное базовое издание [HTTPWatch](https://www.httpwatch.com/download/) (или используйте эквивалентный сетевой инструмент трассивки).
  - Используйте регистратор экрана или запустите регистратор шагов (PSR.exe), который поставляется с Windows Vista и позже, чтобы сохранить запись действий, которые вы принимаете во время тестирования.

### <a name="log-the-performance-issue"></a>Журнал проблемы производительности

- Закрой все лишние интернет-браузеры.
- Запустите регистратор шагов или другой регистратор экрана.
- Запустите захват Netmon (или средство отслеживания сети).
- Очистить кэш DNS на клиентский компьютер от командной строки, введя ipconfig/flushdns.
- Запустите новый сеанс браузера и включив HTTPWatch.
- Необязательный. Если вы Exchange Online, запустите средство анализатора производительности Exchange клиента из консоли Office 365 администратора.
- Воспроизведение точных действий, которые вызывают проблему производительности.
- Остановите след Netmon или другого средства.
- В командной строке запустите маршрут трассировки для Office 365 подписки, введя следующую команду и нажав кнопку ENTER:

  ``` cmd
  tracert <subscriptionname>.onmicrosoft.com
  ```

- Остановите регистратор шагов и сохраните видео. Обязательно включай дату и время захвата и показывает ли он хорошую или плохую производительность.
- Сохраните файлы трассировки. Опять же, обязательно включай дату и время захвата и показывает ли он хорошую или плохую производительность.

Если вы не знакомы с управлением средствами, упомянутыми в этой статье, не волнуйтесь, так как мы предлагаем следующие действия. Если вы привыкли делать этот вид захвата сети, вы можете пропустить, как собрать базовые [данные,](performance-tuning-using-baselines-and-history.md#how-to-collect-baselines)который описывает фильтрацию и чтение журналов.

### <a name="flush-the-dns-cache-first"></a>Сначала смыть кэш DNS

Почему? Вымыв кэш DNS, вы начинаете тесты с чистого листа. Очищая кэш, вы сбрасываете содержимое содержимого ретранслиатора DNS в самые последние записи. Помните, что флеш не удаляет записи файлов HOSTs. Если вы широко используете записи файлов HOST, следует скопировать эти записи в файл в другом каталоге, а затем опустеть файл HOST.

#### <a name="flush-your-dns-resolver-cache"></a>Флеш-кэш разрешения DNS

1. Откройте командную подсказку **(начните** запуск \>  \> **cmd** **или Windows** \> **клавишу).**
2. Введите следующую команду и нажмите клавишу ВВОД:

    ``` cmd
    ipconfig /flushdns
    ```

## <a name="netmon"></a>Netmon

Средство мониторинга сети Майкрософт[(Netmon)](https://www.microsoft.com/download/details.aspx?id=4865)анализирует пакеты, то есть трафик, который проходит между компьютерами в сетях. Используя Netmon для отслеживания трафика с помощью Office 365 вы можете захватывать, просматривать и читать заглавные пакеты, определять взаимозаменяющие устройства, проверять важные параметры сетевого оборудования, искать отброшенные пакеты и следить за потоком трафика между компьютерами в корпоративной сети и Office 365. Так как фактический текст трафика зашифрован, то есть он (отправляется в порт 443 через SSL/TLS), вы не можете прочитать отправленные файлы. Вместо этого вы получите неотбитый след пути, который принимает пакет, который может помочь вам отслеживать поведение проблемы.

Убедитесь, что в настоящее время фильтр не применяется. Вместо этого пробегите по шагам и продемонстрируем проблему, прежде чем остановить след и сохранить.

После установки Netmon 3.4 откройте средство и примите следующие действия:

### <a name="take-a-netmon-trace-and-reproduce-the-issue"></a>Возьмите след Netmon и воспроизведйте проблему

1. Запуск Netmon 3.4.
На странице "Начало"  есть три **области:**"Последние захваты", **"Выбор** сетей" и "Начало работы с **Microsoft Network Monitor 3.4". Обратите внимание.** Панель Select Networks также даст вам список сетей по умолчанию, из которых можно захватить. Убедитесь, что сетевые карты выбраны здесь.

2. Нажмите **кнопку Новый захват** в верхней части страницы **Начните.** Это добавляет новую вкладку рядом со вкладками **Начните** страницу под названием **Захват 1**.
![Пользовательский интерфейс Netmon с выделенными кнопками New Capture, Start и Stop.](../media/d4527d84-62ec-4301-82d5-e0166ff71f20.PNG)

3. Чтобы сделать простой захват, нажмите **кнопку Начните** на панели инструментов.

4. Воспроизведение действий, которые представляют проблему производительности.

5. Щелкните  \> **Стоп-файл** \> **Сохранить как**. Не забудьте ударить дату и время с часовой зоной и упоминают, демонстрирует ли он плохую или хорошую производительность.

## <a name="httpwatch"></a>HTTPWatch

[HTTPWatch](https://www.httpwatch.com/download/) поставляется с заряженным и бесплатным выпуском. Бесплатное базовое издание охватывает все необходимое для этого теста. HTTPWatch отслеживает сетевой трафик и время загрузки страницы прямо из окна браузера. HTTPWatch — это подключаемый модуль к Internet Explorer, который графически описывает производительность. Анализ можно сохранить и просмотреть в HTTPWatch Studio.

> [!NOTE]
> Если вы используете другой браузер, например Firefox, Google Chrome или не можете установить HTTPWatch в Internet Explorer, откройте новое окно браузера и нажмите клавишу F12 на клавиатуре. Вы должны увидеть всплывающее всплывающее средство разработчика в нижней части браузера. Если вы используете Opera, нажмите CTRL+SHIFT+I для веб-инспектора, а затем нажмите вкладку **Сеть** и завершите тестирование, описанное ниже. Сведения будут немного отличаться, но время загрузки по-прежнему будет отображаться в миллисекунд. > HTTPWatch также очень полезен для проблем с SharePoint время загрузки страниц в Интернете.

### <a name="run-httpwatch-and-reproduce-the-issue"></a>Запустите HTTPWatch и воспроизведите проблему

HTTPWatch — это подключаемый модуль браузера, поэтому для каждой версии Internet Explorer средство в браузере несколько отличается. Как правило, httpWatch можно найти в панели Команд в браузере Internet Explorer. Если вы не видите плагин HTTPWatch в окне браузера, проверьте версию браузера, нажав справку о , или в более поздних версиях Internet Explorer, щелкните символ передачи и  \> Об **internet Explorer**. Чтобы запустить **планку Команд,** щелкните правой кнопкой мыши меню в Internet Explorer и нажмите **кнопку Команд.**

В прошлом HTTPWatch был связан как с командами, так и с панелью Explorer, поэтому после установки, если вы не сразу увидите значок (даже после перезагрузки) проверьте Инструменты **и** панели инструментов для значка. Помните, что панели инструментов можно настроить и добавить к ним параметры.

![Панель команд internet Explorer с отображаемой иконкой HTTPWatch.](../media/198590b0-d7b1-4bff-a6ad-e4ec3a1e83df.png)

1. Запуск HTTPWatch в окне браузера Internet Explorer. Он будет отображаться пристыкованным к браузеру в нижней части этого окна. Нажмите **кнопку Запись**.

2. Воспроизвести точные действия, связанные с проблемой производительности. Нажмите **кнопку Остановка** в HTTPWatch.

3. **Сохранить** HTTPWatch или **отправить по электронной почте**. Не забудьте назвать файл таким образом, чтобы он включал сведения о дате и времени, а также указывает, содержит ли часы демонстрацию хорошей или плохой производительности.

![HTTPWatch с отображением вкладки "Сеть" при загрузке домашней страницы Office 365.](../media/021a2c64-d581-49fd-adf4-4c364f589d75.PNG)

Этот снимок экрана из Professional httpWatch. Можно открыть следы, взятые в базовой версии, на компьютере с Professional и прочитать его там. Дополнительные сведения могут быть доступны из трассировки с помощью этого метода.

## <a name="problem-steps-recorder"></a>Регистратор действий проблем

Регистратор шагов или PSR.exe позволяет записывать проблемы по мере их фиксировать. Это очень полезный инструмент и очень простой в запуске.

### <a name="run-problem-steps-recorder-psrexe-to-record-your-work"></a>Запуск регистратора действий проблем (PSR.exe) для записи работы

1. Либо используйте **тип запуска** \>  \> **PSR.exe** \> **ОК,** либо  \>  нажмите кнопку Windows ключаPSR.exe\> нажмите кнопку ENTER.

2. Когда появится PSR.exe окно, нажмите **кнопку Начните** запись и воспроизводя действия, воспроизводя проблемы с производительностью. Вы можете добавить комментарии по мере необходимости, щелкнув **Добавить комментарии**.

3. Щелкните **стоп-запись** после завершения действий. Если проблема производительности — это отрисовка страницы, подождите, пока страница не будет отрисовка, прежде чем остановить запись.

4. Щелкните **Сохранить**.

![Снимок экрана регистратора шагов или PSR.exe.](../media/8542b0aa-a3ff-4718-8dc4-43f5521c6c34.PNG)

Дата и время записи для вас. Это вовремя связывает psR с трассировочными данными Netmon и HTTPWatch, а также помогает в устранении неполадок. Дата и время записи PSR могут показать, что между входом и просмотром URL-адреса и частичным отрисовывом веб-сайта администратора, например, прошла минута.

## <a name="read-your-traces"></a>Чтение следов

Невозможно научить всех устранению неполадок в сети и производительности, которые кто-то должен знать в статье. Получение хорошей производительности требует опыта и знаний о том, как работает и обычно работает ваша сеть. Но можно скруглять список главных проблем и показать, как средства могут упростить устранение наиболее распространенных проблем.

Если вы хотите получить навыки чтения сетевых трассировок для Office 365 сайтов, нет лучшего учителя, чем регулярно создавать следы загрузки страниц и получать опыт чтения их. Например, если у вас есть шанс, загрузить Office 365 службу и проследить процесс. Фильтр трассировки для трафика DNS или поиск в FrameData для имени службы, которая просматривается. Сканируйте след, чтобы получить представление о действиях, которые происходят при загрузке службы. Это поможет вам узнать, как должна выглядеть нормальная нагрузка страницы, и в случае устранения неполадок, особенно в области производительности, сравнение хороших и плохих следов может научить вас многому.

Netmon использует Microsoft Intellisense в поле фильтра Display. Intellisense или интеллектуальное завершение кода — это тот трюк, в котором введите период, и все доступные параметры отображаются в поле выбора. Если, например, вас беспокоит масштабирование окна TCP, вы можете найти путь к фильтру (например) с помощью  `.protocol.tcp.window < 100` этого средства.

![Снимок экрана Netmon, показывающий, что поле фильтра отображения использует intellisense.](../media/75a56c11-9a60-47ee-a100-aabdfb1ba10f.PNG)

Следы Netmon могут иметь большой трафик в них. Если у вас нет опыта чтения их, скорее всего, вы будете перегружены открытие трассировки в первый раз. Первое, что нужно сделать, это отделить сигнал от фонового шума в следе. Вы протестировали Office 365, и это трафик, который вы хотите видеть. Если вы привыкли перемещаться по следам, этот список может не понадобиться.

Трафик между клиентом и Office 365 через TLS, что означает, что тело трафика будет зашифровано и не может быть читаемым в общем следе Netmon. Анализ производительности не должен знать специфику сведений в пакете. Однако он очень заинтересован в загонах пакетов и информации, которая в них содержится.

### <a name="tips-to-get-a-good-trace"></a>Советы получить хороший след

- Знать значение адреса IPv4 или IPv6 клиентского компьютера. Это можно получить из командной подсказки, введя **IPConfig** и нажав кнопку ENTER. Знание этого адреса позволит сразу определить, связан ли трафик трассировки непосредственно с клиентского компьютера. Если имеется известный прокси- сервер, прогонать его и получить его IP-адрес, а также.

- Смойте кэш разрешения DNS и, по возможности, закройте все браузеры, кроме браузера, в котором вы тестируете. Если вы не можете это сделать, например, если поддержка использует какой-либо инструмент на основе браузера, чтобы увидеть рабочий стол клиентского компьютера, будьте готовы к фильтрации трассировки.

- В занятом следе найдите Office 365 службу, которую вы используете. Если вы никогда или редко видели трафик раньше, это полезный шаг в отделять проблему производительности от другого сетевого шума. Существует несколько способов сделать это. Непосредственно перед тестом можно использовать _пинг_ или _psPing_ по URL-адресу определенной службы (или, `ping outlook.office365.com` `psping -4 microsoft-my.sharepoint.com:443` например). Вы также можете легко найти, что пинг или PsPing в netmon трассировки (по имени процесса). Это даст вам место, чтобы начать искать.

Если вы используете трассировку Netmon только во время проблемы, это тоже нормально. Чтобы ориентироваться, используйте фильтр like `ContainsBin(FrameData, ASCII, "office")` или `ContainsBin(FrameData, ASCII, "outlook")` . Вы можете записать номер кадра из файла трассировки. Кроме того, может потребоваться прокрутка области _сводки_ кадров вправо и искать столбец Conversation ID. Существует номер, указанный там для ID этого конкретного разговора, что вы также можете записывать и смотреть в изоляции позже. Не забудьте удалить этот фильтр, прежде чем применять другие фильтры.

> [!TIP]
> Netmon имеет много полезных встроенных фильтров. Попробуйте **кнопку Фильтр нагрузки** в верхней части области _фильтра отображения._

![Найдите IP-адрес с помощью PSPing в командной строке на клиентском компьютере.](../media/4c43ac67-e28e-4536-842d-7add7aa28847.PNG)

![Netmon trace from the client showing the same PSPing command through the filter TCP. Flags.Syn == 1.](../media/0ae7ef7d-e003-4d01-a006-dc49bd1fcef2.PNG)

Ознакомьтесь с трафиком и узнайте, как найти необходимую информацию. Например, узнайте, какой пакет в следе имеет первую ссылку на используемую службу Office 365 (например, "Outlook").

Пример Office 365 Outlook в Интернете, и трафик начинается так:

- Стандартный запрос DNS и ответ DNS для outlook.office365.com с соответствием queryIDs. Важно отметить смещение времени для этого поворота, а также то, где в мире Office 365 глобальной DNS отправляет запрос на разрешение имен. В идеале, как можно локально, а не на полпути по всему миру.

- Запрос HTTP GET, отчет о состоянии которого перенесен навсегда (301)

- RWS Traffic, включая RWS Подключение запросы и Подключение ответы. (Это удаленный Уинсок, который делает подключение для вас.)

- Беседа TCP SYN и TCP SYN/ACK. Многие параметры в этом разговоре влияют на производительность.

- Затем состоится серия TLS:TLS-трафика, в котором проходят беседы о рукопожатии TLS и TLS-сертификатах. (Помните, что данные шифруются с помощью SSL/TLS.)

Все части трафика важны и подключены, но небольшие части трассировки содержат сведения, особенно важные с точки зрения устранения неполадок производительности, поэтому мы сосредоточимся на этих областях. Кроме того, поскольку мы сделали достаточно Office 365 устранения неполадок производительности в Корпорации Майкрософт для компиляции списка наиболее распространенных проблем, мы сосредоточимся на этих проблемах и о том, как использовать средства, которые необходимо устранить далее.

Если вы еще не установили их все готово, в приведенной ниже матрице используется несколько инструментов. Где это возможно. Ссылки предоставляются в пункты установки. В список включены распространенные средства отслеживания сетей, такие как [Netmon](https://www.microsoft.com/download/details.aspx?id=4865) и [Wireshark,](https://www.wireshark.org/)но используйте любое удобное средство отслеживания, в котором вы привыкли к фильтрации сетевого трафика. При тестировании помните:

- *Закройте браузеры и протестировать*  с помощью только одного браузера — это уменьшит общий трафик, который вы захватываете. Это делает для менее занят след.
- *Смойте кэш*  разрешения DNS на клиентский компьютер . Это даст вам чистый сланец, когда вы начнете захват, для более чистого следа.

## <a name="common-issues"></a>Распространенные проблемы

Некоторые распространенные проблемы, с которые вы можете столкнуться, и их поиск в сетевом следе.

### <a name="tcp-windows-scaling"></a>Масштабирование Windows TCP

Найдено в syn - SYN/ACK. Устаревшее или устаревшее оборудование может не использовать преимущества масштабирования окон TCP.  Без надлежащих параметров масштабирования окон TCP 16-битный буфер в загонах TCP заполняет миллисекунд.  Трафик не может продолжать отправляться, пока клиент не получит подтверждение о том, что исходные данные получены, что приводит к задержкам.

#### <a name="tools"></a>Инструменты

- Netmon
- Wireshark

#### <a name="what-to-look-for"></a>Что нужно искать

Найди трафик SYN - SYN/ACK в сетевом следе.  В Netmon используйте фильтр типа  `tcp.flags.syn == 1` . Этот фильтр является одинаковым в Wireshark.

![Фильтр в Netmon или Wireshark для пакетов Syn для обоих инструментов: TCP. Flags.Syn == 1.](../media/4b9a12a1-c915-43c8-ac2f-a679d0435a29.PNG)

Обратите внимание, что для каждого СИН имеется номер источника порта (SrcPort), соответствующий в порту назначения (DstPort) связанного подтверждения (SYN/ACK).

Чтобы увидеть значение Windows масштабирования, используемой сетевым подключением, развяжи сначала СИН, а затем связанный syn/ACK.

![На рисунке показано, как сопопобирать SrcPort с DstPort в следе, чтобы получить дельту времени.](../media/6a4ca573-0253-4fbd-93e8-92821ee1c351.png)

### <a name="tcp-idle-time-settings"></a>Время ожидания TCP Параметры

Исторически большинство сетей периметра настроены для переходных подключений, что означает, что простаиваемые подключения обычно прекращаются. Сеансы ожидания TCP могут быть прекращены прокси-службами и брандмауэрами более чем за 100-300 секунд. Это проблематично для Outlook Online, так как оно создает и использует долгосрочные подключения независимо от того, простаивают они или нет.

Когда подключение прекращается с помощью прокси-серверов или брандмауэров, клиент не информируется, а попытка использовать Outlook Online будет означать, что клиентский компьютер будет пытаться повторно восстановить подключение перед созданием нового. Вы можете увидеть зависает в продукте, подсказки, или медленная производительность на странице нагрузки.

#### <a name="tools"></a>Инструменты

- Netmon
- Wireshark

#### <a name="what-to-look-for"></a>Что нужно искать

В Netmon посмотрите на поле Смещение времени для круговой поездки. Круговая поездка — это время между отправкой запроса клиента на сервер и получением ответа обратно. Проверьте между клиентом и точкой отступа (например. Клиент -- Прокси) или клиент \> для Office 365 (клиент \> -- Office 365). Это можно увидеть во многих типах пакетов.

Например, фильтр в Netmon может выглядеть  `.Protocol.IPv4.Address == 10.102.14.112 AND .Protocol.IPv4.Address == 10.201.114.12` как , или, в Wireshark,  `ip.addr == 10.102.14.112 &amp;&amp; ip.addr == 10.201.114.12` .

> [!TIP]
> Не знаете, принадлежит ли IP-адрес вашего следа вашему DNS-серверу? Попробуйте найти его в командной строке. Нажмите **кнопку Начните** запуск и введите \>  \> **cmd** или **нажмите клавишу Windows и** \> введите **cmd**. В запросе введите  `nslookup <the IP address from the network trace>` . Чтобы проверить, используйте nslookup для IP-адреса собственного компьютера. > список ip-диапазонов Корпорации Майкрософт см. в Office 365 [URL-адресов и диапазонов IP-адресов.](./urls-and-ip-address-ranges.md)

Если возникла проблема, ожидайте появления длинных смещений времени в этом случае (Outlook Online), особенно в пакетах TLS:TLS, которые показывают прохождение данных приложений (например, в Netmon можно найти пакеты данных приложений с помощью `.Protocol.TLS AND Description == "TLS:TLS Rec Layer-1 SSL Application Data"` ). Вы должны видеть плавную прогрессию во время сеанса. Если вы видите длительные задержки при Outlook в Интернете, это может быть вызвано высокой степенью отгружаемой.

### <a name="latencyround-trip-time"></a>Время задержки и обратного пути

Задержка — это мера, которая может многое изменить в зависимости от многих переменных, таких, как обновление устройств старения, добавление большого количества пользователей в сеть и процент общей пропускной способности, потребляемой другими задачами на сетевом подключении.

Существуют калькуляторы пропускной способности для Office 365 для этого сетевого планирования и настройки [производительности для Office 365](network-planning-and-performance.md) страницы.

Необходимо измерить скорость подключения или пропускную способность подключения к интернет-каналу? Попробуйте этот сайт (или сайты, как он): [Speedtest Официальный сайт](https://www.speedtest.net/), или запрос вашей любимой поисковой системы для теста **скорости фразы**.

#### <a name="tools"></a>Инструменты

- Ping
- PsPing
- Netmon
- Wireshark

#### <a name="what-to-look-for"></a>Что нужно искать

Чтобы отслеживать задержку в трассировке, вы сможете зафиксировать IP-адрес клиентского компьютера и IP-адрес DNS-сервера в Office 365. Это делается для более легкой фильтрации трассировки. При подключении через прокси-сервер вам потребуется IP-адрес клиентского компьютера, IP-адрес прокси/egress и ip-адрес Office 365 DNS, чтобы упростить работу.

В запросе ping, отправленном в outlook.office365.com, будет названо имя центра обработки данных, получающие запрос, даже если  *ping*  не сможет подключиться для отправки последовательных пакетов ICMP товарного знака. Если вы используете PsPing (бесплатный инструмент для скачивания) и укатерите порт (443) и, возможно, для использования IPv4 (-4), вы получите среднее время в пути для отправленных пакетов. Это будет работать для других URL-адресов в Office 365, например `psping -4 yourSite.sharepoint.com:443` . В самом деле, вы можете указать ряд 1000 000, чтобы получить больший пример для среднего, попробуйте что-то вроде `psping -4 -n 20 yourSite-my.sharepoint.com:443` .

> [!NOTE]
> PsPing не отправляет пакеты ICMP. Он pings с пакетами TCP над определенным портом, поэтому вы можете использовать любой, который вы знаете, чтобы быть открытым. В Office 365, который использует SSL/TLS, попробуйте прикрепить порт :443 к psPing.

![Снимок экрана с разрешением пинга outlook.office365.com и PSPing с 443 аналогичными данными, но также отчеты о среднем RTT в 6,5 мс.](../media/c64339f2-2c96-45b8-b168-c2a060430266.PNG)

Если вы загрузили медленную страницу Office 365 при выполнении сетевого трассировки, необходимо отфильтровать трассировку Netmon или Wireshark `DNS` для . Это один из ИП, который мы ищем.

Вот шаги, которые необходимо предпринять для фильтрации Netmon, чтобы получить IP-адрес (и взглянуть на задержку DNS). В этом примере outlook.office365.com, но может также использовать URL-адрес клиента SharePoint Online (например, hithere.sharepoint.com).

1. Ping URL-адрес и, в результатах, запись имени и `ping outlook.office365.com` IP-адреса сервера DNS запрос был отправлен.
2. Сетевой след, открывая страницу, или делая действия, которые дают вам проблему производительности, или, если вы видите высокую задержку на ping, сама сеть отслеживает ее.
3. Откройте трассировку в Netmon и фильтр для DNS (этот фильтр также работает в Wireshark, но чувствителен к `-- dns` делу). Так как вы знаете имя DNS-сервера из вашего ping, вы также можете фильтровать более быстро в Netmon, как это: , который выглядит так в dns Wireshark и кадр содержит `DNS AND ContainsBin(FrameData, ASCII, "namnorthwest")` "namnorthwest".<br/>Откройте пакет ответов и в окне Сведения о кадре **Netmon** щелкните **DNS,** чтобы расширить для получения дополнительных сведений. В DNS-информации вы найдете IP-адрес сервера DNS, на который поступил запрос в Office 365. Этот IP-адрес потребуется для следующего шага (средства PsPing). Удалите фильтр, щелкните правой кнопкой мыши на ответ DNS в Netmon (Сводка кадров \> **Найти** \> **беседы DNS**), чтобы увидеть DNS-запрос и ответ бок о бок.
4. В Netmon также обратите внимание на столбец Смещение времени между запросом DNS и ответом. На следующем шаге средство [PsPing,](/sysinternals/downloads/psping) легкое в установке и использовании, очень удобно, так как ICMP часто блокируется на брандмауэрах, а также потому, что PsPing элегантно отслеживает задержку в миллисекунд. PsPing завершает подключение TCP к адресу и порту (в нашем случае открытый порт 443).
5. Установка PsPing.
6. Откройте командную подсказку (командный код типа запуска или Windows ключа) и измените каталог в каталог, в котором установлен PsPing для запуска \> \> команды \> PsPing. В моих примерах вы можете увидеть, как я сделал папку "Perf" на корневой части C. Вы можете сделать то же самое для быстрого доступа.
7. Введите команду, чтобы сделать psPing с IP-адресом сервера DNS Office 365 от предыдущего следа Netmon, включая номер порта, например `psping -n 20 132.245.24.82:445` . Это позволит вам сделать выборку из 20 пингов и усреднить задержку при остановке psPing.

Если вы собираетесь Office 365 через прокси-сервер, действия немного отличаются. Сначала psPing на прокси-сервере, чтобы получить среднее значение задержки в миллисекунд до прокси/egress и обратно, а затем либо запустить PsPing на прокси-сервере или на компьютере с прямым подключением к Интернету, чтобы получить недостающее значение (от одного до Office 365 и обратно).

Если вы решите выполнить psPing из прокси-сервера, у вас будет два миллисекундных значения: клиентский компьютер до прокси-сервера или точки отступа, а прокси-сервер — Office 365. И вы закончили! Ну, записи значений, в любом случае.

Если вы запустите PsPing на другом клиентском компьютере, который имеет прямое подключение к Интернету, то есть без прокси-сервера, у вас будет два миллисекундных значения: клиентский компьютер на прокси-сервер или точку отступа и клиентский компьютер для Office 365. В этом случае вычитайте значение клиентского компьютера на прокси-сервер или точку регресса от значения клиентского компьютера до Office 365, и у вас будут номера RTT с клиентского компьютера на прокси-сервер или точку отступа, а с прокси-сервера или отступа точки на Office 365.

Однако если вы можете найти клиентский компьютер в непосредственном подключенном расположении или обойти прокси-сервер, вы можете проверить, воспроизводится ли проблема, и протестировать его использование после этого.

Задержки, как понаблизали в следе Netmon, эти дополнительные миллисекунды можно добавить, если их достаточно в любом сеансе.

![Показана общая задержка в Netmon, при этом заданный по умолчанию столбец "Time Delta" (Смещение по времени) добавлен в раздел "Frame Summary" (Сводка по фреймам).](../media/7ad17380-8527-4bc2-9b9b-6310cf19ba6b.PNG)

> [!NOTE]
> Ваш IP-адрес может быть другим, чем ip-адреса, показанные здесь, например, ваш ing может возвращать что-то большее, как 157.56.0.0/16 или аналогичный диапазон. Список диапазонов, используемых Office 365, Office 365 [URL-адресов и IP-адресов.](./urls-and-ip-address-ranges.md)

Не забудьте расширить все узлы (в верхней части есть кнопка для этого), если вы хотите найти, например, 132.245.

### <a name="proxy-authentication"></a>Проверка подлинности прокси

Это относится только к вам, если вы проходите через прокси-сервер. Если нет, можно пропустить эти действия. При правильной работе проверка подлинности прокси должна проходить в миллисекунах последовательно. Не следует видеть прерывную плохую производительность во время пиковых периодов использования (например).

Если проверка подлинности прокси-серверов будет подключена, каждый раз, когда вы Office 365 подключение к TCP для получения информации, вам необходимо пройти процесс проверки подлинности за кулисами. Например, при переходе с календаря на почту в Outlook Online вы пройдете проверку подлинности. И в SharePoint Online, если страница отображает носители или данные с нескольких сайтов или местоположений, вы пройдете проверку подлинности для каждого подключения TCP, необходимого для отрисовки данных.

В Outlook Online вы можете испытывать медленные нагрузки при переходе между календарем и почтовым ящиком или медленные загрузки страниц в SharePoint Online. Однако здесь не указаны другие симптомы.

Проверка подлинности прокси — это параметр на сервере прокси-сервера egress. Если из-за этого с Office 365 проблемы с производительностью, необходимо проконсультироваться с сетевой командой.

#### <a name="tools"></a>Инструменты

- Netmon
- Wireshark

#### <a name="what-to-look-for"></a>Что нужно искать

Проверка подлинности прокси происходит всякий раз, когда необходимо разворачивать новый сеанс TCP, как правило, для запроса файлов или информации с сервера или для подачи информации. Например, вы можете увидеть проверку подлинности прокси в запросах HTTP GET или HTTP POST. Если вы хотите увидеть кадры, в которых вы запрашиваете проверку подлинности в трассировке, добавьте столбец "NTLMSSP Summary" в Netmon и фильтруйте  `.property.NTLMSSPSummary` . Чтобы узнать, как долго проходит проверка подлинности, добавьте столбец "Дельта времени".

Добавление столбца в Netmon:

1. Щелкните правой кнопкой мыши столбец, например **Description**.
2. Щелкните **Выберите столбцы**.
3. Найдите _сводку NTLMSSP_ и _дельту времени_ в списке и нажмите **кнопку Добавить**.
4. Перемещение новых столбцов на место до или за столбцом _Описание,_ чтобы вы могли читать их бок о бок.
5. Нажмите кнопку **ОК**.

Даже если столбец не добавляется, фильтр Netmon будет работать. Но устранение неполадок будет намного проще, если вы увидите, на каком этапе проверки подлинности вы в настоящее время.

При поиске экземпляров проверки подлинности прокси-серверов обязательно изучите все кадры, на которых существует проблема NTLM или присутствует сообщение проверки подлинности. При необходимости щелкните правой кнопкой мыши определенный элемент трафика и выберите TCP "Поиск \> разговоров". Будьте в курсе значений дельты времени в этих беседах.

![Трассировка Netmon, показывающая проверку подлинности прокси, фильтруемая путем беседы.](../media/b640f176-0a52-4bbb-972e-60fb3d6aece2.PNG)

Четырех секундная задержка проверки подлинности прокси, как положено в Wireshark. Дельта **времени из** предыдущего отображаемого столбца кадра была выполнена с помощью правой щелкнув поле с таким же именем в деталях кадра и выбрав Add as Column.  <br/> ![В Wireshark столбец "Время из предыдущего отображаемого кадра" можно сделать правой кнопкой мыши поле с таким же именем в деталях кадра и выбрать Добавить в качестве столбца.](../media/f5b7bde4-8067-4ee0-bc7f-e9062ce1ba6f.PNG)

### <a name="dns-performance"></a>Производительность DNS

Разрешение имен работает наилучшим образом и быстрее всего, если оно происходит как можно ближе к стране клиента.

Если разрешение имен DNS происходит за границей, он может добавлять секунды к нагрузкам на страницу. В идеале разрешение имен происходит в менее 100 мс. Если нет, то следует дополнительно и расследование.

> [!TIP]
> Не знаете, как работает подключение клиентов в Office 365? Взгляните на справочный документ клиентской подключения [здесь](/previous-versions//dn741250(v=technet.10)).

#### <a name="tools"></a>Инструменты

- Netmon
- Wireshark
- PsPing

#### <a name="what-to-look-for"></a>Что нужно искать

Анализ производительности DNS обычно является другой задачей для сетевого трассировки. Тем не менее, psPing также помогает в праве в или вне, возможной причине.

Трафик DNS основан на запросах TCP и UDP, и ответы четко помечены ИД, который поможет соответствовать определенному запросу с его конкретным ответом. Вы увидите трафик DNS, когда, например, SharePoint Online использует сетевое имя или URL-адрес на веб-странице. Как правило, большая часть этого трафика, за исключением передачи Зон, проходит через UDP.

В Netmon и Wireshark самый простой фильтр, который позволит вам взглянуть на трафик DNS, это просто `dns` . Не забудьте использовать нижний корпус при указании фильтра. Не забудьте смыть кэш разрешения DNS перед началом воспроизведения проблемы на клиентский компьютер. Например, при медленной загрузке страницы SharePoint Online для домашней страницы необходимо закрыть все браузеры, открыть новый браузер, начать отслеживание, смыть кэш разрешения DNS и просмотреть веб-сайт SharePoint Online. После устранения всей страницы необходимо остановить и сохранить след.

![Стандартный фильтр для DNS в Netmon — DNS.](../media/1bebc118-ca13-45f3-803f-ab73e7af401d.png)

Вы хотите посмотреть смещение времени здесь. Возможно, будет полезно добавить столбец **"Дельта** времени" в Netmon, который можно сделать, завершив следующие действия:

1. Щелкните правой кнопкой мыши столбец, например **Description**.
2. Щелкните **Выберите столбцы**.
3. Найдите _дельту времени_ в списке и нажмите **кнопку Добавить**.
4. Перемещение нового столбца на место до или за столбцом _Описание,_ чтобы вы могли читать их бок о бок.
5. Нажмите кнопку **ОК**.

Если вы найдете интересующий запрос, рассмотрите возможность его изоляции, щелкнув его правой кнопкой мыши в панели сведений о кадре, выбрав **DNS Find Conversations** \> . Обратите внимание, что панель "Сетевые беседы" перескакинет прямо к определенному разговору в журнале трафика UDP.

![След Netmon от Outlook нагрузки в Интернете, фильтруемой DNS, и с помощью поиска бесед затем DNS сузить результаты.](../media/763cf20e-7b48-4a37-9449-c9978cfe118b.PNG)

В Wireshark можно сделать столбец для времени DNS. Возьмите ваш след (или откройте след) в Wireshark и `dns` фильтр, или, что более полезно,  `dns.time` . Щелкните любой запрос DNS и на панели с подробными сведениями  `Domain Name System (response)` разойдитесь. Вы увидите поле для времени (например, `[Time: 0.001111100 seconds]` . Щелкните правой кнопкой мыши в этот раз и выберите **Применить в качестве столбца**. Это даст вам **столбец Время** для более быстрой сортировки трассировки. Щелкните новый столбец, чтобы отсортировать, убывая значения, чтобы узнать, какой вызов DNS занял больше всего времени для решения.

[Данные по SharePoint Online, отфильтрованные в Wireshark с помощью dns.time (нижний регистр), при этом значения времени из области сведений собраны в столбец и отсортированы по возрастанию.](../media/1439dcc2-12ff-4ee2-9ef3-1484cf79c384.PNG)

Если вы хотите больше исследовать время разрешения DNS, попробуйте psPing в отношении порта DNS, используемого TCP (например,  `psping <IP address of DNS server>:53` ) . Вы все еще видите проблему производительности? Если это так, то проблема, скорее всего, будет более широкой сетевой проблемой, чем проблема определенного приложения DNS, которое вы нажимаем для разрешения. Кроме того, стоит еще раз отметить, что в outlook.office365.com 1000 000 000 000 000 000 000 000 000 000 000 000 000 000 000 000 Outlook Online (например, outlook-namnorthwest.office365.com).

Если проблема выглядит как конкретная DNS, может потребоваться связаться с ИТ-отделом, чтобы узнать о конфигурациях DNS и DNS Forwarders для дальнейшего изучения этой проблемы.

### <a name="proxy-scalability"></a>Прокси-масштабируемость

Службы, такие как Outlook Online, Office 365 предоставлять клиентам несколько долгосрочных подключений. Поэтому каждый пользователь может использовать больше подключений, для которых требуется более длительный срок службы.

#### <a name="tools"></a>Инструменты

математика;

#### <a name="what-to-look-for"></a>Что нужно искать

Для этого не существует средства сетевого отслеживания или устранения неполадок. Вместо этого он основан на расчетах пропускной способности с учетом ограничений и других переменных.

### <a name="tcp-max-segment-size"></a>TCP Max Segment Size

Найдено в syn - SYN/ACK.  Убедитесь, что пакеты TCP настроены для хранения максимально возможного объема данных.

Цель состоит в том, чтобы увидеть MSS в 1460 bytes для передачи данных. Если вы находитесь за прокси-сервером или используете NAT, не забудьте выполнить этот тест от клиента до прокси/egress/NAT, а также от прокси/egress/NAT до Office 365 для наилучших результатов! Это разные сеансы TCP.

#### <a name="tools"></a>Инструменты

Netmon

#### <a name="what-to-look-for"></a>Что нужно искать

TCP Max Segment Size (MSS) — это еще один параметр трех способов рукопожатия в сетевом следе, что означает, что вы найдете данные, необходимые в пакете SYN - SYN/ACK. MSS на самом деле довольно прост в том, чтобы увидеть.

Откройте любой сетевой след производительности и найдите интересующих вас подключений или это демонстрирует проблему производительности.

> [!NOTE]
> Если вы ищете след и хотите найти трафик, соответствующий вашему разговору, фильтруйте IP-адрес клиента или IP-адрес прокси-сервера или точки отступа или оба. При непосредственном обращении необходимо перейти к URL-адресу, который вы тестируете для IP-Office 365 в следе, и отфильтровать его.

Глядя на след сегодной руки? Попробуйте с помощью фильтров ориентироваться. В Netmon запустите поиск на основе URL-адреса, например, обратите внимание `Containsbin(framedata, ascii, "sphybridExample")` на номер кадра.

В Wireshark используйте что-то вроде  `frame contains "sphybridExample"` . Если вы заметили, что вы нашли удаленный трафик Winsock (RWS) (он может отображаться как [PSH, ACK] в Wireshark), помните, что подключения RWS можно увидеть незадолго до соответствующего СИН - SYN/ACKs, как говорилось ранее.

На этом этапе вы можете записать номер кадра, отбросить фильтр, щелкнуть все трафик в окне Сетевые беседы в Netmon, чтобы посмотреть ближайший СИН. 

Важно отметить, что если на момент трассировки вы не получили ни одной из сведений об IP-адресе, поиск URL-адреса в следе (часть, например), позволит отфильтровать `sphybridExample-my.sharepoint.com` IP-адреса.

Найдите подключение в следе, который вам интересен. Это можно сделать путем сканирования трассировки, фильтрации по IP-адресам или выбора определенных ID-адресов разговоров с помощью окна Сетевые беседы в Netmon. После того, как вы нашли пакет SYN, раздвинйте TCP (в Netmon) или Протокол управления передачей (в Wireshark) в панели Сведения о кадре. Расширйте параметры TCP и MaxSegmentSize. Найдите соответствующий кадр SYN-ACK и расширйте параметры TCP и MaxSegmentSize. Меньшее из этих двух значений будет ваш максимальный размер сегмента. На этом рисунке я использую встроенный столбец в Netmon под названием Устранение неполадок TCP.

![Трассировка сети фильтруется в Netmon с помощью встроенных столбцов.](../media/e073df13-71f8-497a-83b4-bb9f70bd9833.PNG)

Встроенный столбец находится в верхней части панели **Frame Details.** (Чтобы вернуться к обычному представлению, щелкните **Столбцы** снова и выберите **часовой пояс**.)

![Где найти раскрывающийся список "Columns" (Столбцы) в верхней части сводных данных о фрейме, чтобы выбрать пункт "TCP Troubleshoot" (Устранение неполадок TCP).](../media/64fd4baa-a872-4f07-b959-752d7d37fd62.PNG)

Вот фильтрованный след в Wireshark. Существует фильтр, определенный значению MSS ( `tcp.options.mss` ). Кадры рукопожатия SYN, SYN/ACK, ACK связаны в нижней части wireshark, эквивалентной Данным о кадре (так кадр 47 ACK, ссылки на 46 SYN/ACK, ссылки на 43 SYN), чтобы сделать этот вид работы проще.

![Трассировка, фильтруемая в Wireshark по tcp.options.mss для max Segment Size (MSS).](../media/51e278db-801b-48bc-9b68-87cf92f03fd6.PNG)

Если вам нужно проверить **селективное подтверждение** (следующая тема в этой матрице), не закрывай свой след!

### <a name="selective-acknowledgment"></a>Выборочное подтверждение

Найдено в syn - SYN/ACK. Должна быть отчитаться как разрешенная как в SYN, так и в SYN/ACK. Селективное подтверждение (SACK) позволяет более плавную ретрансмиссию данных при пропаже пакета или пакетов. Устройства могут отключить эту функцию, что может привести к проблемам с производительностью.

Если вы находитесь за прокси-сервером или используете NAT, не забудьте выполнить этот тест от клиента до прокси/egress/NAT, а также от прокси/egress/NAT до Office 365 для наилучших результатов! Это разные сеансы TCP.

#### <a name="tools"></a>Инструменты

Netmon

#### <a name="what-to-look-for"></a>Что нужно искать

Селективное подтверждение (SACK) — это еще один параметр в рукопожатии SYN-SYN/ACK. Вы можете фильтровать трассировку для SYN - SYN/ACK многими способами.

Найдите подключение в следе, который вам интересно увидеть, сканируя след, фильтруя IP-адреса или щелкнув ID-адрес беседы с помощью окна Сетевые беседы в Netmon. После того как вы нашли пакет SYN, развиньте TCP в Netmon или Протокол управления передачей в Wireshark в разделе Сведения о кадре. Расширйте параметры TCP и затем SACK. Найдите соответствующий кадр SYN-ACK и расширйте параметры TCP и его поле SACK. Убедитесь, что определенный SACK разрешен как в SYN, так и в SYN/ACK. Вот значения SACK, как в Netmon и Wireshark.

![Селективное подтверждение (SACK) в Netmon в результате tcp.flags.syn == 1.](../media/216f556f-5031-4ed2-b066-a0d9b3251fa2.PNG)

![SACK в Wireshark с фильтром tcp.flags.syn == 1.](../media/0a6e26e5-43dc-403b-adc9-3349a55f4e4b.PNG)

### <a name="dns-geolocation"></a>Геолокация DNS

Если в мире Office 365 устранять эффекты вызова DNS, скорость подключения.

В Outlook Online, после завершения первого DNS-анализа, расположение этого DNS будет использоваться для подключения к ближайшему центру обработки данных. Вы будете подключены к серверу Outlook cas, который будет использовать магистрали сети для подключения к центру обработки данных (DC), где хранятся ваши данные. Это быстрее.

При доступе SharePoint Online пользователь, путешествующий за границей, будет направлен в активный центр обработки данных — это центр DC, расположение которого основано на домашней базе клиента SPO (так, dC в США, если пользователь, если он основан на США).

Lync Online имеет активные узлы в более чем одном dC одновременно. Когда запросы отправляются для онлайн-экземпляров Lync, DNS Корпорации Майкрософт определяет, откуда в мире поступил запрос, и возвращает IP-адреса из ближайшего регионального DC, где активен Lync online.

> [!TIP]
> Необходимо узнать больше о том, как клиенты подключаются к Office 365? Взгляните на справочную [статью "Подключение](/previous-versions//dn741250(v=technet.10)) клиентов" (и ее полезную графику).

#### <a name="tools"></a>Инструменты

- Ping
- PsPing

#### <a name="what-to-look-for"></a>Что нужно искать

Запросы на разрешение имен с DNS-серверов клиента на DNS-серверы Майкрософт в большинстве случаев должны привести к возвращению Microsoft DNS IP-адреса регионального центра обработки данных (dC). Что это значит для вас? Если ваша штаб-квартира находится в Бангалоре, Индия, но вы путешествуете по США, когда браузер запрашивает Outlook Online, DNS-серверы Майкрософт должны передать IP-адреса центрам обработки данных в США — региональному центру обработки данных. Если почта требуется из Outlook, эти данные будут пересекать быструю магистралную сеть Майкрософт между центрами обработки данных.

DNS работает быстрее, когда разрешение имен делается максимально близко к расположению пользователя. Если вы в Европе, вы хотите перейти в microsoft DNS в Европе и (в идеале) иметь дело с центром обработки данных в Европе. Производительность от клиента в Европе до DNS и центра обработки данных в Америке будет медленнее.

Запустите средство Ping outlook.office365.com, чтобы определить, куда в мире будет маршрутить запрос DNS. Если вы находитесь в Европе, вы должны увидеть ответ от чего-то подобного outlook-emeawest.office365.com. В Северной и Южной Америке ожидайте чего-то подобного outlook-namnorthwest.office365.com.

Откройте командную подсказку на клиентном компьютере (с помощью командного или Windows типа \> \> \> клавиши). Введите outlook.office365.com и нажмите кнопку ENTER. Помните, чтобы указать -4, если вы хотите указать для ping через IPv4. Возможно, вам не удастся получить ответ из пакетов ICMP, но вы должны увидеть имя DNS, на который был направит запрос. Если вы хотите увидеть номера задержки для этого подключения, попробуйте psPing на IP-адрес сервера, возвращаемого путем пинга.

![Результаты выполнения команды ping для проверки связи с outlook.office365.com, показывающие разрешение в outlook-namnorthwest.](../media/06c944d5-6159-43ec-aa31-757770695e8b.PNG)

![PsPing to the IP address returned by the ping to outlook.office365.com showing average 28 millisecond latency.](../media/f2b25a75-1a87-4479-b8a7-fa4375683507.PNG)

### <a name="office-365-application-troubleshooting"></a>Office 365 Устранение неполадок приложения

#### <a name="tools"></a>Инструменты

- Netmon
- HTTPWatch
- Консоль F12 в браузере

В этой сетевой статье мы не используем средства, используемые в устранении неполадок, определенных для приложений. Но вы найдете ресурсы, которые  *можно использовать* [на этой странице](https://support.office.com/article/Network-planning-and-performance-tuning-for-Office-365-e5f1228c-da3c-4654-bf16-d163daee8848).

## <a name="related-topics"></a>Статьи по теме

[Управление конечными точками Office 365](https://support.office.com/article/99cab9d4-ef59-4207-9f2b-3728eb46bf9a)

[Вопросы и ответы о конечных точках Office 365](https://support.office.com/article/d4088321-1c89-4b96-9c99-54c75cae2e6d)