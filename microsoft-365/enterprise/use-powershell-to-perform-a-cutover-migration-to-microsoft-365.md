---
title: Прямая миграция в Microsoft 365 с помощью PowerShell
ms.author: kvice
author: kelleyvice-msft
manager: laurawi
audience: Admin
ms.topic: article
ms.service: o365-administration
localization_priority: Normal
search.appverid:
- MET150
ms.collection: Ent_O365
f1.keywords:
- NOCSH
ms.custom: seo-marvel-apr2020
ms.assetid: b468cb4b-a35c-43d3-85bf-65446998af40
description: Узнайте, как использовать PowerShell для перемещения содержимого из системы исходных сообщений электронной почты одновременно, выполняя миграцию на Microsoft 365.
ms.openlocfilehash: 6e59ac4d590208e0faed22e94cabe05601b17f18
ms.sourcegitcommit: 53acc851abf68e2272e75df0856c0e16b0c7e48d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/02/2021
ms.locfileid: "51581062"
---
# <a name="use-powershell-to-perform-a-cutover-migration-to-microsoft-365"></a>Прямая миграция в Microsoft 365 с помощью PowerShell

*Эта статья относится к Microsoft 365 корпоративный и Office 365 корпоративный.*

Вы можете перенести содержимое почтовых ящиков пользователей из системы исходных сообщений электронной почты в систему Microsoft 365 одновременно с помощью переноса переключе. В этой статье описаны задачи, которые выполняются при прямой миграции электронной почты с помощью Exchange Online PowerShell.

Просмотрев тему [,](/Exchange/mailbox-migration/what-to-know-about-a-cutover-migration)Что нужно знать о переносе электронной почты в Microsoft 365, вы можете получить обзор процесса миграции. Ознакомившись с содержимым этой статьи, начните переносить почтовые ящики из одной почтовой системы в другую, руководствуясь приведенными в этой статье сведениями.

> [!NOTE]
> Вы также можете использовать центр администрирования Exchange для выполнения переноса перереза. См. [врезки переноса](/Exchange/mailbox-migration/cutover-migration-to-office-365)электронной почты на Microsoft 365.

## <a name="what-do-you-need-to-know-before-you-begin"></a>Что нужно знать перед началом работы?

Предполагаемое время для выполнения этой задачи: 2-5 минут для создания пакета миграции. После запуска пакета миграции продолжительность миграции будет зависеть от количества почтовых ящиков в пакете, размера каждого почтового ящика и доступной пропускной способности сети. Сведения о других факторах, влияющих на время переноса почтовых ящиков в Microsoft 365, см. в [сообщении Migration Performance.](/Exchange/mailbox-migration/office-365-migration-best-practices)

Для выполнения этой процедуры (процедур) необходимы соответствующие разрешения. Сведения о необходимых разрешениях см. в пункте "Миграция" статьи [Разрешения получателей](/exchange/recipients-permissions-exchange-2013-help) в соответствующей таблице.

Чтобы использовать командлеты Exchange Online PowerShell, вам необходимо войти в систему и импортировать командлеты в локальный сеанс Windows PowerShell. Инструкции см в статье [Подключение к Exchange Online с помощью удаленной оболочки PowerShell](/powershell/exchange/connect-to-exchange-online-powershell).

Полный список команд миграции см. в статье [Командлеты перемещения и миграции](/powershell/exchange/).

## <a name="migration-steps"></a>Шаги миграции

### <a name="step-1-prepare-for-a-cutover-migration"></a>Шаг 1. Подготовка к прямой миграции
<a name="BK_Step1"> </a>

- **Добавление локальной Exchange организации в качестве принятого домена Microsoft 365 организации.** Служба миграции использует SMTP-адрес локального почтового ящика для создания Microsoft Online Services и адреса электронной почты для новых Microsoft 365 почтовых ящиков. Миграция не удалась, Exchange домен не является принятым доменом или основным доменом Microsoft 365 организации. Дополнительные сведения см. в [дополнительных сведениях: Проверка домена.](../admin/setup/add-domain.md)

- **Настройте мобильный Outlook на локальном сервере Exchange.** Служба миграции электронной почты использует протокол RPC через HTTP, также называемый мобильный Outlook, для подключения к локальному серверу Exchange Server. Дополнительные сведения о настройке службы мобильный Outlook для Exchange 2010, Exchange 2007 и Exchange 2003 см. в следующих статьях.

  - [Exchange 2010. Включение мобильного Outlook](/previous-versions/office/exchange-server-2010/bb123542(v=exchg.141))

  - [Exchange 2007. Инструкции по включению мобильного Outlook](/previous-versions/office/exchange-server-2007/bb123889(v=exchg.80))

  - [Exchange 2003. Сценарии развертывания для RPC через HTTP](/previous-versions/tn-archive/bb124876(v=exchg.65))

  - [Настройка мобильного Outlook в Exchange 2003](/previous-versions/office/exchange-server-2007/aa996922(v=exchg.80))

    > [!IMPORTANT]
    > Конфигурацию мобильного Outlook необходимо настроить с использованием сертификата, выпущенного доверенным центром сертификации (ЦС). Настройка с использованием самозаверяющего сертификата невозможна. Дополнительные сведения см. в статье [Инструкции по настройке протокола SSL для мобильного Outlook](/previous-versions/office/exchange-server-2007/aa995982(v=exchg.80)).

- **Проверьте возможность подключения к организации Exchange с помощью мобильного Outlook.** Проверьте настройки подключения с использованием следующих способов.

  - Подключитесь к локальному почтовому ящику Exchange с помощью Microsoft Outlook из-за пределов корпоративной сети.

  - Проверьте настройки подключения с помощью [анализатора удаленного подключения Exchange](https://www.testexchangeconnectivity.com/) корпорации Майкрософт. Используйте средства мобильного Outlook (RPC через HTTP) или проверки автообнаружения Outlook.

  - В Exchange Online PowerShell выполните следующие команды.

  ```powershell
  $Credentials = Get-Credential
  ```

  ```powershell
  Test-MigrationServerAvailability -ExchangeOutlookAnywhere -Autodiscover -EmailAddress <email address for on-premises administrator> -Credentials $credentials
  ```

- **Назначьте для локальной учетной записи необходимые разрешения на доступ к почтовым ящикам в организации Exchange.** Учетная запись локального пользователя, используемая для подключения к локальной Exchange организации (также называемой администратором миграции), должна иметь необходимые разрешения для доступа к почтовым ящикам, которые необходимо перенести в Microsoft 365. Эта учетная запись пользователя необходима для создания конечной точки миграции в вашей локальной организации.

    В следующем списке перечислены права администратора, необходимые для переноса почтовых ящиков с помощью прямой миграции. У вас есть три варианта.

  - Администратор миграции должен быть членом группы **Администраторы домена** в службе каталогов Active Directory локальной организации.

    Или

  - Администратор миграции должен иметь разрешение **FullAccess** для всех локальных почтовых ящиков.

    Или

  - Администратор миграции должен иметь разрешение **Получить как** в локальной базе данных, где хранятся почтовые ящики пользователей.

- **Отключите единую систему обмена сообщениями.** Если для локальных почтовых ящиков включена поддержка единой системы обмена сообщениями, ее необходимо отключить, прежде чем переносить почтовые ящики. После завершения миграции поддержку единой системы обмена сообщениями для этих ящиков можно снова включить.

- **Группы безопасности и делегаты** Служба миграции электронной почты не может определить, являются ли локально группы Active Directory группами безопасности или нет, поэтому она не может представить какие-либо перенесенные группы в качестве групп безопасности в Microsoft 365. Если в клиенте Microsoft 365 группы безопасности, перед началом переноса переключеть необходимо сначала в клиенте Microsoft 365 группу безопасности с включенной почтой. Кроме того, при этом способе перемещаются только почтовые ящики, почтовые пользователи, контакты и группы с поддержкой электронной почты. Если любой другой объект Active Directory, например пользователь, не перенесенный в Microsoft 365, назначен в качестве диспетчера или делегирования переносимого объекта, его необходимо удалить из объекта перед переносом.

### <a name="step-2-create-a-migration-endpoint"></a>Шаг 2. Создание конечной точки миграции
<a name="BK_Step2"> </a>

Чтобы успешно перенести электронную почту, Microsoft 365 необходимо подключиться и связаться с системой исходных сообщений электронной почты. Для этого Microsoft 365 конечную точку миграции. Чтобы создать конечную точку миграции мобильного Outlook для прямой миграции, сначала [подключитесь к Exchange Online](/powershell/exchange/connect-to-exchange-online-powershell).

Полный список команд миграции см. в статье [Командлеты перемещения и миграции](/powershell/exchange/).

В Exchange Online PowerShell выполните следующие команды.

```powershell
$Credentials = Get-Credential
```

В примере используется командлет [Test-MigrationServerAvailability](/powershell/module/exchange/test-migrationserveravailability), который получает и проверяет параметры подключения к локальному серверу Exchange, а затем использует эти параметры для создания конечной точки миграции CutoverEndpoint.

```powershell
$TSMA = Test-MigrationServerAvailability -ExchangeOutlookAnywhere -Autodiscover -EmailAddress administrator@contoso.com -Credentials $credentials
```

```powershell
New-MigrationEndpoint -ExchangeOutlookAnywhere -Name CutoverEndpoint -ConnectionSettings $TSMA.ConnectionSettings
```

> [!NOTE]
> С помощью командлета **New-MigrationEndpoint** и параметра **-TargetDatabase** можно указать базу данных, которая будет использоваться службой. В противном случае база данных назначается случайным образом на сайте Службы федерации Active Directory (AD FS) 2.0, на котором расположен почтовый ящик управления.

#### <a name="verify-it-worked"></a>Проверка работы

В Exchange Online PowerShell выполните следующую команду, чтобы отобразить сведения о конечной точке миграции CutoverEndpoint.

```powershell
Get-MigrationEndpoint CutoverEndpoint | Format-List EndpointType,ExchangeServer,UseAutoDiscover,Max*

```

### <a name="step-3-create-the-cutover-migration-batch"></a>Шаг 3. Создание пакета прямой миграции
<a name="BK_Step3"> </a>

Чтобы создать пакет для прямой миграции, выполните командлет **New-MigrationBatch** в Exchange Online PowerShell. Можно создать пакет миграции и запустить его обработку автоматически, включив параметр _AutoStart_. Кроме того, вы можете создать пакет миграции, а затем вручную запустить его с помощью командлета **Start-MigrationBatch**. В этом примере создается пакет миграции CutoverBatch и используется конечная точка миграции, созданная на предыдущем шаге.

```powershell
New-MigrationBatch -Name CutoverBatch -SourceEndpoint CutoverEndpoint -AutoStart
```

В этом примере также создается пакет миграции CutoverBatch и используется конечная точка миграции, созданная на предыдущем шаге. Так как параметр  _AutoStart_ не включен, пакет миграции необходимо запустить вручную на панели мониторинга миграции или с помощью командлета **Start-MigrationBatch**. Как было сказано выше, в одно и то же время может существовать только один пакет прямой миграции.

```powershell
New-MigrationBatch -Name CutoverBatch -SourceEndpoint CutoverEndpoint
```

#### <a name="verify-it-worked"></a>Проверка работы

Чтобы убедиться, что вы успешно создали пакет прямой миграции, выполните следующую команду в Exchange Online PowerShell для отображения сведений о новом пакете миграции.

```powershell
Get-MigrationBatch | Format-List
```

### <a name="step-4-start-the-cutover-migration-batch"></a>Шаг 4. Запуск пакета прямой миграции
<a name="BK_Step4"> </a>

Чтобы запустить пакет миграции в Exchange Online PowerShell, выполните следующую команду. Будет создан пакет миграции CutoverBatch.

```powershell
Start-MigrationBatch -Identity CutoverBatch
```

#### <a name="verify-it-worked"></a>Проверка работы

Если пакет миграции успешно запущен, состояние пакета на панели мониторинга миграции изменится на "Синхронизация". Чтобы убедиться, вы успешно запустили пакет миграции с помощью Exchange Online PowerShell, выполните следующую команду.

```powershell
Get-MigrationBatch -Identity CutoverBatch |  Format-List Status
```

### <a name="step-5-route-your-email-to-microsoft-365"></a>Шаг 5. Маршрут электронной почты в Microsoft 365
<a name="BK_Step5"> </a>

Почтовые системы используют запись DNS, которая называется записью MX, чтобы определять, куда нужно доставить электронную почту. В процессе миграции электронной почты запись MX указывала на вашу исходную систему электронной почты. Теперь, когда миграция электронной почты Microsoft 365 завершена, пришло время указать запись MX в Microsoft 365. Это помогает убедиться, что электронная почта доставляется в Microsoft 365 почтовые ящики. Перемещая запись MX, вы также сможете отключить старую систему электронной почты, когда будете готовы сделать это.

Для многих поставщиков DNS предоставляются отдельные инструкции по изменению записей MX. Если вашего поставщика DNS нет в списке или вы хотите в целом понять, как выполнять этот процесс, также существуют [общие инструкции по настройке записей MX](https://support.office.microsoft.com/article/7b7b075d-79f9-4e37-8a9e-fb60c1d95166#bkmk_add_mx).

Системам электронной почты клиентов и партнеров может потребоваться до 72 часов, чтобы распознать измененную запись MX. Подождите по крайней мере 72 часа, прежде чем перейти к следующей задаче: [Шаг 6. Удаление пакета прямой миграции](use-powershell-to-perform-a-cutover-migration-to-microsoft-365.md#Bk_step6).

### <a name="step-6-delete-the-cutover-migration-batch"></a>Шаг 6. Удаление пакета прямой миграции
<a name="Bk_step6"> </a>

После изменения записи MX и проверки того, что вся электронная почта передается в почтовые ящики Microsoft 365, уведомите пользователей о том, что их почта будет Microsoft 365. Затем можно удалить пакет прямой миграции. Убедитесь в следующем, прежде чем удалить пакет миграции.

- Все пользователи используют Microsoft 365 почтовые ящики. После удаления пакета почта, отправленная в почтовые ящики в локальном Exchange Server не копируется в соответствующие Microsoft 365 почтовые ящики.

- Microsoft 365 почтовые ящики были синхронизированы по крайней мере один раз после начала непосредственной передачи почты. Чтобы сделать это, убедитесь, что значение в поле Последнее синхронизированное время для пакета миграции является более последним, чем когда почта начала маршрутизироваться непосредственно в Microsoft 365 почтовые ящики.

Чтобы удалить пакет миграции CutoverBatch в Exchange Online PowerShell, выполните следующую команду.

```powershell
Remove-MigrationBatch -Identity CutoverBatch
```

### <a name="section-7-assign-user-licenses"></a>Шаг 7. Назначение пользователям лицензий
<a name="BK_Step7"> </a>

 **Активация Microsoft 365 учетных записей пользователей для перенесенных учетных записей путем назначения лицензий.** Если не назначить лицензию, почтовый ящик отключается после окончания льготного периода (30 дней). Чтобы назначить лицензию в центре администрирования Microsoft 365, см. в руб. Назначение или [неназначимые лицензии.](../admin/manage/assign-licenses-to-users.md)

### <a name="step-8-complete-post-migration-tasks"></a>Шаг 8. Необходимые действия после миграции
<a name="BK_Step8"> </a>

- **Создайте DNS-запись автообнаружения, чтобы пользователи смогли с легкостью получить доступ к своим почтовым ящикам.** После переноса всех почтовых ящиков на Microsoft 365 можно настроить запись DNS автообнаружаемых данных для организации Microsoft 365, чтобы пользователи могли легко подключаться к своим новым Microsoft 365 почтовым ящикам с Outlook и мобильными клиентами. Эта новая запись DNS с автоматическим открытием должна использовать то же пространство имен, которое используется для Microsoft 365 организации. Например, если пространство имен облачной службы имеет значение cloud.contoso.com, необходимо создать запись DNS автообнаружения autodiscover.cloud.contoso.com.

    Если вы Exchange Server, вы также должны убедиться, что запись CNAME для автоматического разобновки DNS должна указать на Microsoft 365 во внутренней и внешней DNS после миграции, чтобы клиент Outlook подключается к правильному почтовому ящику.

    > [!NOTE]
    >  В Exchange 2007, Exchange 2010 и Exchange 2013 для параметра  `Set-ClientAccessServer AutodiscoverInternalConnectionURI` необходимо задать значение `Null`.

    Microsoft 365 записи CNAME для реализации службы автооткрытия для Outlook и мобильных клиентов. Запись CNAME автообнаружения должна содержать следующие сведения:

  - **Псевдоним:** autodiscover

  - **Целевой объект:** autodiscover.outlook.com

    Дополнительные сведения см. в [добавлении записей DNS для подключения домена.](../admin/get-help-with-domains/create-dns-records-at-any-dns-hosting-provider.md)

- **Спишите локальные сервера Exchange.** После проверки того, что вся электронная почта передается непосредственно в почтовые ящики Microsoft 365, и вам больше не нужно поддерживать организацию электронной почты на локальной основе или не планировать реализацию решения единого входного (SSO), вы можете удалить Exchange с серверов и удалить локальное Exchange организацию.

    Дополнительные сведения см. в следующих статьях:

  - [Изменение или удаление Exchange 2010](/previous-versions/office/exchange-server-2010/ee332361(v=exchg.141))

  - [Удаление организации Exchange 2007](/previous-versions/office/exchange-server-2007/aa998313(v=exchg.80))

  - [Удаление сервера Exchange Server 2003](/previous-versions/tn-archive/bb125110(v=exchg.65))