---
title: Подготовка к синхронизации каталогов с Microsoft 365
ms.author: josephd
author: JoeDavies-MSFT
manager: laurawi
ms.date: 09/30/2020
audience: Admin
ms.topic: article
ms.service: o365-administration
localization_priority: Normal
f1.keywords:
- CSH
ms.custom:
- Adm_O365
- O365p_AddUsersWithDirSync
- O365M_AddUsersWithDirSync
- O365E_HRCSetupAADConnectAboutLM617031
- O365E_AddUsersWithDirSync
ms.collection:
- Ent_O365
- M365-identity-device-management
search.appverid:
- MET150
- MOP150
- MOE150
- MBS150
ms.assetid: 01920974-9e6f-4331-a370-13aea4e82b3e
description: Описывает подготовку к подготовке пользователей к Microsoft 365 с помощью синхронизации каталогов и долгосрочных преимуществ использования этого метода.
ms.openlocfilehash: 1fe99247a5c50c7bb8fc7eb1347ce6a4cd6aad94
ms.sourcegitcommit: 27b2b2e5c41934b918cac2c171556c45e36661bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "50927328"
---
# <a name="prepare-for-directory-synchronization-to-microsoft-365"></a>Подготовка к синхронизации каталогов с Microsoft 365

*Эта статья относится к Microsoft 365 корпоративный и Office 365 корпоративный.*

Преимущества гибридной синхронизации удостоверений и каталогов в организации:

- Сокращение административных программ в организации
- Необязательный включение сценария с одним входом
- Автоматизация изменений учетных записей в Microsoft 365

Дополнительные сведения о преимуществах использования синхронизации каталогов см. в гибридной идентификации с [Azure Active Directory (Azure AD)](/azure/active-directory/hybrid/whatis-hybrid-identity) и гибридной идентификацией [для Microsoft 365.](plan-for-directory-synchronization.md)

Однако синхронизация каталогов требует планирования и подготовки, чтобы убедиться, что ваши службы домена Active Directory (AD DS) синхронизируются с клиентом Azure AD подписки Microsoft 365 с минимальным количеством ошибок.

Следуйте этим шагам, чтобы получить наилучшие результаты.

## <a name="1-directory-cleanup-tasks"></a>1. Задачи очистки каталогов

Прежде чем синхронизировать AD DS с клиентом Azure AD, необходимо очистить AD DS.

> [!IMPORTANT]
> Если вы не выполняете очистку AD DS перед синхронизацией, это может привести к значительному негативному влиянию на процесс развертывания. Может потребоваться несколько дней или даже недель, чтобы пройти цикл синхронизации каталогов, выявления ошибок и повторной синхронизации.

В AD DS выполните следующие задачи очистки для каждой учетной записи пользователя, которая будет назначена лицензии Microsoft 365:

1. Убедитесь, что допустимый и уникальный адрес электронной почты в **атрибуте proxyAddresses.**

2. Удалите все дублирующиеся значения в **атрибуте proxyAddresses.**

3. По возможности убедитесь в допустимом и уникальном значении **атрибута userPrincipalName** в объекте **пользователя.** Для наилучшего синхронизации убедитесь, что upN AD DS соответствует upN Azure AD. Если у пользователя нет значения **атрибута userPrincipalName,** объект пользователя должен содержать допустимое и уникальное значение для **атрибута sAMAccountName.**  Удалите все дублирующиеся значения в **атрибуте userPrincipalName.**

4. Для оптимального использования глобального списка адресов (GAL) убедитесь, что сведения в следующих атрибутах учетной записи пользователя AD DS верны:

   - givenName
   - surname
   - displayName
   - должность;
   - Отдел
   - Кабинет
   - рабочий телефон;
   - мобильный телефон;
   - номер факса;
   - адрес;
   - Город
   - регион или область;
   - почтовый индекс;
   - страна или регион.

## <a name="2-directory-object-and-attribute-preparation"></a>2. Подготовка объекта и атрибута Directory

Успешная синхронизация каталогов между AD DS и Microsoft 365 требует надлежащей подготовки атрибутов AD DS. Например, необходимо убедиться, что определенные символы не используются в определенных атрибутах, синхронизированных с средой Microsoft 365. Неожиданные символы не приводят к сбойу синхронизации каталогов, но могут возвращать предупреждение. Недействительные символы приводят к сбойу синхронизации каталогов.

Синхронизация каталогов также не удалась, если некоторые пользователи AD DS имеют один или несколько атрибутов дубликатов. Каждый пользователь должен иметь уникальные атрибуты.

Атрибуты, которые необходимо подготовить, перечислены здесь:

- **displayName**

  - Если атрибут существует в объекте пользователя, он будет синхронизирован с Microsoft 365.
  - Если этот атрибут существует в объекте пользователя, для него должно быть значение. То есть атрибут не должен быть пустым.
  - Максимальное число символов: 256

- **givenName**

  - Если атрибут существует в объекте пользователя, он будет синхронизирован с Microsoft 365, но Microsoft 365 не требует и не использует его.
  - Максимальное число символов: 64

- **mail**

  - Значение атрибута должно быть уникальным в каталоге.

    > [!NOTE]
    > Если имеются дублирующиеся значения, первый пользователь со значением синхронизируется. Последующие пользователи не будут отображаться в Microsoft 365. Необходимо изменить либо значение в Microsoft 365, либо изменить оба значения в AD DS, чтобы оба пользователя появились в Microsoft 365.

- **mailNickname** (псевдоним Exchange)

  - Значение атрибута не может начинаться с периода (.).
  - Значение атрибута должно быть уникальным в каталоге.

    > [!NOTE]
    > Подчеркивает ("_") в синхронизированном имени указывает, что исходное значение этого атрибута содержит недопустимые символы. Дополнительные сведения об этом атрибуте см. в [атрибуте Exchange alias.](/powershell/module/exchange/set-mailbox)
    >

- **proxyAddresses**

  - Атрибут с несколькими значениями
  - Максимальное количество символов на значение: 256
  - Значение атрибута не должно содержать пробел.
  - Значение атрибута должно быть уникальным в каталоге.
  - Недействительные символы: \< \> ( ) ; , [ ] "

    Обратите внимание, что недействительные символы применяются к символам, следующим типам delimiter и ":", таким образом, чтобы SMTP:User@contso.com разрешено, но SMTP:user:M@contoso.com нет.

    > [!IMPORTANT]
    > Все адреса Протокола транспорта простой почты (SMTP) должны соответствовать стандартам обмена сообщениями электронной почты. Удалите дублирующие или нежелательные адреса, если они существуют.

- **sAMAccountName**

  - Максимальное число символов: 20
  - Значение атрибута должно быть уникальным в каталоге.
  - Недействительные символы: [ \ " | , / : \< \> = = ; \* ']
  - Если пользователь имеет недействительный **атрибут sAMAccountName,** но имеет допустимый атрибут **userPrincipalName,** учетная запись пользователя создается в Microsoft 365.
  - Если **и sAMAccountName,** и **userPrincipalName** являются недействительными, необходимо обновить атрибут AD DS **userPrincipalName.**

- **sn** (фамилия)

  - Если атрибут существует в объекте пользователя, он будет синхронизирован с Microsoft 365, но Microsoft 365 не требует и не использует его.

- **targetAddress**

    Необходимо, чтобы атрибут **targetAddress** (например, SMTP:tom@contoso.com), который был заполнен для пользователя, должен отображаться в GAL Microsoft 365. В сценариях миграции сторонних сообщений для этого потребуется расширение схемы Microsoft 365 для AD DS. Расширение схемы Microsoft 365 также добавит другие полезные атрибуты для управления объектами Microsoft 365, которые заполняются с помощью средства синхронизации каталогов из AD DS. Например, будет добавлен **атрибут msExchHideFromAddressLists** для управления скрытыми почтовыми ящиками или группами рассылки.

  - Максимальное число символов: 256
  - Значение атрибута не должно содержать пробел.
  - Значение атрибута должно быть уникальным в каталоге.
  - Недействительные символы: \ \< \> ( ) ; , [ ]
  - Все адреса Протокола транспорта простой почты (SMTP) должны соответствовать стандартам обмена сообщениями электронной почты.

- **userPrincipalName**

  - Атрибут **userPrincipalName** должен быть в формате вход в Интернет, где за именем пользователя следует знак (@) и доменное имя: например, user@contoso.com. Все адреса Протокола транспорта простой почты (SMTP) должны соответствовать стандартам обмена сообщениями электронной почты.
  - Максимальное количество символов для **атрибута userPrincipalName** — 113. До и после знака (@) разрешено определенное количество символов:
  - Максимальное количество символов для имени пользователя, которое находится перед знаком (@): 64
  - Максимальное количество символов для доменного имени после знака (@): 48
  - Недействительные символы: \ % &amp; \* + / = ? { } | \< \> ( ) ; : , [ ] "
  - Разрешены символы: A — Z, a - z, 0 — 9, ' . - _ ! # ^ ~
  - Буквы с диакритичными знаками, такими как umlauts, accents и tildes, являются недействительными символами.
  - Символ @требуется в каждом **значении userPrincipalName.**
  - Символ "@" не может быть первым символом в каждом значении **userPrincipalName**.
  - Имя пользователя не может закончиться периодом (.), амперандом (), пробелом или знаком &amp; (@).
  - Имя пользователя не может содержать пробелы.
  - Необходимо использовать домены routable; например, нельзя использовать локальные или внутренние домены.
  - Символы кодировки Юникод преобразуются в символы подчеркивания.
  - **UserPrincipalName не** может содержать какие-либо дублирующие значения в каталоге.

## <a name="3-prepare-the-userprincipalname-attribute"></a>3. Подготовка атрибута userPrincipalName

Active Directory предназначен для того, чтобы позволить конечным пользователям вашей организации войти в каталог с помощью **sAMAccountName** или **userPrincipalName.** Кроме того, конечные пользователи могут войти в Microsoft 365 с помощью основного имени пользователя (UPN) своей работы или учетной записи школы. Синхронизация каталогов пытается создать новых пользователей в Azure Active Directory с помощью того же upN, что и в вашей AD DS. UpN форматирован как адрес электронной почты.

В Microsoft 365 upN — это атрибут по умолчанию, используемый для создания адреса электронной почты. Легко получить **userPrincipalName** (в AD DS и Azure AD) и основной адрес электронной почты в **proxyAddresses,** задаваемом для различных значений. Если они установлены для различных значений, администраторы и конечные пользователи могут быть не в себе.

Лучше всего согласовать эти атрибуты, чтобы уменьшить путаницу. Чтобы соответствовать требованиям единого входного знака с помощью служб Федерации Active Directory (AD FS) 2.0, необходимо убедиться, что upNs в Azure Active Directory и AD DS совпадают и используют допустимую область имен домена.

## <a name="4-add-an-alternative-upn-suffix-to-ad-ds"></a>4. Добавьте альтернативный суффикс upN в AD DS

Возможно, вам потребуется добавить альтернативный суффикс upN, чтобы связать корпоративные учетные данные пользователя с средой Microsoft 365. Суффикс UPN — это часть имени участника-пользователя, расположенная справа от символа @. UPN-имена, которые используются для единого входа, могут содержать буквы, цифры, точки, дефисы и подчеркивания, другие символы запрещены.

Дополнительные сведения о добавлении альтернативного суффикса UPN в Active Directory см. в статью [Подготовка к синхронизации каталогов.]( https://go.microsoft.com/fwlink/p/?LinkId=525430)

## <a name="5-match-the-ad-ds-upn-with-the-microsoft-365-upn"></a>5. Соответствие upN AD DS с upN Microsoft 365

Если вы уже настроили синхронизацию каталогов, upN пользователя для Microsoft 365 может не совпадать с upN AD DS пользователя, который определен в вашей AD DS. Это может произойти, если пользователю была назначена лицензия до проверки домена. Чтобы исправить это, используйте [PowerShell,](https://go.microsoft.com/fwlink/p/?LinkId=396730) чтобы исправить дубликат UPN для обновления upN пользователя, чтобы убедиться, что upN Microsoft 365 совпадает с корпоративным именем пользователя и доменом. Если вы обновляете upN в AD DS и хотите, чтобы он синхронизировался с идентификатором Azure Active Directory, необходимо удалить лицензию пользователя в Microsoft 365 до внесения изменений в AD DS.

См. также, как подготовить домен без маршрутизации [(например, локальный домен) для синхронизации каталогов.](prepare-a-non-routable-domain-for-directory-synchronization.md)

## <a name="next-steps"></a>Дальнейшие действия

Если вы сделали шаги с 1 по 5 выше, см. в рублях [Настройка синхронизации каталогов.](set-up-directory-synchronization.md)