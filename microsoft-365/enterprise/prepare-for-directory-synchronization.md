---
title: Подготовка к синхронизации каталогов с Microsoft 365
ms.author: josephd
author: JoeDavies-MSFT
manager: laurawi
ms.date: 09/30/2020
audience: Admin
ms.topic: article
ms.service: o365-administration
localization_priority: Normal
f1.keywords:
- CSH
ms.custom:
- Adm_O365
- O365p_AddUsersWithDirSync
- O365M_AddUsersWithDirSync
- O365E_HRCSetupAADConnectAboutLM617031
- O365E_AddUsersWithDirSync
ms.collection:
- Ent_O365
- M365-identity-device-management
search.appverid:
- MET150
- MOP150
- MOE150
- MBS150
ms.assetid: 01920974-9e6f-4331-a370-13aea4e82b3e
description: Описание подготовки пользователей к использованию Microsoft 365 с помощью синхронизации службы каталогов и долгосрочных преимуществ использования этого метода.
ms.openlocfilehash: e49cc4472b47320650d8a0ca90395b69ae5b6df7
ms.sourcegitcommit: bdf65d48b20f0f428162c39ee997accfa84f4e5d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/20/2020
ms.locfileid: "49371628"
---
# <a name="prepare-for-directory-synchronization-to-microsoft-365"></a>Подготовка к синхронизации каталогов с Microsoft 365

*Эта статья относится к Microsoft 365 корпоративный и Office 365 корпоративный.*

Преимущества гибридной синхронизации удостоверений и каталогов в организации:

- Сокращение административных программ в организации
- При желании включение сценария единого входов
- Автоматизация изменений учетных записей в Microsoft 365

Дополнительные сведения о преимуществах синхронизации службы каталогов см. в гибридном удостоверении с [Azure Active Directory (Azure AD)](https://go.microsoft.com/fwlink/p/?LinkId=525398) и гибридном удостоверении [для Microsoft 365.](plan-for-directory-synchronization.md)

Однако синхронизация службы каталогов требует планирования и подготовки, чтобы ваши доменные службы Active Directory (AD DS) синхронизировались с клиентом Azure AD подписки На Microsoft 365 с минимальным количеством ошибок.

Выполните следующие действия, чтобы получить наилучшие результаты.

## <a name="1-directory-cleanup-tasks"></a>1. Задачи очистки каталога

Перед синхронизацией AD DS с клиентом Azure AD необходимо очистить AD DS.

> [!IMPORTANT]
> Если вы не выполните очистку AD DS перед синхронизацией, это может значительно отрицательно сказаться на процессе развертывания. Цикл синхронизации каталогов, выявления ошибок и повторной синхронизации может занять несколько дней или даже недель.

В AD DS выполните следующие задачи очистки для каждой учетной записи пользователя, для которых будет назначена лицензия Microsoft 365:

1. Убедитесь, что в атрибуте **proxyAddresses** допустимый и уникальный адрес электронной почты.

2. Удалите повторяющиеся значения в **атрибуте proxyAddresses.**

3. По возможности убедитесь в допустимом и уникальном значении атрибута **userPrincipalName** в объекте **пользователя.** Для лучшей синхронизации убедитесь, что upN AD DS соответствует upN Azure AD. Если у пользователя нет значения атрибута **userPrincipalName,** объект пользователя должен содержать допустимое и уникальное значение атрибута **sAMAccountName.**  Удалите повторяющиеся значения в **атрибуте userPrincipalName.**

4. Для оптимального использования глобального списка адресов (GAL) убедитесь в правильности сведений в следующих атрибутах учетной записи пользователя AD DS:

   - givenName;
   - surname
   - displayName
   - должность;
   - Отдел
   - Кабинет
   - рабочий телефон;
   - мобильный телефон;
   - номер факса;
   - адрес;
   - Город
   - регион или область;
   - почтовый индекс;
   - страна или регион.

## <a name="2-directory-object-and-attribute-preparation"></a>2. Подготовка объекта каталога и атрибутов

Для успешной синхронизации службы каталогов между AD DS и Microsoft 365 необходимо правильно подготовить атрибуты AD DS. Например, необходимо убедиться, что определенные символы не используются в определенных атрибутах, синхронизируются со средой Microsoft 365. Непредвиденные символы не приводят к сбойу синхронизации каталогов, но могут возвращать предупреждение. Недопустимые символы приводят к сбойу синхронизации каталогов.

Синхронизация каталогов также не удастся, если у некоторых пользователей AD DS есть один или несколько дублирующихся атрибутов. Каждый пользователь должен иметь уникальные атрибуты.

Ниже перечислены атрибуты, которые необходимо подготовить.

- **displayName**

  - Если атрибут существует в объекте пользователя, он будет синхронизирован с Microsoft 365.
  - Если этот атрибут существует в объекте пользователя, для него должно быть значение. То есть атрибут не должен быть пустым.
  - Максимальное число символов: 256

- **givenName;**

  - Если атрибут существует в объекте пользователя, он будет синхронизирован с Microsoft 365, но Microsoft 365 не требует или не использует его.
  - Максимальное число символов: 64

- **mail**

  - Значение атрибута должно быть уникальным в каталоге.

    > [!NOTE]
    > Если имеются повторяющиеся значения, синхронизируется первый пользователь со значением. Последующие пользователи не будут отображаться в Microsoft 365. Необходимо изменить либо значение в Microsoft 365, либо оба значения в AD DS, чтобы оба пользователя появились в Microsoft 365.

- **mailNickname** (псевдоним Exchange)

  - Значение атрибута не может начинаться с точка (.).
  - Значение атрибута должно быть уникальным в каталоге.

    > [!NOTE]
    > Символы подчеркиваия ("_") в синхронизированном имени указывают, что исходное значение этого атрибута содержит недопустимые символы. Дополнительные сведения об этом атрибуте см. в [атрибуте псевдонима Exchange.](https://docs.microsoft.com/powershell/module/exchange/set-mailbox)
    >

- **proxyAddresses**

  - Атрибут с несколькими значениями
  - Максимальное количество символов на значение: 256
  - Значение атрибута не должно содержать пробел.
  - Значение атрибута должно быть уникальным в каталоге.
  - Недопустимые символы: \< \> ( ) ; , [ ] " '

    Обратите внимание, что недопустимые символы применяются к символам, следующим за типом "delimiter" и ":", таким образом, SMTP:User@contso.com разрешено, SMTP:user:M@contoso.com нет.

    > [!IMPORTANT]
    > Все SMTP-адреса должны соответствовать стандартам обмена сообщениями электронной почты. Удалите дублирующиеся или нежелательные адреса, если они существуют.

- **sAMAccountName**

  - Максимальное число символов: 20
  - Значение атрибута должно быть уникальным в каталоге.
  - Недопустимые символы: [ \ " | , / : \< \> + = ; ? \* ']
  - Если у пользователя есть недопустимый **атрибут sAMAccountName,** но допустимый атрибут **userPrincipalName,** учетная запись пользователя создается в Microsoft 365.
  - Если **параметры sAMAccountName** и **userPrincipalName** недопустимы, необходимо обновить атрибут **userPrincipalName** AD DS.

- **sn** (фамилия)

  - Если атрибут существует в объекте пользователя, он будет синхронизирован с Microsoft 365, но Microsoft 365 не требует или не использует его.

- **targetAddress**

    Необходимо, чтобы атрибут **targetAddress** (например, SMTP:tom@contoso.com), который был заполнен для пользователя, должен отображаться в gal Microsoft 365. В сценариях миграции сообщений сторонних пользователей для этого потребуется расширение схемы Microsoft 365 для AD DS. Расширение схемы Microsoft 365 также добавит другие полезные атрибуты для управления объектами Microsoft 365, которые заполняются с помощью средства синхронизации каталогов из AD DS. Например, добавляется атрибут **msExchHideFromAddressLists** для управления скрытыми почтовыми ящиками или группами рассылки.

  - Максимальное число символов: 256
  - Значение атрибута не должно содержать пробел.
  - Значение атрибута должно быть уникальным в каталоге.
  - Недопустимые символы: \ \< \> ( ) ; , [ ] "
  - Все SMTP-адреса должны соответствовать стандартам обмена сообщениями электронной почты.

- **userPrincipalName**

  - Атрибут **userPrincipalName** должен иметь формат для доступа в Интернет, в котором за именем пользователя следует знак @и доменное имя: например, user@contoso.com. Все SMTP-адреса должны соответствовать стандартам обмена сообщениями электронной почты.
  - Максимальное количество символов для **атрибута userPrincipalName** — 113. До и после знака @разрешается определенное количество символов:
  - Максимальное количество символов для имени пользователя перед знаком @: 64
  - Максимальное количество символов для имени домена после знака @: 48
  - Недопустимые символы: \ % &amp; \* + / = ? { } | \< \> ( ) ; : , [ ] "
  - Разрешенные символы: A – Z, a - z, 0 – 9, ' . - _ ! # ^ ~
  - Буквы с диакритичными знаками, такими как umlauts, accents и tildes, являются недопустимыми символами.
  - Символ @требуется в каждом значении **userPrincipalName.**
  - Символ "@" не может быть первым символом в каждом значении **userPrincipalName**.
  - Имя пользователя не может быть оканчено точками (.), амперанд ( ), пробелом или знаком &amp; @.
  - Имя пользователя не может содержать пробелы.
  - Необходимо использовать домены с маршрутией; например, нельзя использовать локальные или внутренние домены.
  - Символы кодировки Юникод преобразуются в символы подчеркивания.
  - **UserPrincipalName** не может содержать повторяющиеся значения в каталоге.

## <a name="3-prepare-the-userprincipalname-attribute"></a>3. Подготовка атрибута userPrincipalName

Active Directory позволяет конечным пользователям в организации войти в каталог с помощью **sAMAccountName** или **userPrincipalName.** Аналогичным образом, конечные пользователи могут войти в Microsoft 365, используя имя участников-пользователей (UPN) своей работы или учебной учетной записи. Синхронизация службы каталогов пытается создать новых пользователей в Azure Active Directory с помощью того же upN, что и в AD DS. UpN форматирован как адрес электронной почты.

В Microsoft 365 upN является атрибутом по умолчанию, используемым для создания адреса электронной почты. Легко получить **userPrincipalName** (в AD DS и в Azure AD) и основной адрес электронной почты в **proxyAddresses,** задав разные значения. Если для них установлены разные значения, администраторы и конечные пользователи могут запутаться.

Лучше всего выровнять эти атрибуты, чтобы уменьшить путаницу. Чтобы обеспечить соответствие требований единого вход с помощью служб федерации Active Directory (AD FS) 2.0, необходимо убедиться, что имена субъектов-пользователей в Azure Active Directory и доменных службах Active Directory совпадают и используют действительное пространство имен домена.

## <a name="4-add-an-alternative-upn-suffix-to-ad-ds"></a>4. Добавление альтернативного суффикса upN в AD DS

Вам может потребоваться добавить альтернативный суффикс upN, чтобы связать корпоративные учетные данные пользователя со средой Microsoft 365. Суффикс UPN — это часть имени участника-пользователя, расположенная справа от символа @. UPN-имена, которые используются для единого входа, могут содержать буквы, цифры, точки, дефисы и подчеркивания, другие символы запрещены.

Дополнительные сведения о добавлении альтернативного суффикса upN в Active Directory см. в подготовьтесь к синхронизации [службы каталогов.]( https://go.microsoft.com/fwlink/p/?LinkId=525430)

## <a name="5-match-the-ad-ds-upn-with-the-microsoft-365-upn"></a>5. Соответствие upN AD DS с upN Microsoft 365

Если вы уже настроили синхронизацию службы каталогов, имя пользователя для Microsoft 365 может не совпадать с ИД пользователя AD DS UPN, которое определено в AD DS. Это может произойти, если пользователю была назначена лицензия до проверки домена. Чтобы устранить эту проблему, исправьте дублирующееся имя пользователя-пользователя с помощью [PowerShell,](https://go.microsoft.com/fwlink/p/?LinkId=396730) чтобы убедиться, что имя пользователя Microsoft 365 соответствует корпоративному имени пользователя и домену. Если вы обновляете имя пользователя в AD DS и хотите синхронизировать его с удостоверением Azure Active Directory, необходимо удалить лицензию пользователя в Microsoft 365 перед внесением изменений в AD DS.

См. также, как подготовить не маршрутизируемый домен [(например, локальный домен) для синхронизации каталогов.](prepare-a-non-routable-domain-for-directory-synchronization.md)

## <a name="next-steps"></a>Дальнейшие действия

Если вы сделали шаги с 1 по 5 выше, см. ["Настройка синхронизации каталогов".](set-up-directory-synchronization.md)
