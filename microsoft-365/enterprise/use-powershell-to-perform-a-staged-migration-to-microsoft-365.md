---
title: Поэтапная миграция в Microsoft 365 с помощью PowerShell
ms.author: josephd
author: JoeDavies-MSFT
manager: laurawi
ms.date: 07/17/2020
audience: Admin
ms.topic: article
ms.service: o365-administration
localization_priority: Normal
search.appverid:
- MET150
ms.collection: Ent_O365
f1.keywords:
- NOCSH
ms.custom: seo-marvel-apr2020
ms.assetid: a20f9dbd-6102-4ffa-b72c-ff813e700930
description: Узнайте, как использовать PowerShell для перемещения контента из системы исходных сообщений электронной почты с помощью поэтапной миграции в Microsoft 365.
ms.openlocfilehash: 6a458f6164a842394ec87f59df11939a8c435ea2
ms.sourcegitcommit: 48195345b21b409b175d68acdc25d9f2fc4fc5f1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/30/2021
ms.locfileid: "53229651"
---
# <a name="use-powershell-to-perform-a-staged-migration-to-microsoft-365"></a>Поэтапная миграция в Microsoft 365 с помощью PowerShell

*Эта статья относится к Microsoft 365 корпоративный и Office 365 корпоративный.*

Содержимое почтовых ящиков пользователей можно перенести из системы исходных сообщений электронной почты в Microsoft 365 с помощью поэтапной миграции.

В этой статье описываются задачи, связанные с поэтапной миграцией электронной почты с помощью Exchange Online PowerShell. В разделе ["Что нужно знать о](/Exchange/mailbox-migration/what-to-know-about-a-staged-migration)поэтапной миграции электронной почты", представлен обзор процесса миграции. Ознакомившись с содержимым этой статьи, начните переносить почтовые ящики из одной почтовой системы в другую, руководствуясь приведенными в этой статье сведениями.

> [!NOTE]
> Вы также можете использовать центр администрирования Exchange для выполнения поэтапной миграции. См. [этапную миграцию](/Exchange/mailbox-migration/perform-a-staged-migration/perform-a-staged-migration)электронной почты в Microsoft 365.

## <a name="what-do-you-need-to-know-before-you-begin"></a>Что нужно знать перед началом работы?

Предполагаемое время для выполнения этой задачи: 2-5 минут для создания пакета миграции. После запуска пакета миграции продолжительность миграции будет зависеть от количества почтовых ящиков в пакете, размера каждого почтового ящика и доступной пропускной способности сети. Сведения о других факторах, влияющих на время переноса почтовых ящиков в Microsoft 365, см. в [сообщении Migration Performance.](/Exchange/mailbox-migration/office-365-migration-best-practices)

Для выполнения этой процедуры (процедур) необходимы соответствующие разрешения. Сведения о необходимых разрешениях см. в пункте "Миграция" статьи [Разрешения получателей](/exchange/recipients-permissions-exchange-2013-help).

Чтобы использовать командлеты Exchange Online PowerShell, вам необходимо войти в систему и импортировать командлеты в локальный сеанс Windows PowerShell. Инструкции см в статье [Подключение к Exchange Online с помощью удаленной оболочки PowerShell](/powershell/exchange/connect-to-exchange-online-powershell).

Полный список команд миграции см. в статье [Командлеты перемещения и миграции](/powershell/exchange/).

## <a name="migration-steps"></a>Шаги миграции

### <a name="step-1-prepare-for-a-staged-migration"></a>Шаг 1. Подготовка к поэтапной миграции

Перед переносом почтовых ящиков в Microsoft 365 с помощью поэтапной миграции необходимо внести несколько изменений в Exchange среду.

 **Настройте Мобильный Outlook на локальном сервере Exchange Server**. Служба миграции электронной почты использует компонент Мобильный Outlook (также известный как RPC через HTTP) для подключения к локальному серверу Exchange Server. Сведения о настройке Мобильный Outlook для Exchange Server 2007 и Exchange 2003 см. в следующих статьях.

- [Exchange 2007. Инструкции по включению мобильного Outlook](/previous-versions/office/exchange-server-2007/bb123889(v=exchg.80))

- [Настройка мобильного Outlook в Exchange 2003](/previous-versions/office/exchange-server-2007/aa996922(v=exchg.80))

> [!IMPORTANT]
> В вашей конфигурации Мобильный Outlook необходимо использовать сертификат, выданный доверенным центром сертификации (ЦС). Мобильный Outlook невозможно настроить с помощью самозаверяющего сертификата. Дополнительные сведения см. в статье [Инструкции по настройке протокола SSL для мобильного Outlook](/previous-versions/office/exchange-server-2007/aa995982(v=exchg.80)).

 **Необязательно. Убедитесь, что вы можете подключиться к своей организации Exchange с помощью Мобильный Outlook**. Для проверки параметров подключения воспользуйтесь одним из следующих методов.

- Используйте Outlook из-за пределов вашей корпоративной сети, чтобы подключиться к своему локальному почтовому ящику Exchange.

- Для [проверки параметров](https://https://testconnectivity.microsoft.com/) подключения используйте анализатор удаленного подключения Майкрософт. Используйте Мобильный Outlook (RPC через HTTP) или проверки автообнаружения Outlook.

- В Exchange Online PowerShell выполните следующие команды.

  ```powershell
  $Credentials = Get-Credential
  ```

  ```powershell
  Test-MigrationServerAvailability -ExchangeOutlookAnywhere -Autodiscover -EmailAddress <email address for on-premises administrator> -Credentials $credentials
  ```

 **Настройка разрешений** Учетная запись локального пользователя, используемая для подключения к локальной Exchange организации (также называемой администратором миграции), должна иметь необходимые разрешения для доступа к почтовым ящикам, которые необходимо перенести в Microsoft 365. Эта учетная запись пользователя используется при подключении к системе электронной почты, создав конечную точку миграции позднее в этой процедуре (шаг[3. Создание конечной точки миграции).](use-powershell-to-perform-a-staged-migration-to-microsoft-365.md#BK_Endpoint)

Для переноса почтовых ящиков администратор должен иметь один из следующих наборов разрешений.

- Он должен входить в группу **администраторов домена** в доменной службе Active Directory локальной организации.

     или 

- Он должен получить разрешение на уровне **FullAccess** для каждого локального почтового ящика и разрешение **WriteProperty** на изменение свойства **TargetAddress** в локальных учетных записях пользователей.

     или 

- Он должен получить разрешение **Получать как** для базы данных локальных почтовых ящиков, в которой хранятся почтовые ящики пользователей, и разрешение **WriteProperty** на изменение свойства **TargetAddress** в локальных учетных записях пользователей.

Инструкции по набору этих разрешений см. в инструкции Назначение разрешений для переноса [почтовых ящиков в Microsoft 365.](/Exchange/mailbox-migration/assign-permissions-for-migration)

 **Отключите единую систему обмена сообщениями.** Если единая система обмена сообщениями включена для переносимых локальных почтовых ящиков, отключите ее перед миграцией. Включите эту систему по завершении миграции. Практические инструкции см. в статье [Выключение единой системы обмена сообщениями для пользователя](/previous-versions/office/exchange-server-2007/bb124691(v=exchg.80)).

 **Синхронизация каталогов используется для создания новых пользователей в Microsoft 365.** Синхронизация каталогов используется для создания всех локального пользователя в Microsoft 365 организации.

После создания пользователей им необходимо предоставить лицензии. У вас есть 30 дней на то, чтобы добавить лицензии после создания пользователей. Инструкции по добавлению лицензий см. в разделе [Шаг 8. Необходимые действия после миграции](use-powershell-to-perform-a-staged-migration-to-microsoft-365.md#BK_Postmigration).

 Вы можете использовать средство синхронизации Microsoft Azure Active Directory (Azure AD) или службы синхронизации Microsoft Azure AD для синхронизации и создания локального пользователя в Microsoft 365. После переноса почтовых ящиков в Microsoft 365 вы управляете учетными записями пользователей в локальной организации, и они синхронизируются с вашей Microsoft 365 организацией. Дополнительные сведения см. в[каталоге Интеграция](/previous-versions/azure/azure-services/jj573653(v=azure.100)) .

### <a name="step-2-create-a-csv-file-for-a-staged-migration-batch"></a>Шаг 2. Создание CSV-файла для пакета поэтапной миграции

После идентификации пользователей, чьи почтовые ящики на локальной основе необходимо перенести в Microsoft 365, для создания пакета миграции используется разделенный запятой файл (CSV). Каждая строка в CSV-файле, используемой Microsoft 365 для запуска миграции, содержит сведения о локальном почтовом ящике.

> [!NOTE]
> Количество почтовых ящиков, которые можно перенести в Microsoft 365 с помощью поэтапной миграции, не ограничивается. CSV-файл для пакета миграции может содержать не более 2000 строк. Чтобы перенести более 2000 почтовых ящиков, создайте дополнительные CSV-файлы и используйте каждый из них для создания нового пакета миграции.

 **Поддерживаемые атрибуты**

CSV-файл для поэтапной миграции поддерживает три атрибута, которые описаны ниже. Каждая строка в CSV-файле соответствует почтовому ящику и должна содержать значение каждого из этих атрибутов.

|**Атрибут**|**Описание**|**Обязательный?**|
|:-----|:-----|:-----|
|EmailAddress  <br/> |Задает основной SMTP-адрес электронной почты, например pilarp@contoso.com, для локальных почтовых ящиков.  <br/> Используйте основной SMTP-адрес для локального почтового ящика, а не пользовательские ID из Microsoft 365. Например, если локальное доменное имя contoso.com, а домен электронной почты Microsoft 365 — service.contoso.com, доменное имя contoso.com для адресов электронной почты в CSV-файле.  <br/> |Обязательный  <br/> |
|Password  <br/> |Пароль для нового почтового ящика Microsoft 365. Любые ограничения паролей, которые применяются к вашей Microsoft 365 организации, также применяются к паролям, включенным в CSV-файл.  <br/> |Необязательный  <br/> |
|ForceChangePassword  <br/> |Указывает, должен ли пользователь изменить пароль при первом входе в свой новый Microsoft 365 почтовый ящик. Задайте для этого параметра значение **True** или **False**. <br/> > [!NOTE]> Если вы внедрили решение единого входа путем развертывания служб федерации Active Directory (AD FS) в локальной организации, для атрибута **ForceChangePassword** необходимо задать значение **False**.          |Необязательный  <br/> |

 **Формат CSV-файла**

Ниже приведен пример формата CSV-файла. В этом примере три локального почтовых ящика переносят в Microsoft 365.

В первой строке (строке заголовков CSV-файла) содержатся имена атрибутов или полей, значения которых находятся в последующих строках. Имя каждого атрибута отделяется запятой.

```powershell
EmailAddress,Password,ForceChangePassword
pilarp@contoso.com,Pa$$w0rd,False
tobyn@contoso.com,Pa$$w0rd,False
briant@contoso.com,Pa$$w0rd,False
```

Каждая строка под строкой заголовков представляет одного пользователя и содержит данные, используемые для переноса почтового ящика этого пользователя. Значения атрибутов в каждой строке должны следовать в том же порядке, что и имена атрибутов в строке заголовков.

Создать CSV-файл можно с помощью любого текстового редактора или соответствующего приложения, например Excel. Сохраните файл как CSV- или TXT-файл.

> [!NOTE]
> Если CSV-файл содержит знаки, не входящие в ASCII, или специальные символы, сохраните его в кодировке UTF-8 или другой кодировке Юникода. В зависимости от приложения сохранить CSV-файл в кодировке UTF-8 или другой кодировке Юникода может оказаться проще, если язык системы соответствует языку, используемому в CSV-файле.

### <a name="step-3-create-a-migration-endpoint"></a>Шаг 3. Создание конечной точки миграции
<a name="BK_Endpoint"> </a>

Чтобы успешно перенести электронную почту, Microsoft 365 необходимо подключиться и связаться с системой исходных сообщений электронной почты. Для этого Microsoft 365 конечную точку миграции. Чтобы создать конечную точку миграции мобильного Outlook с помощью PowerShell для поэтапной миграции, сначала [подключитесь к Exchange Online](/powershell/exchange/connect-to-exchange-online-powershell).

Полный список команд миграции см. в статье [Командлеты перемещения и миграции](/powershell/exchange/).

Чтобы создать конечную точку миграции мобильного Outlook с именем StagedEndpoint в Exchange Online PowerShell, выполните следующие команды.

```powershell
$Credentials = Get-Credential
```

```powershell
New-MigrationEndpoint -ExchangeOutlookAnywhere -Name StagedEndpoint -Autodiscover -EmailAddress administrator@contoso.com -Credentials $Credentials
```

Дополнительные сведения о командлете **New-MigrationEndpoint** см. в статье [New-MigrationEndpoint](/powershell/module/exchange/new-migrationendpoint).

> [!NOTE]
> С помощью командлета **New-MigrationEndpoint** и параметра **-TargetDatabase** можно указать базу данных, которая будет использоваться службой. В противном случае база данных назначается случайным образом на сайте Службы федерации Active Directory (AD FS) 2.0, на котором расположен почтовый ящик управления.

#### <a name="verify-it-worked"></a>Проверка работы

В Exchange Online PowerShell выполните следующую команду, чтобы отобразить сведения о конечной точке миграции StagedEndpoint.

```powershell
Get-MigrationEndpoint StagedEndpoint | Format-List EndpointType,ExchangeServer,UseAutoDiscover,Max*
```

### <a name="step-4-create-and-start-a-stage-migration-batch"></a>Шаг 4. Создание и запуск пакета поэтапной миграции
<a name="BK_Endpoint"> </a>

Чтобы создать пакет для прямой миграции, выполните командлет **New-MigrationBatch** в Exchange Online PowerShell. Можно создать пакет миграции и запустить его обработку автоматически, включив параметр _AutoStart_. Кроме того, вы можете создать пакет миграции, а затем вручную запустить его с помощью командлета **Start-MigrationBatch**. В этом примере создается пакет миграции StagedBatch1 и используется конечная точка миграции, созданная на предыдущем шаге.

```powershell
New-MigrationBatch -Name StagedBatch1 -SourceEndpoint StagedEndpoint -AutoStart
```

В этом примере также создается пакет миграции StagedBatch1 и используется конечная точка миграции, созданная на предыдущем шаге. Так как параметр  _AutoStart_ не включен, пакет миграции необходимо запустить вручную на панели мониторинга миграции или с помощью командлета **Start-MigrationBatch**. Как было сказано выше, в одно и то же время может существовать только один пакет прямой миграции.

```powershell
New-MigrationBatch -Name StagedBatch1 -SourceEndpoint StagedEndpoint
```

#### <a name="verify-it-worked"></a>Проверка работы

Выполните следующую команду в Exchange Online PowerShell, чтобы отобразить сведения о пакете миграции StagedBatch1.

```powershell
Get-MigrationBatch -Identity StagedBatch1 | Format-List
```

Вы также можете убедиться, что пакет запущен, выполнив следующую команду.

```powershell
Get-MigrationBatch -Identity StagedBatch1 | Format-List Status
```

Дополнительные сведения о командлете **Get-MigrationBatch** см. в статье [Get-MigrationBatch](/powershell/module/exchange/get-migrationbatch).

### <a name="step-5-convert-on-premises-mailboxes-to-mail-enabled-users"></a>Шаг 5. Преобразование локальных почтовых ящиков в учетные записи пользователей, поддерживающих почту
<a name="BK_Endpoint"> </a>

После успешного переноса почтовых ящиков необходимо предоставить пользователям доступ к их почте. Теперь у пользователя, почтовый ящик которого был перенесен, есть как локальное, так и одно в Microsoft 365. Пользователи с почтовым ящиком в Microsoft 365 перестанут получать новую почту в локальном почтовом ящике.

Так как вы не закончили с миграцией, вы еще не готовы направлять всех пользователей Microsoft 365 для их электронной почты. Так что же делать с пользователями, у которых есть оба почтовых ящика? Локальные почтовые ящики, которые вы уже перенесли, можно изменить на пользователей, поддерживающих почту. При изменении с почтового ящика на пользователя с включенной почтой можно направить Microsoft 365 для своей электронной почты, а не в локальном почтовом ящике.

Еще одна важная причина преобразования почтовых ящиков на локальной основе для пользователей с поддержкой почты заключается в сохранении прокси-адресов из Microsoft 365 почтовых ящиков путем копирования прокси-адресов для пользователей с поддержкой почты. Это позволит вам управлять облачными пользователями из локальной организации с помощью Active Directory. Кроме того, если после переноса всех почтовых ящиков в Microsoft 365 в Exchange Server организацию вы решите выключить свою организацию с локальной Exchange Server, прокси-адреса, скопированные пользователям с поддержкой почты, останутся в локальном Каталоге Active Directory.

### <a name="step-6-delete-a-staged-migration-batch"></a>Шаг 6. Удаление пакета поэтапной миграции
<a name="BK_Endpoint"> </a>

 После успешного переноса всех почтовых ящиков из пакета миграции и преобразования локальных почтовых ящиков из пакета в учетные записи пользователей, поддерживающих почту, пакет поэтапной миграции можно удалить. Убедитесь, что почта пересылается в почтовые Microsoft 365 в пакете миграции. При удалении пакета поэтапной миграции служба миграции удаляет все записи, связанные с пакетом, а также сам пакет.

Чтобы удалить пакет миграции StagedBatch1 в Exchange Online PowerShell, выполните следующую команду.

```powershell
Remove-MigrationBatch -Identity StagedBatch1
```

Дополнительные сведения о командлете **Remove-MigrationBatch** см. в статье [Remove-MigrationBatch](/powershell/module/exchange/remove-migrationbatch).

#### <a name="verify-it-worked"></a>Проверка работы

Выполните следующую команду в Exchange Online PowerShell, чтобы отобразить сведения о пакете миграции IMAPBatch1.

```powershell
Get-MigrationBatch StagedBatch1
```

Команда либо вернет пакет миграции с состоянием **Удаление**, либо вернет ошибку (не удалось найти пакет миграции), что подтверждает удаление пакета миграции.

Дополнительные сведения о командлете **Get-MigrationBatch** см. в статье [Get-MigrationBatch](/powershell/module/exchange/get-migrationbatch).

### <a name="step7-assign-licenses-to-microsoft-365-users"></a>Step7. Назначение лицензий Microsoft 365 пользователям
<a name="BK_Endpoint"> </a>

Активация Microsoft 365 учетных записей пользователей для перенесенных учетных записей путем назначения лицензий. Если не назначить лицензию, почтовый ящик отключится по окончании льготного периода (30 дней). Чтобы назначить лицензию в Центр администрирования Microsoft 365, см. в руб. Назначение или [неназначимые лицензии.](../admin/manage/assign-licenses-to-users.md)

### <a name="step-8-complete-post-migration-tasks"></a>Шаг 8. Необходимые действия после миграции
<a name="BK_Postmigration"> </a>

- **Создайте DNS-запись автообнаружения, чтобы пользователи смогли с легкостью получить доступ к своим почтовым ящикам.** После переноса всех почтовых ящиков на Microsoft 365 можно настроить запись DNS автообнаружаемых данных для организации Microsoft 365, чтобы пользователи могли легко подключаться к своим новым Microsoft 365 почтовым ящикам с Outlook и мобильными клиентами. Эта новая запись DNS с автоматическим открытием должна использовать то же пространство имен, которое используется для Microsoft 365 организации. Например, если пространство имен облачной службы имеет значение cloud.contoso.com, необходимо создать запись DNS автообнаружения autodiscover.cloud.contoso.com.

    Microsoft 365 записи CNAME для реализации службы автооткрытия для Outlook и мобильных клиентов. Запись CNAME автообнаружения должна содержать следующие сведения:

  - **Псевдоним:** autodiscover

  - **Целевой объект:** autodiscover.outlook.com

    Дополнительные сведения см. в [добавлении записей DNS для подключения домена.](../admin/get-help-with-domains/create-dns-records-at-any-dns-hosting-provider.md)

- **Спишите локальные сервера Exchange.** После проверки того, что вся электронная почта передается непосредственно в почтовые ящики Microsoft 365, и вам больше не нужно поддерживать локальное почтовое сообщение или не планировать реализацию решения SSO, вы можете удалить Exchange с серверов и удалить локальное Exchange организацию.

    Дополнительные сведения см. в следующих статьях:

  - [Изменение или удаление Exchange 2010](/previous-versions/office/exchange-server-2010/ee332361(v=exchg.141))

  - [Удаление организации Exchange 2007](/previous-versions/office/exchange-server-2007/aa998313(v=exchg.80))

  - [Удаление сервера Exchange Server 2003](/previous-versions/tn-archive/bb125110(v=exchg.65))
