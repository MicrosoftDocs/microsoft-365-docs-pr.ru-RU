---
title: Поэтапная миграция в Microsoft 365 с помощью PowerShell
ms.author: josephd
author: JoeDavies-MSFT
manager: laurawi
ms.date: 07/17/2020
audience: Admin
ms.topic: article
ms.service: o365-administration
localization_priority: Normal
search.appverid:
- MET150
ms.collection: Ent_O365
f1.keywords:
- NOCSH
ms.custom: seo-marvel-apr2020
ms.assetid: a20f9dbd-6102-4ffa-b72c-ff813e700930
description: Узнайте, как использовать PowerShell для перемещения контента из исходной почтовой системы с течением времени с помощью поэтапной миграции в Microsoft 365.
ms.openlocfilehash: ebf2067fe7ae9fc2d2b58d0aa804c7843295b38a
ms.sourcegitcommit: 79065e72c0799064e9055022393113dfcf40eb4b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/14/2020
ms.locfileid: "46693107"
---
# <a name="use-powershell-to-perform-a-staged-migration-to-microsoft-365"></a>Поэтапная миграция в Microsoft 365 с помощью PowerShell

*Эта статья относится к Microsoft 365 корпоративный и Office 365 корпоративный.*

Вы можете перенести содержимое почтовых ящиков пользователей из исходной системы электронной почты в Microsoft 365 со временем с помощью поэтапной миграции.
  
В этой статье описываются задачи, связанные с поэтапной миграцией электронной почты с помощью Exchange Online PowerShell. В теме, [что необходимо знать о поэтапной миграции электронной почты](https://go.microsoft.com/fwlink/p/?LinkId=536487), вы можете получить обзор процесса миграции. Ознакомившись с содержимым этой статьи, начните переносить почтовые ящики из одной почтовой системы в другую, руководствуясь приведенными в этой статье сведениями.
  
> [!NOTE]
> Вы также можете выполнить поэтапную миграцию с помощью центра администрирования Exchange. [Выполните поэтапную миграцию электронной почты в Microsoft 365](https://go.microsoft.com/fwlink/p/?LinkId=536687). 
  
## <a name="what-do-you-need-to-know-before-you-begin"></a>Что нужно знать перед началом работы?

Предполагаемое время выполнения задачи: 2-5 минут для создания пакета миграции. После запуска пакета миграции продолжительность миграции будет зависеть от количества почтовых ящиков в пакете, размера каждого почтового ящика и доступной пропускной способности сети. Сведения о других факторах, влияющих на время переноса почтовых ящиков в Microsoft 365, можно найти в разделе [производительность миграции](https://go.microsoft.com/fwlink/p/?LinkId=275079).
  
Для выполнения этой процедуры (процедур) необходимы соответствующие разрешения. Сведения о необходимых разрешениях см. в пункте "Миграция" статьи [Разрешения получателей](https://go.microsoft.com/fwlink/p/?LinkId=534105).
  
Чтобы использовать командлеты Exchange Online PowerShell, вам необходимо войти в систему и импортировать командлеты в локальный сеанс Windows PowerShell. Инструкции см в статье [Подключение к Exchange Online с помощью удаленной оболочки PowerShell](https://go.microsoft.com/fwlink/p/?LinkId=534121).
  
Полный список команд миграции см. в статье [Командлеты перемещения и миграции](https://go.microsoft.com/fwlink/p/?LinkId=534750).
  
## <a name="migration-steps"></a>Шаги миграции

### <a name="step-1-prepare-for-a-staged-migration"></a>Шаг 1. Подготовка к поэтапной миграции

Прежде чем переносить почтовые ящики в Microsoft 365 с помощью поэтапной миграции, в среду Exchange необходимо внести несколько изменений.
  
 **Настройте Мобильный Outlook на локальном сервере Exchange Server**. Служба миграции электронной почты использует компонент Мобильный Outlook (также известный как RPC через HTTP) для подключения к локальному серверу Exchange Server. Сведения о настройке Мобильный Outlook для Exchange Server 2007 и Exchange 2003 см. в следующих статьях.
  
- [Exchange 2007. Инструкции по включению мобильного Outlook](https://go.microsoft.com/fwlink/?LinkID=167210)
    
- [Настройка мобильного Outlook в Exchange 2003](https://go.microsoft.com/fwlink/?LinkID=167209)
    
> [!IMPORTANT]
> В вашей конфигурации Мобильный Outlook необходимо использовать сертификат, выданный доверенным центром сертификации (ЦС). Мобильный Outlook невозможно настроить с помощью самозаверяющего сертификата. Дополнительные сведения см. в статье [Инструкции по настройке протокола SSL для мобильного Outlook](https://go.microsoft.com/fwlink/?LinkID=80875). 
  
 **Необязательно. Убедитесь, что вы можете подключиться к своей организации Exchange с помощью Мобильный Outlook**. Для проверки параметров подключения воспользуйтесь одним из следующих методов.
  
- Используйте Outlook из-за пределов вашей корпоративной сети, чтобы подключиться к своему локальному почтовому ящику Exchange.
    
- Проверьте параметры подключения с помощью [анализатора удаленных подключений (Майкрософт](https://https://testconnectivity.microsoft.com/) ). Используйте Мобильный Outlook (RPC через HTTP) или проверки автообнаружения Outlook.
    
- В Exchange Online PowerShell выполните следующие команды.
    
  ```powershell
  $Credentials = Get-Credential
  ```

  ```powershell
  Test-MigrationServerAvailability -ExchangeOutlookAnywhere -Autodiscover -EmailAddress <email address for on-premises administrator> -Credentials $credentials
  ```

 **Настройка разрешений** Локальная учетная запись пользователя, которая используется для подключения к локальной организации Exchange (также называемую администратором миграции), должна иметь необходимые разрешения для доступа к локальным почтовым ящикам, которые необходимо перенести в Microsoft 365. Эта учетная запись пользователя используется при подключении к почтовой системе путем создания конечной точки миграции позже в этой процедуре ([Шаг 3: создание конечной точки миграции](use-powershell-to-perform-a-staged-migration-to-microsoft-365.md#BK_Endpoint) ).
  
Для переноса почтовых ящиков администратор должен иметь один из следующих наборов разрешений.
  
- Он должен входить в группу **администраторов домена** в доменной службе Active Directory локальной организации.
    
     или 
    
- Он должен получить разрешение на уровне **FullAccess** для каждого локального почтового ящика и разрешение **WriteProperty** на изменение свойства **TargetAddress** в локальных учетных записях пользователей.
    
     или 
    
- Он должен получить разрешение **Получать как** для базы данных локальных почтовых ящиков, в которой хранятся почтовые ящики пользователей, и разрешение **WriteProperty** на изменение свойства **TargetAddress** в локальных учетных записях пользователей.
    
Инструкции по настройке этих разрешений приведены в разделе [Назначение разрешений для переноса почтовых ящиков в Microsoft 365](https://go.microsoft.com/fwlink/?LinkId=521656).
  
 **Отключите единую систему обмена сообщениями.** Если единая система обмена сообщениями включена для переносимых локальных почтовых ящиков, отключите ее перед миграцией. Включите эту систему по завершении миграции. Практические инструкции см. в статье[Выключение единой системы обмена сообщениями для пользователя](https://go.microsoft.com/fwlink/?LinkId=521891).
  
 **Используйте синхронизацию службы каталогов для создания новых пользователей в Microsoft 365.** Синхронизация службы каталогов используется для создания всех локальных пользователей в организации Microsoft 365.
  
После создания пользователей им необходимо предоставить лицензии. У вас есть 30 дней на то, чтобы добавить лицензии после создания пользователей. Инструкции по добавлению лицензий см. в разделе [Шаг 8. Необходимые действия после миграции](use-powershell-to-perform-a-staged-migration-to-microsoft-365.md#BK_Postmigration).
  
 Для синхронизации и создания локальных пользователей в Microsoft 365 вы можете использовать средство синхронизации Microsoft Azure Active Directory (Azure AD) или службы синхронизации Microsoft Azure AD. После переноса почтовых ящиков в Microsoft 365 вы можете управлять учетными записями пользователей в локальной организации и синхронизировать их с вашей организацией Microsoft 365. Более подробную информацию вы найдете в статье[Интеграция каталогов](https://go.microsoft.com/fwlink/?LinkId=521788) .
  
### <a name="step-2-create-a-csv-file-for-a-staged-migration-batch"></a>Шаг 2. Создание CSV-файла для пакета поэтапной миграции

После определения пользователей, чьи локальные почтовые ящики необходимо перенести в Microsoft 365, создайте пакет миграции с помощью CSV-файла с разделителями-запятыми (CSV). Каждая строка в CSV-файле, используемая Microsoft 365 для запуска миграции, содержит сведения о локальном почтовом ящике. 
  
> [!NOTE]
> Количество почтовых ящиков, которые можно перенести в Microsoft 365 с помощью поэтапной миграции, не ограничено. CSV-файл для пакета миграции может содержать не более 2000 строк. Чтобы перенести более 2000 почтовых ящиков, создайте дополнительные CSV-файлы и используйте каждый из них для создания нового пакета миграции. 
  
 **Поддерживаемые атрибуты**
  
CSV-файл для поэтапной миграции поддерживает три атрибута, которые описаны ниже. Каждая строка в CSV-файле соответствует почтовому ящику и должна содержать значение каждого из этих атрибутов.
  
|**Атрибут**|**Описание**|**Обязательный?**|
|:-----|:-----|:-----|
|EmailAddress  <br/> |Задает основной SMTP-адрес электронной почты, например pilarp@contoso.com, для локальных почтовых ящиков.  <br/> Используйте основной SMTP-адрес для локальных почтовых ящиков, а не идентификаторов пользователей из Microsoft 365. Например, если локальный домен называется contoso.com, но домен электронной почты Microsoft 365 называется service.contoso.com, для адресов электронной почты в CSV-файле следует использовать доменное имя contoso.com.  <br/> |Обязательный  <br/> |
|Password  <br/> |Пароль, заданный для нового почтового ящика Microsoft 365. Все ограничения паролей, применяемые к организации Microsoft 365, также применяются к паролям, включенным в CSV-файл.  <br/> |Необязательный  <br/> |
|ForceChangePassword  <br/> |Указывает, должен ли пользователь изменить пароль при первом входе в новый почтовый ящик Microsoft 365. Задайте для этого параметра значение **True** или **False**. <br/> > [!NOTE]> Если вы внедрили решение единого входа путем развертывания служб федерации Active Directory (AD FS) в локальной организации, для атрибута **ForceChangePassword** необходимо задать значение **False**.          |Необязательный  <br/> |
   
 **Формат CSV-файла**
  
Ниже приведен пример формата CSV-файла. В этом примере три локальных почтовых ящика переносятся в Microsoft 365.
  
В первой строке (строке заголовков CSV-файла) содержатся имена атрибутов или полей, значения которых находятся в последующих строках. Имя каждого атрибута отделяется запятой.
  
```powershell
EmailAddress,Password,ForceChangePassword 
pilarp@contoso.com,Pa$$w0rd,False 
tobyn@contoso.com,Pa$$w0rd,False 
briant@contoso.com,Pa$$w0rd,False 
```

Каждая строка под строкой заголовков представляет одного пользователя и содержит данные, используемые для переноса почтового ящика этого пользователя. Значения атрибутов в каждой строке должны следовать в том же порядке, что и имена атрибутов в строке заголовков. 
  
Создать CSV-файл можно с помощью любого текстового редактора или соответствующего приложения, например Excel. Сохраните файл как CSV- или TXT-файл.
  
> [!NOTE]
> Если CSV-файл содержит знаки, не входящие в ASCII, или специальные символы, сохраните его в кодировке UTF-8 или другой кодировке Юникода. В зависимости от приложения сохранить CSV-файл в кодировке UTF-8 или другой кодировке Юникода может оказаться проще, если язык системы соответствует языку, используемому в CSV-файле. 
  
### <a name="step-3-create-a-migration-endpoint"></a>Шаг 3. Создание конечной точки миграции
<a name="BK_Endpoint"> </a>

Для успешной миграции электронной почты в Microsoft 365 необходимо подключиться к исходной почтовой системе и связаться с ней. Для этого в Microsoft 365 используется конечная точка миграции. Чтобы создать конечную точку миграции мобильного Outlook с помощью PowerShell для поэтапной миграции, сначала [подключитесь к Exchange Online](https://go.microsoft.com/fwlink/p/?LinkId=534121). 
  
Полный список команд миграции см. в статье [Командлеты перемещения и миграции](https://go.microsoft.com/fwlink/p/?LinkId=534750).
  
Чтобы создать конечную точку миграции мобильного Outlook с именем StagedEndpoint в Exchange Online PowerShell, выполните следующие команды.
  
```powershell
$Credentials = Get-Credential
```

```powershell
New-MigrationEndpoint -ExchangeOutlookAnywhere -Name StagedEndpoint -Autodiscover -EmailAddress administrator@contoso.com -Credentials $Credentials
```

Дополнительные сведения о командлете **New-MigrationEndpoint** см. в статье[New-MigrationEndpoint](https://go.microsoft.com/fwlink/p/?LinkId=536437).
  
> [!NOTE]
> С помощью командлета **New-MigrationEndpoint** и параметра **-TargetDatabase** можно указать базу данных, которая будет использоваться службой. В противном случае база данных назначается случайным образом на сайте Службы федерации Active Directory (AD FS) 2.0, на котором расположен почтовый ящик управления.
  
#### <a name="verify-it-worked"></a>Проверка работы

В Exchange Online PowerShell выполните следующую команду, чтобы отобразить сведения о конечной точке миграции StagedEndpoint.
  
```powershell
Get-MigrationEndpoint StagedEndpoint | Format-List EndpointType,ExchangeServer,UseAutoDiscover,Max*
```

### <a name="step-4-create-and-start-a-stage-migration-batch"></a>Шаг 4. Создание и запуск пакета поэтапной миграции
<a name="BK_Endpoint"> </a>

Чтобы создать пакет для прямой миграции, выполните командлет **New-MigrationBatch** в Exchange Online PowerShell. Можно создать пакет миграции и запустить его обработку автоматически, включив параметр _AutoStart_. Кроме того, вы можете создать пакет миграции, а затем вручную запустить его с помощью командлета **Start-MigrationBatch**. В этом примере создается пакет миграции StagedBatch1 и используется конечная точка миграции, созданная на предыдущем шаге.
  
```powershell
New-MigrationBatch -Name StagedBatch1 -SourceEndpoint StagedEndpoint -AutoStart
```

В этом примере также создается пакет миграции StagedBatch1 и используется конечная точка миграции, созданная на предыдущем шаге. Так как параметр  _AutoStart_ не включен, пакет миграции необходимо запустить вручную на панели мониторинга миграции или с помощью командлета **Start-MigrationBatch**. Как было сказано выше, в одно и то же время может существовать только один пакет прямой миграции.
  
```powershell
New-MigrationBatch -Name StagedBatch1 -SourceEndpoint StagedEndpoint
```

#### <a name="verify-it-worked"></a>Проверка работы

Выполните следующую команду в Exchange Online PowerShell, чтобы отобразить сведения о пакете миграции StagedBatch1.
  
```powershell
Get-MigrationBatch -Identity StagedBatch1 | Format-List
```

Вы также можете убедиться, что пакет запущен, выполнив следующую команду.
  
```powershell
Get-MigrationBatch -Identity StagedBatch1 | Format-List Status
```

Дополнительные сведения о командлете **Get-MigrationBatch** см. в статье[Get-MigrationBatch](https://go.microsoft.com/fwlink/p/?LinkId=536441).
  
### <a name="step-5-convert-on-premises-mailboxes-to-mail-enabled-users"></a>Шаг 5. Преобразование локальных почтовых ящиков в учетные записи пользователей, поддерживающих почту
<a name="BK_Endpoint"> </a>

После успешного переноса почтовых ящиков необходимо предоставить пользователям доступ к их почте. Пользователь, чей почтовый ящик был перенесен, теперь имеет локальный почтовый ящик и один из них в Microsoft 365. Пользователи с почтовым ящиком в Microsoft 365 прекратят получать новую почту в своем локальном почтовом ящике. 
  
Так как вы не выполнили миграцию, вы пока не готовы перенаправлены к Microsoft 365 для всех пользователей. Так что же делать с пользователями, у которых есть оба почтовых ящика? Локальные почтовые ящики, которые вы уже перенесли, можно изменить на пользователей, поддерживающих почту. При переходе с почтового ящика на пользователя с включенной поддержкой почты можно направить пользователя в электронную почту в Microsoft 365 вместо того, чтобы перейти к локальному почтовому ящику. 
  
Еще одна важная причина преобразования локальных почтовых ящиков в пользователей с включенной поддержкой почты — хранение адресов прокси-серверов из почтовых ящиков Microsoft 365 путем копирования прокси-адресов в пользователей с включенной поддержкой почты. Это позволит вам управлять облачными пользователями из локальной организации с помощью Active Directory. Кроме того, если вы решили списать локальную организацию Exchange Server после переноса всех почтовых ящиков в Microsoft 365, прокси-адреса, скопированные в пользователей с включенной поддержкой почты, останутся в локальной службе Active Directory.
    
### <a name="step-6-delete-a-staged-migration-batch"></a>Шаг 6. Удаление пакета поэтапной миграции
<a name="BK_Endpoint"> </a>

 После успешного переноса всех почтовых ящиков из пакета миграции и преобразования локальных почтовых ящиков из пакета в учетные записи пользователей, поддерживающих почту, пакет поэтапной миграции можно удалить. Обязательно убедитесь, что почта перенаправляется в почтовые ящики Microsoft 365 в пакете миграции. При удалении пакета поэтапной миграции служба миграции удаляет все записи, связанные с пакетом, а также сам пакет.
  
Чтобы удалить пакет миграции StagedBatch1 в Exchange Online PowerShell, выполните следующую команду.
  
```powershell
Remove-MigrationBatch -Identity StagedBatch1
```

Дополнительные сведения о командлете **Remove-MigrationBatch** см. в статье[Remove-MigrationBatch](https://go.microsoft.com/fwlink/p/?LinkId=536481).
  
#### <a name="verify-it-worked"></a>Проверка работы

Выполните следующую команду в Exchange Online PowerShell, чтобы отобразить сведения о пакете миграции IMAPBatch1.
  
```powershell
Get-MigrationBatch StagedBatch1
```

Команда либо вернет пакет миграции с состоянием **Удаление**, либо вернет ошибку (не удалось найти пакет миграции), что подтверждает удаление пакета миграции.
  
Дополнительные сведения о командлете **Get-MigrationBatch** см. в статье[Get-MigrationBatch](https://go.microsoft.com/fwlink/p/?LinkId=536441).
  
### <a name="step7-assign-licenses-to-microsoft-365-users"></a>Step7: Назначение лицензий пользователям Microsoft 365
<a name="BK_Endpoint"> </a>

Активируйте учетные записи пользователей Microsoft 365 для мигрировавших учетных записей, назначая лицензии. Если не назначить лицензию, почтовый ящик отключится по окончании льготного периода (30 дней). Чтобы назначить лицензию в центре администрирования Microsoft 365, ознакомьтесь со статьей [назначение и отмена назначения лицензий](https://docs.microsoft.com/microsoft-365/admin/manage/assign-licenses-to-users).
  
### <a name="step-8-complete-post-migration-tasks"></a>Шаг 8. Необходимые действия после миграции
<a name="BK_Postmigration"> </a>

- **Создайте DNS-запись автообнаружения, чтобы пользователи смогли с легкостью получить доступ к своим почтовым ящикам.** После переноса всех локальных почтовых ящиков в Microsoft 365 вы можете настроить запись DNS службы автообнаружения для организации Microsoft 365, чтобы пользователи могли легко подключаться к новым почтовым ящикам Microsoft 365 с Outlook и мобильными клиентами. Эта новая запись DNS автообнаружения должна использовать то же пространство имен, которое вы используете для вашей организации Microsoft 365. Например, если пространство имен облачной службы имеет значение cloud.contoso.com, необходимо создать запись DNS автообнаружения autodiscover.cloud.contoso.com.
    
    В Microsoft 365 для реализации службы автообнаружения для клиентов Outlook и мобильных устройств используется запись CNAME. Запись CNAME автообнаружения должна содержать следующие сведения:
    
  - **Псевдоним:** autodiscover
    
  - **Целевой объект:** autodiscover.outlook.com
    
    Дополнительные сведения см. [в статье Добавление DNS-записей для подключения к домену](https://go.microsoft.com/fwlink/p/?LinkId=535028).
    
- **Спишите локальные сервера Exchange.** После проверки того, что вся электронная почта направляется непосредственно в почтовые ящики Microsoft 365, и вам больше не нужна поддержка локальной организации электронной почты или не планируется внедрять решение единого входа, вы можете удалить Exchange с серверов и удалить локальную организацию Exchange.
    
    Дополнительные сведения см. в следующих статьях:
    
  - [Изменение или удаление Exchange 2010](https://go.microsoft.com/fwlink/?LinkId=217936)
    
  - [Удаление организации Exchange 2007](https://go.microsoft.com/fwlink/?LinkID=100485)
    
  - [Удаление сервера Exchange Server 2003](https://go.microsoft.com/fwlink/?LinkID=56561)
    

