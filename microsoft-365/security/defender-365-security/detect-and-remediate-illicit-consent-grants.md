---
title: Обнаружение и исправление незаконных грантов на согласие
f1.keywords:
- NOCSH
ms.author: tracyp
author: MSFTTracyp
manager: dansimp
ms.date: ''
audience: ITPro
ms.topic: article
ms.collection:
- o365_security_incident_response
- M365-security-compliance
localization_priority: Normal
search.appverid:
- MET150
description: Узнайте, как распознавать и устранять атаку незаконных грантов на согласие в Microsoft Office 365.
ms.custom: seo-marvel-apr2020
ms.technology: mdo
ms.prod: m365-security
ms.openlocfilehash: 4a9b3ff11acb32a4b3038cc18922f8e22fda0b4c
ms.sourcegitcommit: 956176ed7c8b8427fdc655abcd1709d86da9447e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/23/2021
ms.locfileid: "51070029"
---
# <a name="detect-and-remediate-illicit-consent-grants"></a>Обнаружение и исправление незаконных грантов на согласие

[!INCLUDE [Microsoft 365 Defender rebranding](../includes/microsoft-defender-for-office.md)]

**Область применения**
- [Microsoft Defender для Office 365 (план 1 и план 2)](defender-for-office-365.md)
- [Microsoft 365 Defender](../defender/microsoft-365-defender.md)

**Сводка**  Узнайте, как распознавать и устранять атаку незаконных грантов согласия в Office 365.

## <a name="what-is-the-illicit-consent-grant-attack-in-office-365"></a>What is the illicit consent grant attack in Office 365?

В случае незаконной атаки на предоставление согласия злоумышленник создает приложение, зарегистрированное в Azure, которое запрашивает доступ к таким данным, как контактные данные, электронная почта или документы. Затем злоумышленник угостит конечного пользователя предоставлением этому приложению согласия на доступ к своим данным либо с помощью фишинговой атаки, либо путем внесения незаконного кода в надежный веб-сайт. После того как незаконному приложению было предоставлено согласие, он имеет доступ к данным на уровне учетной записи без необходимости организации учетной записи. Обычные действия по исправлению, такие как сброс паролей для взлома учетных записей или требование многофакторной проверки подлинности (MFA) на учетных записях, не эффективны для этого типа атаки, так как это сторонние приложения и внешние для организации.

Эти атаки используют модель взаимодействия, которая предполагает, что вызываемая информация является автоматизацией, а не человеком.

> [!IMPORTANT]
> Вы подозреваете, что у вас возникли проблемы с незаконными грантами на согласие из приложения, прямо сейчас? Microsoft Cloud App Security (MCAS) имеет средства обнаружения, расследования и исправлений приложений OAuth. В этой статье MCAS описаны инструкции по расследованию рискованных приложений [OAuth.](/cloud-app-security/investigate-risky-oauth) Вы также можете установить политики приложений [OAuth](/cloud-app-security/app-permission-policy) для изучения разрешений, запрашиваемого приложениями, которые пользователи разрешают эти приложения, и широко утверждать или запрещать эти запросы разрешений.

## <a name="what-does-an-illicit-consent-grant-attack-look-like-in-office-365"></a>Как выглядит атака незаконного предоставления согласия в Office 365?

Чтобы найти признаки  этой атаки, также называемые Индикаторы компромисса (МОК), необходимо искать журнал аудита. Для организаций с большим количеством зарегистрированных в Azure приложений и большой пользовательской базой, лучше всего еженедельно пересматривать гранты на согласие организаций.

### <a name="steps-for-finding-signs-of-this-attack"></a>Действия по обнаружению признаков этой атаки

1. Откройте Центр **соответствия требованиям & безопасности** в <https://protection.office.com> .

2. Перейдите к **поиску** и выберите **поиск журнала аудита.**

3. Поиск (все действия и все пользователи) и введите дату начала и даты окончания, если требуется, а затем нажмите **кнопку Поиск**.

4. Нажмите **кнопку Фильтр результатов** и введите согласие на применение в **поле Действия.**

5. Нажмите на результат, чтобы узнать подробности действия. Щелкните **дополнительные сведения,** чтобы получить сведения о действии. Проверьте, задает ли IsAdminContent true.

> [!NOTE]
>
> Для отображения соответствующей записи журнала аудита в результатах поиска после события может занять от 30 минут до 24 часов.
>
> Срок сохранения записи аудита и поиска в журнале аудита зависит от подписки Microsoft 365, а именно от типа лицензии, назначенной конкретному пользователю. Дополнительные сведения см. в [журнале Аудит.](../../compliance/search-the-audit-log-in-security-and-compliance.md)
>
> Если это значение верно, это указывает на то, что кто-то с глобальным доступом администратора мог предоставить широкий доступ к данным. Если это непредвиденное, примите меры [для подтверждения атаки.](#how-to-confirm-an-attack)

## <a name="how-to-confirm-an-attack"></a>Подтверждение атаки

Если выше указан один или несколько экземпляров IOCs, необходимо дополнительно исследовать, чтобы положительно подтвердить, что атака произошла. Для подтверждения атаки можно использовать любой из этих трех методов:

- Приложения инвентаризации и их разрешения с помощью портала Azure Active Directory. Этот метод является тщательным, но вы можете проверить только одного пользователя в то время, которое может быть очень много времени, если у вас есть много пользователей, чтобы проверить.

- Приложения инвентаризации и их разрешения с помощью PowerShell. Это самый быстрый и тщательный метод с наименьшим количеством накладных расходов.

- Убедитесь, что пользователи лично проверяют свои приложения и разрешения и сообщают о полученных результатах администраторам для устранения последствий.

## <a name="inventory-apps-with-access-in-your-organization"></a>Инвентаризация приложений с доступом в организации

Это можно сделать для пользователей с помощью портала Azure Active Directory или PowerShell или индивидуального переустановки доступа к приложениям.

### <a name="steps-for-using-the-azure-active-directory-portal"></a>Действия по использованию портала Azure Active Directory

Вы можете искать приложения, которым каждый пользователь предоставил разрешения с помощью портала [Azure Active Directory.](https://portal.azure.com/)

1. Вход на портал Azure с административными правами.

2. Выберите лезвие Azure Active Directory.

3. Выберите пункт **Пользователи**.

4. Выберите пользователя, который необходимо просмотреть.

5. Выбор **приложений**.

В этом документе покажут приложения, которые назначены пользователю, и какие разрешения имеют приложения.

### <a name="steps-for-having-your-users-enumerate-their-application-access"></a>Действия, необходимые для того, чтобы пользователи переумеяли доступ к приложениям

Чтобы пользователи перейти https://myapps.microsoft.com к ним и просмотреть собственный доступ к приложению. Они должны иметь возможность просматривать все приложения с доступом, просматривать сведения о них (в том числе область доступа) и отоискить привилегии для подозрительных или незаконных приложений.

### <a name="steps-for-doing-this-with-powershell"></a>Действия для этого с Помощью PowerShell

Самый простой способ проверки атаки незаконного гранта на согласие — выполнить [Get-AzureADPSPermissions.ps1, ](https://gist.github.com/psignoret/41793f8c6211d2df5051d77ca3728c09)которая сбросит все гранты на согласие OAuth и приложения OAuth для всех пользователей в вашем аренде в один файл CSV.

#### <a name="pre-requisites"></a>Необходимые условия

- Установлена библиотека PowerShell Azure AD.

- Права глобального администратора на клиента, с чем будет работать сценарий.

- Локальный администратор на компьютере, с которого будут запускаться сценарии.

> [!IMPORTANT]
> Настоятельно ***рекомендуется требовать*** многофакторной проверки подлинности в административной учетной записи. Этот скрипт поддерживает проверку подлинности MFA.

1. Во входе на компьютер, на который будет запускаться сценарий с правами местного администратора.

2. Скачайте или [ скопируйтеGet-AzureADPSPermissions.ps1](https://gist.github.com/psignoret/41793f8c6211d2df5051d77ca3728c09) из GitHub в папку, из которой будет запускаться сценарий. Это будет та же папка, в которую будет permissions.csv".

3. Откройте экземпляр PowerShell в качестве администратора и откройте папку, в которая сохранен сценарий.

4. Подключись к каталогу с помощью [комлета Connect-AzureAD.](/powershell/module/azuread/connect-azuread)

5. Запустите эту команду PowerShell:

   ```powershell
   Get-AzureADPSPermissions.ps1 | Export-csv -Path "Permissions.csv" -NoTypeInformation
   ```

Скрипт создает один файл с именем Permissions.csv. Выполните следующие действия, чтобы найти незаконные гранты разрешений на приложения:

1. В столбце ConsentType (столбец G) поиск значения "AllPrinciples". Разрешение AllPrincipals позволяет клиентской приложению получать доступ к содержимому каждого в аренде. Для правильной работы приложениям Microsoft 365 необходимо это разрешение. Каждое приложение, не в microsoft с таким разрешением, должно быть тщательно рассмотрено.

2. В столбце Разрешения (столбец F) просмотрите разрешения, которые каждое делегированное приложение должно содержимым. Обратите внимание на разрешения "Чтение" и "Написать" или "*. Все" разрешения и внимательно просмотрите их, так как они могут быть не подходящими.

3. Просмотрите конкретные пользователи, у них есть предоставленные разрешения. Если у пользователей с высоким профилем или с высоким влиянием имеются недопустимые разрешения, следует изучить далее.

4. В столбце ClientDisplayName (столбец C) искать приложения, которые кажутся подозрительными. Приложения с именами с ошибками, именами с ошибками или именами, звучаными хакерами, должны быть тщательно рассмотрены.

## <a name="determine-the-scope-of-the-attack"></a>Определение области атаки

После завершения доступа к приложениям для  инвентаризации просмотрите журнал аудита, чтобы определить полный объем нарушения. Поиск пострадавших пользователей, сроки доступа незаконного приложения к организации и разрешения, которые у приложения были. Журнал **аудита** можно найти в Центре безопасности и соответствия требованиям [Microsoft 365.](../../compliance/search-the-audit-log-in-security-and-compliance.md)

> [!IMPORTANT]
> [Аудит почтовых ящиков](../../compliance/enable-mailbox-auditing.md) и аудит действий для администраторов и пользователей должны быть включены до атаки, чтобы вы могли получить эту информацию. [](../../compliance/turn-audit-log-search-on-or-off.md)

## <a name="how-to-stop-and-remediate-an-illicit-consent-grant-attack"></a>Как остановить и поправить атаку незаконного предоставления согласия

После того как вы определили приложение с незаконными разрешениями, у вас есть несколько способов удалить этот доступ.

- Вы можете отопросить разрешение приложения на портале Azure Active Directory по:

  - Перейдите к пострадавшему пользователю в лезвии **Пользователя Azure Active Directory.**

  - Выбор **приложений**.

  - Выберите незаконное приложение.

  - Нажмите **Кнопку Удалить** в упражнении вниз.

- Вы можете отоперить грант на согласие OAuth в PowerShell, следуя шагам в [Remove-AzureADOAuth2PermissionGrant](/powershell/module/azuread/Remove-AzureADOAuth2PermissionGrant).

- Вы можете отогнать назначение роли приложения-службы в PowerShell, следуя шагам в [Remove-AzureADServiceAppRoleAssignment.](/powershell/module/azuread/Remove-AzureADServiceAppRoleAssignment)

- Вы также можете отключить вход для пострадавшей учетной записи вообще, что в свою очередь отключит доступ приложения к данным в этой учетной записи. Это не идеально для производительности конечного пользователя, конечно, но если вы работаете, чтобы ограничить влияние быстро, это может быть жизнеспособным краткосрочным исправлением.

- Вы можете отключить интегрированные приложения для аренды. Это резкий шаг, который отключает возможность для конечных пользователей предоставлять согласие на основе клиента. Это не позволяет пользователям непреднамеренно предоставлять доступ к вредоносному приложению. Это не рекомендуется, так как это серьезно снижает производительность ваших пользователей в сторонних приложениях. Вы можете сделать это, следуя шагам в повороте интегрированных [приложений на или выключение](../../admin/misc/user-consent.md).

## <a name="secure-microsoft-365-like-a-cybersecurity-pro"></a>Защитите Microsoft 365 на профессиональном уровне

Для вашей подписки Microsoft 365 предусмотрен целый ряд полезных функций безопасности, которые можно использовать для защиты ваших данных и пользователей. Используйте статью к [Стратегия развития безопасности Microsoft 365: приоритеты на первые 30 дней, 90 дней и далее](security-roadmap.md), чтобы применить лучшие методики, рекомендованные корпорацией Майкрософт, для защиты вашего клиента Microsoft 365.

- Задачи для выполнения в первые 30 дней. Они дают немедленный эффект и не создают помех вашим пользователям.

- Задачи для выполнения в течение 90 дней. Эти задачи требуют немного больше времени на планирование и реализацию, но значительно укрепляют вашу безопасность.

- Более 90 дней. Эти меры дополняют ваши действия в течение первых 90 дней.

## <a name="see-also"></a>См. также:

- [Неожиданное приложение в списке](/azure/active-directory/application-access-unexpected-application) приложений проходит администраторам с помощью различных действий, которые они могут захоть принять после того, как поймем, что есть неожиданные приложения с доступом к данным.

- [Интеграция приложений с Azure Active Directory](/azure/active-directory/active-directory-apps-permissions-consent) — это обзор согласия и разрешений на высоком уровне.

- [Проблемы, связанные с разработкой приложения,](/azure/active-directory/active-directory-application-dev-development-content-map) предоставляют ссылки на различные статьи, связанные с согласием.

- Основные объекты приложений и служб [в Azure Active Directory (Azure AD)](/azure/active-directory/develop/active-directory-application-objects) предоставляют обзор основных объектов приложений и служб, которые являются ключевыми для модели приложений.

- [Управление доступом к приложениям](/azure/active-directory/active-directory-managing-access-to-apps) — это обзор возможностей, которые администраторы должны управлять доступом пользователей к приложениям.