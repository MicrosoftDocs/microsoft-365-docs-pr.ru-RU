---
title: Создание и управление пользовательскими правилами обнаружения в Microsoft 365 Defender
description: Узнайте, как создавать и управлять пользовательскими правилами обнаружения на основе расширенных запросов на охоту
keywords: передовая охота, охота на угрозы, охота на киберугрозы, защита от угроз Майкрософт, Microsoft 365, mtp, m365, поиск, запрос, телеметрия, пользовательские обнаружения, правила, схема, кусто, Microsoft 365, Microsoft Threat Protection, RBAC, разрешения, ATP Защитника Майкрософт
search.product: eADQiWindows 10XVcnh
search.appverid: met150
ms.prod: m365-security
ms.mktglfcycl: deploy
ms.sitesec: library
ms.pagetype: security
f1.keywords:
- NOCSH
ms.author: maccruz
author: schmurky
localization_priority: Normal
manager: dansimp
audience: ITPro
ms.collection:
- M365-security-compliance
- m365initiative-m365-defender
ms.topic: article
ms.technology: m365d
ms.openlocfilehash: 220e4e6546899dd00f3a02bf83039a928be4f8dc
ms.sourcegitcommit: 582555d2b4ef5f2e2494ffdeab2c1d49e5d6b724
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/01/2021
ms.locfileid: "51498848"
---
# <a name="create-and-manage-custom-detections-rules"></a>Создание и управление пользовательскими правилами обнаружения

[!INCLUDE [Microsoft 365 Defender rebranding](../includes/microsoft-defender.md)]


**Область применения:**
- Microsoft 365 Defender

Настраиваемые правила обнаружения — это правила, которые можно разработать и настроить с помощью [расширенных запросов](advanced-hunting-overview.md) на охоту. Эти правила позволяет активно отслеживать различные события и состояния системы, в том числе предполагаемые нарушения и неправильные конечные точки. Вы можете настроить их для запуска с регулярными интервалами, создавая оповещения и принимая ответные действия при совпадениях.

## <a name="required-permissions-for-managing-custom-detections"></a>Необходимые разрешения для управления пользовательскими обнаружениями

Чтобы управлять пользовательскими обнаружениями, вам должна быть назначена одна из этих ролей:

- **Администратор безопасности**— пользователи с этой ролью [Azure Active Directory](/azure/active-directory/users-groups-roles/directory-assign-admin-roles#security-administrator) могут управлять настройками безопасности в центре безопасности Microsoft 365 и других порталах и службах.

- **Оператор безопасности**— Пользователи с этой ролью [Azure Active Directory](/azure/active-directory/users-groups-roles/directory-assign-admin-roles#security-administrator) могут управлять оповещениями и иметь глобальный доступ только для чтения к функциям, связанным с безопасностью, включая всю информацию в центре безопасности Microsoft 365. Эта роль достаточна для управления пользовательскими обнаружениями только в том случае, если управление доступом на основе ролей (RBAC) отключено в Microsoft Defender для endpoint. Если настроена RBAC, необходимо также  разрешение на управление настройками безопасности для Defender для конечной точки.

Чтобы управлять требуемой разрешениями, **глобальный администратор** может:

- **Назначьте администратору безопасности** или **оператору** безопасности роль в центре администрирования [Microsoft 365](https://admin.microsoft.com/) под руководством **администратора**  >  **службы безопасности ролей.**
- Проверьте параметры RBAC для Защитника Майкрософт для конечной точки в Центре безопасности [Защитника Майкрософт](https://securitycenter.windows.com/) в роли **параметров**  >    >  **разрешений.** Выберите соответствующую роль, чтобы назначить **разрешение на управление настройками безопасности.**

> [!NOTE]
> Для управления пользовательскими  обнаружениями операторам  безопасности потребуется разрешение на управление настройками безопасности в Microsoft Defender для конечной точки, если включен RBAC.

## <a name="create-a-custom-detection-rule"></a>Создание настраиваемой нормы обнаружения
### <a name="1-prepare-the-query"></a>1. Подготовка запроса.

В центре безопасности Microsoft 365 перейдите в **расширенный** поиск и выберите существующий запрос или создайте новый запрос. При использовании нового запроса запустите запрос для выявления ошибок и понимания возможных результатов.

>[!IMPORTANT]
>Чтобы служба не возвращала слишком много оповещений, каждое правило ограничивается созданием только 100 оповещений при каждом запуске. Перед созданием правила необходимо настроить запрос, чтобы не предупреждать о нормальной ежедневной активности.


#### <a name="required-columns-in-the-query-results"></a>Необходимые столбцы в результатах запроса
Чтобы создать настраиваемую норму обнаружения, запрос должен вернуть следующие столбцы:

- `Timestamp`— используется для набора времени для генерируемых оповещений
- `ReportId`— позволяет искать исходные записи
- Один из следующих столбцов, определяя конкретные устройства, пользователей или почтовые ящики:
    - `DeviceId`
    - `DeviceName`
    - `RemoteDeviceName`
    - `RecipientEmailAddress`
    - `SenderFromAddress` (отправитель конверта или Return-Path адрес)
    - `SenderMailFromAddress` (адрес отправитель, отображаемый клиентом электронной почты)
    - `RecipientObjectId`
    - `AccountObjectId`
    - `AccountSid`
    - `AccountUpn`
    - `InitiatingProcessAccountSid`
    - `InitiatingProcessAccountUpn`
    - `InitiatingProcessAccountObjectId`

>[!NOTE]
>Поддержка дополнительных сущностям будет добавлена по мере того, как новые таблицы будут добавлены в [расширенный схему охоты.](advanced-hunting-schema-tables.md)

Простые запросы, например запросы, которые не используют оператор или оператор для настройки или агрегированных результатов, обычно возвращают `project` `summarize` эти общие столбцы.

Существуют различные способы обеспечения более сложных запросов, возвращая эти столбцы. Например, если вы предпочитаете агрегировать и считать по сущности в столбце, например, вы можете вернуться и получить его из последнего события с участием каждого `DeviceId` `Timestamp` `ReportId` уникального `DeviceId` .

В приведенной ниже примере запросов подсчитываются количество уникальных устройств () с обнаружениями антивирусов и используется этот подсчет, чтобы найти только устройства с более чем `DeviceId` пятью обнаружениями. Чтобы вернуть последнюю и `Timestamp` `ReportId` соответствующую, он использует оператора с `summarize` `arg_max` функцией.

```kusto
DeviceEvents
| where Timestamp > ago(1d)
| where ActionType == "AntivirusDetection"
| summarize (Timestamp, ReportId)=arg_max(Timestamp, ReportId), count() by DeviceId
| where count_ > 5
```

> [!TIP]
> Для улучшения производительности запроса установите фильтр времени, который соответствует вашей назначенной частоте выполнения для правила. Так как наименее частый запуск происходит _каждые 24_ часа, фильтрация за прошедший день будет охватывать все новые данные.

### <a name="2-create-new-rule-and-provide-alert-details"></a>2. Создайте новое правило и укажу сведения об оповещении.

С помощью запроса в редакторе запроса выберите **правило Создать** обнаружение и укажите следующие сведения оповещения:

- **Имя обнаружения**— имя правила обнаружения
- **Частота**— интервал для выполнения запроса и принятия действий. [Дополнительные рекомендации см. ниже](#rule-frequency)
- **Предупреждение название**— заголовок, отображаемый с оповещениями, инициированными правилом
- **Серьезность**— потенциальный риск компонента или действия, определяемого правилом
- **Категория —** компонент угрозы или действия, которые определены правилом
- **MITRE ATT&CK techniques**—one or more attack techniques identified by the rule as documented in the [MITRE ATT&CK framework](https://attack.mitre.org/). Этот раздел скрыт для определенных категорий оповещений, в том числе вредоносных программ, программ-вымогателей, подозрительных действий и нежелательного программного обеспечения
- **Описание**— дополнительные сведения о компоненте или действии, выявленных правилом 
- **Рекомендуемые действия**— дополнительные действия, которые могут приниматься ответчиками в ответ на предупреждение

#### <a name="rule-frequency"></a>Частота правил
При сохранения нового правила выполняется проверка совпадений с данными за последние 30 дней. Затем правило выполняется снова с фиксированными интервалами, применяя длительность обратного воспроизведения в зависимости от частоты, которая вы выбираете:

- **Каждые 24 часа**— выполняется каждые 24 часа, проверяя данные за последние 30 дней
- **Каждые 12 часов**— выполняется каждые 12 часов, проверяя данные за последние 24 часа
- **Каждые 3 часа**— выполняется каждые 3 часа, проверяя данные за последние 6 часов
- **Каждый** час — выполняется почасовая проверка данных за последние 2 часа.

При редактировании правила оно будет работать с примененными изменениями в следующем времени запуска, запланированном в соответствии с заявной частотой.



>[!TIP]
> Соответствие фильтрам времени в запросе с длительностью отката. Результаты за пределами длительности поиска игнорируются.  

Выберите частоту, которая соответствует точному мониторингу обнаружения. Рассмотрите возможности организации для реагирования на оповещения.

### <a name="3-choose-the-impacted-entities"></a>3. Выберите сущностями с влиянием.
Определите столбцы в результатах запроса, в которых ожидается найти основную затронутую или затрагиваемую сущность. Например, запрос может возвращать адреса отправитель `SenderFromAddress` (или) и `SenderMailFromAddress` `RecipientEmailAddress` получатель (). Определение того, какие из этих столбцов представляют основную объектную сущность, помогает службе агрегировать соответствующие оповещения, соотносить инциденты и целевые действия реагирования.

Для каждого типа сущности (почтовый ящик, пользователь или устройство) можно выбрать только один столбец. Столбцы, не возвращенные запросом, не могут быть выбраны.

### <a name="4-specify-actions"></a>4. Укажите действия.
Ваше пользовательское правило обнаружения может автоматически принимать действия на устройствах, файлах или пользователях, возвращаемые запросом.

#### <a name="actions-on-devices"></a>Действия на устройствах
Эти действия применяются к устройствам в `DeviceId` столбце результатов запроса:
- **Изолировать устройство**— использует Microsoft Defender для конечной точки, чтобы применять полную изоляцию сети, не мешая устройству подключаться к любому приложению или службе. [Дополнительные информацию об изоляции компьютера с конечными точками в Microsoft Defender для конечных точек](/windows/security/threat-protection/microsoft-defender-atp/respond-machine-alerts#isolate-devices-from-the-network)
- **Сбор пакета исследований**— сбор сведений об устройствах в файле ZIP. [Дополнительные информацию о пакете исследований Microsoft Defender для конечной точки](/windows/security/threat-protection/microsoft-defender-atp/respond-machine-alerts#collect-investigation-package-from-devices)
- **Запуск антивирусного сканирования**— выполняет полное Защитник Windows антивирусное сканирование на устройстве
- **Инициировать** расследование — [инициирует автоматическое расследование](m365d-autoir.md) на устройстве
- **Ограничение выполнения приложения**— устанавливает ограничения для устройства, позволяющее запускать только те файлы, которые подписаны сертификатом, выданным Корпорацией Майкрософт. [Дополнительные новости об ограничениях приложений в Microsoft Defender для конечной точки](/microsoft-365/security/defender-endpoint/respond-machine-alerts#restrict-app-execution)

#### <a name="actions-on-files"></a>Действия в файлах
При выборе можно применить действие  карантиного файла к файлам в столбце , или столбце `SHA1` `InitiatingProcessSHA1` `SHA256` `InitiatingProcessSHA256` результатов запроса. Это действие удаляет файл из текущего расположения и помещает копию в карантин.

#### <a name="actions-on-users"></a>Действия для пользователей
При выборе пользователь Mark как **скомпрометированное** действие будет приниматься для пользователей в столбце или столбце `AccountObjectId` `InitiatingProcessAccountObjectId` `RecipientObjectId` результатов запроса. Это действие задает пользователям уровень риска до "высокого" в Azure Active Directory, запуская соответствующие [политики защиты удостоверений.](/azure/active-directory/identity-protection/overview-identity-protection)

> [!NOTE]
> Действие разрешить или заблокировать для пользовательских правил обнаружения в настоящее время не поддерживается в Microsoft 365 Defender.

### <a name="5-set-the-rule-scope"></a>5. Установите область правил.
Установите область, чтобы указать, какие устройства охвачены правилом. Область влияет на правила проверки устройств и не влияет на правила, которые проверяют только почтовые ящики и учетные записи пользователей или удостоверения.

При настройке области можно выбрать:

- Все устройства
- Конкретные группы устройств

Запрашиваются только данные с устройств в области. Кроме того, действия будут приниматься только на этих устройствах.

### <a name="6-review-and-turn-on-the-rule"></a>6. Просмотрите и включите правило.
После просмотра правила выберите **Создать, чтобы** сохранить его. Правило настраиваемой диагностики немедленно запускается. Он снова запускается на основе настроенной частоты для проверки совпадений, создания оповещений и реагировать на действия.


>[!Important] 
>Настраиваемые обнаружения следует регулярно проверять на эффективность и эффективность. Чтобы убедиться, что вы создаете обнаружения, которые вызывают истинные оповещения, необходимо время, чтобы просмотреть существующие пользовательские обнаружения, следуя шагам в управлении существующими пользовательскими [правилами обнаружения.](#manage-existing-custom-detection-rules) <br>  
Вы поддерживаете контроль над широкостью или спецификой настраиваемых обнаружений, поэтому любые ложные оповещения, созданные пользовательскими обнаружениями, могут указывать на необходимость изменения определенных параметров правил.


## <a name="manage-existing-custom-detection-rules"></a>Управление существующими пользовательскими правилами обнаружения
Вы можете просмотреть список существующих пользовательских правил обнаружения, проверить их предыдущие запуски и просмотреть оповещения, которые они вызвали. Вы также можете запустить правило по запросу и изменить его.

### <a name="view-existing-rules"></a>Просмотр существующих правил

Чтобы просмотреть все существующие пользовательские правила обнаружения, перейдите к **обнаружениям Hunting**  >  **Custom.** На странице перечислены все правила со следующими сведениями о запуске:

- **Последний запуск**— при последнем запуске правила для проверки совпадений запросов и создания оповещений
- **Состояние последнего запуска**— успешно ли выполнило правило
- **Следующий запуск**— следующий запланированный запуск
- **Состояние**— независимо от того, включено или отключено правило

### <a name="view-rule-details-modify-rule-and-run-rule"></a>Просмотр сведений о правилах, изменение правила и правила запуска

Чтобы просмотреть всестороннюю информацию о настраиваемом правиле обнаружения, перейдите к **обнаружению Hunting** Custom и выберите  >   имя правила. Затем можно просмотреть общие сведения о правиле, включая сведения о состоянии и области запуска. На странице также содержится список срабатывуемого оповещений и действий.

![Страница пользовательских сведений о правилах обнаружения](../../media/custom-detection-details.png)<br>
*Пользовательские сведения о правилах обнаружения*

На этой странице также можно принять следующие действия по правилу:

- **Запустите**— запустите правило немедленно. Это также сбрасывает интервал для следующего запуска.
- **Изменение**— изменение правила без изменения запроса
- **Изменение запроса**— изменение запроса в продвинутой охоте
- **Включаем**  /  **Отключите** правило или остановите его работу
- **Удаление**— отключите правило и удалите его

### <a name="view-and-manage-triggered-alerts"></a>Просмотр и управление срабатывными оповещениями

На экране сведений правила **(Hunting**  >  **Custom detections**[Rule name] ) перейдите к триггерным оповещениям, в которых перечислены оповещения, созданные совпадениями,  >  к правилу.  Выберите оповещение, чтобы просмотреть подробные сведения о нем и принять следующие действия:

- Управление оповещением путем настройки его состояния и классификации (true или false alert)
- Ссылка оповещений на инцидент
- Запустите запрос, который вызвал оповещение при продвинутой охоте

### <a name="review-actions"></a>Проверка действий
В экране сведений правила **(Hunting**  >  **Custom detections**  >  **[Rule name]),** перейдите к **triggered actions**, в котором перечислены действия, принятые на основе совпадений с правилом.

>[!TIP]
>Чтобы быстро просмотреть сведения и принять меры по элементу в таблице, используйте столбец выбора [&#10003;] слева от таблицы.

## <a name="see-also"></a>См. также
- [Обзор настраиваемых обнаружений](custom-detections-overview.md)
- [Обзор расширенной охоты](advanced-hunting-overview.md)
- [Познакомьтесь с языком запросов расширенной охоты](advanced-hunting-query-language.md)
- [Перенос расширенных запросов на охоту из Microsoft Defender для конечной точки](advanced-hunting-migrate-from-mde.md)
