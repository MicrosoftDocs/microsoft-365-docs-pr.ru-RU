---
title: Как SPF предотвращает спуфинг
f1.keywords:
- CSH
ms.author: tracyp
author: MSFTTracyP
manager: dansimp
ms.date: 12/15/2016
audience: ITPro
ms.topic: article
localization_priority: Normal
search.appverid:
- MET150
ms.assetid: 3aff33c5-1416-4867-a23b-e0c0c5b4d2be
ms.collection:
- M365-security-compliance
ms.custom:
- seo-marvel-apr2020
description: Узнайте, как Microsoft 365 использует запись SPF TXT в DNS, чтобы гарантировать, что почтовые системы назначения доверяют сообщениям, отправленным из вашего пользовательского домена.
ms.technology: mdo
ms.prod: m365-security
ms.openlocfilehash: daf170339f4a218c404114f9c82b1d465779100d
ms.sourcegitcommit: 786f90a163d34c02b8451d09aa1efb1e1d5f543c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/18/2021
ms.locfileid: "50286872"
---
# <a name="how-microsoft-365-uses-sender-policy-framework-spf-to-prevent-spoofing"></a>Как Microsoft 365 использует инфраструктуру политики отправителей (SPF) для предотвращения спуфинга

[!INCLUDE [Microsoft 365 Defender rebranding](../includes/microsoft-defender-for-office.md)]

**Область применения**
- [Exchange Online Protection](exchange-online-protection-overview.md)
- [Microsoft Defender для Office 365 (план 1 и план 2)](office-365-atp.md)
- [Microsoft 365 Defender](../mtp/microsoft-threat-protection.md)

 **Сводка:** В этой статье описывается, как Microsoft 365 использует запись SPF TXT в DNS, чтобы гарантировать, что почтовые системы назначения доверяют сообщениям, отправленным из вашего пользовательского домена. Это относится к исходящие сообщения, отправленные из Microsoft 365. Сообщения, отправленные из Microsoft 365 получателю в Microsoft 365, всегда проходят через SPF.

Запись TXT инфраструктуры политики отправителей  это запись DNS, которая помогает предотвратить спуфинг и фишинг путем проверки доменного имени, с которого отправляются сообщения. Инфраструктура политики отправителей проверяет источники сообщений, сверяя IP-адрес отправителя с предполагаемым владельцем отправляющего домена.

> [!NOTE]
> Рабочая группа IETF признала типы записей SPF устаревшими в 2014 г. Вместо них для публикации данных инфраструктуры политики отправителей необходимо использовать записи TXT в службе DNS. Далее в этой статье для простоты используется термин "запись SPF TXT".

Администраторы доменов публикуют данные инфраструктуры политики отправителей в записях типа TXT в DNS. Эти данные позволяют определить уполномоченные серверы исходящей почты. В свою очередь, конечные почтовые системы проверяют, были ли сообщения отправлены уполномоченными серверами исходящей почты. Если вы уже знакомы с SPF или имеете простое развертывание и просто хотите знать, что следует включить в запись SPF TXT в DNS для Microsoft 365, вы можете перейти к [настройкам SPF в Microsoft 365,](set-up-spf-in-office-365-to-help-prevent-spoofing.md)чтобы предотвратить спуфинг. Если у вас нет развертывания, которое полностью размещено в Microsoft 365, или вам нужны дополнительные сведения о работе SPF или устранении неполадок с SPF для Microsoft 365, читайте дальше.

> [!NOTE]
> Раньше, если вы также использовали SharePoint Online, в личный домен нужно было добавить другую запись SPF TXT. Этого больше не требуется. Это изменение необходимо для того, чтобы уведомления SharePoint Online не попадали в папку нежелательной почты. Сразу вносить изменения не нужно, но если вы получили сообщение об ошибке "слишком много подстановок", измените запись SPF TXT, как описано в описании в [настройках SPF в Microsoft 365,](set-up-spf-in-office-365-to-help-prevent-spoofing.md)чтобы предотвратить спуфинг.

## <a name="how-spf-works-to-prevent-spoofing-and-phishing-in-microsoft-365"></a>Как SPF работает для предотвращения спуфинга и фишинга в Microsoft 365
<a name="HowSPFWorks"> </a>

Инфраструктура политики отправителей определяет, разрешено ли отправителю посылать сообщения от имени домена. Если отправителю это запрещено, то есть сообщение не проходит проверку инфраструктуры политики отправителей на сервере получателя, то политика нежелательной почты, настроенная на этом сервере, определяет, как поступить с сообщением.

Каждая запись SPF TXT содержит объявления типа записи, IP-адреса, которым разрешено отправлять сообщения из домена, и внешние домены, которым разрешено отправлять сообщения от его имени, а также правило принудительного применения. В допустимой записи SPF TXT должны присутствовать все три элемента. В этой статье описывается, как создать запись SPF TXT, и данная статья содержит практические практики по работе со службами в Microsoft 365. Кроме того, представлены ссылки на инструкции по работе с регистратором доменов для публикации записей в службе DNS.

### <a name="spf-basics-ip-addresses-allowed-to-send-from-your-custom-domain"></a>Основные сведения об инфраструктуре политики отправителей: IP-адреса, которым разрешено отправлять сообщения из личного домена
<a name="SPFBasicsIPaddresses"> </a>

Рассмотрим базовый синтаксис правила для инфраструктуры политики отправителей:

v=spf1 \<IP\>\<enforcement rule\>

Допустим, для домена contoso.com имеется следующее правило инфраструктуры политики отправителей:

v=spf1 \<IP address #1\> \<IP address #2\> \<IP address #3\>\<enforcement rule\>

В этом примере правило инфраструктуры политики отправителей разрешает почтовому серверу получать сообщения только со следующих IP-адресов для домена contoso.com:

- IP-адрес №1

- IP-адрес №2

- IP-адрес №3

Это правило инфраструктуры политики отправителей указывает почтовому серверу получателя, что если сообщение поступает из домена contoso.com, но не с одного из этих IP-адресов, то сервер получателя должен применять к этому сообщению правило принудительного применения. Обычно используется одно из следующих правил:

- **Серьезный сбой.** В конверт сообщения добавляется отметка "серьезный сбой", а затем соблюдается политика нежелательной почты, настроенная на сервере для этого типа сообщений.

- **Мягкий сбой.** В конверт сообщения добавляется отметка "мягкий сбой". Как правило, почтовые серверы настраиваются так, чтобы все равно доставлять такие сообщения. Эта отметка не видна большинству пользователей.

- **Нейтральное.** Не выполняется никаких действий, то есть в конверт сообщения не добавляются отметки. Обычно это правило зарезервировано для тестирования и редко используется.

В следующих примерах показано, как инфраструктура политики отправителей работает в различных ситуациях. В этих примерах contoso.com является отправителем, а woodgrovebank.com — получателем.

### <a name="example-1-email-authentication-of-a-message-sent-directly-from-sender-to-receiver"></a>Пример 1. Проверка подлинности сообщения электронной почты, отправленного непосредственно от отправителя к получателю
<a name="spfExample1"> </a>

Инфраструктура политики отправителей лучше всего работает с прямыми маршрутами от отправителя к получателю, например:

![Схема, на которой показано, как инфраструктура политики отправителей проверяет подлинность электронной почты, отправляемой непосредственно с сервера на сервер.](../../media/835c20a7-ed4c-49c4-91fe-b8ebb3e452a1.jpg)

Когда woodgrovebank.com получает сообщение, то оно проходит проверку инфраструктуры политики отправителей и проверку подлинности, если IP-адрес №1 указан в записи SPF TXT для contoso.com.

### <a name="example-2-spoofed-sender-address-fails-the-spf-check"></a>Пример 2. Поддельный адрес отправителя не проходит проверку инфраструктуры политики отправителей
<a name="spfExample2"> </a>

Допустим, злоумышленнику удалось найти уязвимость в домене contoso.com:

![Схема, на которой показано, как инфраструктура политики отправителей проверяет подлинность электронной почты, отправляемой с поддельного сервера.](../../media/235dac3d-cdc5-466e-86e0-37b5979de198.jpg)

Так как IP-адрес №12 не указан в записи SPF TXT для домена contoso.com, сообщение не проходит проверку инфраструктуры политики отправителей, а получатель может отметить его как нежелательное.

### <a name="example-3-spf-and-forwarded-messages"></a>Пример 3. Инфраструктура политики отправителей и пересылаемые сообщения
<a name="spfExample3"> </a>

Главный недостаток инфраструктуры политики отправителей состоит в том, что она не работает с пересылаемыми сообщениями. Допустим, пользователь домена woodgrovebank.com настроил правило пересылки, которое отправляет все сообщения в учетную запись outlook.com:

![Схема, на которой показано, что инфраструктура политики отправителей не может проверить подлинность пересланного сообщения.](../../media/6e92acd6-463e-4a1b-8327-fb1cf861f356.jpg)

Изначально сообщение проходит проверку инфраструктуры политики отправителей в домене woodgrovebank.com, но не проходит ее в outlook.com, так как IP-адрес №25 не указан в записи SPF TXT для домена contoso.com. Затем outlook.com может отметить сообщение как нежелательное. Чтобы обойти эту проблему, используйте инфраструктуру политики отправителей вместе с другими методами проверки подлинности, например DKIM и DMARC.

### <a name="spf-basics-including-third-party-domains-that-can-send-mail-on-behalf-of-your-domain"></a>Основные сведения об инфраструктуре политики отправителей: включение сторонних доменов, которые могут отправлять сообщения от имени вашего домена
<a name="SPFBasicsIncludes"> </a>

В запись SPF TXT можно добавлять не только IP-адреса, но и домены. Для этого используются операторы include. Например, для домена contoso.com может потребоваться включить все IP-адреса почтовых серверов на доменах contoso.net и contoso.org, которые принадлежат той же организации. Для этого на домене contoso.com публикуется запись SPF TXT следующего вида:

```text
v=spf1 include:contoso.net include:contoso.org -all
```

Когда принимающий сервер видит эту запись в DNS, он также выполняет DNS-подымену для записи SPF TXT для contoso.net, а затем для contoso.org. Если в записях для contoso.net или contoso.org обнаруживается дополнительный contoso.org include, он также будет следовать этим утверждениям. Во избежание атак типа "отказ в обслуживании" для одного сообщения допускается не более 10 DNS-запросов. Каждый оператор include представляет дополнительный DNS-запрос. Если в сообщении более 10 таких запросов, оно не проходит проверку инфраструктуры политики отправителей. После достижения этого ограничения отправитель может получить сообщение о том, что было сгенерировано слишком много просмотров или превышено максимальное число прыжков для сообщения (это может произойти, когда цикл подысков и превышение временивых результатов DNS). Советы по устранению неполадок см. в рекомендации по [SPF в Microsoft 365.](how-office-365-uses-spf-to-prevent-spoofing.md#SPFTroubleshoot)

## <a name="requirements-for-your-spf-txt-record-and-microsoft-365"></a>Требования к записи SPF TXT и Microsoft 365
<a name="SPFReqsinO365"> </a>

Если вы настроили почту при настройках Microsoft 365, вы уже создали запись SPF TXT, которая определяет серверы обмена сообщениями Майкрософт в качестве законного источника почты для вашего домена. Скорее всего, эта запись выглядит следующим образом:

```text
v=spf1 include:spf.protection.outlook.com -all
```

Если вы полностью размещены, то есть у вас нет локального почтового сервера, отправив исходящего сообщения, это единственная запись SPF TXT, которую необходимо опубликовать для Office 365.

Если у вас гибридное развертывание (т. е. некоторые почтовые ящики размещены локально, а другие — в Microsoft 365) или отдельный клиент Exchange Online Protection (EOP) (т. е. ваша организация использует EOP для защиты своих почтовых ящиков), необходимо добавить IP-адрес исходящей почты для каждого локального почтового сервера в запись SPF TXT в DNS.

## <a name="form-your-spf-txt-record-for-microsoft-365"></a>Форма записи SPF TXT для Microsoft 365
<a name="FormYourSPF"> </a>

Воспользуйтесь сведениями о синтаксисе, представленными в этой статье, чтобы создать запись SPF TXT для личного домена. Здесь описаны наиболее часто используемые варианты синтаксиса, но существуют и другие. После создания записи необходимо обновить ее у регистратора доменных имен.

Сведения о доменах, которые необходимо включить для Microsoft 365, см. в записях [внешних DNS,](../../enterprise/external-domain-name-system-records.md)необходимых для SPF. Используйте [пошаговую](../../admin/get-help-with-domains/create-dns-records-at-any-dns-hosting-provider.md#add-or-edit-an-spf-txt-record-to-help-prevent-email-spam-outlook-exchange-online) инструкцию по обновлению записей SPF (TXT) для регистратора доменных имен.

### <a name="spf-txt-record-syntax-for-microsoft-365"></a>Синтаксис записи SPF TXT для Microsoft 365
<a name="SPFSyntaxO365"> </a>

Типичная запись SPF TXT для Microsoft 365 имеет следующий синтаксис:

```text
v=spf1 [<ip4>|<ip6>:<IP address>] [include:<domain name>] <enforcement rule>
```

Например:

```text
v=spf1 ip4:192.168.0.1 ip4:192.168.0.2 include:spf.protection.outlook.com -all
```

где:

- **v=spf1**  обязательный параметр. Он определяет тип записи как SPF TXT.

- **ip4** указывает, что используются IP-адреса версии 4. **ip6** указывает, что используются IP-адреса версии 6. При использовании IP-адресов IPv6 **ip4** в примерах следует заменить на **ip6**. Можно также указать диапазоны IP-адресов с использованием нотации CIDR, например **ip4:192.168.0.1/26**.

- _IP-адрес_ — это IP-адрес, который необходимо добавить в запись SPF TXT. Обычно это IP-адрес почтового сервера исходящие сообщения для организации. Можно перечислить несколько серверов исходящие почтовые серверы. Дополнительные сведения см. в примере: запись SPF TXT для нескольких исходящие почтовые серверы и [Microsoft 365](how-office-365-uses-spf-to-prevent-spoofing.md#ExampleSPFMultipleMailServerO365).

- _domain name_ — это домен, который требуется добавить в качестве надежного отправителя. Список доменных имен, которые необходимо включить для Microsoft 365, см. в записях [внешних DNS,](../../enterprise/external-domain-name-system-records.md)необходимых для SPF.

- Как правило, используется одно из указанных ниже правил принудительного применения.

  - -all

    Указывает на серьезный сбой. Если вам известны все разрешенные IP-адреса для домена, укажите их в записи SPF TXT и используйте квалификатор -all (серьезный сбой). Кроме того, если используется только инфраструктура политики отправителей, то есть не используются DMARC и DKIM, то рекомендуется использовать квалификатор -all. Рекомендуем всегда использовать этот квалификатор.

  - ~all

    Указывает на мягкий сбой. При отсутствии полного списка IP-адресов следует использовать квалификатор ~all (мягкий сбой). Кроме того, если используется DMARC с параметром p=quarantine или p=reject, вы можете использовать квалификатор ~all. В противном случае используйте квалификатор -all.

  - ?all

    Указывает на нейтральное состояние. Этот квалификатор используется при тестировании инфраструктуры политики отправителей. Не рекомендуем использовать его в рабочем развертывании.

### <a name="example-spf-txt-record-to-use-when-all-of-your-mail-is-sent-by-microsoft-365"></a>Пример: запись SPF TXT, используемая при отправлении всей почты с помощью Microsoft 365
<a name="ExampleSPFNoSP"> </a>

Если вся почта отправляется Microsoft 365, используйте ее в записи SPF TXT:

```text
v=spf1 include:spf.protection.outlook.com -all
```

### <a name="example-spf-txt-record-for-a-hybrid-scenario-with-one-on-premises-exchange-server-and-microsoft-365"></a>Пример: запись SPF TXT для гибридного сценария с одним Exchange Server и Microsoft 365
<a name="ExampleSPFHybridOneExchangeServer"> </a>

В гибридной среде, если IP-адрес локального сервера Exchange Server  192.168.0.1, чтобы настроить правило принудительного применения для инфраструктуры политики отправителей на серьезный сбой, создайте следующую запись SPF TXT:

```text
v=spf1 ip4:192.168.0.1 include:spf.protection.outlook.com -all
```

### <a name="example-spf-txt-record-for-multiple-outbound-on-premises-mail-servers-and-microsoft-365"></a>Пример: запись SPF TXT для нескольких исходящие почтовые серверы и Microsoft 365
<a name="ExampleSPFMultipleMailServerO365"> </a>

При наличии нескольких серверов исходящей электронной почты необходимо включить IP-адрес для каждого почтового сервера в записи SPF TXT и отделить каждый IP-адрес пробелом, за которым следует выражение "ip4:". Например:

```text
v=spf1 ip4:192.168.0.1 ip4:192.168.0.2 ip4:192.168.0.3 include:spf.protection.outlook.com -all
```

## <a name="next-steps-set-up-spf-for-microsoft-365"></a>Дальнейшие действия: настройка SPF для Microsoft 365
<a name="SPFNextSteps"> </a>

После того как вы сформулируете запись SPF TXT, выполните действия, которые необходимо предпринять в настройках SPF в [Microsoft 365,](set-up-spf-in-office-365-to-help-prevent-spoofing.md) чтобы предотвратить спуфинг, чтобы добавить ее в свой домен.

Несмотря на то что инфраструктура политики отправителей призвана предотвратить спуфинг, существуют некоторые методики, которые позволяют обойти ее. Чтобы защититься от них, после настройки SPF необходимо также настроить DKIM и DMARC для Microsoft 365. To get started, see [Use DKIM to validate outbound email sent from your custom domain in Microsoft 365](use-dkim-to-validate-outbound-email.md). Затем см. статью [Использование протокола DMARC для проверки электронной почты в Microsoft 365](use-dmarc-to-validate-email.md).

## <a name="troubleshooting-best-practices-for-spf-in-microsoft-365"></a>Устранение неполадок: best practices for SPF in Microsoft 365
<a name="SPFTroubleshoot"> </a>

Для личного домена можно создать только одну запись SPF TXT. Создание нескольких записей приводит к ситуации циклического перебора и сбою инфраструктуры политики отправителей. Чтобы избежать этого, вы можете создать отдельные записи для каждого поддомена. Например, создайте одну запись для домена contoso.com и еще одну для поддомена bulkmail.contoso.com.

Если перед доставкой сообщения электронной почты выполняется более 10 DNS-запросов, почтовый сервер получателя сообщит о постоянной ошибке ( _permerror_), а сообщение не пройдет проверку инфраструктуры политики отправителей. Сервер получателя также может отправить отчет о недоставке, включающий ошибку примерно следующего содержания:

- Превышено максимальное количество прыжков для сообщения.

- Для сообщения потребовалось слишком много запросов.

## <a name="avoiding-the-too-many-lookups-error-when-you-use-third-party-domains-with-microsoft-365"></a>Предотвращение ошибки "слишком много подыском" при использовании сторонних доменов в Microsoft 365
<a name="SPFTroubleshoot"> </a>

Некоторые записи SPF TXT для сторонних доменов поручают серверу получателя выполнять большое количество DNS-запросов. Например, на момент написания этой статьи запись домена Salesforce.com содержит 5 операторов include:

```text
v=spf1 include:_spf.google.com
include:_spfblock.salesforce.com
include:_qa.salesforce.com
include:_spfblock1.salesforce.com
include:spf.mandrillapp.com mx ~all
```

Чтобы избежать ошибки, вы можете реализовать политику, согласно которой (к примеру) для отправки массовых рассылок все должны использовать специальный поддомен. Затем вы можете задать для поддомена отдельную запись SPF TXT, включающую массовые рассылки.

 В некоторых случаях, таких как пример с доменом salesforce.com, необходимо указывать домен в записи SPF TXT, но в остальных случаях сторонний поставщик уже создал поддомен специально для этой цели. Например, для домена exacttarget.com создан поддомен, который необходимо использовать с записью SPF TXT:

```text
cust-spf.exacttarget.com
```

При включении сторонних доменов в запись SPF TXT необходимо согласовать со сторонним поставщиком, какой домен или поддомен будет использоваться, чтобы соблюдать ограничение в 10 запросов.

## <a name="how-to-view-your-current-spf-txt-record-and-determine-the-number-of-lookups-that-it-requires"></a>Как просмотреть текущую запись SPF TXT и определить необходимое количество запросов
<a name="SPFTroubleshoot"> </a>

С помощью команды nslookup можно просматривать записи DNS, включая запись SPF TXT. Кроме того, при желании вы можете воспользоваться множеством бесплатных веб-средств для просмотра содержимого записи SPF TXT. Просмотрев запись SPF TXT и проследив цепь операторов include, вы можете определить, сколько DNS-запросов требуется для записи. Некоторые веб-средства даже считают и показывают эти запросы. Наблюдая за их количеством, вы сможете предотвратить постоянные ошибки (permerror) от сервера получателя при отправке сообщений из организации.

## <a name="for-more-information"></a>Дополнительные сведения
<a name="SPFTroubleshoot"> </a>

Нужна помощь, чтобы добавить запись TXT инфраструктуры политики отправителей? Подробные сведения об использовании sender Policy Framework с пользовательским доменом в [Microsoft 365](../../admin/get-help-with-domains/create-dns-records-at-any-dns-hosting-provider.md#add-or-edit-an-spf-txt-record-to-help-prevent-email-spam-outlook-exchange-online) можно прочитать в статье "Создание записей DNS для любого поставщика услуг размещения DNS для Microsoft 365". [Заглавные поля](anti-spam-message-headers.md) сообщений для борьбы с нежелательной почтой включают в себя синтаксис и поля, используемые Microsoft 365 для проверок SPF.
