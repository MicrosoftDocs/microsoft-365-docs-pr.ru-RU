---
title: Как инфраструктура политики отправителей (SPF) запрещает спуфинг
f1.keywords:
- CSH
ms.author: tracyp
author: MSFTTracyP
manager: dansimp
ms.date: 12/15/2016
audience: ITPro
ms.topic: article
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- MET150
ms.assetid: 3aff33c5-1416-4867-a23b-e0c0c5b4d2be
ms.collection:
- M365-security-compliance
ms.custom:
- seo-marvel-apr2020
description: Сведения о том, как Microsoft 365 использует запись в формате TXT инфраструктуры политики отправителей (SPF), чтобы гарантировать, что конечные системы электронной почты доверяют сообщениям, отправленным из личного домена.
ms.openlocfilehash: 702c5de90c53388a3d55ad752010fbaa04b5556b
ms.sourcegitcommit: 555d756c69ac9031d1fb928f2e1f9750beede066
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2020
ms.locfileid: "47307653"
---
# <a name="how-microsoft-365-uses-sender-policy-framework-spf-to-prevent-spoofing"></a>Как Microsoft 365 использует инфраструктуру политики отправителей (SPF) для предотвращения спуфинга

 **Сводка:** В этой статье описывается, как Microsoft 365 использует запись The SPF TXT Framework (SPF) в DNS, чтобы обеспечить доверие конечным системам электронной почты к сообщениям, отправленным из личного домена. Это относится к исходящей почте, отправляемой из Microsoft 365. Сообщения, отправляемые из Microsoft 365 получателю в Microsoft 365, всегда будут передавать SPF.

Запись TXT инфраструктуры политики отправителей  это запись DNS, которая помогает предотвратить спуфинг и фишинг путем проверки доменного имени, с которого отправляются сообщения. Инфраструктура политики отправителей проверяет источники сообщений, сверяя IP-адрес отправителя с предполагаемым владельцем отправляющего домена.

> [!NOTE]
> Рабочая группа IETF признала типы записей SPF устаревшими в 2014 г. Вместо них для публикации данных инфраструктуры политики отправителей необходимо использовать записи TXT в службе DNS. Далее в этой статье для простоты используется термин "запись SPF TXT".

Администраторы доменов публикуют данные инфраструктуры политики отправителей в записях типа TXT в DNS. Эти данные позволяют определить уполномоченные серверы исходящей почты. В свою очередь, конечные почтовые системы проверяют, были ли сообщения отправлены уполномоченными серверами исходящей почты. Если вы уже знакомы с SPF или у вас есть простое развертывание, и просто хотите узнать, что следует включить в запись SPF TXT в DNS для Microsoft 365, можно перейти к разделу Настройка политики [SPF в Microsoft 365, чтобы предотвратить подмену сведений](set-up-spf-in-office-365-to-help-prevent-spoofing.md). Если у вас нет развертывания, которое полностью размещено в Microsoft 365, или вы хотите получить дополнительные сведения о том, как работает SPF или как устранить неполадки с помощью SPF для Microsoft 365, продолжайте чтение.

> [!NOTE]
> Раньше, если вы также использовали SharePoint Online, в личный домен нужно было добавить другую запись SPF TXT. Этого больше не требуется. Это изменение необходимо для того, чтобы уведомления SharePoint Online не попадали в папку нежелательной почты. Нет необходимости вносить какие – либо изменения немедленно, но при получении сообщения об ошибке "слишком много просмотров" измените запись SPF TXT, как описано в разделе [Set up SPF in Microsoft 365, чтобы предотвратить подмену информации](set-up-spf-in-office-365-to-help-prevent-spoofing.md).

## <a name="how-spf-works-to-prevent-spoofing-and-phishing-in-microsoft-365"></a>Принцип работы SPF для предотвращения спуфинга и фишинга в Microsoft 365
<a name="HowSPFWorks"> </a>

Инфраструктура политики отправителей определяет, разрешено ли отправителю посылать сообщения от имени домена. Если отправителю это запрещено, то есть сообщение не проходит проверку инфраструктуры политики отправителей на сервере получателя, то политика нежелательной почты, настроенная на этом сервере, определяет, как поступить с сообщением.

Каждая запись SPF TXT содержит объявления типа записи, IP-адреса, которым разрешено отправлять сообщения из домена, и внешние домены, которым разрешено отправлять сообщения от его имени, а также правило принудительного применения. В допустимой записи SPF TXT должны присутствовать все три элемента. В этой статье описывается создание записи SPF TXT и приводятся рекомендации по работе со службами в Microsoft 365. Кроме того, представлены ссылки на инструкции по работе с регистратором доменов для публикации записей в службе DNS.

### <a name="spf-basics-ip-addresses-allowed-to-send-from-your-custom-domain"></a>Основные сведения об инфраструктуре политики отправителей: IP-адреса, которым разрешено отправлять сообщения из личного домена
<a name="SPFBasicsIPaddresses"> </a>

Рассмотрим базовый синтаксис правила для инфраструктуры политики отправителей:

v = spf1 \<IP\>\<enforcement rule\>

Допустим, для домена contoso.com имеется следующее правило инфраструктуры политики отправителей:

v = spf1 \<IP address #1\> \<IP address #2\> \<IP address #3\>\<enforcement rule\>

В этом примере правило инфраструктуры политики отправителей разрешает почтовому серверу получать сообщения только со следующих IP-адресов для домена contoso.com:

- IP-адрес №1

- IP-адрес №2

- IP-адрес №3

Это правило инфраструктуры политики отправителей указывает почтовому серверу получателя, что если сообщение поступает из домена contoso.com, но не с одного из этих IP-адресов, то сервер получателя должен применять к этому сообщению правило принудительного применения. Обычно используется одно из следующих правил:

- **Серьезный сбой.** В конверт сообщения добавляется отметка "серьезный сбой", а затем соблюдается политика нежелательной почты, настроенная на сервере для этого типа сообщений.

- **Мягкий сбой.** В конверт сообщения добавляется отметка "мягкий сбой". Как правило, почтовые серверы настраиваются так, чтобы все равно доставлять такие сообщения. Эта отметка не видна большинству пользователей.

- **Нейтральное.** Не выполняется никаких действий, то есть в конверт сообщения не добавляются отметки. Обычно это правило зарезервировано для тестирования и редко используется.

В следующих примерах показано, как инфраструктура политики отправителей работает в различных ситуациях. В этих примерах contoso.com является отправителем, а woodgrovebank.com — получателем.

### <a name="example-1-email-authentication-of-a-message-sent-directly-from-sender-to-receiver"></a>Пример 1. Проверка подлинности сообщения электронной почты, отправленного непосредственно от отправителя к получателю
<a name="spfExample1"> </a>

Инфраструктура политики отправителей лучше всего работает с прямыми маршрутами от отправителя к получателю, например:

![Схема, на которой показано, как инфраструктура политики отправителей проверяет подлинность электронной почты, отправляемой непосредственно с сервера на сервер.](../../media/835c20a7-ed4c-49c4-91fe-b8ebb3e452a1.jpg)

Когда woodgrovebank.com получает сообщение, то оно проходит проверку инфраструктуры политики отправителей и проверку подлинности, если IP-адрес №1 указан в записи SPF TXT для contoso.com.

### <a name="example-2-spoofed-sender-address-fails-the-spf-check"></a>Пример 2. Поддельный адрес отправителя не проходит проверку инфраструктуры политики отправителей
<a name="spfExample2"> </a>

Допустим, злоумышленнику удалось найти уязвимость в домене contoso.com:

![Схема, на которой показано, как инфраструктура политики отправителей проверяет подлинность электронной почты, отправляемой с поддельного сервера.](../../media/235dac3d-cdc5-466e-86e0-37b5979de198.jpg)

Так как IP-адрес №12 не указан в записи SPF TXT для домена contoso.com, сообщение не проходит проверку инфраструктуры политики отправителей, а получатель может отметить его как нежелательное.

### <a name="example-3-spf-and-forwarded-messages"></a>Пример 3. Инфраструктура политики отправителей и пересылаемые сообщения
<a name="spfExample3"> </a>

Главный недостаток инфраструктуры политики отправителей состоит в том, что она не работает с пересылаемыми сообщениями. Допустим, пользователь домена woodgrovebank.com настроил правило пересылки, которое отправляет все сообщения в учетную запись outlook.com:

![Схема, на которой показано, что инфраструктура политики отправителей не может проверить подлинность пересланного сообщения.](../../media/6e92acd6-463e-4a1b-8327-fb1cf861f356.jpg)

Изначально сообщение проходит проверку инфраструктуры политики отправителей в домене woodgrovebank.com, но не проходит ее в outlook.com, так как IP-адрес №25 не указан в записи SPF TXT для домена contoso.com. Затем outlook.com может отметить сообщение как нежелательное. Чтобы обойти эту проблему, используйте инфраструктуру политики отправителей вместе с другими методами проверки подлинности, например DKIM и DMARC.

### <a name="spf-basics-including-third-party-domains-that-can-send-mail-on-behalf-of-your-domain"></a>Основные сведения об инфраструктуре политики отправителей: включение сторонних доменов, которые могут отправлять сообщения от имени вашего домена
<a name="SPFBasicsIncludes"> </a>

В запись SPF TXT можно добавлять не только IP-адреса, но и домены. Для этого используются операторы include. Например, для домена contoso.com может потребоваться включить все IP-адреса почтовых серверов на доменах contoso.net и contoso.org, которые принадлежат той же организации. Для этого на домене contoso.com публикуется запись SPF TXT следующего вида:

```text
v=spf1 include:contoso.net include:contoso.org -all
```

Когда принимающий сервер видит эту запись в DNS, он также выполняет поиск DNS в записи SPF TXT для contoso.net, а затем для contoso.org. Если обнаруживается дополнительный оператор include в записях для contoso.net или contoso.org, он также будет подписываться. Во избежание атак типа "отказ в обслуживании" для одного сообщения допускается не более 10 DNS-запросов. Каждый оператор include представляет дополнительный DNS-запрос. Если в сообщении более 10 таких запросов, оно не проходит проверку инфраструктуры политики отправителей. Если сообщение достигает этого ограничения, в зависимости от способа настройки принимающего сервера, отправитель может получить сообщение о том, что сообщение создано как "слишком много просмотров", так и в поле "максимальное число прыжков для сообщения превышено" (это может произойти при поиске в цикле поиска и превышении времени ожидания DNS). Советы по предотвращению этой ситуации приведены в статье [Устранение неполадок: рекомендации по использованию SPF в Microsoft 365](how-office-365-uses-spf-to-prevent-spoofing.md#SPFTroubleshoot).

## <a name="requirements-for-your-spf-txt-record-and-microsoft-365"></a>Требования к записи SPF TXT и Microsoft 365
<a name="SPFReqsinO365"> </a>

Если вы настроили почту при настройке Microsoft 365, вы уже создали запись SPF TXT, которая определяет серверы обмена сообщениями Майкрософт как легальный источник почты для вашего домена. Скорее всего, эта запись выглядит следующим образом:

```text
v=spf1 include:spf.protection.outlook.com -all
```

Если вы являетесь полностью размещенным клиентом, то есть у вас нет локальных почтовых серверов, которые отправляют исходящую почту, это единственная запись SPF TXT, которую необходимо опубликовать для Office 365.

Если у вас есть гибридное развертывание (то есть, у вас есть локальные почтовые ящики, размещенные в Microsoft 365, или если вы являетесь отдельным клиентом Exchange Online Protection (EOP) (то есть ваша организация использует EOP для защиты локальных почтовых ящиков), необходимо добавить исходящий IP-адрес для каждого из локальных пограничных серверов в запись SPF TXT в DNS.

## <a name="form-your-spf-txt-record-for-microsoft-365"></a>Форма записи SPF TXT для Microsoft 365
<a name="FormYourSPF"> </a>

Воспользуйтесь сведениями о синтаксисе, представленными в этой статье, чтобы создать запись SPF TXT для личного домена. Здесь описаны наиболее часто используемые варианты синтаксиса, но существуют и другие. После создания записи необходимо обновить ее у регистратора доменных имен.

Для получения сведений о доменах, которые необходимо включить в Microsoft 365, просмотрите [внешние DNS-записи, необходимые для SPF](https://docs.microsoft.com/microsoft-365/enterprise/external-domain-name-system-records). Используйте пошаговые [инструкции](https://docs.microsoft.com/microsoft-365/admin/get-help-with-domains/create-dns-records-at-any-dns-hosting-provider#add-a-txt-record-for-spf-to-help-prevent-email-spam) по обновлению записей SPF (txt) для вашего регистратора доменных имен.

### <a name="spf-txt-record-syntax-for-microsoft-365"></a>Синтаксис записи SPF TXT для Microsoft 365
<a name="SPFSyntaxO365"> </a>

Типичная запись SPF TXT для Microsoft 365 имеет следующий синтаксис:

```text
v=spf1 [<ip4>|<ip6>:<IP address>] [include:<domain name>] <enforcement rule>
```

Например:

```text
v=spf1 ip4:192.168.0.1 ip4:192.168.0.2 include:spf.protection.outlook.com -all
```

где:

- **v=spf1**  обязательный параметр. Он определяет тип записи как SPF TXT.

- **ip4** указывает, что используются IP-адреса версии 4. **ip6** указывает, что используются IP-адреса версии 6. При использовании IP-адресов IPv6 **ip4** в примерах следует заменить на **ip6**. Можно также указать диапазоны IP-адресов с использованием нотации CIDR, например **ip4:192.168.0.1/26**.

- _IP-адрес_ — это IP-адрес, который вы хотите добавить в запись SPF txt. Обычно это IP-адрес сервера исходящей почты для вашей организации. Вы можете перечислить несколько серверов исходящей почты. Дополнительную информацию можно узнать в [статье пример: запись SPF txt для нескольких исходящих почтовых серверов и Microsoft 365](how-office-365-uses-spf-to-prevent-spoofing.md#ExampleSPFMultipleMailServerO365).

- _domain name_ — это домен, который требуется добавить в качестве надежного отправителя. Список доменных имен, которые следует включить в Microsoft 365, приведен в разделе [внешние DNS-записи, необходимые для SPF](https://docs.microsoft.com/microsoft-365/enterprise/external-domain-name-system-records).

- Как правило, используется одно из указанных ниже правил принудительного применения.

  - -all

    Указывает на серьезный сбой. Если вам известны все разрешенные IP-адреса для домена, укажите их в записи SPF TXT и используйте квалификатор -all (серьезный сбой). Кроме того, если используется только инфраструктура политики отправителей, то есть не используются DMARC и DKIM, то рекомендуется использовать квалификатор -all. Рекомендуем всегда использовать этот квалификатор.

  - ~all

    Указывает на мягкий сбой. При отсутствии полного списка IP-адресов следует использовать квалификатор ~all (мягкий сбой). Кроме того, если используется DMARC с параметром p=quarantine или p=reject, вы можете использовать квалификатор ~all. В противном случае используйте квалификатор -all.

  - ?all

    Указывает на нейтральное состояние. Этот квалификатор используется при тестировании инфраструктуры политики отправителей. Не рекомендуем использовать его в рабочем развертывании.

### <a name="example-spf-txt-record-to-use-when-all-of-your-mail-is-sent-by-microsoft-365"></a>Пример: запись SPF TXT для использования при отправке всей почты корпорацией Microsoft 365
<a name="ExampleSPFNoSP"> </a>

Если вся почта отправляется корпорацией Microsoft 365, используйте ее в записи SPF TXT:

```text
v=spf1 include:spf.protection.outlook.com -all
```

### <a name="example-spf-txt-record-for-a-hybrid-scenario-with-one-on-premises-exchange-server-and-microsoft-365"></a>Пример: запись SPF TXT для гибридного сценария с одним локальным сервером Exchange Server и Microsoft 365
<a name="ExampleSPFHybridOneExchangeServer"> </a>

В гибридной среде, если IP-адрес локального сервера Exchange Server  192.168.0.1, чтобы настроить правило принудительного применения для инфраструктуры политики отправителей на серьезный сбой, создайте следующую запись SPF TXT:

```text
v=spf1 ip4:192.168.0.1 include:spf.protection.outlook.com -all
```

### <a name="example-spf-txt-record-for-multiple-outbound-on-premises-mail-servers-and-microsoft-365"></a>Пример: запись SPF TXT для нескольких исходящих локальных почтовых серверов и Microsoft 365
<a name="ExampleSPFMultipleMailServerO365"> </a>

При наличии нескольких серверов исходящей электронной почты необходимо включить IP-адрес для каждого почтового сервера в записи SPF TXT и отделить каждый IP-адрес пробелом, за которым следует выражение "ip4:". Например:

```text
v=spf1 ip4:192.168.0.1 ip4:192.168.0.2 ip4:192.168.0.3 include:spf.protection.outlook.com -all
```

## <a name="next-steps-set-up-spf-for-microsoft-365"></a>Дальнейшие действия: Настройка SPF для Microsoft 365
<a name="SPFNextSteps"> </a>

Определив запись SPF TXT, выполните действия, описанные в разделе [Set up SPF in Microsoft 365, чтобы предотвратить подмену](set-up-spf-in-office-365-to-help-prevent-spoofing.md) , чтобы добавить ее в ваш домен.

Несмотря на то что инфраструктура политики отправителей призвана предотвратить спуфинг, существуют некоторые методики, которые позволяют обойти ее. Чтобы защититься от них, после того как вы настроили SPF, также следует настроить DKIM и DMARC для Microsoft 365. Чтобы приступить к работе, ознакомьтесь со [статьей использование DKIM для проверки исходящей электронной почты, отправленной из личного домена в Microsoft 365](use-dkim-to-validate-outbound-email.md). Затем см. статью [Использование протокола DMARC для проверки электронной почты в Microsoft 365](use-dmarc-to-validate-email.md).

## <a name="troubleshooting-best-practices-for-spf-in-microsoft-365"></a>Устранение неполадок: рекомендации по использованию SPF в Microsoft 365
<a name="SPFTroubleshoot"> </a>

Для личного домена можно создать только одну запись SPF TXT. Создание нескольких записей приводит к ситуации циклического перебора и сбою инфраструктуры политики отправителей. Чтобы избежать этого, вы можете создать отдельные записи для каждого поддомена. Например, создайте одну запись для домена contoso.com и еще одну для поддомена bulkmail.contoso.com.

Если перед доставкой сообщения электронной почты выполняется более 10 DNS-запросов, почтовый сервер получателя сообщит о постоянной ошибке ( _permerror_), а сообщение не пройдет проверку инфраструктуры политики отправителей. Сервер получателя также может отправить отчет о недоставке, включающий ошибку примерно следующего содержания:

- Превышено максимальное количество прыжков для сообщения.

- Для сообщения потребовалось слишком много запросов.

## <a name="avoiding-the-too-many-lookups-error-when-you-use-third-party-domains-with-microsoft-365"></a>Устранение ошибки "слишком много просмотров" при использовании сторонних доменов с Microsoft 365
<a name="SPFTroubleshoot"> </a>

Некоторые записи SPF TXT для сторонних доменов поручают серверу получателя выполнять большое количество DNS-запросов. Например, на момент написания этой статьи запись домена Salesforce.com содержит 5 операторов include:

```text
v=spf1 include:_spf.google.com
include:_spfblock.salesforce.com
include:_qa.salesforce.com
include:_spfblock1.salesforce.com
include:spf.mandrillapp.com mx ~all
```

Чтобы избежать ошибки, вы можете реализовать политику, согласно которой (к примеру) для отправки массовых рассылок все должны использовать специальный поддомен. Затем вы можете задать для поддомена отдельную запись SPF TXT, включающую массовые рассылки.

 В некоторых случаях, таких как пример с доменом salesforce.com, необходимо указывать домен в записи SPF TXT, но в остальных случаях сторонний поставщик уже создал поддомен специально для этой цели. Например, для домена exacttarget.com создан поддомен, который необходимо использовать с записью SPF TXT:

```text
cust-spf.exacttarget.com
```

При включении сторонних доменов в запись SPF TXT необходимо согласовать со сторонним поставщиком, какой домен или поддомен будет использоваться, чтобы соблюдать ограничение в 10 запросов.

## <a name="how-to-view-your-current-spf-txt-record-and-determine-the-number-of-lookups-that-it-requires"></a>Как просмотреть текущую запись SPF TXT и определить необходимое количество запросов
<a name="SPFTroubleshoot"> </a>

С помощью команды nslookup можно просматривать записи DNS, включая запись SPF TXT. Кроме того, при желании вы можете воспользоваться множеством бесплатных веб-средств для просмотра содержимого записи SPF TXT. Просмотрев запись SPF TXT и проследив цепь операторов include, вы можете определить, сколько DNS-запросов требуется для записи. Некоторые веб-средства даже считают и показывают эти запросы. Наблюдая за их количеством, вы сможете предотвратить постоянные ошибки (permerror) от сервера получателя при отправке сообщений из организации.

## <a name="for-more-information"></a>Дополнительные сведения
<a name="SPFTroubleshoot"> </a>

Нужна помощь, чтобы добавить запись TXT инфраструктуры политики отправителей? Ознакомьтесь со статьей [Создание DNS-записей на любом поставщике услуг хостинга DNS для Microsoft 365](https://docs.microsoft.com/microsoft-365/admin/get-help-with-domains/create-dns-records-at-any-dns-hosting-provider#add-a-txt-record-for-spf-to-help-prevent-email-spam) для получения подробных сведений об использовании платформы политики отправителей с настраиваемым доменом в Microsoft 365. [Заголовки сообщений защиты от нежелательной почты](anti-spam-message-headers.md) включает синтаксис и поля заголовков, используемые Microsoft 365 для проверок SPF.


