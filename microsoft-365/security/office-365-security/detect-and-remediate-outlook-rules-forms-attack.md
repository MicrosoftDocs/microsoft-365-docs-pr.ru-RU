---
title: Обнаружение и исправление атак Outlook и пользовательских форм.
f1.keywords:
- NOCSH
ms.author: tracyp
author: MSFTTracyp
manager: dansimp
ms.date: 04/23/2018
audience: ITPro
ms.topic: article
ms.collection:
- o365_security_incident_response
- M365-security-compliance
localization_priority: Normal
search.appverid:
- MET150
description: Узнайте, как распознавать и устранять Outlook и настраиваемые впрыски форм в Office 365
ms.custom: seo-marvel-apr2020
ms.technology: mdo
ms.prod: m365-security
ms.openlocfilehash: 0846051b65b34ec26358f87bb4ca49302573e6e7
ms.sourcegitcommit: dcb97fbfdae52960ae62b6faa707a05358193ed5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/25/2021
ms.locfileid: "51205921"
---
# <a name="detect-and-remediate-outlook-rules-and-custom-forms-injections-attacks"></a>Обнаружение и исправление Outlook правил и атак на впрыски пользовательских форм

[!INCLUDE [Microsoft 365 Defender rebranding](../includes/microsoft-defender-for-office.md)]


**Сводка** Узнайте, как распознавать и устранять Outlook и настраиваемые атаки впрыски форм в Office 365.

## <a name="what-is-the-outlook-rules-and-custom-forms-injection-attack"></a>Что такое атака Outlook правил и пользовательских форм?

После того как злоумышленник получит доступ к организации, он попытается закрепиться, чтобы остаться в организации или вернуться после обнаружения. Это действие называется *созданием механизма сохранения.* Существует два способа, с помощью Outlook для создания механизма сохранения:

- Используя Outlook правила.
- Вводя настраиваемые формы в Outlook.

Переустановка Outlook или даже предоставление пострадавшему лицу нового компьютера не поможет. При подключении Outlook к почтовому ящику синхронизируются все правила и формы из облака. Правила или формы обычно предназначены для удаленного запуска кода и установки вредоносных программ на локальной машине. Вредоносные программы крадут учетные данные или выполняют другие незаконные действия.

Хорошая новость заключается в том, что если клиенты Outlook исправлены до последней версии, вы не будете уязвимы перед угрозой, так как текущие Outlook клиентские по умолчанию блокируют оба механизма.

Атаки обычно следуют следующим шаблонам:

**Использование правил:**

1. Злоумышленник крадет учетные данные пользователя.

2. Злоумышленник впишется в почтовый ящик Exchange пользователя (Exchange Online или локальном Exchange).

3. Злоумышленник создает правило пересылания почтовых ящиков в почтовом ящике. Правило пересылания запускается, когда почтовый ящик получает определенное сообщение от злоумышленника, которое соответствует условиям правила. Условия правил и формат сообщений адаптированы друг для друга.

4. Злоумышленник отправляет сообщение с триггером в скомпрометированный почтовый ящик, который по-прежнему используется в обычном режиме ничего не подозревающего пользователя.

5. Когда почтовый ящик получает сообщение, которое соответствует условиям правила, применяется действие правила. Обычно правилом является запуск приложения на удаленном сервере WebDAV.

6. Обычно приложение устанавливает вредоносные программы на компьютер пользователя (например, [PowerShell Empire).](https://www.powershellempire.com/)

7. Вредоносная программа позволяет злоумышленнику украсть (или снова украсть) имя пользователя и пароль или другие учетные данные из локальной машины и выполнять другие вредоносные действия.

**Использование форм:**

1. Злоумышленник крадет учетные данные пользователя.

2. Злоумышленник впишется в почтовый ящик Exchange пользователя (Exchange Online или локальном Exchange).

3. Злоумышленник вставляет настраиваемый шаблон формы почты в почтовый ящик пользователя. Настраиваемая форма запускается, когда почтовый ящик получает определенное сообщение от злоумышленника, которое требует, чтобы почтовый ящик загружал настраиваемую форму. Настраиваемая форма и формат сообщений являются индивидуальными друг для друга.

4. Злоумышленник отправляет сообщение с триггером в скомпрометированный почтовый ящик, который по-прежнему используется в обычном режиме ничего не подозревающего пользователя.

5. Когда почтовый ящик получает сообщение, почтовый ящик загружает необходимую форму. Форма запускает приложение на удаленном сервере (WebDAV).

6. Обычно приложение устанавливает вредоносные программы на компьютер пользователя (например, [PowerShell Empire).](https://www.powershellempire.com/)

7. Вредоносная программа позволяет злоумышленнику украсть (или снова украсть) имя пользователя и пароль или другие учетные данные из локальной машины и выполнять другие вредоносные действия.

## <a name="what-a-rules-and-custom-forms-injection-attack-might-look-like-office-365"></a>Как может выглядеть атака "Правила" и "Впрыски пользовательских форм" Office 365?

Эти механизмы сохраняемости вряд ли будут замечены пользователями и в некоторых случаях могут даже быть невидимыми для них. В этой статье рассказывается, как найти любой из семи знаков (Индикаторы компромисса), перечисленных ниже. Если вы найдете какой-либо из них, необходимо предпринять действия по исправлению.

- **Индикаторы компромисса Правил:**
  - Действие правила — запустить приложение.
  - Правило ссылается на URL-адрес EXE, ZIP или URL-адрес.
  - На локальной машине и посмотрите на новые процессы, которые возникают из Outlook PID.

- **Индикаторы компрометации настраиваемой формы:**
  - Пользовательские формы, представленные в качестве собственного класса сообщений.
  - Класс сообщений содержит исполняемый код.
  - Как правило, вредоносные формы хранятся в библиотеке личных форм или папках "Входящие".
  - Форма называется IPM. Примечание. [настраиваемая фамилия].

## <a name="steps-for-finding-signs-of-this-attack-and-confirming-it"></a>Действия по обнаружению признаков этой атаки и ее подтверждению

Для подтверждения атаки можно использовать любой из следующих методов:

- Вручную изучите правила и формы для каждого почтового ящика с помощью Outlook клиента. Этот метод является тщательным, но вы можете проверить только один почтовый ящик одновременно. Этот метод может быть очень трудоемким, если у вас есть много пользователей, чтобы проверить, а также может заразить компьютер, который вы используете.

- Используйте скрипт [Get-AllTenantRulesAndForms.ps1](https://github.com/OfficeDev/O365-InvestigationTooling/blob/master/Get-AllTenantRulesAndForms.ps1) PowerShell, чтобы автоматически сбросить все правила пересылания почты и настраиваемые формы для всех пользователей в вашем аренде. Это самый быстрый и безопасный метод с наименьшим количеством накладных расходов.

### <a name="confirm-the-rules-attack-using-the-outlook-client"></a>Подтверждение атаки правил с помощью Outlook клиента

1. Откройте для Outlook клиента в качестве пользователя. Пользователю может потребоваться ваша помощь в проверке правил в почтовом ящике.

2. Обратитесь [к управлению](https://support.microsoft.com/office/c24f5dea-9465-4df4-ad17-a50704d66c59) сообщениями электронной почты, используя статью правил для процедур, как открыть интерфейс правил в Outlook.

3. Найди правила, которые пользователь не создал, или какие-либо неожиданные правила или правила с подозрительными именами.

4. В описании правила описаны действия правил, которые запускают и приложения или ссылаются на .EXE, .ZIP или на запуск URL-адреса.

5. Найди новые процессы, которые начинаются с Outlook процесса. Обратитесь [к ссылке Найти ID процесса](/windows-hardware/drivers/debugger/finding-the-process-id).

### <a name="steps-to-confirm-the-forms-attack-using-the-outlook-client"></a>Действия по подтверждению атаки Forms с помощью Outlook клиента

1. Откройте клиент Outlook как пользователь.

2. Выполните действия, [покажите вкладку Разработчик](https://support.microsoft.com/office/e1192344-5e56-4d45-931b-e5fd9bea2d45) для пользовательской версии Outlook.

3. Откройте теперь видимую вкладку разработчика в Outlook и нажмите **кнопку разработать форму**.

4. Выберите **почтовый ящик** из **списка Look In.** И посмотрите на любые настраиваемые формы. Пользовательские формы достаточно редки, что если у вас есть какие-либо настраиваемые формы на всех, это стоит более глубокий взгляд.

5. Изучите любые настраиваемые формы, особенно те, которые помечены как скрытые.

6. Откройте любые настраиваемые формы и в группе **форм** нажмите **кнопку Просмотр кода,** чтобы узнать, что выполняется при загрузке формы.

### <a name="steps-to-confirm-the-rules-and-forms-attack-using-powershell"></a>Действия по подтверждению атаки Правил и форм с помощью PowerShell

Самый простой способ проверки атаки правил или настраиваемой формы — запустить [Get-AllTenantRulesAndForms.ps1](https://github.com/OfficeDev/O365-InvestigationTooling/blob/master/Get-AllTenantRulesAndForms.ps1) PowerShell. Этот скрипт подключается к каждому почтовому ящику клиента и сбрасывает все правила и формы в два .csv файлов.

#### <a name="pre-requisites"></a>Необходимые условия

Чтобы запустить сценарий, необходимо иметь права глобального администратора, так как сценарий подключается к каждому почтовому ящику в аренде для чтения правил и форм.

1. Вопишите в машину, на которую будет запускаться сценарий с правами местного администратора.

2. Скачайте или скопируйте Get-AllTenantRulesAndForms.ps1 из GitHub в папку, из которой он будет запускаться. Сценарий создаст два файла с печатью даты в этой папке, MailboxFormsExport-yyyy-mm-dd.csv и MailboxRulesExport-yyyy-mm-dd.csv.

3. Откройте экземпляр PowerShell в качестве администратора и откройте папку, в которая сохранен сценарий.

4. Выполните эту командную строку PowerShell следующим образом `.\Get-AllTenantRulesAndForms.ps1`.\Get-AllTenantRulesAndForms.ps1

#### <a name="interpreting-the-output"></a>Интерпретация вывода

- **MailboxRulesExport-*yyyy-mm-dd*.csv**: Изучите правила (по одной строке) для условий действий, которые включают приложения или исполняемые:

  - **ActionType (столбец A).** Если вы видите значение "ID_ACTION_CUSTOM", правило, скорее всего, является вредоносным.

  - **IsPotentiallyMalicious (столбец D)**: Если это значение "TRUE", правило, скорее всего, является вредоносным.

  - **ActionCommand (столбец G).** Если в этом столбце перечислены приложения или любой файл с .exe или .zip расширениями или неизвестным входом, который ссылается на URL-адрес, правило, скорее всего, является вредоносным.

- **Почтовые ящикиFormsExport-*yyy-mm-dd*.csv:** В общем, использование настраиваемой формы встречается редко. Если вы найдете какой-либо из них в этой книге, откройте почтовый ящик этого пользователя и изучите форму. Если организация намеренно не поместила ее туда, она, скорее всего, является вредоносной.

## <a name="how-to-stop-and-remediate-the-outlook-rules-and-forms-attack"></a>Остановка и исправление атаки Outlook правил и форм

Если вы найдете какие-либо доказательства любой из этих атак, исправление просто, просто удалите правило или форму из почтового ящика. Это можно сделать с помощью Outlook или с помощью удаленной PowerShell для удаления правил.

### <a name="using-outlook"></a>Использование Outlook

1. Определите все устройства, которые пользователь использовал с Outlook. Все они должны быть очищены от потенциальных вредоносных программ. Не разрешайте пользователю войти и использовать электронную почту до очистки всех устройств.

2. Выполните действия в [правиле Удалить для](https://support.microsoft.com/office/2f0e7139-f696-4422-8498-44846db9067f) каждого устройства.

3. Если вы не уверены в наличии других вредоносных программ, вы можете форматировать и переустановить все программное обеспечение на устройстве. Для мобильных устройств можно следовать шагам производителей, чтобы сбросить устройство на заводской образ.

4. Установите самые последние версии Outlook. Помните, что текущая версия Outlook блокирует оба типа этой атаки по умолчанию.

5. После удаления всех автономных копий почтового ящика сбросйте пароль пользователя (используйте высококачественный) и [](../../admin/security-and-compliance/set-up-multi-factor-authentication.md) выполните действия в настройках многофакторной проверки подлинности для пользователей, если MFA еще не включен. Это гарантирует, что учетные данные пользователя не будут подвергаться воздействию других средств (например, фишинга или повторного использования пароля).

### <a name="using-powershell"></a>Использование PowerShell

Существует два удаленных комлета PowerShell, которые можно использовать для удаления или отключения опасных правил. Просто следуйте шагам.

#### <a name="steps-for-mailboxes-that-are-on-an-exchange-server"></a>Действия для почтовых ящиков, которые находятся на Exchange сервере

1. Подключение на сервер Exchange с помощью удаленной PowerShell. Выполните действия в [Подключение для Exchange серверов с помощью удаленной PowerShell.](/powershell/exchange/connect-to-exchange-servers-using-remote-powershell)

2. Если вы хотите полностью удалить одно правило, несколько правил или все правила из почтового ящика, используйте [cmdlet Remove-InboxRule.](/powershell/module/exchange/Remove-InboxRule)

3. Если вы хотите сохранить правило и его содержимое для дальнейшего исследования, используйте для этого [cmdlet Disable-InboxRule.](/powershell/module/exchange/disable-inboxrule)

#### <a name="steps-for-mailboxes-in-exchange-online"></a>Действия для почтовых ящиков в Exchange Online

1. Следуйте шагам [в Подключение Exchange Online с помощью PowerShell](/powershell/exchange/connect-to-exchange-online-powershell).

2. Если вы хотите полностью удалить одно правило, несколько правил или все правила из почтового ящика, используйте комлет [Правила](/powershell/module/exchange/Remove-InboxRule) удаления входящие.

3. Если вы хотите сохранить правило и его содержимое для дальнейшего исследования, используйте для этого [cmdlet Disable-InboxRule.](/powershell/module/exchange/disable-inboxrule)

## <a name="how-to-minimize-future-attacks"></a>Минимизация будущих атак

### <a name="first-protect-your-accounts"></a>Во-первых: защита учетных записей

Эксплойты Правил и форм используются злоумышленником только после кражи или взлома одной из учетных записей пользователя. Таким образом, первым шагом к предотвращению использования этих эксплойтов в вашей организации является агрессивная защита учетных записей пользователей. Некоторые из наиболее распространенных способов взлома учетных записей — это атаки с помощью фишинга или [спрея паролей.](https://www.microsoft.com/security/blog/2020/04/23/protecting-organization-password-spray-attacks/)

Лучший способ защиты учетных записей пользователей и особенно учетных записей администратора — настроить многофакторную [проверку подлинности для пользователей.](../../admin/security-and-compliance/set-up-multi-factor-authentication.md) Вы также должны:

- Отслеживание доступа и использования учетных записей [пользователей.](/azure/active-directory/active-directory-view-access-usage-reports) Вы не можете предотвратить первоначальное нарушение, но сократите продолжительность и влияние нарушения, обнаружив его раньше. Вы можете использовать эти [Office 365 Cloud App Security для](/cloud-app-security/what-is-cloud-app-security) мониторинга учетных записей и оповещения о необычных действиях:

  - **Несколько** неудачных попыток входа: эта политика профилирует среду и вызывает оповещения, когда пользователи выполняют несколько неудачных действий входа в одном сеансе по отношению к выучатой базовой линии, что может указывать на попытку нарушения.

  - **Невозможное** путешествие. Эта политика определяет среду и вызывает оповещения, когда действия обнаруживаются у одного и того же пользователя в разных местах в течение периода времени, который меньше ожидаемого времени перемещения между двумя расположениями. Это может указывать на то, что другой пользователь использует те же учетные данные. Обнаружение этого аномального поведения требует начального периода обучения в семь дней, в течение которого он узнает шаблон активности нового пользователя.

  - **Необычное** вымысированное действие (по пользователю) : эта политика профилирует среду и вызывает оповещения, когда пользователи выполняют несколько обезличенных действий в одном сеансе в отношении базового уровня, который может указывать на попытку нарушения.

- Используйте такой инструмент, как [Office 365 secure Score](https://securescore.office.com/) для управления конфигурациями и поведением безопасности учетной записи.

### <a name="second-keep-your-outlook-clients-current"></a>Во-вторых, Outlook клиентов

Полностью обновленные и исправленные версии Outlook 2013 и 2016 г. по умолчанию отключают действие правила и формы "Начните приложение". Это гарантирует, что даже если злоумышленник нарушает учетную запись, действие правила и формы будет заблокировано. Вы можете установить последние обновления и исправления безопасности, следуя шагам в [Install Office обновлений](https://support.microsoft.com/office/2ab296f3-7f03-43a2-8e50-46de917611c5).

Вот версии исправлений для Outlook 2013 и 2016 г.:

- **Outlook 2016**: 16.0.4534.1001 или больше.

- **Outlook 2013**: 15.0.4937.1000 или больше.

Дополнительные сведения об отдельных исправлениях безопасности см. в этой информации:

- [Outlook 2016 Исправление безопасности](https://support.microsoft.com/help/3191883)

- [Outlook 2013 исправление безопасности](https://support.microsoft.com/help/3191938)

### <a name="third-monitor-your-outlook-clients"></a>Третье: мониторинг Outlook клиентов

Обратите внимание, что даже при установке исправлений и обновлений злоумышленник может изменить конфигурацию локальной машины, чтобы повторно включить поведение "Начните приложение". С помощью [advanced Group Policy Management](/microsoft-desktop-optimization-pack/agpm/) можно отслеживать и применять локальные политики машин для клиентов.

Вы можете увидеть, было ли повторно включено "Начните приложение" с помощью переопределения в реестре с помощью сведений о просмотре реестра системы с помощью [64-битных](https://support.microsoft.com/help/305097)версий Windows . Проверьте эти подкайки:

- **Outlook 2016:**`HKEY_CURRENT_USER\Software\Microsoft\Office\16.0\Outlook\Security\`

- **Outlook 2013**:`HKEY_CURRENT_USER\Software\Microsoft\Office\15.0\Outlook\Security\`

Найми ключ EnableUnsafeClientMailRules. Если он существует и установлен до 1, Outlook исправление безопасности было переопределено, и компьютер уязвим для атаки Form/Rules. Если значение 0, действие "Начните приложение" отключено. Если обновленная и исправленная версия Outlook установлена, а этого ключа реестра нет, система не уязвима для этих атак.

Пользователи с локальной Exchange должны рассмотреть возможность блокировки старых версий Outlook, которые не имеют доступных исправлений. Сведения об этом процессе можно найти в статье Настройка Outlook [клиента.](/exchange/configure-outlook-client-blocking-exchange-2013-help)

## <a name="secure-microsoft-365-like-a-cybersecurity-pro"></a>Защитите Microsoft 365 на профессиональном уровне

Для вашей подписки Microsoft 365 предусмотрен целый ряд полезных функций безопасности, которые можно использовать для защиты ваших данных и пользователей. Используйте статью к [Стратегия развития безопасности Microsoft 365: приоритеты на первые 30 дней, 90 дней и далее](security-roadmap.md), чтобы применить лучшие методики, рекомендованные корпорацией Майкрософт, для защиты вашего клиента Microsoft 365.

- Задачи для выполнения в первые 30 дней. Они имеют непосредственный эффект и мало влияют на пользователей.

- Задачи для выполнения в течение 90 дней. Эти задачи требуют немного больше времени на планирование и реализацию, но значительно укрепляют вашу безопасность.

- Более 90 дней. Эти меры дополняют ваши действия в течение первых 90 дней.

## <a name="see-also"></a>См. также:

- [Вредоносные Outlook в](https://silentbreaksecurity.com/malicious-outlook-rules/) SilentBreak Security Post о векторе правил предоставляют подробный обзор того, как Outlook правила.

- [MAPI над HTTP и Mailrule Pwnage](https://sensepost.com/blog/2016/mapi-over-http-and-mailrule-pwnage/) в блоге Sensepost о Mailrule Pwnage обсуждает средство под названием Ruler, которое позволяет использовать почтовые ящики Outlook правил.

- [Outlook формы и оболочки в](https://sensepost.com/blog/2017/outlook-forms-and-shells/) блоге Sensepost о векторе угрозы форм.

- [Линейка codebase](https://github.com/sensepost/ruler)

- [Индикаторы компромисса линейки](https://github.com/sensepost/notruler/blob/master/iocs.md)