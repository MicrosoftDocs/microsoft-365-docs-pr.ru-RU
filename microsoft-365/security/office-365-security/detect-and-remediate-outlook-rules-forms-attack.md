---
title: Обнаружение и исправление атак с введением в правила Outlook и пользовательские формы.
f1.keywords:
- NOCSH
ms.author: tracyp
author: MSFTTracyp
manager: dansimp
ms.date: 04/23/2018
audience: ITPro
ms.topic: article
ms.collection:
- o365_security_incident_response
- M365-security-compliance
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- MET150
description: Узнайте, как распознавать и устранять атаки с введением в правила Outlook и настраиваемые формы в Office 365
ms.custom: seo-marvel-apr2020
ms.openlocfilehash: cbdc41315d64d341248d6900147aabc5a0b9877c
ms.sourcegitcommit: 47de4402174c263ae8d70c910ca068a7581d04ae
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2020
ms.locfileid: "49663647"
---
# <a name="detect-and-remediate-outlook-rules-and-custom-forms-injections-attacks"></a>Обнаружение и устранение атак с правилами Outlook и пользовательскими формами

[!INCLUDE [Microsoft 365 Defender rebranding](../includes/microsoft-defender-for-office.md)]


**Сводка** Узнайте, как распознавать и устранять атаки с правилами Outlook и пользовательскими формами в Office 365.

## <a name="what-is-the-outlook-rules-and-custom-forms-injection-attack"></a>What is the Outlook Rules and Custom Forms injection attack?

После того как злоумышленник взломает учетную запись в вашем аренде и вошел в нее, он попытается установить способ оставаться в системе или вернуться после обнаружения и удаления. Это называется созданием механизма сохраняемости. Два способа сделать это — использовать правила Outlook или внедрять настраиваемые формы в Outlook.
В обоих случаях правило или форма синхронизируются из облачной службы вниз с классическим клиентом, поэтому полный формат и повторное установка клиентского программного обеспечения не устраняют механизм встраивания. Это происходит потому, что при повторном подсоединение клиентского программного обеспечения Outlook к почтовому ящику в облаке оно повторно скачивает правила и формы из облака. После установки правил и форм злоумышленник использует их для выполнения удаленного или пользовательского кода, как правило, для установки вредоносных программ на локальном компьютере. Затем вредоносная программа повторно похищает учетные данные или выполняет другие незаконные действия.
В этом случае мы будем уверены, что если клиенты будут исправлены до последней версии, вы не будете уязвимыми к угрозе, так как текущие клиентские настройки Outlook по умолчанию блокируют оба механизма.

Атаки обычно следуют следующим шаблонам:

**Эксплойт правил:**

1. Злоумышленник похищает имя пользователя и пароль одного из ваших пользователей.

2. Затем злоумышленник войтывает в почтовый ящик Exchange пользователей. Почтовый ящик может быть либо в Exchange Online, либо в локальной exchange.

3. Затем злоумышленник создает правило пересылки в почтовом ящике, которое запускается, когда почтовый ящик получает сообщение электронной почты, которое соответствует условиям правила. Критерии правила и содержимое триггера электронной почты адаптированы друг для друга.

4. Злоумышленник отправляет сообщение с триггером пользователю, который обычно использует свой почтовый ящик.

5. При получении сообщения электронной почты запускается правило. Обычно правило запускает приложение на удаленном сервере WebDAV.

6. Как правило, приложение устанавливает вредоносное ПО, например [Powershell Вайл,](https://www.powershellempire.com/)локально на компьютере пользователя.

7. Вредоносная программа позволяет злоумышленнику повторно украсть имя пользователя и пароль или другие учетные данные с локального компьютера и выполнять другие вредоносные действия.

**Эксплойт форм:**

1. Злоумышленник похищает имя пользователя и пароль одного из ваших пользователей.

2. Затем злоумышленник должен войти в этот почтовый ящик Exchange. Почтовый ящик может быть либо в Exchange Online, либо в локальной exchange.

3. Затем злоумышленник создает настраиваемый шаблон формы почты и вставляет его в почтовый ящик пользователя. Настраиваемая форма запускается, когда почтовый ящик получает сообщение электронной почты, в которое необходимо загрузить настраиваемую форму. Настраиваемая форма и формат электронной почты адаптированы друг для друга.
4. Злоумышленник отправляет сообщение с триггером пользователю, который обычно использует свой почтовый ящик.

5. При получении электронного письма форма загружается. Форма запускает приложение на удаленном сервере WebDAV.

6. Как правило, приложение устанавливает вредоносные программы, такие как [Powershell Вайл,](https://www.powershellempire.com/)локально на компьютере пользователя.

7. Вредоносная программа позволяет злоумышленнику повторно украсть имя пользователя и пароль или другие учетные данные с локального компьютера и выполнять другие вредоносные действия.

## <a name="what-a-rules-and-custom-forms-injection-attack-might-look-like-office-365"></a>Как может выглядеть атака с правилами и пользовательскими формами в Office 365?

Эти механизмы сохраняемости вряд ли будут замечены вашими пользователями и в некоторых случаях даже невидимы для них. В этой статье рассказывается, как искать любые из семи признаков ("Индикаторы компрометации"), перечисленных ниже. При их поиске необходимо предпринять действия по исправлению.

- Индикаторы компрометации правил:

  - Действие правила — запуск приложения.

  - Правило ссылается на EXE-адрес, ZIP-адрес или URL-адрес.

  - На локальном компьютере найди новый процесс, который начинается из PID Outlook.

- Индикаторы компрометации настраиваемой формы:

  - Настраиваемая форма, сохраненная как собственный класс сообщения.

  - Класс сообщения содержит исполняемый код.

  - Обычно хранится в библиотеке личных форм или папках "Входящие".

  - Форма называется IPM. Примечание. [пользовательское имя].

## <a name="steps-for-finding-signs-of-this-attack-and-confirming-it"></a>Действия по обнаружению признаков этой атаки и ее подтверждению

Для подтверждения атаки можно использовать любой из этих двух методов:

- Вручную проверьте правила и формы для каждого почтового ящика с помощью клиента Outlook. Этот метод является тщательным, но вы можете проверять пользователя почтового ящика только за один раз, что может быть очень трудоемким, если у вас много пользователей для проверки. Это также может привести к нарушению безопасности компьютера, с который вы проводите проверку.

- Используйте [ сценарийGet-AllTenantRulesAndForms.ps1](https://github.com/OfficeDev/O365-InvestigationTooling/blob/master/Get-AllTenantRulesAndForms.ps1) PowerShell, чтобы автоматически дамп всех правил пересылки почты и настраиваемые формы для всех пользователей в вашем аренде. Это самый быстрый и безопасный метод с наименьшим объемом накладных расходов.

### <a name="confirm-the-rules-attack-using-the-outlook-client"></a>Подтверждение атаки правил с помощью клиента Outlook

1. Откройте клиент Outlook пользователей в качестве пользователя. Пользователю может потребоваться ваша помощь при проверке правил в его почтовом ящике.

2. Процедуры [открытия интерфейса](https://support.microsoft.com/office/c24f5dea-9465-4df4-ad17-a50704d66c59) правил в Outlook можно найти в статье "Управление сообщениями электронной почты с помощью правил".

3. Найди правила, которые пользователь не создал, или непредвиденные правила или правила с подозрительными именами.

4. Посмотрите в описании правила действия правила, которые запускают и приложения или ссылаются на . EXE, . ZIP-файл или запуск URL-адреса.

5. Найди новые процессы, которые начинают использовать ИД процесса Outlook. Ссылка на [поиск ИД процесса.](https://docs.microsoft.com/windows-hardware/drivers/debugger/finding-the-process-id)

### <a name="steps-to-confirm-the-forms-attack-using-the-outlook-client"></a>Действия для подтверждения атаки на forms с помощью клиента Outlook

1. Откройте клиент Outlook в качестве пользователя.

2. Выполните действия, которые необходимо предпринять, [на вкладке "Разработчик"](https://support.microsoft.com/office/e1192344-5e56-4d45-931b-e5fd9bea2d45) для пользователей версии Outlook.

3. Откройте теперь видимую вкладку разработчика в Outlook и **щелкните "Создать форму".**

4. Выберите **"Входящие"** в **списке "Просмотр".** Найми все настраиваемые формы. Настраиваемые формы встречаются достаточно редко, поэтому если у вас есть какие-либо настраиваемые формы, стоит более глубокий вид.

5. Изучите все настраиваемые формы, особенно те, которые помечены как скрытые.

6. Откройте все настраиваемые формы и в группе **форм** щелкните "Просмотреть **код",** чтобы увидеть, что выполняется при загрузке формы.

### <a name="steps-to-confirm-the-rules-and-forms-attack-using-powershell"></a>Действия для подтверждения атаки на правила и формы с помощью PowerShell

Самый простой способ проверить правила или настраиваемую атаку на формы — запустить [ сценарий ](https://github.com/OfficeDev/O365-InvestigationTooling/blob/master/Get-AllTenantRulesAndForms.ps1)Get-AllTenantRulesAndForms.ps1PowerShell. Этот сценарий подключается к каждому почтовому ящику в клиенте и создает дампа всех правил и форм в два CSV-файла.

#### <a name="pre-requisites"></a>Необходимые условия

Для запуска сценария необходимы права глобального администратора, так как сценарий подключается к каждому почтовому ящику в аренде для чтения правил и форм.

1. Во sign in to the machine that you will run the script from with with local administrator rights.

2. Скачайте или скопируйте Get-AllTenantRulesAndForms.ps1 из GitHub в папку, из которой вы будете его запускать. Сценарий создаст в этой папке два файла с отметкой даты, MailboxFormsExport-yyyy-mm-dd.csv и MailboxRulesExport-yyyy-mm-dd.csv.

3. Откройте экземпляр PowerShell от учетной записи администратора и откройте папку, в которая сохранен сценарий.

4. Запустите эту командную строку PowerShell, как по.\Get-AllTenantRulesAndForms.ps1 `.\Get-AllTenantRulesAndForms.ps1`

#### <a name="interpreting-the-output"></a>Интерпретация выходных данных

- **MailboxRulesExport-*yyyy-mm-dd*.csv**: проверьте правила (по одному на строку) на условия действий, которые включают приложения или исполняемые исполняемые приложения:

  - **ActionType (столбец A).** Если вы видите значение "ID_ACTION_CUSTOM", правило, скорее всего, является вредоносным.

  - **IsPotentiallyMalicious (столбец D)**: если это значение имеет значение TRUE, правило, скорее всего, является вредоносным.

  - **ActionCommand (столбец G)**: если в этом списке перечислены приложение или любой файл с РАСШИРЕНИЕм ZIP или записью, которая ссылается на URL-адрес, который не должен там быть, правило, скорее всего, является вредоносным.

- **MailboxFormsExport-*yyy-mm-dd*.csv**: как правило, использование настраиваемой формы очень редко. Если в этой книге есть такая книга, вы открываете почтовый ящик этого пользователя и проверяете форму. Если ваша организация намеренно не поместила ее в нее, скорее всего, она является вредоносной.

## <a name="how-to-stop-and-remediate-the-outlook-rules-and-forms-attack"></a>Остановка и устранение атак с правилами и формами Outlook

Если вы найдете какие-либо признаки какой-либо из этих атак, исправление будет простым, просто удалите правило или форму из почтового ящика. Это можно сделать с помощью клиента Outlook или удаленной powerShell для удаления правил.

### <a name="using-outlook"></a>Использование Outlook

1. Определите все устройства, которые пользователь использовал с Outlook. Все они должны быть очищены от потенциальной вредоносной программы. Не разрешайте пользователю вошел и мог использовать электронную почту, пока не будут очищены все устройства.

2. Выполните действия, которые необходимо [предпринять при удалении правила](https://support.microsoft.com/office/2f0e7139-f696-4422-8498-44846db9067f) для каждого устройства.

3. Если вы не уверены в наличии других вредоносных программ, вы можете отформатировать и повторно установить все программное обеспечение на устройстве. Для мобильных устройств можно следовать шагам изготовителей, чтобы сбросить устройство до заводского образа.

4. Установите самые последние версии Outlook. Помните, что текущая версия Outlook по умолчанию блокирует оба типа этой атаки.

5. После удаления всех автономных копий почтового ящика сбросйте пароль пользователя (используйте высококачественный) и [](https://docs.microsoft.com/microsoft-365/admin/security-and-compliance/set-up-multi-factor-authentication) следуйте шагам в настройке многофакторной проверки подлинности для пользователей, если многофакторная проверка подлинности еще не включена. Это гарантирует, что учетные данные пользователя не будут выводиться другими способами (например, фишингом или повторно использовать пароль).

### <a name="using-powershell"></a>Использование PowerShell

Существует два удаленных cmdlets PowerShell, которые можно использовать для удаления или отключения опасных правил. Просто следуйте этим шагам.

#### <a name="steps-for-mailboxes-that-are-on-an-exchange-server"></a>Действия для почтовых ящиков, которые находятся на сервере Exchange Server

1. Подключите сервер Exchange Server с помощью удаленной powerShell. Выполните действия, которые необходимо предпринять при [подключении к серверам Exchange с помощью удаленной powerShell.](https://docs.microsoft.com/powershell/exchange/connect-to-exchange-servers-using-remote-powershell)

2. Если вы хотите полностью удалить одно правило, несколько правил или все [](https://docs.microsoft.com/powershell/module/exchange/Remove-InboxRule) правила из почтового ящика, используйте его.

3. Если вы хотите сохранить правило и его содержимое для дальнейшего исследования, используйте для этого cmdlet [Disable-InboxRule.](https://docs.microsoft.com/powershell/module/exchange/disable-inboxrule)

#### <a name="steps-for-mailboxes-in-exchange-online"></a>Действия для почтовых ящиков в Exchange Online

1. Выполните действия, которые необходимо предпринять при [подключении к Exchange Online с помощью PowerShell.](https://docs.microsoft.com/powershell/exchange/connect-to-exchange-online-powershell)

2. Если вы хотите полностью удалить одно правило, несколько правил или все правила из почтового ящика, используйте его с помощью [cmdlet Remove-Inbox Rule.](https://docs.microsoft.com/powershell/module/exchange/Remove-InboxRule)

3. Если вы хотите сохранить правило и его содержимое для дальнейшего исследования, используйте для этого cmdlet [Disable-InboxRule.](https://docs.microsoft.com/powershell/module/exchange/disable-inboxrule)

## <a name="how-to-minimize-future-attacks"></a>Как свести к минимуму будущие атаки

### <a name="first-protect-your-accounts"></a>Во-первых: защитите свои учетные записи

Эксплойт правил и форм используется злоумышленником только после кражи или взлома одной из учетных записей пользователя. Поэтому первым шагом по предотвращению использования этих эксплойтов в организации является защита учетных записей пользователей. Некоторые из наиболее распространенных способов взлома учетных записей — фишинговые атаки или [распыление](https://www.dabcc.com/microsoft-defending-against-password-spray-attacks/) паролей.

Лучший способ защитить учетные записи пользователей, особенно учетные записи администраторов, — настроить многофакторную проверку [подлинности для пользователей.](https://docs.microsoft.com/microsoft-365/admin/security-and-compliance/set-up-multi-factor-authentication) Кроме того, вам следует:

- Отслеживайте доступ к учетным записям пользователей [и их использования.](https://docs.microsoft.com/azure/active-directory/active-directory-view-access-usage-reports) Начальное нарушение не может быть предотвращено, но его продолжительность и влияние будут сокращены за счет более скорого обнаружения. Вы можете использовать эти политики [Office 365 Cloud App Security](https://docs.microsoft.com/cloud-app-security/what-is-cloud-app-security) для отслеживания учетных записей и оповещения о необычных действиях:

  - Несколько неудачных попыток **входа:** эта политика профилирует среду и вызывает оповещения, когда пользователи выполняют несколько неудачных действий входа в одном сеансе по отношению к заданной базовой оценке, что может указывать на попытку взлома.

  - Невозможные перемещения: эта политика профилирует среду и вызывает оповещения при обнаружении действий от одного и того же пользователя в разных местах в течение периода времени, который меньше ожидаемого времени перемещения между двумя расположениями. Это может указывать на то, что другой пользователь использует одинаковые учетные данные. Обнаружение этого аномального поведения требует начального периода обучения в семь дней, в течение которого он получает данные о шаблоне активности нового пользователя.

  - Нестандартное обезличенные действия **(по пользователям):** эта политика профилирует среду и вызывает оповещения, когда пользователи выполняют несколько действий, выполнив в одном сеансе действия с учетом выявленных базовых показателей, что может указывать на попытку взлома.

- Используйте такое средство, как [оценка безопасности Office 365,](https://securescore.office.com/) для управления конфигурациями и поведением учетной записи.

### <a name="second-keep-your-outlook-clients-current"></a>Second: Keep your Outlook clients current

Полностью обновленные и исправленные версии Outlook 2013 и 2016 отключают действие правила или формы "Запустить приложение" по умолчанию. Это гарантирует, что даже если злоумышленник взломает учетную запись, действия правила и формы будут заблокированы. Вы можете установить последние обновления и исправления для системы безопасности, следуя шагам в [области установки обновлений Office.](https://support.microsoft.com/office/2ab296f3-7f03-43a2-8e50-46de917611c5)

Вот версии исправлений для клиентов Outlook 2013 и 2016:

- **Outlook 2016**: 16.0.4534.1001 или более.

- **Outlook 2013**: 15.0.4937.1000 или более.

Дополнительные сведения об отдельных исправлениях безопасности см. в:

- [Исправление для системы безопасности Outlook 2016](https://support.microsoft.com/help/3191883)

- [Исправление для системы безопасности Outlook 2013](https://support.microsoft.com/help/3191938)

### <a name="third-monitor-your-outlook-clients"></a>Третий: мониторинг клиентов Outlook

Обратите внимание, что даже после установки исправлений и обновлений злоумышленник может изменить конфигурацию локального компьютера, чтобы снова включить поведение "Запустить приложение". С помощью [advanced Group Policy Management](https://docs.microsoft.com/microsoft-desktop-optimization-pack/agpm/) вы можете отслеживать и применять политики локальных компьютеров на своих клиентах.

Чтобы узнать, включено ли повторное использование "Запуска приложения" через переопределения в реестре, можно использовать сведения в [64-битных](https://support.microsoft.com/help/305097)версиях Windows, чтобы просмотреть системный реестр. Проверьте эти подмайки:

- **Outlook 2016:**`HKEY_CURRENT_USER\Software\Microsoft\Office\16.0\Outlook\Security\`

- **Outlook 2013:**`HKEY_CURRENT_USER\Software\Microsoft\Office\15.0\Outlook\Security\`

Найми ключ EnableUnsafeClientMailRules. Если он существует и имеет 1, исправление безопасности Outlook переопределено, и компьютер является уязвимым к атаке на формы и правила. Если значение 0, действие "Запустить приложение" отключено. Если установлена обновленная и исправленная версия Outlook, а этот ключ реестра не существует, система не будет уязвимой для этих атак.

Клиентам с локальной установкой Exchange следует рассмотреть возможность блокировки более старых версий Outlook, в них нет доступных исправлений. Подробные сведения об этом процессе можно найти в статье "Настройка [блокировки клиента Outlook".](https://docs.microsoft.com/exchange/configure-outlook-client-blocking-exchange-2013-help)

## <a name="secure-microsoft-365-like-a-cybersecurity-pro"></a>Защитите Microsoft 365 на профессиональном уровне

Для вашей подписки Microsoft 365 предусмотрен целый ряд полезных функций безопасности, которые можно использовать для защиты ваших данных и пользователей. Используйте статью к [Стратегия развития безопасности Microsoft 365: приоритеты на первые 30 дней, 90 дней и далее](security-roadmap.md), чтобы применить лучшие методики, рекомендованные корпорацией Майкрософт, для защиты вашего клиента Microsoft 365.

- Задачи для выполнения в первые 30 дней. Они дают немедленный эффект и не создают помех вашим пользователям.

- Задачи для выполнения в течение 90 дней. Эти задачи требуют немного больше времени на планирование и реализацию, но значительно укрепляют вашу безопасность.

- Более 90 дней. Эти меры дополняют ваши действия в течение первых 90 дней.

## <a name="see-also"></a>См. также:

- [Вредоносные правила Outlook](https://silentbreaksecurity.com/malicious-outlook-rules/) с помощью SilentBreak Security Post о векторе правил предоставляют подробный обзор того, как правила Outlook.

- [MapI over HTTP и Mailrule Pwnage](https://sensepost.com/blog/2016/mapi-over-http-and-mailrule-pwnage/) в блоге Sensepost о Mailrule Pwnage обсуждают средство под названием Ruler, которое позволяет использовать почтовые ящики с помощью правил Outlook.

- [Формы и оболочки Outlook](https://sensepost.com/blog/2017/outlook-forms-and-shells/) в блоге Sensepost о векторе угрозы форм.

- [Ruler Codebase](https://github.com/sensepost/ruler)

- [Индикаторы компрометации линейки](https://github.com/sensepost/notruler/blob/master/iocs.md)
