---
title: Обнаружение и исправление нелегальных разрешений на согласие
f1.keywords:
- NOCSH
ms.author: tracyp
author: MSFTTracyp
manager: dansimp
ms.date: ''
audience: ITPro
ms.topic: article
ms.collection:
- o365_security_incident_response
- M365-security-compliance
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- MET150
description: Сведения о том, как распознать и исправить незаконное согласие на атаку в Microsoft Office 365.
ms.custom: seo-marvel-apr2020
ms.openlocfilehash: 125ebdf8b3d17e3a14abec8154129b0144928905
ms.sourcegitcommit: 6a1a8aa024fd685d04da97bfcbc8eadacc488534
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/12/2020
ms.locfileid: "46652961"
---
# <a name="detect-and-remediate-illicit-consent-grants"></a>Обнаружение и исправление нелегальных разрешений на согласие

**Сводка**  Сведения о том, как распознать и исправить незаконное согласие на атаку в Office 365.

## <a name="what-is-the-illicit-consent-grant-attack-in-office-365"></a>Что такое незаконная атака на предоставление согласия в Office 365?

При атаке с незаконным предоставлением согласия злоумышленник создает приложение, зарегистрированное в Azure, которое запрашивает доступ к данным, например контактной информации, электронной почте или документам. Затем злоумышленник выдает конечному пользователю разрешение на доступ к данным приложения через фишинг или путем добавления нелегального кода в доверенный веб-сайт. После получения согласия у нелегального приложения ему предоставляется доступ к данным на уровне учетной записи без необходимости в Организации. Обычные действия по исправлению, такие как сброс паролей для нарушений учетных записей или требование многофакторной проверки подлинности (MFA) для учетных записей, не являются эффективными при атаках этого типа, так как они являются сторонними приложениями и являются внешними по отношению к Организации.

Эти атаки используют модель взаимодействия, которая предполагает, что объект, вызывающий эту информацию, является автоматизацией, а не человеком.

> [!IMPORTANT]
> Вы считаете, что у вас возникли проблемы с незаконным согласием на предоставление разрешений из приложения, прямо сейчас? Microsoft Cloud App Security (МКАС) содержит средства для обнаружения, проверки и исправления приложений OAuth. В этой статье МКАС представлено руководство по [исследованию рискованных приложений OAuth](https://docs.microsoft.com/cloud-app-security/investigate-risky-oauth). Вы также можете задать [политики приложений OAuth](https://docs.microsoft.com/cloud-app-security/app-permission-policy) для исследования разрешений, запрошенных приложением, которые пользователи будут выполнять авторизацию для этих приложений, и при этом будут утверждать или отменять эти запросы разрешений.

## <a name="what-does-an-illicit-consent-grant-attack-look-like-in-office-365"></a>Как выглядит незаконная атака на предоставление согласия в Office 365?

Необходимо выполнить поиск в **журнале аудита** , чтобы найти знаки, также называемые индикаторами нарушения безопасности (IOC) данной атаки. Для организаций с множеством приложений, зарегистрированных с помощью Azure, и большим числом пользователей рекомендуется проанализировать предоставление разрешений в организациях еженедельно.

### <a name="steps-for-finding-signs-of-this-attack"></a>Действия по поиску подписывания этой атаки

1. Откройте **центр соответствия требованиям по безопасности &** по адресу <https://protection.office.com> .

2. Перейдите к разделу **Поиск** и выберите пункт **Поиск в журнале аудита**.

3. Выполните поиск (все действия и все пользователи) и введите начальную и конечную даты, если необходимо, и нажмите кнопку **Поиск**.

4. Нажмите кнопку **фильтровать результаты** и введите согласие для приложения в поле **действие** .

5. Щелкните результат, чтобы просмотреть сведения о действии. Щелкните **Дополнительные сведения** , чтобы получить сведения о действии. Убедитесь, что для Исадминконтент задано значение true.

> [!NOTE]
>
> Это может занять от 30 минут до 24 часов, чтобы соответствующая запись журнала аудита отображалась в результатах поиска после возникновения события.
>
> Время, в течение которого запись аудита сохраняется и может быть найдена в журнале аудита, зависит от подписки на Microsoft 365, а именно от типа лицензии, назначенной определенному пользователю. Дополнительные сведения см в разделе [журнал аудита](../../compliance/search-the-audit-log-in-security-and-compliance.md).
>
> Если это значение равно true, это указывает на то, что кто с глобальным администратором может получить доступ к данным. Если это не предусмотрено, выполните действия для [подтверждения атаки](#how-to-confirm-an-attack).

## <a name="how-to-confirm-an-attack"></a>Как проверить атаку

Если у вас есть один или несколько экземпляров Иокс, указанных выше, необходимо провести дальнейшее исследование, чтобы подтвердить возникновение атаки. Вы можете использовать любой из этих трех методов для подтверждения атаки:

- Приложения инвентаризации и их разрешения с помощью портала Azure Active Directory. Этот метод является исчерпывающим, но вы можете проверять только одного пользователя за раз, что может занять много времени, если у вас много пользователей для проверки.

- Приложения инвентаризации и их разрешения с помощью PowerShell. Это самый быстрый и наиболее тщательный метод, с минимальным количеством издержек.

- Попросите пользователей проверить свои приложения и разрешения и отправить результаты обратно администраторам для исправления.

## <a name="inventory-apps-with-access-in-your-organization"></a>Инвентаризация приложений с доступом в Организации

Это можно сделать для пользователей с помощью портала Azure Active Directory или с помощью PowerShell или попросите пользователей отдельно перечислить доступ к приложениям.

### <a name="steps-for-using-the-azure-active-directory-portal"></a>Действия по использованию портала Azure Active Directory

Вы можете найти приложения, которым любой отдельный пользователь предоставил разрешения с помощью [портала Azure Active Directory](https://portal.azure.com/).

1. Войдите на портал Azure с правами администратора.

2. Выберите колонку Azure Active Directory.

3. Выберите пункт **Пользователи**.

4. Выберите пользователя, которого вы хотите просмотреть.

5. Выберите пункт **приложения**.

Отобразятся приложения, назначенные пользователю, и разрешения, доступные приложениям.

### <a name="steps-for-having-your-users-enumerate-their-application-access"></a>Действия по перечислению доступа пользователей к приложениям

Попросите пользователей перейти на https://myapps.microsoft.com свой собственный доступ к приложениям и просмотреть их. Они должны иметь возможность просматривать все приложения с доступом, просматривать подробные сведения о них (в том числе область доступа), а также отменять права на подозрительные или незаконные приложения.

### <a name="steps-for-doing-this-with-powershell"></a>Действия для этого с помощью PowerShell

Самый простой способ проверить, может ли атака с незаконным предоставлением согласия выполнить [Get-AzureADPSPermissions.ps1](https://gist.github.com/psignoret/41793f8c6211d2df5051d77ca3728c09), в результате чего будут выведены все разрешения OAuth и приложения OAuth для всех пользователей в вашей организации в один CSV-файл.

#### <a name="pre-requisites"></a>Необходимые условия

- Библиотека Azure AD PowerShell установлена.

- Права глобального администратора клиента, для которого будет выполняться скрипт.

- Локальный администратор компьютера, на котором будут выполняться сценарии.

> [!IMPORTANT]
> ***Настоятельно рекомендуется*** требовать многофакторную проверку подлинности для учетной записи администратора. Этот скрипт поддерживает проверку подлинности MFA.

1. Войдите на компьютер, на котором будет выполняться сценарий с правами локального администратора.

2. Скачайте или скопируйте скрипт [Get-AzureADPSPermissions.ps1](https://gist.github.com/psignoret/41793f8c6211d2df5051d77ca3728c09) из GitHub в папку, из которой будет выполняться сценарий. Это будет та же папка, в которую будет записан выходной файл "permissions.csv".

3. Откройте экземпляр PowerShell от имени администратора и откройте папку, в которую вы сохранили скрипт.

4. Подключитесь к каталогу с помощью командлета [Connect – AzureAD](https://docs.microsoft.com/powershell/module/azuread/connect-azuread) .

5. Выполните следующую команду PowerShell:

   ```powershell
   Get-AzureADPSPermissions.ps1 | Export-csv -Path "Permissions.csv" -NoTypeInformation
   ```

Сценарий создает один файл с именем Permissions.csv. Выполните следующие действия, чтобы найти незаконные предоставления разрешений приложений:

1. В столбце Консенттипе (столбец G) найдите значение "АллпринЦиплес". Разрешение АллпринЦипалс позволяет клиентскому приложению получать доступ к контенту всех пользователей в Организации. Встроенные приложения Microsoft 365 требуют, чтобы это разрешение работало правильно. Следует внимательно проанализировать все приложения, отличные от Майкрософт, с этим разрешением.

2. В столбце Permission (Column F) просмотрите разрешения, которые у каждого делегированного приложения есть в содержимом. Ищите разрешение "чтение" и "запись" или "*. Разрешение ALL и внимательно изучите их, так как они могут быть неуместны.

3. Изучите определенных пользователей, которым предоставлены полученные разрешения. Если высокая или высокая степень влияния на пользователей приводят к неприемлемому получению, следует проанализировать дополнительные сведения.

4. В столбце Клиентдисплайнаме (столбец C) найдите приложения, которые кажутся подозрительными. Приложения с неправильными именами, именами Super Бланд или звуковыми названиями хакеров следует внимательно рассмотреть.

## <a name="determine-the-scope-of-the-attack"></a>Определение области атаки

Завершив инвентаризацию доступа к приложению, просмотрите **журнал аудита** , чтобы определить полную область нарушения. Поиск затронутых пользователей, временных кадров, к которым приложение было незаконно получило доступ к вашей организации, а также разрешения, которые имело приложение. Вы можете выполнить поиск в **журнале аудита** в [центре безопасности и соответствия требованиям Microsoft 365](https://docs.microsoft.com/microsoft-365/compliance/search-the-audit-log-in-security-and-compliance).

> [!IMPORTANT]
> Для получения этих сведений необходимо включить [Аудит и](https://docs.microsoft.com/microsoft-365/compliance/enable-mailbox-auditing) [Аудит действий для администраторов и пользователей,](https://docs.microsoft.com/microsoft-365/compliance/turn-audit-log-search-on-or-off) прежде чем приступить к атакам.

## <a name="how-to-stop-and-remediate-an-illicit-consent-grant-attack"></a>Как отказаться от атак с незаконным предоставлением согласия

После определения приложения с незаконными разрешениями вы можете удалить этот доступ несколькими способами.

- Вы можете отозвать разрешение приложения на портале Azure Active Directory, выполнив следующие действия:

  - Перейдите к затронутому пользователю в колонке **пользователя Azure Active Directory** .

  - Выберите пункт **приложения**.

  - Выберите нелегальное приложение.

  - Нажмите кнопку **Удалить** в разделе Детализация.

- Вы можете отозвать предоставление согласия OAuth с помощью PowerShell, выполнив действия, описанные в командлете [Remove – AzureADOAuth2PermissionGrant](https://docs.microsoft.com/powershell/module/azuread/Remove-AzureADOAuth2PermissionGrant).

- Вы можете отозвать назначение роли приложения службы с помощью PowerShell, выполнив действия, описанные в статье [Remove – азуреадсервицеаппролеассигнмент](https://docs.microsoft.com/powershell/module/azuread/Remove-AzureADServiceAppRoleAssignment).

- Вы также можете отключить вход в затронутую учетную запись, что в свою очередь отключит доступ приложений к данным в этой учетной записи. Это не является идеальным условием для продуктивности конечного пользователя, но если вы работаете над ограничениями на снижение влияния, это может быть приемлемым краткосрочным исправлением.

- Вы можете отключить интегрированные приложения для вашего клиента. Это радикальный этап, который отключает возможность предоставления конечным пользователям разрешения на уровне клиента. Это предотвратит непреднамеренное предоставление пользователям доступа к вредоносному приложению. Это не рекомендуется, так как серьезно снижает способность пользователей работать с приложениями сторонних производителей. Для этого выполните действия, описанные в статье [Включение и отключение интегрированных приложений](https://docs.microsoft.com/microsoft-365/admin/misc/integrated-apps).

## <a name="secure-microsoft-365-like-a-cybersecurity-pro"></a>Защитите Microsoft 365 на профессиональном уровне

Для вашей подписки Microsoft 365 предусмотрен целый ряд полезных функций безопасности, которые можно использовать для защиты ваших данных и пользователей. Используйте статью к [Стратегия развития безопасности Microsoft 365: приоритеты на первые 30 дней, 90 дней и далее](security-roadmap.md), чтобы применить лучшие методики, рекомендованные корпорацией Майкрософт, для защиты вашего клиента Microsoft 365.

- Задачи для выполнения в первые 30 дней. Они дают немедленный эффект и не создают помех вашим пользователям.

- Задачи для выполнения в течение 90 дней. Эти задачи требуют немного больше времени на планирование и реализацию, но значительно укрепляют вашу безопасность.

- Более 90 дней. Эти меры дополняют ваши действия в течение первых 90 дней.

## <a name="see-also"></a>См. также:

- [Неожиданное приложение в списке "Мои приложения](https://docs.microsoft.com/azure/active-directory/application-access-unexpected-application) " просматривает администраторов с помощью различных действий, которые могут потребоваться после реализации приложений с доступом к данным.

- [Интеграция приложений с Azure Active Directory](https://docs.microsoft.com/azure/active-directory/active-directory-apps-permissions-consent) — это высокоуровневый обзор разрешений и разрешений.

- [Проблемы при разработке приложения](https://docs.microsoft.com/azure/active-directory/active-directory-application-dev-development-content-map) предоставляет ссылки на различные статьи, связанные с согласием.

- [Объекты приложения и субъекта-службы в Azure Active Directory (Azure AD)](https://docs.microsoft.com/azure/active-directory/develop/active-directory-application-objects) предоставляет общие сведения об основных объектах приложения и службы, которые являются основными для модели приложения.

- [Управление доступом к приложениям](https://docs.microsoft.com/azure/active-directory/active-directory-managing-access-to-apps) — обзор возможностей, которые администраторы могут использовать для управления доступом пользователей к приложениям.
