---
title: Обнаружение и устранение незаконного получения согласия
f1.keywords:
- NOCSH
ms.author: tracyp
author: MSFTTracyp
manager: dansimp
ms.date: ''
audience: ITPro
ms.topic: article
ms.collection:
- o365_security_incident_response
- M365-security-compliance
localization_priority: Normal
search.appverid:
- MET150
description: Узнайте, как распознавать и устранять незаконное согласие, предоставляя атаку в Microsoft Office 365.
ms.custom: seo-marvel-apr2020
ms.technology: mdo
ms.prod: m365-security
ms.openlocfilehash: a1c724bb3b201e0ddf1edea4794606c7083605e8
ms.sourcegitcommit: a1846b1ee2e4fa397e39c1271c997fc4cf6d5619
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/09/2021
ms.locfileid: "50165443"
---
# <a name="detect-and-remediate-illicit-consent-grants"></a>Обнаружение и устранение незаконного получения согласия

[!INCLUDE [Microsoft 365 Defender rebranding](../includes/microsoft-defender-for-office.md)]

**Область применения**
- [Microsoft Defender для Office 365 (план 1 и план 2)](https://go.microsoft.com/fwlink/?linkid=2148715)
- [Microsoft 365 Defender](https://go.microsoft.com/fwlink/?linkid=2118804)

**Сводка**  Узнайте, как распознавать и устранять незаконное согласие, предоставляя атаки в Office 365.

## <a name="what-is-the-illicit-consent-grant-attack-in-office-365"></a>Что такое атака с предоставлением незаконного согласия в Office 365?

В случае незаконного предоставления согласия злоумышленник создает зарегистрированное в Azure приложение, которое запрашивает доступ к таким данным, как контактные данные, электронная почта или документы. Затем злоумышленник дает конечному пользователю согласие на доступ к своим данным с помощью фишинговой атаки или путем внесения незаконного кода в доверенный веб-сайт. После предоставления незаконного согласия приложение имеет доступ к данным на уровне учетной записи без необходимости в учетной записи организации. Обычные действия по исправлению, такие как сброс паролей для учетных записей с нарушением безопасности или требование многофакторной проверки подлинности (MFA) для учетных записей, не являются эффективными для этого типа атак, так как это сторонние приложения, которые являются внешними по отношению к организации.

Эти атаки используют модель взаимодействия, которая предполагает, что вызываемая информация является автоматизацией, а не человеком.

> [!IMPORTANT]
> Вы подозреваете, что у вас возникли проблемы с незаконной предоставлением согласия из приложения? Microsoft Cloud App Security (MCAS) имеет средства для обнаружения, изучения и устранения ваших приложений OAuth. В этой статье MCAS имеется руководство по исследованию рискованных приложений [OAuth.](https://docs.microsoft.com/cloud-app-security/investigate-risky-oauth) Вы также можете настроить политики [приложений OAuth](https://docs.microsoft.com/cloud-app-security/app-permission-policy) для изучения разрешений, запрашиваемого приложением, пользователей, которые авторизют эти приложения, и широко утвердить или запретить эти запросы разрешений.

## <a name="what-does-an-illicit-consent-grant-attack-look-like-in-office-365"></a>Как выглядит атака с предоставлением незаконного согласия в Office 365?

Вам необходимо найти в журнале **аудита** признаки этой атаки, также называемые индикаторами компрометации (IOC). Для организаций с большим количеством зарегистрированных в Azure приложений и большой пользовательской базой лучше всего еженедельно пересматривать предоставление согласия вашей организации.

### <a name="steps-for-finding-signs-of-this-attack"></a>Действия по обнаружению признаков этой атаки

1. Откройте Центр **безопасности & соответствия требованиям по** <https://protection.office.com>

2. Перейдите **в поиск и** выберите поиск в **журнале аудита.**

3. Поиск (всех действий и всех пользователей) и введите дату начала и даты окончания, если это необходимо, а затем нажмите кнопку **"Поиск".**

4. Нажмите **кнопку "Фильтр" и** введите "Согласие на приложение" **в поле "Действие".**

5. Щелкните результат, чтобы увидеть сведения о действии. Щелкните **"Дополнительные сведения",** чтобы получить сведения о действии. Проверьте, установлено ли для isAdminContent true.

> [!NOTE]
>
> Отображение соответствующей записи журнала аудита в результатах поиска после возникновения события может занять от 30 минут до 24 часов.
>
> Продолжительность сохранения записи аудита и поиска в журнале аудита зависит от подписки на Microsoft 365, а именно от типа лицензии, назначенной определенному пользователю. Дополнительные сведения [см. в журнале аудита.](../../compliance/search-the-audit-log-in-security-and-compliance.md)
>
> Если это значение имеет значение true, это означает, что кто-то с доступом глобального администратора мог предоставить широкий доступ к данным. Если это непредвиденное, примите меры [для подтверждения атаки.](#how-to-confirm-an-attack)

## <a name="how-to-confirm-an-attack"></a>Подтверждение атаки

Если у вас есть один или несколько указанных выше экземпляров IOC, необходимо дополнительно исследовать, чтобы положительно подтвердить, что атака произошла. Для подтверждения атаки можно использовать любой из этих трех методов:

- Инвентаризация приложений и их разрешений с помощью портала Azure Active Directory. Этот метод является тщательным, но вы можете проверить только одного пользователя за раз, что может быть очень много времени, если у вас много пользователей для проверки.

- Инвентаризация приложений и их разрешений с помощью PowerShell. Это самый быстрый и тщательный метод с наименьшим объемом накладных расходов.

- Пользователи должны отдельно проверять свои приложения и разрешения и сообщать администраторам результаты для их устранения.

## <a name="inventory-apps-with-access-in-your-organization"></a>Инвентаризация приложений с доступом в организации

Вы можете сделать это для пользователей с помощью портала Azure Active Directory или PowerShell или по отдельности с помощью приложения.

### <a name="steps-for-using-the-azure-active-directory-portal"></a>Действия по использованию портала Azure Active Directory

Вы можете найти приложения, которым любой пользователь предоставил разрешения, с помощью портала [Azure Active Directory.](https://portal.azure.com/)

1. Во sign in to the Azure Portal with administrative rights.

2. Выберите blade Azure Active Directory.

3. Выберите пункт **Пользователи**.

4. Выберите пользователя, который вы хотите просмотреть.

5. Выберите **приложения.**

В этом документе покажутся приложения, которые назначены пользователю, и разрешения, которые у них есть.

### <a name="steps-for-having-your-users-enumerate-their-application-access"></a>Действия по предоставлению пользователям доступа к приложениям

Пользователи должны перейти к ним https://myapps.microsoft.com и просмотреть собственный доступ к приложениям. Они должны иметь возможность просматривать все приложения с доступом, просматривать сведения о них (включая область доступа) и отоскить привилегии подозрительным или запрещенным приложениям.

### <a name="steps-for-doing-this-with-powershell"></a>Действия для этого с помощью PowerShell

Самый простой способ проверить, что атака с предоставлением незаконного согласия — это запустить [Get-AzureADPSPermissions.ps1, ](https://gist.github.com/psignoret/41793f8c6211d2df5051d77ca3728c09)в результате чего все разрешения OAuth и приложения OAuth для всех пользователей в вашем аренде будут сброшены в один CSV-файл.

#### <a name="pre-requisites"></a>Необходимые условия

- Установлена библиотека Azure AD PowerShell.

- Права глобального администратора в клиенте, в отношении который будет запускаться сценарий.

- Локальный администратор на компьютере, с которого будут запускаться сценарии.

> [!IMPORTANT]
> Настоятельно ***рекомендуется использовать*** многофакторную проверку подлинности для учетной записи администратора. Этот сценарий поддерживает проверку подлинности MFA.

1. Во sign in to the computer that you will run the script from with with local administrator rights.

2. Скачайте или [ скопируйтеGet-AzureADPSPermissions.ps1](https://gist.github.com/psignoret/41793f8c6211d2df5051d77ca3728c09) из GitHub в папку, из которой будет запускаться сценарий. Это будет та же папка, в которую будет записан выходной permissions.csv".

3. Откройте экземпляр PowerShell от учетной записи администратора и откройте папку, в которая сохранен сценарий.

4. Подключись к каталогу с помощью [cmdlet Connect-AzureAD.](https://docs.microsoft.com/powershell/module/azuread/connect-azuread)

5. Запустите эту команду PowerShell:

   ```powershell
   Get-AzureADPSPermissions.ps1 | Export-csv -Path "Permissions.csv" -NoTypeInformation
   ```

Сценарий создает один файл с именем Permissions.csv. Выполните следующие действия, чтобы найти незаконное предоставление разрешений для приложений:

1. В столбце ConsentType (столбец G) на поиск значения "AllPrinciples". Разрешение AllPrincipals позволяет клиентского приложения для доступа к контенту всех в клиенте. Для правильной работы приложений Microsoft 365 необходимо это разрешение. Каждое приложение от корпорации Майкрософт с этим разрешением должно быть тщательно проанализировано.

2. В столбце "Разрешение" (столбец F) просмотрите разрешения, которые каждое делегированное приложение имеет для контента. Найми разрешения "Чтение" и "Записать" или "*". Разрешение "Все" и внимательно просмотрите их, так как они могут быть не подходящими.

3. Просмотрите конкретных пользователей, которые получили согласие. Если пользователям с высоким уровнем профиля или пользователям с высоким уровнем воздействия предоставлены недопустимые разрешения, следует провести дальнейшее исследование.

4. В столбце ClientDisplayName (столбец C) найди приложения, которые кажутся подозрительными. Приложения с опечатными именами, суперпустые имена или имена, звучающие от хакеров, следует тщательно проанализировать.

## <a name="determine-the-scope-of-the-attack"></a>Определение области атаки

После завершения инвентаризации доступа к приложениям просмотрите журнал аудита, чтобы определить полную область нарушения.  Поиск затронутых пользователей, время, в которое у незаконного приложения был доступ к вашей организации, и разрешения, которые у приложения есть. Поиск по **журналу аудита** можно найти в Центре безопасности и [соответствия требованиям Microsoft 365.](https://docs.microsoft.com/microsoft-365/compliance/search-the-audit-log-in-security-and-compliance)

> [!IMPORTANT]
> [Чтобы получить](https://docs.microsoft.com/microsoft-365/compliance/enable-mailbox-auditing) эти [](https://docs.microsoft.com/microsoft-365/compliance/turn-audit-log-search-on-or-off) сведения, необходимо включить аудит и аудит действий почтовых ящиков для администраторов и пользователей до атаки.

## <a name="how-to-stop-and-remediate-an-illicit-consent-grant-attack"></a>Как остановить и исправление атаки с предоставлением незаконного согласия

После того как вы определили приложение с незаконными разрешениями, у вас есть несколько способов удалить этот доступ.

- Вы можете отопросить разрешение приложения на портале Azure Active Directory с помощью:

  - Перейдите к затронутого пользователя в blade **пользователя Azure Active Directory.**

  - Выберите **приложения.**

  - Выберите незаконное приложение.

  - Click **Remove** in the drill down.

- Вы можете отоскить предоставление согласия OAuth с помощью PowerShell, вы следуя шагам в [remove-AzureADOAuth2PermissionGrant.](https://docs.microsoft.com/powershell/module/azuread/Remove-AzureADOAuth2PermissionGrant)

- Вы можете отоскить назначение роли приложения-службы с помощью PowerShell, выполв действия в [remove-AzureADServiceAppRoleAssignment.](https://docs.microsoft.com/powershell/module/azuread/Remove-AzureADServiceAppRoleAssignment)

- Вы также можете отключить вход для затронутой учетной записи, что, в свою очередь, отключит доступ приложения к данным в этой учетной записи. Конечно, это не идеальное решение для повышения производительности конечного пользователя, но если вы работаете над быстрой работой по ограничению влияния, это может быть допустимым краткосрочным исправлением.

- Вы можете отключить интегрированные приложения для своего аренды. Это очень важный шаг, который отключает возможность предоставления пользователями согласия на уровне клиента. Это предотвращает непреднамеренное предоставление пользователям доступа к вредоносному приложению. Это не рекомендуется, так как это серьезно снижает производительность работы пользователей со сторонними приложениями. Это можно сделать, выверив или выключив интегрированные [приложения.](https://docs.microsoft.com/microsoft-365/admin/misc/integrated-apps)

## <a name="secure-microsoft-365-like-a-cybersecurity-pro"></a>Защитите Microsoft 365 на профессиональном уровне

Для вашей подписки Microsoft 365 предусмотрен целый ряд полезных функций безопасности, которые можно использовать для защиты ваших данных и пользователей. Используйте статью к [Стратегия развития безопасности Microsoft 365: приоритеты на первые 30 дней, 90 дней и далее](security-roadmap.md), чтобы применить лучшие методики, рекомендованные корпорацией Майкрософт, для защиты вашего клиента Microsoft 365.

- Задачи для выполнения в первые 30 дней. Они дают немедленный эффект и не создают помех вашим пользователям.

- Задачи для выполнения в течение 90 дней. Эти задачи требуют немного больше времени на планирование и реализацию, но значительно укрепляют вашу безопасность.

- Более 90 дней. Эти меры дополняют ваши действия в течение первых 90 дней.

## <a name="see-also"></a>См. также:

- [Непредвиденное](https://docs.microsoft.com/azure/active-directory/application-access-unexpected-application) приложение в списке моих приложений проходит администраторам по различным действиям, которые могут потребоваться им после того, как они понимают, что существуют непредвиденные приложения с доступом к данным.

- [Интеграция приложений с Azure Active Directory](https://docs.microsoft.com/azure/active-directory/active-directory-apps-permissions-consent) — это высокоуровневый обзор согласия и разрешений.

- [Проблемы, связанные с разработкой приложения,](https://docs.microsoft.com/azure/active-directory/active-directory-application-dev-development-content-map) предоставляют ссылки на различные статьи, связанные с согласием.

- Объекты приложений и основных служб [в Azure Active Directory (Azure AD)](https://docs.microsoft.com/azure/active-directory/develop/active-directory-application-objects) предоставляют обзор основных объектов приложений и служб, которые являются основными для модели приложений.

- [Управление доступом к приложениям](https://docs.microsoft.com/azure/active-directory/active-directory-managing-access-to-apps) — это обзор возможностей, которые администраторы должны использовать для управления доступом пользователей к приложениям.
