---
title: Трассировка сообщений в Центре безопасности и соответствия требованиям
f1.keywords:
- NOCSH
ms.author: chrisda
author: chrisda
manager: dansimp
audience: ITPro
ms.topic: how-to
localization_priority: Normal
ms.assetid: 3e64f99d-ac33-4aba-91c5-9cb4ca476803
ms.custom:
- seo-marvel-apr2020
description: Администраторы могут использовать трассировка сообщений в Центре & соответствия требованиям, чтобы узнать, что произошло с сообщениями.
ms.technology: mdo
ms.prod: m365-security
ms.openlocfilehash: 1ce26f7a6cdad15019e2b40eb6f8746e5723d4f0
ms.sourcegitcommit: 786f90a163d34c02b8451d09aa1efb1e1d5f543c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/18/2021
ms.locfileid: "50290661"
---
# <a name="message-trace-in-the-security--compliance-center"></a>Трассировка сообщений в Центре безопасности и соответствия требованиям

[!INCLUDE [Microsoft 365 Defender rebranding](../includes/microsoft-defender-for-office.md)]

**Область применения**
- [Exchange Online Protection](exchange-online-protection-overview.md)
- [Microsoft Defender для Office 365 (план 1 и план 2)](office-365-atp.md)
- [Microsoft 365 Defender](../mtp/microsoft-threat-protection.md)

## <a name="message-trace-features"></a>Функции трассировки сообщений

Трассировка сообщений в Центре & соответствия требованиям отслеживает сообщения электронной почты по мере их перемещения через организацию Exchange Online. Вы можете определить, было ли сообщение получено, отклонено, отложено или доставлено службой. Здесь также показано, какие действия были предприняты с сообщением до того, как оно достигло окончательного состояния.

Трассировка сообщений в Центре & соответствия требованиям улучшает исходную трассировку сообщений, доступную в Центре администрирования Exchange (EAC). Данные трассировки сообщений можно использовать для эффективного ответа на вопросы пользователей о том, что произошло с сообщениями, устранения неполадок потока почты и проверки изменений политики.

> [!NOTE]
>
> - Для трассировки сообщений необходимо быть членом группы ролей "Управление организацией", "Управление соответствием требованиям" или "Help Desk". Дополнительные сведения см. в статье [Разрешения в Центре безопасности и соответствия требованиям](permissions-in-the-security-and-compliance-center.md).
>
> - Максимальное количество сообщений, отображаемого в результатах, зависит от выбранного [](#choose-report-type) типа отчета (подробные сведения см. в разделе "Выбор типа отчета"). The [Get-HistoricalSearch cmdlet](https://docs.microsoft.com/powershell/module/exchange/get-historicalsearch) in Exchange Online PowerShell or standalone EOP PowerShell returns all messages in the results.

## <a name="open-message-trace"></a>Открытие трассировки сообщений

1. Откройте Центр безопасности & соответствия <https://protection.office.com> требованиям по

2. Раз **развернуть поток почты** и выбрать **трассировку сообщений.**

## <a name="message-trace-page"></a>Страница трассировки сообщений

Здесь можно запустить новую трассировку по умолчанию, нажав кнопку **"Запустить трассировку".** При этом будут искаться все сообщения для всех отправителей и получателей за последние два дня. Вы также можете использовать один из сохраненных запросов из доступных категорий запросов и выполнить их как есть или использовать в качестве отправной точки для собственных запросов:

- **Запросы по умолчанию:** встроенные запросы, предоставляемые Microsoft 365.

- **Пользовательские запросы:** запросы, сохраненные администраторами в организации для дальнейшего использования.

- **Автоматические запросы:** последние десять последних запусков запросов. Этот список упрощает выбор места, на котором вы слева.

Кроме того, на  этой странице находится раздел загружаемых отчетов о отправленных вами запросах, а также сами отчеты, когда они доступны для скачивания.

## <a name="options-for-a-new-message-trace"></a>Параметры для новой трассировки сообщений

### <a name="filter-by-senders-and-recipients"></a>Фильтрация по отправителям и получателям

По умолчанию используются значения **"Все отправитые"** и **"Все** получатели", но для фильтрации результатов можно использовать следующие поля:

- **По этим людям:** щелкните в этом поле, чтобы выбрать одного или несколько отправителей из вашей организации. Можно также начать ввести имя, и элементы в списке будут фильтроваться по типу, как и поведение страницы поиска.

- **Для этих людей:** щелкните в этом поле, чтобы выбрать одного или несколько получателей в организации.

> [!NOTE]
>
> - Вы также можете ввести адреса электронной почты внешних отправителей и получателей. Поддерживаются поддеревные знаки (например, ),, но нельзя одновременно использовать несколько записей с поддиаными знаками в одном `*@contoso.com` поле.
>
> - Можно в paste multiple senders or recipients lists separated by semicolons ( `;` ). пробелы ( `\s` ), возврат каретки ( `\r` ) или следующие строки ( `\n` ).

### <a name="time-range"></a>Диапазон времени

Значение по умолчанию **— 2 дня,** но можно указать диапазоны дат и времени до 90 дней. При использовании диапазонов дат и времени учитывайте указанные здесь проблемы.

- По умолчанию диапазон времени в представлении **ползунок** выбирается с помощью строки времени. Можно выбрать только отображаемую настройку дня или времени. Попытка выбрать значение между значениями прикрепит начало/конец к ближайшему отображаемого параметру.

  ![Диапазон времени ползунок в новой трассировке сообщений в Центре & соответствия требованиям](../../media/55a9e9c1-f7d5-4047-b217-824e8b976bcb.png)

  Однако можно также переключиться на настраиваемый  вид,  в котором можно указать значения даты начала  и окончания (включая время), а также выбрать часовой пояс для диапазона дат и времени.  Обратите внимание, **что параметр часового** пояса применяется как к входным данным запроса, так и к результатам запроса.

  ![Настраиваемый диапазон времени в новой трассировок сообщений в Центре безопасности & соответствия требованиям](../../media/ed4c8d50-9ea5-4694-93f9-ee3ab6660b4f.png)

  В течение 10 дней или меньше результаты сразу же доступны в качестве **сводного** отчета. Если указать диапазон времени, который даже немного больше 10 дней, результаты будут отложены, так как они доступны только  в качестве загружаемого CSV-файла **(расширенные** сводные или расширенные отчеты).

  Дополнительные сведения о различных типах отчетов см. в разделе "Выбор типа [отчета"](#choose-report-type) этой статьи.

  > [!NOTE]
  > Расширенные и расширенные отчеты подготовлены с использованием архивных данных трассировки сообщений, и может занять до нескольких часов, прежде чем отчет будет доступен для скачивания. В зависимости от того, сколько других администраторов также отправило запросы отчетов за то же время, вы также можете заметить задержку перед началом обработки вашего запроса в очереди.

- При сохранении запроса в представлении **ползунок** сохраняется относительный диапазон времени (например, 3 дня от сегодняшнего дня). При сохранении  запроса в настраиваемом представлении сохраняется абсолютный диапазон дат и времени (например, 2018-05-06 с 13:00 до 2018-05-08 18:00).

### <a name="more-search-options"></a>Дополнительные параметры поиска

#### <a name="delivery-status"></a>Состояние доставки.

Можно оставить значение по умолчанию **"Все** выбрано" или выбрать одно из следующих значений для фильтрации результатов:

- **Доставлено:** сообщение успешно доставлено в нужное место назначения.

- **Ожидание:** попытка доставки сообщения или попытка его повторного доставки.

- **Expanded**: получатель группы рассылки был расширен перед доставкой отдельным участникам группы.

- **Сбой:** сообщение не было доставлено.

- **Карантин:** сообщение было отправлено на карантин (как спам, массовая рассылка или фишинг). Дополнительные сведения см. в сообщениях электронной почты, отправленных на карантин, [в EOP.](quarantine-email-messages.md)

- **Отфильтрован как спам:** сообщение было обнаружено как нежелательное и отклонено или заблокировано (не было в карантине).

- **Получение состояния:** Сообщение было недавно получено Microsoft 365, но другие данные о состоянии пока недоступны. Проверьте это через несколько минут.

> [!NOTE]
> Значения **Pending,** **Quarantined** и **Filter as spam** доступны только для поиска менее чем за 10 дней. Кроме того, между фактическим состоянием доставки и состоянием доставки может быть задержка от 5 до 10 минут.

#### <a name="message-id"></a>ИД сообщения

Это ИД сообщения Интернета (также известный как ИД клиента), который находится в поле **Message-ID:** header в заголке сообщения. Пользователи могут предоставить вам это значение для изучения определенных сообщений.

Это значение не изменяется на протяжении всего времени жизни сообщения. Для сообщений, созданных в Microsoft 365 или Exchange, значение имеет формат, включая угловые `<GUID@ServerFQDN>` скобки ( \< \> ). Например, `<d9683b4c-127b-413a-ae2e-fa7dfb32c69d@DM3NAM06BG401.Eop-nam06.prod.protection.outlook.com>`. Другие системы обмена сообщениями могут использовать другой синтаксис или значения. Это значение должно быть уникальным, но не все почтовые системы строго следуют этому требованию. Если поле **"Message-ID:** header field" не существует или не является пустым для входящих сообщений из внешних источников, ему будет назначено произвольное значение.

При использовании **message ID для** фильтрации результатов не забудьте включить полную строку, включая любые угловые скобки.

#### <a name="direction"></a>Direction

Вы можете оставить значение по умолчанию **"Все"** выбранным или выбрать входящие **(сообщения,** отправленные получателям в организации) или "Исходящие" (сообщения, отправленные пользователями в организации) для фильтрации результатов. 

#### <a name="original-client-ip-address"></a>Исходный IP-адрес клиента.

Вы можете подавлять результаты по IP-адресу клиента, чтобы исследовать взломав компьютеры, отправляя большие объемы нежелательной почты или вредоносных программ. Хотя сообщения, возможно, приходят от нескольких отправителей, скорее всего, на одном компьютере будут создаваться все сообщения.

> [!NOTE]
> Сведения об IP-адресе клиента доступны только в течение 10 дней  и доступны только в расширенных сводных отчетах или расширенных отчетах (загружаемых CSV-файлах). 

### <a name="choose-report-type"></a>Выбор типа отчета

Доступные типы отчетов:

- **Сводка.** Доступна, если диапазон времени меньше 10 дней и не требует дополнительных параметров фильтрации. Результаты доступны почти сразу после нажатия кнопки **"Поиск".** Отчет возвращает до 20 000 результатов.

- **Расширенная** сводка или расширенные отчеты: эти отчеты доступны только в качестве загружаемых CSV-файлов, и для них требуется один или несколько из следующих параметров фильтрации вне зависимости от диапазона **времени:** эти **люди,** эти люди или ИД **сообщения.** Для отправителей или получателей можно использовать подкадрамы (например, \* @contoso.com). Расширенный сводный отчет возвращает до 50 000 результатов. Расширенный отчет возвращает до 1000 результатов.

> [!NOTE]
> 
> - Расширенные и расширенные отчеты подготовлены с использованием архивных данных трассировки сообщений, и загрузка отчета может занять до нескольких часов. В зависимости от того, сколько других администраторов также отправило запросы отчетов за то же время, вы также можете заметить задержку перед началом обработки запроса в очереди.
> 
> - Хотя вы можете выбрать расширенный сводный или расширенный отчет для любого диапазона дат и времени, обычно последние четыре часа архивных данных будут недоступны для этих двух типов отчетов.

При нажатии кнопки "Далее" вы получите страницу сводки с выбранными вариантами фильтрации, уникальным (редактируемым) заголовком отчета и адресом электронной почты, который получает уведомление после завершения трассировки сообщений (также редактируемый и должен быть в одном из принятых доменов вашей организации).  Щелкните **"Подготовить отчет"** для отправки трассировки сообщений. На главной **странице** трассировки сообщений можно увидеть состояние отчета в разделе **"Загружаемые отчеты".**

Дополнительные сведения о сведениях, возвращаемой в различных типах отчетов, см. в следующем разделе.

## <a name="message-trace-results"></a>Результаты трассировки сообщений

Различные типы отчетов возвращают различные уровни информации. Сведения, доступные в различных отчетах, описаны в следующих разделах.

### <a name="summary-report-output"></a>Выходные данные сводного отчета

После запуска трассировки сообщений будут перечислены результаты, отсортированные по убываю дате и времени (самый последний первый).

![Результаты сводного отчета по трассировке сообщений в Центре & соответствия требованиям](../../media/0664bafe-0b03-477b-b571-0b046ac8c977.png)

Сводный отчет содержит следующие сведения:

- **Date**: the date and time at which the message was received by the service, using the configured UTC time zone.

- **Sender**: адрес электронной почты отправитель (*домен* @ *псевдонима).*

- **Получатель:** адрес электронной почты получателя или получателя. Для сообщения, отправленного нескольким получателям, существует одна строка для каждого получателя. Если получателем является группа рассылки, динамическая группа рассылки или группа безопасности с включенной поддержкой почты, группа будет первым получателем, а затем каждый член группы находится в отдельной строке.

- **Тема:** первые 256 символов темы **сообщения:** поле.

- **Состояние:** эти значения описаны в разделе ["Состояние доставки".](#delivery-status)

По умолчанию первые 250 результатов загружаются и легко доступны. При прокрутке вниз происходит небольшая пауза при загрузке следующего пакета результатов. Вместо прокрутки можно нажать кнопку **"Загрузить** все", чтобы загрузить все результаты до 10 000.

Можно щелкнуть заглавные столбцы, чтобы отсортировать результаты по значениям в этом столбце по возрастанию или убыванию.

Можно **щелкнуть фильтр результатов,** чтобы отфильтровать результаты по одному или несколько столбцов.

Вы можете экспортировать результаты после выбора одной или более  строк, щелкнув "Экспорт результатов", а затем выбрав "Экспортировать все результаты", "Экспорт загруженных результатов" или "Экспортировать **выбранные".**

#### <a name="find-related-records-for-this-message"></a>Поиск связанных записей для этого сообщения

Связанные записи сообщений — это записи с одинаковым ИД сообщения. Помните, что даже одно сообщение, отправленное между двумя людьми, может создавать несколько записей. Количество записей увеличивается, если на сообщение влияет расширение группы рассылки, пересылание, правила потока почты (также известные как правила транспорта) и т. д.

После того как вы нажмете на строку, вы сможете  найти связанные записи для  сообщения, нажав кнопку "Найти связанное" или выбрав "Дополнительные параметры" "Дополнительные записи для этого ![ ](../../media/1ea52bbf-9d00-48ce-9362-307f7f6fb7fe.png) \> сообщения").

Дополнительные сведения об ИД сообщения см. в разделе "ИД сообщения" этой статьи.

#### <a name="message-trace-details"></a>Сведения трассировки сообщений

В выходных данных сводного отчета можно просмотреть сведения о сообщении одним из следующих способов:

- Выберите строку (щелкните в любом месте строки, кроме этого, за исключением этого.

- Select the row's check box and click **More options** More ![ View message ](../../media/1ea52bbf-9d00-48ce-9362-307f7f6fb7fe.png) \> **details**.

   ![Подробные сведения после двойного щелчка по строке трассировки сообщений сводного отчета в Центре безопасности & соответствия требованиям](../../media/e50ee7cd-810a-4c06-8b58-e56ffd7028d1.png)

Сведения о трассировке сообщений содержат следующие дополнительные сведения, которых нет в сводных отчетах:

- **События сообщений**: в этом разделе содержатся классификации, которые помогают классифицировать действия, которые служба принимает на сообщения. **Некоторые из наиболее интересных событий,** которые могут возникнуть:

  - **Получение:** сообщение получено службой.

  - **Отправка:** сообщение было отправлено службой.

  - **Fail**: The message failed to be delivered.

  - **Доставка:** сообщение было доставлено в почтовый ящик.

  - **Expand**: сообщение было отправлено в расширенную группу рассылки.

  - **Transfer**: Recipients were moved to a bifurcated message because of content conversion, message recipient limits, or agents.

  - **Defer**: доставка сообщения была отложена и может быть предпринята повторно позже.

  - **Решение:** сообщение было перенаправлено на новый адрес получателя на основе данных о том, как найти Active Directory. В этом случае исходный адрес получателя указывается в отдельной строке трассировки сообщений вместе с итоговым состоянием доставки сообщения.

  > [!NOTE]
  > 
  > - Успешно доставленное сообщение создает несколько записей  событий в трассирове сообщений.
  > 
  > - Этот список не является исчерпывающим. Описание других событий см. в описании типов [событий в журнале отслеживания сообщений.](https://docs.microsoft.com/Exchange/mail-flow/transport-logs/message-tracking#event-types-in-the-message-tracking-log) Обратите внимание, что эта ссылка является Exchange Server (локальной exchange).

- **Дополнительные сведения:** этот раздел содержит следующие сведения:

  - **ИД сообщения:** это значение описано в разделе ["ИД](#message-id) сообщения" выше в этой статье. Например, `<d9683b4c-127b-413a-ae2e-fa7dfb32c69d@DM3NAM06BG401.Eop-nam06.prod.protection.outlook.com>`.

  - **Размер сообщения**.

  - **С IP-адреса:** IP-адрес компьютера, который отправил сообщение. Для исходящие сообщения, отправленные из Exchange Online, это значение пустое.

  - **To IP**: the IP address or addresses where the service attempted to deliver the message. Если сообщение имеет несколько получателей, они отображаются. Для входящие сообщений, от отправленных в Exchange Online, это значение пустое.

### <a name="enhanced-summary-reports"></a>Расширенные сводные отчеты

Доступные (завершенные) расширенные сводные отчеты доступны в разделе загружаемых отчетов в начале трассировки сообщений.  В отчете доступны следующие сведения:

- **origin_timestamp:** дата и время, когда сообщение было изначально получено службой с использованием <sup>*</sup> настроенного часовой пояс UTC.

- **sender_address**: адрес электронной почты отправитель *(домен* @ *псевдонима).*

- **Recipient_status**: состояние доставки сообщения получателю. Если сообщение было отправлено нескольким получателям, в нем будут отображиться все получатели и соответствующее состояние для каждого из них в формате: \<*email address*\> ## \<*status*\> . Например,

  - **##Receive, Send означает,** что сообщение было получено службой и отправлено в нужное место назначения.

  - **##Receive, Fail означает,** что сообщение было получено службой, но не удалось отправить сообщение в нужное место назначения.

  - **##Receive, Deliver означает,** что сообщение было получено службой и доставлено в почтовый ящик получателя.

- **message_subject**: первые 256 символов в поле темы **сообщения.**

- **total_bytes**: размер сообщения в вложенных сообщениях в виде вложений.

- **message_id:** это значение описано в разделе ["ИД](#message-id) сообщения" выше в этой статье. Например, `<d9683b4c-127b-413a-ae2e-fa7dfb32c69d@DM3NAM06BG401.Eop-nam06.prod.protection.outlook.com>`.

- **network_message_id**: уникальное значение ИД сообщения, которое сохраняется во всех копиях сообщения, которые могут быть созданы из-за разбиения или расширения группы рассылки. Пример значения: `1341ac7b13fb42ab4d4408cf7f55890f` .

- **original_client_ip**: IP-адрес клиента отправитель.

- **directionality**: указывает, было ли сообщение отправлено входящие (1) в вашу организацию или было ли оно отправлено исходящие (2) из вашей организации.

- **connector_id**: имя источника или конечного соединитела. Дополнительные сведения о соединителях в Exchange Online см. в подключении потока почты с помощью [соединителя в Office 365.](https://docs.microsoft.com/Exchange/mail-flow-best-practices/use-connectors-to-configure-mail-flow/use-connectors-to-configure-mail-flow)

- **delivery_priority:** было ли сообщение отправлено с <sup>*</sup> высоким, низким или **обычным приоритетом.**  

<sup>*</sup> Эти свойства доступны только в расширенных сводных отчетах.

### <a name="extended-reports"></a>Расширенные отчеты

Доступные (завершенные) расширенные отчеты  доступны в разделе загружаемых отчетов в начале трассировки сообщений. Практически вся информация из расширенного сводного отчета доступна в расширенном отчете (за исключением origin_timestamp и **delivery_priority).**  Следующие дополнительные сведения доступны только в расширенном отчете:

- **client_ip**: IP-адрес почтового сервера или клиента обмена сообщениями, который отправил сообщение.

- **client_hostname**: имя или FQDN сервера электронной почты или клиента обмена сообщениями, которые отправили сообщение.

- **server_ip**: IP-адрес источника или конечного сервера.

- **server_hostname**: имя или имя FQDN конечного сервера.

- **source_context**: дополнительные сведения, связанные с **исходным полем.** Например,

  - `Protocol Filter Agent`

  - `3489061114359050000`

- **source**: компонент Exchange Online, отвечающий за событие. Например,

  - `AGENT`

  - `MAILBOXRULE`

  - `SMTP`

- **event_id:** они соответствуют значениям событий **Message,** которые поясняется в разделе "Поиск связанных записей [для этого сообщения".](#find-related-records-for-this-message)

- **internal_message_id:** идентификатор сообщения, присвоенный сервером Exchange Online, который в настоящее время обрабатывает сообщение.

- **recipient_address**: адреса электронной почты получателей сообщения. Если указано несколько адресов, то они отделяются друг от друга точкой с запятой (;).

- **recipient_count**: общее количество получателей в сообщении.

- **related_recipient_address**: используется с событиями и для отображения других адресов электронной почты получателей, `EXPAND` `REDIRECT` `RESOLVE` связанных с сообщением.

- **reference**: это поле содержит дополнительные сведения для определенных типов событий. Например,

  - **Уведомление** о доставке: содержит ссылку на отчет, которая является значением **message_id** связанного уведомления о доставке (также известного как уведомление о доставке, отчет о не доставке, отчет о возврате или сообщение о возврате), если после этого события создается уведомление о доставке. Если это DSN-сообщение, это  поле содержит message_id исходного сообщения, для которое было сгенерировано DSN.

  - **EXPAND**: содержит **related_recipient_address** значение связанных сообщений.

  - **RECEIVE**: может **содержать message_id** значение связанного сообщения, если сообщение было сформировано другими процессами (например, правилами для входящих сообщений).

  - **SEND**: содержит **internal_message_id** всех сообщений DSN.

  - **TRANSFER**: содержит **internal_message_id** значение сообщения, которое ветвяется (например, при преобразовании содержимого, ограничениях получателей сообщений или агентах).

  - **MAILBOXRULE**: **содержит internal_message_id** входящих сообщений, из-за чего правило для входящих сообщений генерируло исходящие сообщения.

    Для других типов событий это поле обычно пустое.

- **return_path:** адрес электронной почты, указанный командой **MAIL FROM,** которая отправила сообщение. Хотя это поле никогда не является пустым, в нем может быть представлено пустое значение адреса `<>` отправитель.

- **message_info:** дополнительные сведения о сообщении. Например,

  - Дата и время возникновения сообщения в UTC для `DELIVER` и `SEND` событий. Дата и время начала — это время, когда сообщение впервые попало в организацию Exchange Online. Дата и время в формате UTC представлены в формате даты и времени ISO 8601: , где = год, = месяц, = день, указывает начало компонента `yyyy-mm-ddThh:mm:ss.fffZ` `yyyy` `mm` `dd` `T` времени, = час, = минута, = секунда, = доли `hh` `mm` секунды, `ss` `fff` `Z` и обозначает `Zulu` , что другой способ обозначает UTC.

  - Ошибки проверки подлинности. Например, можно увидеть значение и тип проверки подлинности, которые использовались при `11a` ошибке проверки подлинности.

- **tenant_id**: значение GUID, которое представляет организацию Exchange Online (например, `39238e87-b5ab-4ef6-a559-af54c6b07b42` ).

- **original_server_ip**: IP-адрес исходного сервера.

- **custom_data**: содержит данные, связанные с определенными типами событий. Дополнительные сведения см. в следующих разделах.

#### <a name="custom_data-values"></a>custom_data значения

Поле **custom_data** для события используется различными агентами Exchange Online для регистрации `AGENTINFO` сведений об обработке сообщений. Некоторые из наиболее интересных агентов описаны в следующих разделах.

#### <a name="spam-filter-agent"></a>Агент фильтрации нежелательной почты

Значение **custom_data** начинается с `S:SFA` агента фильтрации нежелательной почты. Основные сведения описаны в следующей таблице:

****

|Значение|Описание|
|---|---|
|`SFV=NSPM`|Сообщение помечено как не являющееся нежелательным и отправлено указанным получателям.|
|`SFV=SPM`|Сообщение было помечено как нежелательное с помощью фильтрации нежелательной почты (также известной как фильтрация содержимого).|
|`SFV=BLK`|Фильтрация была пропущена, а сообщение было заблокировано, так как оно исходило от заблокированного отправителя.|
|`SFV=SKS`|Сообщение было помечено как нежелательное до его обработки с помощью фильтрации нежелательной почты. Это применяется к сообщениям, сопоставленным с правилом потока обработки почты (другое название — правило транспорта), требующим автоматически помечать их как нежелательные и обходить любую дополнительную фильтрацию.|
|`SCL=<number>`|Дополнительные сведения о различных значениях вероятности нежелательной почты и их значении см. в разделе [Вероятность нежелательной почты](spam-confidence-levels.md).    |
|`PCL=<number>`|Значение вероятности фишинга для сообщения. Эти значения можно интерпретировать так же, как и значения SCL, которые задокументированы в [Вероятность нежелательной почты](spam-confidence-levels.md).  |
|`DI=SB`|Отправитель сообщения заблокирован.|
|`DI=SQ`|Сообщение перемещено в карантин.|
|`DI=SD`|Сообщение удалено.|
|`DI=SJ`|Сообщение отправлено в папку нежелательной почты получателя.|
|`DI=SN`|Сообщение перенаправлено через пул обычной исходящей доставки.|
|`DI=SO`|Сообщение перенаправлено через пул высокого риска доставки. Дополнительные сведения см. в статье [Пул доставки сообщений с высоким уровнем опасности](high-risk-delivery-pool-for-outbound-messages.md).|
|`SFS=[a]|SFS=[b]`|Это означает выполнение правил нежелательной почты.|
|`IPV=CAL`|Сообщение пропущено через фильтр нежелательной почты, поскольку IP-адрес указан в списке разрешенных IP-адресов в фильтре подключений.|
|`H=<EHLOstring>`|Строка HELO или EHLO подключенного почтового сервера.|
|`PTR=<ReverseDNS>`|Запись PTR отправляющего IP-адреса, называемая также обратным DNS-адресом.|
|

Пример **custom_data** для сообщения, отфильтрованного по спаму, например:

`S:SFA=SUM|SFV=SPM|IPV=CAL|SRV=BULK|SFS=470454002|SFS=349001|SCL=9|SCORE=-1|LIST=0|DI=SN|RD=ftmail.inc.com|H=ftmail.inc.com|CIP=98.129.140.74|SFP=1501|ASF=1|CTRY=US|CLTCTRY=|LANG=en|LAT=287|LAT=260|LAT=18;`

#### <a name="malware-filter-agent"></a>Агент фильтрации вредоносных программ

Значение **custom_data** начинается с `S:AMA` агента фильтрации вредоносных программ. Основные сведения описаны в следующей таблице:

****

|Значение|Описание|
|---|---|
|`AMA=SUM|v=1|` или `AMA=EV|v=1`|Сообщение помечено как содержащее вредоносные программы. `SUM` указывает, что вредоносная программа могла быть обнаружена любым количеством обдвижков. `EV` указывает, что вредоносная программа обнаружена определенным механизмом. Если обработчиком обнаружены вредоносные программы, это вызывает последующие действия.|
|`Action=r`|Сообщение заменено.|
|`Action=p`|Сообщение не проходило фильтрацию.|
|`Action=d`|Сообщение отложено.|
|`Action=s`|Сообщение удалено.|
|`Action=st`|Сообщение не проходило фильтрацию.|
|`Action=sy`|Сообщение не проходило фильтрацию.|
|`Action=ni`|Сообщение отклонено.|
|`Action=ne`|Сообщение отклонено.|
|`Action=b`|Сообщение заблокировано.|
|`Name=<malware>`|Имя обнаруженной вредоносной программы.|
|`File=<filename>`|Имя файла, содержащего вредоносные программы.|
|

Пример значения **custom_data** сообщения, которое содержит вредоносную программу, выглядит так:

`S:AMA=SUM|v=1|action=b|error=|atch=1;S:AMA=EV|engine=M|v=1|sig=1.155.974.0|name=DOS/Test_File|file=filename;S:AMA=EV|engine=A|v=1|sig=201707282038|name=Test_File|file=filename`

#### <a name="transport-rule-agent"></a>Агент правил транспорта

Значение **custom_data** начинается с агента правил транспорта для правил потока почты (также известных `S:TRA` как правила транспорта). Основные сведения описаны в следующей таблице:

****

|Значение|Описание|
|---|---|
|`ETR|ruleId=<guid>`|Выполнено правило идентификатора.|
|`St=<datetime>`|Дата и время в UTC, когда произошло соответствие правилу.|
|`Action=<ActionDefinition>`|Примененное действие. Список доступных действий см. в действиях правил [потока почты в Exchange Online.](https://docs.microsoft.com/exchange/security-and-compliance/mail-flow-rules/mail-flow-rule-actions)|
|`Mode=<Mode>`|Режим правила. Допустимые значения:<ul><li>**Enforce**: all actions on the rule will be enforced.</li><li>**Тестирование с подсказками политики:** все действия подсказки политики будут отправлены, но другие действия по принулнию не будут действовать.</li><li>**Тестирование без подсказок** политики: действия будут перечислены в файле журнала, но отправителю не будет высылаться никаких уведомлений, а действия по принужжнию не будут действовать.</li></ul>|
|

Пример **custom_data** для сообщений, которые совпадают с условиями правила потока почты, выглядит так:

`S:TRA=ETR|ruleId=19a25eb2-3e43-4896-ad9e-47b6c359779d|st=7/17/2017 12:31:25 AM|action=ApplyHtmlDisclaimer|sev=1|mode=Enforce`
