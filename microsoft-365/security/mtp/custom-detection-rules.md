---
title: Создание пользовательских правил обнаружения и управление ими в Microsoft 365 Defender
description: Узнайте, как создавать настраиваемые правила обнаружения и управлять ими на основе расширенных запросов охоты
keywords: advanced hunting, threat hunting, cyber threat hunting, microsoft threat protection, microsoft 365, mtp, m365, search, query, telemetry, custom detections, rules, schema, kusto, microsoft 365, Microsoft Threat Protection, RBAC, permissions, Microsoft Defender ATP
search.product: eADQiWindows 10XVcnh
search.appverid: met150
ms.prod: m365-security
ms.mktglfcycl: deploy
ms.sitesec: library
ms.pagetype: security
f1.keywords:
- NOCSH
ms.author: lomayor
author: lomayor
ms.localizationpriority: medium
manager: dansimp
audience: ITPro
ms.collection:
- M365-security-compliance
- m365initiative-m365-defender
ms.topic: article
ms.technology: m365d
ms.openlocfilehash: d58292f658446259bfab5b1b55c8b462d081421c
ms.sourcegitcommit: d354727303d9574991b5a0fd298d2c9414e19f6c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/02/2021
ms.locfileid: "50080627"
---
# <a name="create-and-manage-custom-detections-rules"></a>Создание пользовательских правил обнаружения и управление ими

[!INCLUDE [Microsoft 365 Defender rebranding](../includes/microsoft-defender.md)]


**Область применения:**
- Microsoft 365 Defender

Настраиваемые правила обнаружения — это правила, которые можно проектировать и настраивать с помощью [запросов на расширенный](advanced-hunting-overview.md) поиск. Эти правила по-настоящему отслеживают различные события и состояния системы, включая подозрительные нарушения безопасности и неправильные конечные точки. Вы можете настроить их на регулярный запуск с регулярными интервалами, создавая оповещения и принимая ответные действия при совпадениях.

## <a name="required-permissions-for-managing-custom-detections"></a>Необходимые разрешения для управления пользовательскими обнаружениями

Для управления пользовательскими обнаружениями вам должна быть назначена одна из этих ролей:

- **Администратор безопасности**— пользователи с этой ролью [Azure Active Directory](https://docs.microsoft.com/azure/active-directory/users-groups-roles/directory-assign-admin-roles#security-administrator) могут управлять настройками безопасности в Центре безопасности Microsoft 365 и других порталах и службах.

- **Оператор безопасности**— пользователи с этой ролью [Azure Active Directory](https://docs.microsoft.com/azure/active-directory/users-groups-roles/directory-assign-admin-roles#security-administrator) могут управлять оповещениями и иметь глобальный доступ только для чтения к функциям, связанным с безопасностью, включая всю информацию в Центре безопасности Microsoft 365. Этой роли достаточно для управления пользовательскими обнаружениями, только если управление доступом на основе ролей (RBAC) отключено в Microsoft Defender для конечной точки. Если вы настроили RBAC,  вам также потребуется разрешение на управление настройками безопасности для Защитника для конечной точки.

Для управления требуемой разрешениями **глобальный администратор** может:

- **Назначьте роль администратора** безопасности или оператора **безопасности** в Центре администрирования [Microsoft 365](https://admin.microsoft.com/) в области **"Администратор безопасности**  >  **ролей".**
- Проверьте параметры RBAC для Microsoft Defender для конечной точки в Центре безопасности [Microsoft Defender](https://securitycenter.windows.com/) в области **"Роли разрешений**  >  **параметров".**  >   Выберите соответствующую роль, чтобы назначить **разрешение на управление настройками безопасности.**

> [!NOTE]
> Для управления пользовательскими  обнаружениями операторам  безопасности потребуется разрешение на управление настройками безопасности в Microsoft Defender для конечной точки, если включен RBAC.

## <a name="create-a-custom-detection-rule"></a>Создание настраиваемой правила обнаружения
### <a name="1-prepare-the-query"></a>1. Подготовьте запрос.

В Центре безопасности Microsoft 365 перейдите в службу **"Расширенный** поиск" и выберите существующий запрос или создайте новый запрос. При использовании нового запроса запустите запрос, чтобы определить ошибки и понять возможные результаты.

>[!IMPORTANT]
>Чтобы служба не возвращала слишком много оповещений, каждое правило может создавать только 100 оповещений при каждом запуске. Перед созданием правила оповещайте запрос о нормальной ежедневной активности.


#### <a name="required-columns-in-the-query-results"></a>Необходимые столбцы в результатах запроса
Чтобы создать пользовательское правило обнаружения, запрос должен вернуть следующие столбцы:

- `Timestamp`— используется для замещений времени для созданных оповещений
- `ReportId`— включает подыском для исходных записей
- Один из следующих столбцов, которые определяют определенные устройства, пользователей или почтовые ящики:
    - `DeviceId`
    - `DeviceName`
    - `RemoteDeviceName`
    - `RecipientEmailAddress`
    - `SenderFromAddress` (отправитель конверта или Return-Path адрес)
    - `SenderMailFromAddress` (адрес отправитель отображается почтовым клиентом)
    - `RecipientObjectId`
    - `AccountObjectId`
    - `AccountSid`
    - `AccountUpn`
    - `InitiatingProcessAccountSid`
    - `InitiatingProcessAccountUpn`
    - `InitiatingProcessAccountObjectId`

>[!NOTE]
>Поддержка дополнительных сущностям будет добавлена по мере того, как новые таблицы будут добавлены в схему [дополнительной охоты.](advanced-hunting-schema-tables.md)

Простые запросы, такие как запросы, которые не используют оператор или для настройки или агрегировать результаты, обычно возвращают `project` `summarize` эти общие столбцы.

Существуют различные способы, чтобы более сложные запросы возвращали эти столбцы. Например, если вы предпочитаете агрегировать и подсчитать по объекту в столбце, например, вы можете возвращать и получать его из последнего события, включаемого в `DeviceId` `Timestamp` `ReportId` каждый уникальный `DeviceId` .

В приведенной ниже примере запроса подсчитываются уникальные устройства ( ) с антивирусными средствами, и этот подсчет используется для поиска только устройств с более чем `DeviceId` пятью обнаружениями. Для возврата последней `Timestamp` версии и соответствующей `ReportId` функции используется оператор с `summarize` `arg_max` функцией.

```kusto
DeviceEvents
| where Timestamp > ago(1d)
| where ActionType == "AntivirusDetection"
| summarize (Timestamp, ReportId)=arg_max(Timestamp, ReportId), count() by DeviceId
| where count_ > 5
```

> [!TIP]
> Для улучшения производительности запроса установите фильтр времени, который соответствует назначенной частоте выполнения правила. Так как наименее частый запуск _происходит каждые 24_ часа, фильтрация за последний день охватывает все новые данные.

### <a name="2-create-new-rule-and-provide-alert-details"></a>2. Создание нового правила и предоставление сведений об оповещении.

С помощью запроса в редакторе запросов выберите **"Создать** правило обнаружения" и укажите следующие сведения об оповещении:

- **Имя обнаружения**— имя правила обнаружения
- **Частота**— интервал выполнения запроса и выполнения действий. [См. дополнительные рекомендации ниже](#rule-frequency)
- **Заголовок оповещения**— заголовок, отображаемая с оповещениями, инициированными правилом
- **Серьезность**— потенциальный риск компонента или действия, определяемого правилом
- **Категория —** компонент угрозы или действие, заданной правилом
- **MITRE ATT&CK**— один или несколько методов атаки, выявленных правилом, как описано в документе [MITRE ATT&CK framework.](https://attack.mitre.org/) Этот раздел скрыт для определенных категорий оповещений, в том числе вредоносных программ, программ-вымогателей, подозрительных действий и нежелательных программ
- **Описание**— дополнительные сведения о компоненте или действии, выявленных правилом 
- **Рекомендуемые действия**— дополнительные действия, которые ответчики могут принять в ответ на оповещение

#### <a name="rule-frequency"></a>Частота правил
Когда вы сохраняете или редактируете новое правило, оно запускается и проверяет совпадения с данными за последние 30 дней. Затем правило выполняется снова с фиксированными интервалами, применяя длительность обратного перенаправки в зависимости от частоты, которая вы выбираете:

- **Каждые 24 часа —** выполняется каждые 24 часа, проверяя данные за последние 30 дней
- **Каждые 12 часов —** выполняется каждые 12 часов, проверяя данные за последние 24 часа
- **Каждые 3 часа —** выполняется каждые 3 часа, проверяя данные за последние 6 часов
- **Каждый час**— выполняется каждый час, проверяя данные за последние 2 часа

>[!TIP]
> Со соответствовать фильтрам времени в запросе с длительностью возвращения. Результаты вне периода поиска игнорируются.  

Выберите частоту, которая соответствует частоте отслеживания обнаружений. Рассмотрите возможность организации реагировать на оповещения.

### <a name="3-choose-the-impacted-entities"></a>3. Выберите объекты, на которые они влияют.
Определите столбцы в результатах запроса, в которых ожидается найти основную затронутую или затронутую сущность. Например, запрос может возвращать адреса отправитель `SenderFromAddress` `SenderMailFromAddress` (или) и получатель ( `RecipientEmailAddress` ). Определение того, какой из этих столбцов представляет основной объект, помогает службе агрегировать соответствующие оповещения, соотносить инциденты и целевые действия реагирования.

Для каждого типа сущности (почтового ящика, пользователя или устройства) можно выбрать только один столбец. Столбцы, которые не возвращаются запросом, не могут быть выбраны.

### <a name="4-specify-actions"></a>4. Укажите действия.
Настраиваемые правила обнаружения могут автоматически принимать действия с устройствами, файлами или пользователями, возвращенными запросом.

#### <a name="actions-on-devices"></a>Действия на устройствах
Эти действия применяются к устройствам в `DeviceId` столбце результатов запроса:
- **Изолировать устройство —** использует Microsoft Defender для конечной точки, чтобы применить полную сетевую изоляцию, не мешая устройству подключаться к любому приложению или службе. [Дополнительные информации о Microsoft Defender для изоляции конечной точки компьютера](https://docs.microsoft.com/windows/security/threat-protection/microsoft-defender-atp/respond-machine-alerts#isolate-devices-from-the-network)
- **Сбор пакета исследования**— собирает сведения об устройстве в ZIP-файле. [Узнайте больше о пакете исследования в Microsoft Defender для конечной точки](https://docs.microsoft.com/windows/security/threat-protection/microsoft-defender-atp/respond-machine-alerts#collect-investigation-package-from-devices)
- **Запуск антивирусной проверки**— выполняет полную Защитник Windows антивирусную проверку на устройстве
- **Инициирует** исследование — [инициирует автоматическое исследование](mtp-autoir.md) на устройстве
- **Ограничение выполнения приложения**— устанавливает ограничения на устройстве, чтобы разрешить запуск только файлов, подписанных с помощью выданного Корпорацией Майкрософт сертификата. [Узнайте больше об ограничениях приложений в Microsoft Defender для конечной точки](https://docs.microsoft.com/windows/security/threat-protection/microsoft-defender-atp/respond-machine-alerts#restrict-app-execution)

#### <a name="actions-on-files"></a>Действия с файлами
Если этот вариант выбран, вы  можете применить действие к файлу карантина к файлам в столбце , , или столбце `SHA1` `InitiatingProcessSHA1` `SHA256` `InitiatingProcessSHA256` результатов запроса. Это действие удаляет файл из текущего расположения и помещает копию в карантин.

#### <a name="actions-on-users"></a>Действия над пользователями
Если этот вариант  выбран, пользователь пометит пользователя как скомпрометированную меру над пользователями в столбце или столбце результатов `AccountObjectId` `InitiatingProcessAccountObjectId` `RecipientObjectId` запроса. Это действие устанавливает для пользователей высокий уровень риска в Azure Active Directory, запуская соответствующие политики [защиты удостоверений.](https://docs.microsoft.com/azure/active-directory/identity-protection/overview-identity-protection)

> [!NOTE]
> Действие "Разрешить или заблокировать" для пользовательских правил обнаружения в настоящее время не поддерживается в Microsoft 365 Defender.

### <a name="5-set-the-rule-scope"></a>5. За установите область действия правила.
Установите область, чтобы указать, на какие устройства распространяется правило. Область влияет на правила проверки устройств и не влияет на правила, которые проверяют только почтовые ящики и учетные записи пользователей или удостоверения.

При настройке области можно выбрать:

- Все устройства
- Конкретные группы устройств

Запрашиваются только данные с устройств в области. Кроме того, действия будут предприняты только на этих устройствах.

### <a name="6-review-and-turn-on-the-rule"></a>6. Просмотрите и включите правило.
После проверки правила выберите **"Создать",** чтобы сохранить его. Настраиваемые правила обнаружения немедленно выполняется. Он запускается снова в зависимости от настроенной частоты проверки совпадений, создания оповещений и реагировать на них.

## <a name="manage-existing-custom-detection-rules"></a>Управление существующими пользовательскими правилами обнаружения
Вы можете просмотреть список существующих пользовательских правил обнаружения, проверить их предыдущие запуски и просмотреть оповещения, которые они сработали. Вы также можете запустить правило по запросу и изменить его.

### <a name="view-existing-rules"></a>Просмотр существующих правил

Чтобы просмотреть все существующие пользовательские правила обнаружения, перейдите к  >  **настраиваемой охоте на обнаружения.** На странице перечислены все правила со следующими сведениями о запуске:

- **Последний запуск**— когда правило было в последний раз запускаться для проверки совпадений запросов и создания оповещений
- **Состояние последнего запуска**— успешно ли прошло правило
- **Следующий запуск**— следующий запланированный запуск
- **Состояние**— было ли правило включено или отключено

### <a name="view-rule-details-modify-rule-and-run-rule"></a>Просмотр сведений о правиле, изменение правила и правило запуска

Чтобы просмотреть всесторонние сведения о настраиваемом правиле обнаружения, перейдите к настраиваемой охоте на обнаружения  >   и выберите имя правила. Затем можно просмотреть общие сведения о правиле, включая сведения о состоянии и области его запуска. На странице также содержится список инициированных оповещений и действий.

![Страница сведений о настраиваемом правиле обнаружения](../../media/custom-detection-details.png)<br>
*Сведения о настраиваемом правиле обнаружения*

На этой странице также можно сделать следующие действия с правилом:

- **Запустите** правило немедленно. Это также сбрасывает интервал для следующего запуска.
- **Изменение**— изменение правила без изменения запроса
- **Изменение запроса**— изменение запроса в режиме расширенных поисков
- **Включить**  /  **Отключение**— включите правило или остановите его работу
- **Удаление**— отключите правило и удалите его

### <a name="view-and-manage-triggered-alerts"></a>Просмотр инициированных оповещений и управление ими

На экране сведений о правиле **(поиск** пользовательских обнаружений  >    >  **[имя правила]**) перейдите к триггерным оповещениям, в котором перечислены оповещения, созданные совпадениями с правилом. Выберите оповещение, чтобы просмотреть подробные сведения о нем и принять следующие меры:

- Управление оповещением путем настройки его состояния и классификации (true или false alert)
- Связывать оповещение с инцидентом
- Запуск запроса, который инициирует оповещение при расширенных охотах

### <a name="review-actions"></a>Проверка действий
In the rule details screen (**Hunting**  >  **Custom detections**  >  **[Rule name]**), go to **Triggered actions**, which lists the actions taken based on matches to the rule.

>[!TIP]
>Чтобы быстро просмотреть сведения и принять меры к элементу в таблице, используйте столбец выбора [&#10003;] в левой части таблицы.

## <a name="see-also"></a>См. также
- [Обзор настраиваемых обнаружений](custom-detections-overview.md)
- [Обзор расширенной охоты на угрозы](advanced-hunting-overview.md)
- [Познакомьтесь с языком запросов расширенной охоты](advanced-hunting-query-language.md)
- [Перенос запросов на расширенный поиск из Microsoft Defender для конечной точки](advanced-hunting-migrate-from-mdatp.md)
