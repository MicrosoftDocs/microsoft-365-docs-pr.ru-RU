---
title: Создание настраиваемых правил обнаружения в защите от угроз Майкрософт и управление ими
description: Узнайте, как создавать и управлять пользовательскими правилами обнаружения на основе расширенных запросов поиска.
keywords: Расширенный поиск, Поиск угроз, Поиск угроз кибератак, защита от угроз Майкрософт, Microsoft 365, MTP, m365, поиск, запрос, телеметрии, пользовательские обнаружения, правила, схема, Кусто, Microsoft 365, защита от угроз Майкрософт, RBAC, разрешения, защитник Майкрософт
search.product: eADQiWindows 10XVcnh
search.appverid: met150
ms.prod: microsoft-365-enterprise
ms.mktglfcycl: deploy
ms.sitesec: library
ms.pagetype: security
f1.keywords:
- NOCSH
ms.author: lomayor
author: lomayor
ms.localizationpriority: medium
manager: dansimp
audience: ITPro
ms.collection: M365-security-compliance
ms.topic: article
ms.openlocfilehash: 7afcf16a42824ff234e53412a0cbd44f997fcaf9
ms.sourcegitcommit: 634abe8a237e27dfe82376e6ef32280aab5d4a27
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/01/2020
ms.locfileid: "45005714"
---
# <a name="create-and-manage-custom-detections-rules"></a>Создание настраиваемых правил обнаружения и управление ими

**Область применения:**
- Защита от угроз (Майкрософт)

Настраиваемые правила обнаружения, основанные на [расширенных](advanced-hunting-overview.md) запросах поиска, позволяют отслеживать различные события и состояния системы, включая невероятные действия и неправильно настроенные конечные точки. Вы можете настроить их для запуска через определенные интервалы, создавая оповещения и отменяя действия ответа при обнаружении совпадений.

## <a name="required-permissions-for-managing-custom-detections"></a>Необходимые разрешения для управления пользовательскими обнаружениями

Для управления пользовательскими обнаружениями необходимо назначить одну из этих ролей:

- **Администратор безопасности** — роль администратора безопасности или администратора безопасности — это [роль Azure Active Directory](https://docs.microsoft.com/azure/active-directory/users-groups-roles/directory-assign-admin-roles#security-administrator) для управления различными параметрами безопасности в центре безопасности Microsoft 365 и различными порталами и службами.

- **Оператор безопасности** — роль оператора безопасности — это [роль Azure Active Directory](https://docs.microsoft.com/azure/active-directory/users-groups-roles/directory-assign-admin-roles#security-administrator) для управления оповещениями и имеющая доступ только для чтения к функциям, связанным с безопасностью, включая всю информацию в центре безопасности Microsoft 365. Эта роль достаточно для управления пользовательскими обнаружениями только в том случае, если управление доступом на основе ролей (RBAC) отключено в Microsoft Defender ATP. Если вы настроили RBAC, вам также потребуется разрешение на **Управление параметрами безопасности** для пакета ATP для защитника Microsoft.

Для управления необходимыми разрешениями **глобальный администратор** может выполнить следующие действия:

- Назначьте роль **администратора безопасности** или **оператора безопасности** в [центре администрирования Microsoft 365](https://admin.microsoft.com/) в разделе **Roles**  >  **администратор безопасности**ролей.
- Проверьте параметры RBAC для защитника Майкрософт в [центре безопасности защитника Microsoft](https://securitycenter.windows.com/) в разделе **Параметры**  >  **разрешений**  >  **Roles**. Выберите соответствующую роль, чтобы назначить разрешение " **Управление параметрами безопасности** ".

> [!NOTE]
> Чтобы управлять пользовательскими обнаружениями, для **операторов безопасности** потребуется разрешение на **Управление параметрами безопасности** в защитнике Майкрософт, если параметр RBAC включен.

## <a name="create-a-custom-detection-rule"></a>Создание настраиваемого правила обнаружения
### <a name="1-prepare-the-query"></a>1. Подготовьте запрос.

В центре безопасности Microsoft 365 перейдите в раздел **Расширенный** Поиск и выберите существующий или создайте новый запрос. При использовании нового запроса выполните запрос, чтобы выявить ошибки и понять возможные результаты.

#### <a name="required-columns-in-the-query-results"></a>Обязательные столбцы в результатах запроса
Чтобы создать настраиваемое правило обнаружения, запрос должен возвратить следующие столбцы:

- `Timestamp`
- Одно из следующих столбцов устройства, пользователя или почтового ящика:
    - `DeviceId`
    - `DeviceName`
    - `RemoteDeviceName`
    - `RecipientEmailAddress`
    - `SenderFromAddress`(отправитель или обратный путь к конверту)
    - `SenderMailFromAddress`(адрес отправителя, отображаемый клиентом электронной почты)
    - `RecipientObjectId`
    - `AccountObjectId`
    - `AccountSid`
    - `AccountUpn`
    - `InitiatingProcessAccountSid`
    - `InitiatingProcessAccountUpn`
    - `InitiatingProcessAccountObjectId`
>[!NOTE]
>Поддержка дополнительных сущностей будет добавлена при добавлении новых таблиц в [расширенную схему](advanced-hunting-schema-tables.md)подпоисков.

Простые запросы, например те, которые не используют `project` оператор OR `summarize` для настройки или агрегирования результатов, обычно возвращают эти общие столбцы.

Существует несколько способов, позволяющих обеспечить более сложные запросы возвращать эти столбцы. Например, если вы предпочитаете объединить и подсчитать подсчета сущностями в столбце `DeviceId` , например, вы по-прежнему можете возвратить `Timestamp` его из самого последнего события, использующего каждое уникальное значение `DeviceId` .

Ниже приведен пример запроса, который подсчитывает количество уникальных устройств ( `DeviceId` ) с обнаружением вирусов и использует этот счетчик для поиска устройств с более чем пятью обнаружениями. Чтобы получить последнюю версию `Timestamp` , он использует `summarize` оператор с `arg_max` функцией.

```kusto
DeviceEvents
| where ActionType == "AntivirusDetection"
| summarize Timestamp = max(Timestamp), count() by DeviceId, SHA1, InitiatingProcessAccountObjectId 
| where count_ > 5
```
### <a name="2-create-new-rule-and-provide-alert-details"></a>2. Создайте новое правило и предоставьте сведения об оповещении.

С помощью запроса в редакторе запросов выберите **создать правило обнаружения** и укажите следующие сведения об оповещении:

- **Имя для обнаружения** — имя правила обнаружения
- **Частота** — интервал для выполнения запроса и выполнения действия. [Дополнительные рекомендации приведены ниже](#rule-frequency)
- **Заголовок оповещения** — заголовок, отображаемый с оповещениями, инициированными правилом
- **Severity** — потенциальный риск для компонента или действия, идентифицируемого правилом
- **Category (категория** ) — компонент угрозы или действия, определяемые правилом
- **МИТРЕ ATT&а методы** — одна или несколько способов атаки, определяемых правилом, описанных в разделе [МИТРЕ ATT&а Framework](https://attack.mitre.org/). Этот раздел не применяется и скрыт для определенных категорий оповещений, в том числе вредоносных программ, программой-шантажистом, подозрительными действиями и нежелательным программным обеспечением.
- **Description (описание** ) — Дополнительные сведения о компоненте или действии, определяемом правилом 
- **Рекомендуемые действия** — дополнительные действия, которые могут принимать ответчики в ответ на оповещение

#### <a name="rule-frequency"></a>Частота правил
При сохранении нового или измененного правила обнаружения сразу же выполняется и проверяется соответствие за прошедшие 30 дней данных. Затем правило выполняется повторно с фиксированными интервалами и лукбакк продолжительностью в зависимости от того, какая частота выбрана:

- **Каждые 24 часа** — выполняется каждые 24 часа, проверяя данные за прошедшие 30 дней.
- **Каждые 12 часов** — выполняется каждые 12 часов, выполняется проверка данных за прошедшие 24 часа
- **Каждые 3 часа** — выполняется каждые 3 часа, проверка данных за прошедшие 6 часов
- **Каждый час** — выполняется Почасовая проверка данных за прошлые 2 часа

Выберите частоту, совпадающую с тем, насколько близко вы хотите отслеживать обнаружение, и продумайте, что емкость Организации отвечает на оповещения.

### <a name="3-choose-the-impacted-entities"></a>3. Выберите затронутые объекты.
Определите столбцы в результатах запроса, где ожидается Поиск основной затронутой или затронутой сущности. Например, запрос может возвращать адреса отправителя ( `SenderFromAddress` или `SenderMailFromAddress` ) и получателей ( `RecipientEmailAddress` ). Определение того, какие из этих столбцов представляют основную затронутую сущность, помогает службе собирать соответствующие оповещения, сопоставлять инциденты и целевые действия отклика.

Можно выбрать только один столбец для каждого типа сущности (почтовый ящик, пользователь или устройство). Столбцы, которые не возвращаются запросом, не могут быть выбраны.

### <a name="4-specify-actions"></a>4. Укажите действия.
Настраиваемое правило обнаружения может автоматически выполнять действия на устройствах, файлах или пользователях, возвращенных запросом.

#### <a name="actions-on-devices"></a>Действия на устройствах
Эти действия применяются к устройствам в `DeviceId` столбце результатов запроса:
- **Изолировать устройство** — использует Microsoft Defender ATP для применения полной изоляции сети, что не позволяет устройству подключаться к любому приложению или службе. [Дополнительные сведения о изоляции компьютеров ATP для защитника Майкрософт](https://docs.microsoft.com/windows/security/threat-protection/microsoft-defender-atp/respond-machine-alerts#isolate-devices-from-the-network)
- **Собрать пакет для расследования** — собирает сведения об устройствах в ZIP-файле. [Дополнительные сведения о пакете исследования Microsoft Defender ATP](https://docs.microsoft.com/windows/security/threat-protection/microsoft-defender-atp/respond-machine-alerts#collect-investigation-package-from-devices)
- **Запустить антивирусное сканирование** — выполняет полную проверку на устройстве антивирусной программы "Защитник Windows"
- **Initiate расследования** — инициирует [Автоматическое исследование](mtp-autoir.md) на устройстве
- **Ограничить выполнение приложения** — устанавливает ограничения на устройство, чтобы разрешить запуск только тех файлов, которые подписаны на сертификат, выданный корпорацией Майкрософт. [Дополнительные сведения об ограничениях приложений с помощью защитника Майкрософт для ATP](https://docs.microsoft.com/windows/security/threat-protection/microsoft-defender-atp/respond-machine-alerts#restrict-app-execution)

#### <a name="actions-on-files"></a>Действия с файлами
Если выбран этот параметр, вы можете применить действие к **файлу в карантине** к файлам в `SHA1` результатах запроса,, или в `InitiatingProcessSHA1` `SHA256` `InitiatingProcessSHA256` столбце. Это действие удаляет файл из текущего расположения и помещает копию в карантин.

#### <a name="actions-on-users"></a>Действия для пользователей
Если выбран этот параметр, **пользователь пометить как Скомпрометированное** действие будет выполняться для пользователей `AccountObjectId` в `InitiatingProcessAccountObjectId` столбце, или в `RecipientObjectId` столбце результатов запроса. Это действие устанавливает для уровня риска "высокий" в Azure Active Directory, активируя соответствующие [политики защиты удостоверений](https://docs.microsoft.com/azure/active-directory/identity-protection/overview-identity-protection).

> [!NOTE]
> Действие разрешить или блокировать для правил настраиваемого обнаружения в настоящее время не поддерживается в защите от угроз Майкрософт.

### <a name="5-set-the-rule-scope"></a>5. Задайте область применения правила.
Задайте область, чтобы указать, какие устройства попадают под действие правила. Правила влияния на области, которые проверяют устройства и не влияют на правила, которые проверяют только почтовые ящики, учетные записи пользователей и удостоверения.

При задании области можно выбрать:

- Все устройства
- Конкретные группы устройств

Будут запрашиваться только данные из устройств в области. Кроме того, действия будут выполняться только для этих устройств.

### <a name="6-review-and-turn-on-the-rule"></a>6. Проверьте и включите правило.
После просмотра правила нажмите кнопку **создать** , чтобы сохранить его. Пользовательское правило обнаружения сразу же запустится. Он выполняется повторно в зависимости от настроенной частоты для проверки совпадений, создания оповещений и выполнения действий ответа.

## <a name="manage-existing-custom-detection-rules"></a>Управление существующими пользовательскими правилами обнаружения
Вы можете просмотреть список существующих настраиваемых правил обнаружения, проверить их предыдущие запуски и просмотреть оповещения, которые они инициировали. Вы также можете выполнить правило по требованию и изменить его.

### <a name="view-existing-rules"></a>Просмотр существующих правил

**Чтобы просмотреть**все существующие настраиваемые правила обнаружения, перейдите к разделу  >  **Поиск с пользовательским обнаружением**. На странице перечислены все правила со следующими сведениями о запуске:

- **Последнее выполнение** — при последнем запуске правила для проверки совпадений запросов и создания оповещений
- **Состояние последнего запуска** — успешно ли выполнено правило
- **Следующий запуск** — следующее запланированное выполнение
- **Status (состояние** ) — включено ли правило

### <a name="view-rule-details-modify-rule-and-run-rule"></a>Просмотр сведений о правиле, правила изменения и запуска

Чтобы просмотреть подробные сведения **о настраиваемом**правиле обнаружения, выберите имя правила из списка правила  >  **поиска**. Откроется страница со сведениями о настраиваемом правиле обнаружения с общими сведениями о правиле, в том числе сведениями об оповещении, состоянии выполнения и области. Он также предоставляет список инициированных оповещений и инициированных действий.

![Страница сведений о настраиваемом правиле обнаружения](../../media/custom-detection-details.png)<br>
*Сведения о настраиваемом правиле обнаружения*

На этой странице можно также выполнить следующие действия для правила:

- **Run** — немедленное выполнение правила. При этом также сбрасывается интервал следующего запуска.
- **Изменить** — изменить правило, не изменяя запрос
- **Изменение запроса** — изменение запроса в расширенном поиске
- **Включение**  /  **Отключить** — включить или остановить выполнение правила
- **Удалить** — отключить правило и удалить его

### <a name="view-and-manage-triggered-alerts"></a>Просмотр и управление инициированными оповещениями

На экране сведения о правиле **(**  >  **Поиск пользовательских обнаружений**  >  **[имя правила]**) перейдите к **триггерным оповещениям** , чтобы просмотреть список оповещений, созданных по совпадениям с правилом. Выберите оповещение, чтобы просмотреть подробные сведения об этом оповещении, и выполните следующие действия для этого оповещения:

- Управление предупреждением с помощью задания его состояния и классификации (true или false Alert)
- Связывание предупреждения с инцидентом
- Запуск запроса, запускающего оповещение при расширенном поиске

### <a name="review-actions"></a>Проверка действий
На экране сведения о правиле **(**  >  **Поиск пользовательских обнаружений**  >  **[имя правила]**) перейдите к **триггерным действиям** , чтобы просмотреть список действий, выполняемых на основании совпадений с правилом.

>[!TIP]
>Чтобы быстро просмотреть сведения и выполнить действия над элементом таблицы, используйте столбец Selection [&#10003;] слева от таблицы.

## <a name="related-topic"></a>Связанная тема
- [Обзор настраиваемых обнаружений](custom-detections-overview.md)
- [Обзор расширенной охоты на угрозы](advanced-hunting-overview.md)
- [Познакомьтесь с языком запросов расширенной охоты](advanced-hunting-query-language.md)