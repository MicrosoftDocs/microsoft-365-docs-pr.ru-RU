---
title: Создание настраиваемой системы обнаружения в ATP Защитника Майкрософт
ms.reviewer: ''
description: Узнайте, как создать настраиваемые правила обнаружения на основе расширенных запросов на охоту
keywords: настраиваемые обнаружения, создание, управление, оповещения, редактирование, запуск по требованию, частота, интервал, правила обнаружения, расширенные правила охоты, охота, запрос, действия отклика, mdatp, microsoft defender atp
search.product: eADQiWindows 10XVcnh
search.appverid: met150
ms.prod: m365-security
ms.mktglfcycl: deploy
ms.sitesec: library
ms.pagetype: security
ms.author: lomayor
author: lomayor
localization_priority: Normal
manager: dansimp
audience: ITPro
ms.collection: M365-security-compliance
ms.topic: article
ms.date: 09/20/2020
ms.technology: mde
ms.openlocfilehash: fc4c15d2e391176ed0b4420c13fb865674da0361
ms.sourcegitcommit: 2a708650b7e30a53d10a2fe3164c6ed5ea37d868
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/24/2021
ms.locfileid: "51163591"
---
# <a name="create-custom-detection-rules"></a>Создание настраиваемой системы обнаружения

[!INCLUDE [Microsoft 365 Defender rebranding](../../includes/microsoft-defender.md)]

**Область применения:**
- [Microsoft Defender для конечной точки](https://go.microsoft.com/fwlink/p/?linkid=2154037)
- [Microsoft 365 Defender](https://go.microsoft.com/fwlink/?linkid=2118804)

>Хотите испытать Defender для конечной точки? [Зарегистрився для бесплатной пробной.](https://www.microsoft.com/microsoft-365/windows/microsoft-defender-atp?ocid=docs-wdatp-assignaccess-abovefoldlink)

Настраиваемые правила [](advanced-hunting-overview.md) обнаружения, созданные из расширенных запросов на охоту, позволяет активно отслеживать различные события и состояния системы, включая предполагаемые нарушения и неправильно настроенные устройства. Вы можете настроить их для запуска с регулярными интервалами, создавая оповещения и принимая ответные действия при совпадениях.

Ознакомьтесь с этой статьей, чтобы узнать, как создать новые пользовательские правила обнаружения. Или [см. просмотр и управление существующими правилами.](custom-detections-manage.md)

> [!NOTE]
> Чтобы создать или управлять пользовательскими обнаружениями, [ваша роль](user-roles.md#create-roles-and-assign-the-role-to-an-azure-active-directory-group) должна иметь разрешение на управление **настройками безопасности.**

## <a name="1-prepare-the-query"></a>1. Подготовка запроса.

В центре безопасности Microsoft Defender перейдите в **расширенный** поиск и выберите существующий запрос или создайте новый запрос. При использовании нового запроса запустите запрос для выявления ошибок и понимания возможных результатов.

>[!IMPORTANT]
>Чтобы служба не возвращала слишком много оповещений, каждое правило ограничивается созданием только 100 оповещений при каждом запуске. Перед созданием правила необходимо настроить запрос, чтобы не предупреждать о нормальной ежедневной активности.

### <a name="required-columns-in-the-query-results"></a>Необходимые столбцы в результатах запроса

Чтобы использовать запрос для пользовательского правила обнаружения, запрос должен возвращать следующие столбцы:

- `Timestamp`
- `DeviceId`
- `ReportId`

Простые запросы, например запросы, которые не используют оператор или оператор для настройки или агрегированных результатов, обычно возвращают `project` `summarize` эти общие столбцы.

Существуют различные способы обеспечения более сложных запросов, возвращая эти столбцы. Например, если вы предпочитаете агрегировать и считать по, вы все равно можете вернуться и получить их из последнего события `DeviceId` `Timestamp` с участием каждого `ReportId` устройства.

В приведенной ниже примере запроса учитывается количество уникальных устройств () с обнаружениями антивирусов и используется для поиска только тех устройств с более чем `DeviceId` пятью обнаружениями. Чтобы вернуть последнюю и `Timestamp` `ReportId` соответствующую, он использует оператора с `summarize` `arg_max` функцией.

```kusto
DeviceEvents
| where Timestamp > ago(7d)
| where ActionType == "AntivirusDetection"
| summarize (Timestamp, ReportId)=arg_max(Timestamp, ReportId), count() by DeviceId
| where count_ > 5
```

> [!TIP]
> Для улучшения производительности запроса установите фильтр времени, который соответствует вашей назначенной частоте выполнения для правила. Так как наименее частый запуск происходит каждые 24 часа, фильтрация за прошедший день будет охватывать все новые данные.

## <a name="2-create-a-new-rule-and-provide-alert-details"></a>2. Создайте новое правило и укажу сведения об оповещении.

С помощью запроса в редакторе запроса выберите **правило Создать** обнаружение и укажите следующие сведения оповещения:

- **Имя обнаружения**— имя правила обнаружения
- **Частота**— интервал для выполнения запроса и принятия действий. [Дополнительные рекомендации см. ниже](#rule-frequency)
- **Предупреждение название**— заголовок, отображаемый с оповещениями, инициированными правилом
- **Серьезность**— потенциальный риск компонента или действия, определяемого правилом. [Чтение о серьезности оповещений](alerts-queue.md#severity)
- **Категория —** тип компонента угрозы или действий, если таковой существует. [Чтение о категориях оповещений](alerts-queue.md#understanding-alert-categories)
- **МЕТОДЫ ATT&CK**— одна или несколько методов атаки, которые определены правилом, как описано в рамках ATT MITRE&CK. Этот раздел недо доступен с определенными категориями оповещений, такими как вредоносные программы, программы-вымогательства, подозрительные действия и нежелательное программное обеспечение.
- **Описание**— дополнительные сведения о компоненте или действии, выявленных правилом 
- **Рекомендуемые действия**— дополнительные действия, которые могут приниматься ответчиками в ответ на предупреждение

Дополнительные сведения о том, как отображаются сведения об оповещении, [читайте в публикации "Ъ" "Очередь оповещения".](alerts-queue.md)

### <a name="rule-frequency"></a>Частота правил

При сэкономлении запускается новое пользовательское правило обнаружения, проверяя совпадения за последние 30 дней данных. Затем правило выполняется снова с фиксированными интервалами и длительностью обратного воспроизведения в зависимости от частоты, которая вы выбираете:

- **Каждые 24 часа**— выполняется каждые 24 часа, проверяя данные за последние 30 дней
- **Каждые 12 часов**— выполняется каждые 12 часов, проверяя данные за последние 24 часа
- **Каждые 3 часа**— выполняется каждые 3 часа, проверяя данные за последние 6 часов
- **Каждый** час — выполняется почасовая проверка данных за последние 2 часа.

> [!IMPORTANT]
> При изменении запроса, который уже запланирован в качестве настраиваемого обнаружения, следующее немедленное выполнение будет иметь окно в 30 дней, точно так же, как если бы создавался новый запрос. Изменения большого количества запросов и с фильтрами времени, которые по умолчанию больше, чем по умолчанию для выбранной частоты, могут повлиять на общее потребление квот в Advanced Hunting и привести к исчерпанию дневной квоты.

> [!TIP]
> Соответствие фильтрам времени в запросе с длительностью отката. Результаты за пределами длительности поиска игнорируются.

Выберите частоту, которая совпадает с тем, как тщательно следует отслеживать обнаружение, и рассмотрите возможности организации для реагирования на оповещения.

## <a name="3-choose-the-impacted-entities"></a>3. Выберите сущностями с влиянием.

Определите столбцы в результатах запроса, в которых ожидается найти основную затронутую или затрагиваемую сущность. Например, запрос может возвращать ИД устройств и пользователей. Определение того, какие из этих столбцов представляют основную объектную сущность, помогает службе агрегировать соответствующие оповещения, соотносить инциденты и целевые действия реагирования.

Для каждого типа сущности можно выбрать только один столбец. Столбцы, не возвращенные запросом, не могут быть выбраны.

## <a name="4-specify-actions"></a>4. Укажите действия.

Ваше пользовательское правило обнаружения может автоматически принимать действия на файлах или устройствах, возвращаемые запросом.

### <a name="actions-on-devices"></a>Действия на устройствах

Эти действия применяются к устройствам в `DeviceId` столбце результатов запроса:

- **Изолировать устройство**— применяется полная изоляция сети, предотвращая подключение устройства к любому приложению или службе, за исключением службы Defender for Endpoint. [Дополнительные информацию об изоляции устройств](respond-machine-alerts.md#isolate-devices-from-the-network)
- **Сбор пакета исследований**— сбор сведений об устройствах в файле ZIP. [Дополнительные информацию о пакете исследований](respond-machine-alerts.md#collect-investigation-package-from-devices)
- **Запуск антивирусного сканирования**— выполняет полное антивирусное сканирование Microsoft Defender на устройстве
- **Инициировать** расследование — [начинается автоматическое расследование](automated-investigations.md) на устройстве
- **Ограничение выполнения приложения**— устанавливает ограничения на устройстве, позволяя запускать только файлы, подписанные с помощью сертификата, выданного Корпорацией Майкрософт. [Подробнее об ограничении выполнения приложений](respond-machine-alerts.md#restrict-app-execution)

### <a name="actions-on-files"></a>Действия в файлах

Эти действия применяются к файлам в столбце или `SHA1` `InitiatingProcessSHA1` столбце результатов запроса:

- **Разрешить/заблокировать**— автоматически добавляет файл [](manage-indicators.md) в настраиваемый список индикаторов, чтобы всегда было разрешено запускать или блокировать запуск. Область действия можно настроить таким образом, чтобы оно было принято только в выбранных группах устройств. Эта область не зависит от области действия правила.
- **Файл карантина** удаляет файл из текущего расположения и помещает копию в карантин

### <a name="actions-on-users"></a>Действия для пользователей

- **Пометить** пользователя как скомпрометированного — задает уровень риска пользователя до "высокого" в Azure Active Directory, запуская соответствующие [политики защиты удостоверений.](https://docs.microsoft.com/azure/active-directory/identity-protection/overview-identity-protection#risk-levels)

## <a name="5-set-the-rule-scope"></a>5. Установите область правил.

Установите область, чтобы указать, какие устройства охвачены правилом:

- Все устройства
- Конкретные группы устройств

Запрашиваются только данные с устройств в области. Кроме того, действия будут приниматься только на этих устройствах.

## <a name="6-review-and-turn-on-the-rule"></a>6. Просмотрите и включите правило.

После просмотра правила выберите **Создать, чтобы** сохранить его. Правило настраиваемой диагностики немедленно запускается. Он снова запускается на основе настроенной частоты для проверки совпадений, создания оповещений и реагировать на действия.

Вы можете [просматривать и управлять пользовательскими](custom-detections-manage.md)правилами обнаружения, проверять их предыдущие запуски и просматривать срабатываемые ими оповещения. Вы также можете запустить правило по запросу и изменить его.

## <a name="related-topics"></a>Статьи по теме

- [Просмотр и управление пользовательскими правилами обнаружения](custom-detections-manage.md)
- [Обзор настраиваемых обнаружений](overview-custom-detections.md)
- [Обзор расширенной охоты на угрозы](advanced-hunting-overview.md)
- [Познакомьтесь с языком запросов расширенной охоты](advanced-hunting-query-language.md)
- [Просмотр и организация оповещений](alerts-queue.md)
