---
title: Networking up (to the cloud)—One architect's viewpoint
description: Узнайте, как оптимизировать сеть для облачного подключения, избегая наиболее распространенных ошибок.
ms.author: bcarter
author: brendacarter
manager: bcarter
ms.audience: ITPro
ms.topic: article
ms.prod: microsoft-365-enterprise
localization_priority: Normal
ms.collection:
- M365-identity-device-management
- M365-security-compliance
ms.custom: ''
f1.keywords: NOCSH
ms.openlocfilehash: 7de9aec29b0a57e85e3539fc2e99384de545c52a
ms.sourcegitcommit: 27b2b2e5c41934b918cac2c171556c45e36661bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "50904640"
---
# <a name="networking-up-to-the-cloudone-architects-viewpoint"></a>Networking up (to the cloud)—One architect's viewpoint

В этой статье Эд Фишер [(Ed Fisher),](https://www.linkedin.com/in/edfisher/)архитектор & безопасности в Корпорации Майкрософт, описывает, как оптимизировать сеть для облачного подключения, избегая наиболее распространенных ошибок. 

## <a name="about-the-author"></a>Об авторе

![Фото Эда Фишера](../media/solutions-architecture-center/ed-fisher-networking.jpg) 

В настоящее время я главный технический специалист в юго-восточном регионе, где основное внимание уделяется & безопасности. Я работал с клиентами, Office 365 последние 10 лет. Я работал с небольшими магазинами с несколькими расположениями для государственных учреждений и предприятий с миллионами пользователей, распространяемых по всему миру, и многими другими клиентами между ними, большинство из которых имеют десятки тысяч пользователей, несколько местоположений в различных частях мира, потребность в более высокой степени безопасности и множество требований к требованиям соответствия требованиям. Я помог сотням предприятий и миллионам пользователей безопасно и безопасно перемещаться в облако.

С фоном за последние 25 лет, который включает безопасность, инфраструктуру и сетевое проектирование, а также переместив двух моих предыдущих работодателей в Office 365, прежде чем присоединиться к Microsoft, я был на вашей стороне таблицы много раз, и помните, что это такое. Хотя у двух клиентов нет одинаковых клиентов, большинство из них имеют аналогичные потребности, и при потреблении стандартизированной службы, такой как любая платформа SaaS или PaaS, наиболее оптимальные подходы, как правило, одинаковы.

## <a name="its-not-the-networkits-how-youre-misusing-it"></a>Это не сеть, это то, как вы (mis)using it!

Независимо от того, сколько раз это происходит,  он никогда не удивляет меня, как творческие группы безопасности и сетевые группы пытаются получить с тем, как они думают, что они должны подключиться к облачным службам Microsoft. Всегда существует какая-то политика безопасности, стандарты соответствия требованиям или более эффективные способы, которые они настаивают на  использовании, без желания вести беседу о том, чего они пытаются добиться, или о том, как они лучше, проще, эффективнее и эффективнее.

Когда такие вещи обострились для меня, я обычно готов принять вызов и пройти их через как и почему, и получить их туда, где они должны быть. Но если я полностью откровенен, я должен поделиться тем, что иногда я хочу просто позволить им делать то, что они будут, и вернуться, чтобы сказать, что я сказал вам так, когда они, наконец, уступив это не работает. Иногда я хочу это сделать, но *не делаю* этого. Что я делаю, это попытаться объяснить все, что я собираюсь включить в эту должность. Независимо от вашей роли, если ваша организация хочет использовать облачные службы Майкрософт, вероятно, существует определенная мудрость в том, что следует, что может помочь вам.

## <a name="guiding-principles"></a>Руководящие принципы

Давайте начнем с некоторых правил о том, что мы здесь делаем. Мы обсуждаем, как безопасно подключаться к облачным службам для обеспечения минимальной сложности и максимальной производительности при сохранении реальной безопасности. Все это не противоречит этому, даже если вы или ваш клиент не сможете использовать свой любимый прокси-сервер для всего.

- **Просто потому,** что вы можете, не означает, что вы должны : Или перефразировать д-р Ian Malcolm из фильма Парк юрского периода "... Да, да, но ваша группа безопасности была настолько озабочена тем, могут ли они или нет, что они не перестанут думать, следует ли им".
- **Безопасность не означает сложности:** вы не более безопасны только потому, что вы тратите больше денег, маршрут через несколько устройств, или нажмите больше кнопок.
- **Office 365 доступ через Интернет:** Но это не то же самое, Office 365 это Интернет. Это служба SaaS, которая управляется Корпорацией Майкрософт и управляется вами. В отличие от веб-сайтов, которые вы посещаете в Интернете, вы действительно можете заглянуть за кулисы и применить элементы управления, необходимые для соответствия вашим политикам и стандартам соответствия требованиям, если вы понимаете, что, хотя вы можете выполнить поставленные перед вами задачи, вы можете просто выполнять их по-другому.
- **Chokepoints являются плохими,** локализованные прорывы хороши: каждый всегда хочет, чтобы обратно все их интернет-трафик для всех своих пользователей в какой-то центральной точке, как правило, чтобы они могли отслеживать его и применять политику, но часто потому, что это либо дешевле, чем подготовка доступа к Интернету во всех своих местах, или это просто, как они это делают. Но эти точки удушья именно это ... указывает, где трафик задыхается. Нет ничего плохого в том, чтобы запретить пользователям просматривать в Instagram или потоковое видео с кошками, но не относитесь к трафику бизнес-приложений, критически важным для миссии.
- Если DNS не **устраивает,** нет ничего счастливого: лучшей разработанной сетью может быть подколена некачественное DNS, будь то повторение запросов на серверы в других регионах мира или использование DNS-серверов вашего isP или других общедоступных DNS-серверов, которые кэшировали сведения о разрешении DNS.
- **Просто потому,** что это то, как вы это использовали, не означает, что это, как вы должны сделать это сейчас: технология постоянно меняется и Office 365 не является исключением. Применение мер безопасности, разработанных и развернутых для локальной службы или для управления веб-серфингом, не обеспечит такого же уровня безопасности и может оказать существенное негативное влияние на производительность.
- **Office 365 была построена для** доступа через Интернет: вот в двух словах. Независимо от того, что вы хотите сделать между пользователями и вашим преимуществом, трафик по-прежнему идет через Интернет, как только он выходит из сети и до того, как он попадает на нашу. Даже если вы используете Azure ExpressRoute для маршрутов некоторых чувствительных к задержке трафика из сети непосредственно в нашу, подключение к Интернету абсолютно необходимо. Примите его. Не переумывляйте это.

## <a name="where-bad-choices-are-often-made"></a>В тех случаях, когда часто используются плохие решения

Хотя существует множество мест, где во имя безопасности принимаются плохие решения, чаще всего это те, с которыми я сталкивался с клиентами. Во многих беседах с клиентами все это включается одновременно.

### <a name="insufficient-resources-at-the-edge"></a>Недостаточно ресурсов на краю

Очень немногие клиенты развертывают среды greenfield, и у них есть многолетней опыт работы пользователей и их интернет-регресса. Независимо от того, имеются ли у клиентов прокси-серверы или имеются прямые доступы и просто исходящие потоки NAT, они делают это в течение многих лет и не считают, сколько еще они начнут перекачивать через край по мере перемещения традиционно внутренних приложений в облако.

Пропускная способность всегда вызывает беспокойство, но устройства NAT могут не иметь достаточно лошадиных сил для обработки повышенной нагрузки и могут начать преждевременное закрытие подключений, чтобы освободить ресурсы. Большая часть клиентского программного обеспечения, подключаемого к Office 365, ожидает постоянных подключений, а пользователь, полностью использующий Office 365, может иметь 32 или более одновременно подключений. Если устройство NAT сбрасывает их преждевременно, эти приложения могут не оказаться безответными при попытке использования подключений, которых больше нет. Когда они сдаются и пытаются установить новые подключения, они создают еще больше нагрузки на сетевое оборудование.

### <a name="localized-breakout"></a>Локализованный прорыв

Все остальное в этом списке сводится к одному : как можно быстрее сойтись с сети и на нашу. Перенаправка трафика пользователей в центральную точку регрессии, особенно если эта точка находится в другом регионе, чем ваши пользователи, вводит ненужные задержки и влияет как на клиентский опыт, так и на скорость скачивания. Microsoft имеет точки присутствия по всему миру с передними концами для всех наших служб и пиринга,  установленных практически со всеми основными интернет-пользователями, поэтому маршрутивка трафика пользователей локально гарантирует, что он быстро попадает в нашу сеть с минимальной задержкой.

### <a name="dns-resolution-traffic-should-follow-the-internet-egress-path"></a>Трафик разрешения DNS должен следовать пути отступа к Интернету

Конечно, чтобы клиент нашел конечную точку, ему необходимо использовать DNS. DNS-серверы Майкрософт оценивают источник запросов DNS, чтобы гарантировать, что мы возвращаем ответ, который, с точки зрения Интернета, ближе всего к источнику запроса. Убедитесь, что DNS настроен таким образом, чтобы запросы на разрешение имен вышли на тот же путь, что и трафик пользователей, чтобы не дать им локальный отступ, но в конечную точку в другом регионе. Это означает, что локальные DNS-серверы "пустяки" вместо того, чтобы перенаходить на DNS-серверы в удаленных центрах обработки данных. И следите за общедоступными и частными службами DNS, которые могут кэшаторов результатов из одной части мира и служить им для запросов из других частей мира.

### <a name="to-proxy-or-not-to-proxy-that-is-the-question"></a>Чтобы прокси или не прокси-

Одна из первых вещей, которые необходимо рассмотреть, — это подключение прокси-пользователей к Office 365. Это легко; не прокси. Office 365 доступ через Интернет, но это не Интернет. Это расширение основных служб, которые должны рассматриваться как таковые. Все, что может потребоваться прокси-серверу, например DLP или проверка антивирусного программного обеспечения или контента, уже доступно в службе и может использоваться в масштабе и без необходимости взлома подключений с шифрованием TLS. Но если вы действительно хотите прокси-трафик, который вы не можете иначе контролировать, обратите внимание на наши рекомендации по и категории [https://aka.ms/pnc](../enterprise/microsoft-365-network-connectivity-principles.md) трафика на [https://aka.ms/ipaddrs](../enterprise/urls-and-ip-address-ranges.md) . У нас есть три категории трафика для Office 365. Оптимизация и разрешить действительно должны идти прямой и обойти прокси-сервер. По умолчанию можно зафиксить. Сведения в этих документы... прочитать их.

Большинство клиентов, которые настаивают на использовании прокси, когда они действительно смотрят на то, что они делают, понимают, что, когда клиент делает запрос HTTP CONNECT на прокси, прокси-сервер теперь просто дорогой дополнительный маршрутизатор. Протоколы, которые используются, такие как MAPI и RTC, даже не являются протоколами, которые понимают веб-прокси, поэтому даже при взломе TLS вы не получаете никакой дополнительной безопасности. Вы *получаете* дополнительную задержку. Дополнительные возможности см. в этой области, в том числе в категориях Оптимизация, Разрешить и По умолчанию для [https://aka.ms/pnc](../enterprise/microsoft-365-network-connectivity-principles.md) Microsoft 365 трафика.

Наконец, рассмотрите общее влияние на прокси-сервер и соответствующий ответ для борьбы с этим воздействием. Поскольку все больше подключений делается через прокси-сервер, это может уменьшить коэффициент масштаба TCP, чтобы не было буфера так много трафика. Я видел клиентов, где их прокси были настолько перегружены, что они использовали коэффициент масштабирования 0. Так как Scale Factor является экспоненциальным значением, и мы хотели бы использовать 8, каждое снижение значения Scale Factor оказывает огромное негативное влияние на пропускную способность.

TLS Inspection — это безопасность! Но не совсем! Многие клиенты с прокси-клиентами хотят использовать их для проверки всего трафика, а это означает, что TLS "ломаются и проверяются". При этом для веб-сайта, доступного через HTTPS (несмотря на проблемы конфиденциальности), прокси-серверу может потребоваться 10 или даже 20 одновременно потоков в течение нескольких сотен миллисекунд. Если есть большая загрузка или, возможно, участие видео, одно или несколько из этих подключений может длиться гораздо дольше, но в целом большинство из этих подключений установить, передать и закрыть очень быстро. При разрыве и проверке прокси-сервер должен удвоить работу. Для каждого подключения от клиента к прокси-серверу прокси-сервер должен также сделать отдельное подключение к конечной точке. Таким образом, 1 становится 2, 2 становится 4, 32 становится 64 ... Возможно, для обычного веб-серфинга вы можете использовать прокси-решение точно так же, но при попытке сделать то же самое для клиентских подключений к Office 365 количество одновёрстных и долгоживующих подключений может быть на порядок больше, чем размер.

### <a name="streaming-isnt-important-except-that-it-is"></a>Потоковая передача не важна, за исключением *того, что она*

Единственными службами в Office 365, которые используют UDP, являются Skype (скоро будут отменены) и Microsoft Teams. Teams использует UDP для потокового трафика, включая аудио, видео и общий доступ к презентации. Потоковый трафик в прямом эфире, например, при встрече с голосом, видео, а также демонстрацией или демонстрацией. Они используют UDP, так как если пакеты отброшены или приходят из строя, пользователь практически не может его увидеть, и поток может просто продолжать ходить.

Если вы не разрешаете исходящие потоки UDP от клиентов к службе, они могут вернуться к использованию TCP. Но если пакет TCP  отброшен, все останавливается, пока не истечет срок действия времени ретрансмиссии (RTO) и отсутствующий пакет может быть повторно повторно. Если пакет выходит из строя, все останавливается до тех пор, пока другие пакеты не прибудут и могут быть повторно собраны в порядке. Оба приводят к ощутимым сбоям в аудио (помните Max Headroom?) и видео (вы нажмете что-то ... Oh, там оно) и ведет к плохой производительности и плохому опыту пользователя. И помните, что я поставил выше о прокси? При принудительном Teams клиенте использовать прокси-сервер, вы принудить его к использованию TCP. Теперь вы дважды вызываете негативные последствия производительности.

### <a name="split-tunneling-may-seem-scary"></a>Разделение туннелей может показаться страшным

Но это не так. Все подключения к Office 365 подключены к TLS. Мы уже довольно давно предлагаем TLS 1.2 и скоро отключим старые версии, так как устаревшие клиенты по-прежнему используют их, и это риск.

Принуждение к подключению TLS или 32 из них к VPN перед тем, как они перейдут в службу, не добавляет безопасности. Это добавляет задержку и снижает общую пропускную способность. В некоторых решениях VPN он даже заставляет UDP проходить туннель через TCP, что снова будет иметь очень негативное влияние на потоковый трафик. И, если вы не проводите TLS-проверку, нет никаких плюсов, все недостатки. Очень распространенная тема среди клиентов, в настоящее время, когда большая часть их сотрудников удалена, является то, что они видят значительные последствия пропускной способности и производительности от принятия всех своих пользователей подключиться с помощью VPN, а не настройки раздельного туннеля для доступа к оптимизации категории [Office 365](../enterprise/microsoft-365-network-connectivity-principles.md#new-office-365-endpoint-categories)конечных точек .

Это простое решение для раздельного туннелинга. Дополнительные разделы убедитесь в том, что вы Office 365 оптимизацию подключения для удаленных пользователей с помощью [VPN-раздельного туннелинга.](../enterprise/microsoft-365-vpn-split-tunnel.md)

## <a name="the-sins-of-the-past"></a>Грехи прошлого

Много раз причиной плохого выбора является сочетание (1) не зная, как работает служба, (2) пытается придерживаться политик компании, которые были написаны до принятия облака, и (3) группы безопасности, которые не могут быть легко убеждены, что существует несколько способов для достижения своих целей. Надеемся, что выше, и ссылки ниже, поможет с первым. Для получения второго может потребоваться спонсорство. Решение целей политик безопасности, а не их методов, помогает с третьей. От условного доступа к модерации контента, DLP до защиты информации, проверки конечной точки до угроз нулевого дня — любая конечная цель разумной политики безопасности может быть выполнена с помощью того, что доступно в Office 365, и без какой-либо зависимости от локального сетевого оборудования, принудительного прорыва VPN-туннелей и проверки TLS.

В других случаях оборудование, которое было размера и приобретено до начала перемещения организации в облако, просто не может быть масштабироваться для обработки новых шаблонов трафика и нагрузок. Если вы действительно должны перенаградить весь трафик через одну точку egress и/или прокси-сервер, будьте готовы к обновлению сетевого оборудования и пропускной способности соответственно. Тщательно отслеживайте использование обеих сторон, так как это не уменьшится медленно, так как на борту будет больше пользователей. Все будет хорошо до тех пор, пока точка наклона не будет достигнута, то все страдают.

## <a name="exceptions-to-the-rules"></a>Исключения из правил

Если в организации требуются ограничения [клиента,](/azure/active-directory/manage-apps/tenant-restrictions)вам потребуется использовать прокси-сервер с разрывом TLS и проверять, чтобы заставить трафик через прокси-сервер, но вам не нужно принудительно использовать весь трафик через него.  Это не все или ничего предложения, поэтому обратите внимание на то, что необходимо изменить прокси..

Если вы собираетесь разрешить раздельное туннельное движение, а также использовать прокси для общего веб-трафика, убедитесь, что файл PAC определяет, что должно быть прямым, а также то, как определить интересный трафик для того, что проходит через VPN-туннель. Мы предлагаем примеры файлов PAC, [https://aka.ms/ipaddrs](../enterprise/urls-and-ip-address-ranges.md) что облегчит управление этим процессом.

## <a name="conclusion"></a>Заключение

Десятки тысяч организаций, включая почти все fortune 500, используют Office 365 для своих важных функций миссии. Они делают это безопасно, и они делают это через Интернет.

Независимо от того, какие цели безопасности у вас есть в игре, существуют способы их выполнения, которые не требуют vpn-подключений, прокси-серверов, TLS перерыв и проверки, или централизованный интернет-отступ, чтобы получить трафик пользователей от сети и на нашу как можно быстрее, что обеспечивает лучшую производительность, является ли ваша сеть штаб-квартирой компании удаленный офис или пользователь, работающий дома. Наше руководство основано на том, как Office 365 службы, а также для обеспечения безопасного и исполняемой работы пользователей.

## <a name="further-reading"></a>Дальнейшее чтение

[Принципы Office 365 подключения к сети](../enterprise/microsoft-365-network-connectivity-principles.md)

[URL-адреса и диапазоны IP-адресов для Office 365](../enterprise/urls-and-ip-address-ranges.md)

[Управление конечными точками Office 365](../enterprise/managing-office-365-endpoints.md)

[Веб-служба IP-адресов и URL-адресов в Office 365](../enterprise/microsoft-365-ip-web-service.md)

[Доступ к сетевому подключению Office 365](../enterprise/assessing-network-connectivity.md)

[Сеть Office 365 и настройка производительности](../enterprise/network-planning-and-performance.md)

[Оценка сетевого подключения к Office 365](../enterprise/assessing-network-connectivity.md)

[Настройка производительности Office 365 с помощью базовых показателей и журнала производительности](../enterprise/performance-tuning-using-baselines-and-history.md)

[План устранения проблем с производительностью Office 365](../enterprise/performance-troubleshooting-plan.md)

[Сети доставки содержимого](../enterprise/content-delivery-networks.md)

[Проверка подключения Microsoft 365](https://connectivity.office.com/)

[Как Майкрософт строит свою быструю и надежную глобальную сеть](https://azure.microsoft.com/blog/how-microsoft-builds-its-fast-and-reliable-global-network/)

[Блог, посвященный сетям для Office 365](https://techcommunity.microsoft.com/t5/office-365-networking/bd-p/Office365Networking)

[Office 365 подключения для удаленных пользователей с помощью раздельного туннеля VPN](../enterprise/microsoft-365-vpn-split-tunnel.md)