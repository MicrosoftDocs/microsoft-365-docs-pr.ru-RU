---
title: Сеть (в облако) — взгляд одного архитектора
description: Узнайте, как оптимизировать сеть для подключения к облаку, избегая самых распространенных ошибок.
ms.author: bcarter
author: brendacarter
manager: bcarter
ms.audience: ITPro
ms.topic: article
ms.prod: microsoft-365-enterprise
localization_priority: Normal
ms.collection:
- M365-identity-device-management
- M365-security-compliance
ms.custom: ''
f1.keywords: NOCSH
ms.openlocfilehash: 175903949b639740ad00b29013d5748b99bdb2de
ms.sourcegitcommit: ddfb4f3e34deb733e8625e845e4dfd1fcc066ceb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "49771851"
---
# <a name="networking-up-to-the-cloudone-architects-viewpoint"></a>Сеть (в облако) — взгляд одного архитектора

В этой статье [Ed Fisher](https://www.linkedin.com/in/edfisher/), Security & Compliance Architect at Microsoft, describes how to optimize your network for cloud connectivity by avoiding the most common pitfalls. 

## <a name="about-the-author"></a>Об авторе

![Фотография Ed Fisher](../media/solutions-architecture-center/ed-fisher-networking.jpg) 

В настоящее время я главный технический специалист в регионе На Востоке, где основное внимание уделяется обеспечению соответствия & безопасности. Я работал с клиентами, которые переходят на Office 365 в течение последних 10 лет. Я работал с небольшими магазинами с несколькими расположениями для правительственных учреждений и предприятий с миллионами пользователей, распределенных по всему миру, и многими другими клиентами между ними, большинство которых имеет десятки тысяч пользователей, несколько местоположений в различных частях мира, потребность в более высоком уровне безопасности и множество требований соответствия требованиям. Я помогли сотням предприятий и миллионам пользователей безопасно и безопасно перейти в облако.

В фоновом режиме за последние 25 лет, включая безопасность, инфраструктуру и сетевую инженерию, а также переместив двух моих предыдущих работников в Office 365 перед присоединением к Корпорации Майкрософт, я много раз был на стороне вашей таблицы и не помню, что это такое. Хотя ни один клиент не является одинаковым, у большинства из них одинаковые потребности, и при стандартизированной службе, такой как любая платформа SaaS или PaaS, оптимальные подходы обычно одинаковы.

## <a name="its-not-the-networkits-how-youre-misusing-it"></a>Это не сеть— вы (неправильно) используете ее!

Независимо от того, сколько раз это происходит,  мне никогда не удастся узнать, как творческие команды безопасности и сетевые команды пытаются получить, как они думаете, что они должны подключаться к облачным службам Майкрософт. Всегда существуют некоторые политики безопасности, стандарты соответствия требованиям или лучший способ, которыми они хотят пользоваться, не аясь участвовать в беседе о том, чего они пытаются достичь, и как это лучше, проще, эффективнее и эффективнее. 

When this sort of thing is escalated to me, I'm usually willing to take the challenge and walk them through the how's and the why's and get them to where they need to be. Но если я очень явная, мне нужно поделиться этим, иногда я хочу просто дать им возможность сделать то, что они будут делать, и вернуться, чтобы сказать, что я говорил вам, что когда они, наконец, укакую, не будет работать. Иногда мне может потребоваться сделать это, *но это не так.* Я хочу объяснить все, что я включу в эту публикацию. Независимо от вашей роли, если ваша организация хочет использовать облачные службы Майкрософт, вероятно, некоторые из них помогают вам.

## <a name="guiding-principles"></a>Принципы

Начнем с некоторых правил, которые мы здесь делаем. Мы обсудим, как безопасно подключаться к облачным службам, чтобы обеспечить минимальную сложность и максимальную производительность, сохраняя при этом реальную безопасность. Ни одно из последующих данных не противоречит ни одному из них, даже если вы или ваш клиент не сможете использовать ваш любимый прокси-сервер для всего.

- **То, что вы можете,** не означает, что вы должны : или перефразировать dr. Ian Malcolm из фильма Jurassic Park "... Да, да, но ваша группа безопасности была так занята вопросом о том, могут ли они перестать подумать, стоит ли".
- **Безопасность не означает сложность:** вы не более защищены только потому, что тратите больше денег, перенабежайте больше устройств или нажимаете дополнительные кнопки.
- **Доступ к Office 365** через Интернет: это не то же самое, что Office 365 Интернет. Это служба SaaS, которая управляется корпорацией Майкрософт и управляется вами. В отличие от веб-сайтов, которые вы посещаете в Интернете, вы можете заглянув за собой и применить средства контроля, необходимые для соответствия вашим политикам и стандартам соответствия требованиям, если вы понимаете, что несмотря на то, что вы можете выполнить свои цели, вам может потребоваться просто сделать их по-другому.
- **Неудачные** точки — это плохо, хорошо локализованные разрывы: всем всегда нужно вернуть весь интернет-трафик всех пользователей в центральную точку, обычно чтобы они могли отслеживать и применять политику, но часто так как это либо дешевле, чем подготовка доступа к Интернету во всех расположениях, либо это именно то, как они это делают. Но эти точки в точности такие... точки, в которых трафик находится в разных точках. Нет ничего неправильного в том, чтобы запретить пользователям просматривать видео с котами или видео с котами, но не обрабатывайте трафик критически важных бизнес-приложений таким же образом.
- Если **DNS-** и DNS-серверы не были довольны: лучшей сетью может быть неудовлетворительная DNS, будь то повторная рекурсия запросов к серверам в других регионах мира или с помощью DNS-серверов вашего isP или других общедоступных DNS-серверов, кэшющих сведения о разрешении DNS.
- **То,** что вы использовали это раньше, не означает, что теперь это следует сделать так: технологии постоянно меняются, и Office 365 не является исключением. Применение мер безопасности, разработанных и развернутых для локальной службы или для управления веб-трансляциями, не обеспечит тот же уровень безопасности и может существенно отрицательно сказаться на производительности.
- **Office 365 был создан** для доступа через Интернет: вот и все. Независимо от того, что вы хотите сделать между вашими пользователями и вашими краями, трафик по-прежнему проходит через Интернет, когда он покидает вашу сеть и до того, как попадает в нашу сеть. Даже если вы используете Azure ExpressRoute для направления трафика с определенной задержкой из сети непосредственно в нашу сеть, подключение к Интернету является абсолютно обязательной. Примите его. Не переумейте его.

## <a name="where-bad-choices-are-often-made"></a>В тех случаях, когда часто используются неудачные варианты выбора

Хотя существует множество мест, где во имя безопасности принимаются неудачные решения, я чаще всего сталкивался с клиентами. Во многих беседах с клиентами все эти беседы включаются одновременно.

### <a name="insufficient-resources-at-the-edge"></a>Недостаточно ресурсов на границе

Очень немногие клиенты развертывают среды greenfield, и у них есть много лет опыта работы пользователей и их интернет-доступа. Независимо от того, имеются ли у клиентов прокси-серверы или разрешается прямой доступ и просто исходящие трафик NAT, они делают это в течение многих лет и не рассматривают, сколько еще они будут переходить через свои границы при традиционном направлении внутренних приложений в облако.

Пропускная способность всегда является проблемой, но устройства NAT могут не иметь достаточной мощности для обработки увеличенной нагрузки и могут начать преждевременно закрывать подключения, чтобы освободить ресурсы. Большая часть клиентского программного обеспечения, подключаемого к Office 365, ожидает постоянных подключений, а пользователь, полностью использующий Office 365, может иметь 32 или более подключений одновременно. Если устройство NAT сбрасывает их раньше времени, эти приложения могут перестать на них оказаться невнимательными при попытке использовать подключения, которых там больше нет. Когда они отключаются и пытаются установить новые подключения, они создают еще больше нагрузки на сетевую шестеренку.

### <a name="localized-breakout"></a>Локализованный разрыв

Все остальное в этом списке сводится к одному — как можно быстрее при выходе из сети и нашего. Обратное перенаправляние трафика пользователей в центральную точку при откате, особенно если эта точка находится в другом регионе, чем ваши пользователи, представляет собой ненужную задержку и влияет как на скорость загрузки, так и на клиент. У корпорации Майкрософт есть точки присутствия во всем мире, а для всех наших служб и пиринга установлены  практически все основные интернет-клиенты, поэтому локальная маршрутка трафика пользователей гарантирует, что он быстро попадает в нашу сеть с минимальной задержкой.

### <a name="dns-resolution-traffic-should-follow-the-internet-egress-path"></a>Трафик разрешения DNS должен следовать пути интернет-трафика

Конечно, чтобы клиент находит любую конечную точку, он должен использовать DNS. DNS-серверы Майкрософт оценивают источник DNS-запросов, чтобы убедиться, что мы возвращаем ответ, ближе всего к источнику запроса в Интернете. Убедитесь, что DNS настроен таким образом, чтобы запросы на разрешение имен перейти по одному пути с трафиком пользователей, чтобы не дать им локальный выход, но в конечную точку в другом регионе. Это означает, что локальные DNS-серверы могут "перейти в корневой режим", а не перенаходить на DNS-серверы в удаленных центрах обработки данных. И следите за общедоступными и частными службами DNS, которые могут кэшаторить результаты из одной части мира и обслуживать их для запросов из других частей мира.

### <a name="to-proxy-or-not-to-proxy-that-is-the-question"></a>Для прокси-сервера или не для прокси-сервера, то есть вопрос

Одним из первых вещей, которые необходимо учитывать, является прокси-соединение пользователей с Office 365. Это просто; не прокси-сервер. Доступ к Office 365 можно получить через Интернет, но это не Интернет. Это расширение основных служб, которые следует рассматривать как таковые. Все, что может потребоваться прокси-серверу, например DLP, антивальное ПО или проверка содержимого, уже доступно в службе и может использоваться в масштабе без взлома подключений, зашифрованных по TLS. Но если вы действительно хотите прокси-трафик, который вы не можете иным образом контролировать, обратите внимание на наши рекомендации и категории [https://aka.ms/pnc](https://aka.ms/pnc) трафика в [https://aka.ms/ipaddrs](https://aka.ms/ipaddrs) . У нас есть три категории трафика для Office 365. Оптимизация и разрешение должны быть прямыми и обходить прокси-сервер. По умолчанию можно использовать прокси-режим. Подробные сведения в этих документы... прочитать их.

Большинство клиентов, которые хотят использовать прокси,, когда они фактически смотрят на то, что они делают, понимают, что когда клиент делает HTTP CONNECT-запрос к прокси-серверу, прокси-сервер теперь является дорогостоящим дополнительным маршрутизатором. Такие протоколы, как MAPI и RTC, не являются даже протоколами, которые понятны веб-прокси, поэтому даже при взломе TLS вы не получаете дополнительную безопасность. Вы *получаете* дополнительную задержку. Подробнее об этом см. в категориях "Оптимизация", "Разрешить" и "По умолчанию" для трафика [https://aka.ms/pnc](https://aka.ms/pnc) Microsoft 365.

Наконец, продумайте общее влияние на прокси-сервер и соответствующий ответ, чтобы справиться с этим влиянием. По мере того как через прокси-сервер делается все больше подключений, коэффициент масштабирования TCP может уменьшиться, чтобы не было необходимо буферизировать такой объем трафика. Я видел клиентов, у которых их прокси были настолько перегружены, что они использовали коэффициент масштабирования 0. Так как коэффициент масштабирования является экспоненциальным значением, и мы хотим использовать 8, каждое уменьшение значения коэффициента масштабирования оказывает огромное негативное влияние на пропускную способность.

Проверка TLS означает безопасность! Но не совсем! Многие клиенты с прокси-клиентами хотят использовать их для проверки всего трафика, а это означает, что TLS "разрывает и проверяет". При этом для веб-сайта, доступного по протоколу HTTPS (не учитывая вопросы конфиденциальности), прокси-серверу может потребоваться 10 или даже 20 одновременно потоков в течение нескольких сотен миллисекунд. При большой загрузке или, возможно, видео, одно или несколько таких подключений могут длиться намного дольше, но в целом большинство из этих подключений устанавливаются, передаются и очень быстро закрываются. При разрыве и проверке прокси-сервер должен в два раза увеличить время работы. Для каждого подключения от клиента к прокси-серверу прокси-сервер также должен сделать отдельное подключение к конечной точке. Таким образом, 1 становится 2, 2 становится 4, 32 становится 64...посмотрите, куда я иду? Возможно, вы правильно настроили размер прокси-решения для типичного веб-браузера, но при попытке сделать то же самое для клиентских подключений к Office 365 число одноваторных и длительных подключений может быть на порядок больше размера, чем было затрачено.

### <a name="streaming-isnt-important-except-that-it-is"></a>Потоковая передача не важна, за исключением того, что *она*

Единственными службами в Office 365, которые используют UDP, являются Skype (скоро будет отменено) и Microsoft Teams. Teams использует UDP для потокового трафика, включая звук, видео и общий доступ к презентациям. Потоковый трафик — это трансляция, например собрание по сети с голосовой и видеосвязи, а также демонстрационные ролики. Они используют UDP, так как если пакеты отброшены или поступают не по порядку, пользователь практически не может их найти, и поток может просто продолжать ходить.

Если вы не разрешаете исходящие UDP-трафик от клиентов в службу, они могут вернуться к использованию TCP. Но если пакет TCP  отброшен, все останавливается до истечения срока действия RTO и повторной передачи отсутствующих пакетов. Если пакет поступает не по порядку, все останавливается до тех пор, пока другие пакеты не будут поступать и не будут повторно собраны по порядку. Оба приводят к незначительным сбоям в звуке (помните " Max Headroom?") и видео (вы щелкнули что-то... слева, так оно и есть) и ведет к низкой производительности и плохому пользовательскому интерфейсу. И помните, что я поместил выше о прокси?. При принудительном использовании прокси-сервера клиентом Teams принудительно используется TCP. Итак, теперь вы дважды вызываете отрицательное влияние на производительность.

### <a name="split-tunneling-may-seem-scary"></a>Разделение туннелинга может показаться страсивным

Но это не так. Все подключения к Office 365 подключены по TLS. We have been offering TLS 1.2 for quite while now and will be disabling older versions soon because legacy clients still use them and that's a risk.

Принудительным подключением TLS (или 32 из них), чтобы перейти по VPN, прежде чем они перейдут в службу, безопасность не будет добавлена. Он добавляет задержку и снижает общую пропускную способность. В некоторых решениях VPN он даже заставляет UDP проходить через TCP, что снова будет отрицательно влиять на потоковый трафик. Кроме того, если вы не проводите проверку TLS, нет никаких недостатков. Очень распространенная тема среди клиентов, теперь, когда большинство их сотрудников являются удаленными, — это то, что они видят значительное влияние на пропускную способность и производительность, из-за того, что все пользователи подключаются через VPN вместо настройки раздельного туннелинга для доступа к конечным точкам [Office 365](https://docs.microsoft.com/microsoft-365/enterprise/microsoft-365-network-connectivity-principles#new-office-365-endpoint-categories)оптимизировать категорию.

Это простое решение для раздельного туннелинга, и его следует сделать. Для получения дополнительных данных обязательно просмотрите оптимизацию подключения Office 365 для удаленных пользователей, использующих [раздельное VPN-туннелинг.](https://docs.microsoft.com/microsoft-365/enterprise/microsoft-365-vpn-split-tunnel)

## <a name="the-sins-of-the-past"></a>The sins of the past

Во многих случаях причиной выбора является сочетание (1) не зная принципов работы службы, (2) попытка соблюдать политики компании, написанные перед принятием облака, и (3) группы безопасности, которым может быть непросто понять, что существует несколько способов достижения поставленных целей. Надеемся, что вышеперечисленные и ссылки ниже помогут в первом. Возможно, для того, чтобы выйти за секунду, может потребоваться спонсорская поддержка руководителей. Решение целей политик безопасности, а не их методов, помогает с третьей. От условного доступа к модерации содержимого, DLP до защиты информации, проверки конечных точек до угроз нулевого дня — любой конечной цели можно достичь разумной политики безопасности с помощью того, что доступно в Office 365, и без какой-либо зависимости от локальной сетевой шестеренки, принудительного VPN-туннеля и разрыва TLS и проверки.

В других случаях оборудование, которое было приобретено до начала перемещения организации в облако, просто не может быть масштабироваться для обработки новых шаблонов трафика и нагрузок. Если вам действительно необходимо перенаказать весь трафик через единую точку исходяния и/или прокси-сервер, будьте готовы к обновлению сетевого оборудования и пропускной способности соответствующим образом. Внимательно отслеживайте использование обеих технологий, так как это не уменьшится медленно по мере того, как будет двигаться больше пользователей. Все будет нормально до тех пор, пока не будет достигнута точка подкачиния, все будут терпеть убытки.

## <a name="exceptions-to-the-rules"></a>Исключения из правил

Если вашей организации требуются ограничения [клиента,](https://docs.microsoft.com/azure/active-directory/manage-apps/tenant-restrictions)необходимо использовать прокси-сервер с нарушением TLS и проверять принудительное использование определенного трафика через прокси-сервер, но вам не нужно принудительно использовать весь трафик через него.  Это не все или ничего не стоит, поэтому обратите внимание на то, что нужно изменить прокси-сервером.

Если вы собираетесь разрешить разделение туннелей, но также использовать прокси-сервер для общего веб-трафика, убедитесь, что файл PAC определяет, что должно проходить напрямую, а также как определить интересный трафик для того, что проходит через VPN-туннель. Мы предлагаем примеры PAC-файлов, которые [https://aka.ms/ipaddrs](https://aka.ms/ipaddrs) упростит управление этой возможностью.

## <a name="conclusion"></a>Заключение

Десятки тысяч организаций, включая почти все компании Из списка Списка 500, ежедневно используют Office 365 для своих критически важных функций. Они делают это безопасно и делают это через Интернет.

Независимо от того, какие цели безопасности у вас есть, существуют способы, которые не требуют VPN-подключений, прокси-серверов, разрыва TLS и проверки или централизованного интернет-трафика, чтобы как можно быстрее получить трафик пользователей от сети и на нашу сеть, что обеспечивает лучшую производительность, будь то главный офис компании или удаленный офис. , или этот пользователь, работающий дома. Наши рекомендации основаны на построении служб Office 365 и обеспечении безопасного и удобного пользовательского интерфейса.

## <a name="further-reading"></a>Дальнейшее чтение

[Принципы сетевого подключения Office 365](https://docs.microsoft.com/microsoft-365/enterprise/microsoft-365-network-connectivity-principles)

[URL-адреса и диапазоны IP-адресов для Office 365](https://docs.microsoft.com/microsoft-365/enterprise/urls-and-ip-address-ranges)

[Управление конечными точками Office 365](https://docs.microsoft.com/microsoft-365/enterprise/managing-office-365-endpoints)

[Веб-служба IP-адресов и URL-адресов в Office 365](https://docs.microsoft.com/microsoft-365/enterprise/microsoft-365-ip-web-service)

[Доступ к сетевому подключению Office 365](https://docs.microsoft.com/microsoft-365/enterprise/assessing-network-connectivity)

[Сеть Office 365 и настройка производительности](https://docs.microsoft.com/microsoft-365/enterprise/network-planning-and-performance)

[Оценка сетевого подключения к Office 365](https://docs.microsoft.com/microsoft-365/enterprise/assessing-network-connectivity)

[Настройка производительности Office 365 с помощью базовых показателей и журнала производительности](https://docs.microsoft.com/microsoft-365/enterprise/performance-tuning-using-baselines-and-history)

[План устранения проблем с производительностью Office 365](https://docs.microsoft.com/microsoft-365/enterprise/performance-troubleshooting-plan)

[Сети доставки содержимого](https://docs.microsoft.com/microsoft-365/enterprise/content-delivery-networks)

[Проверка подключения Microsoft 365](https://connectivity.office.com/)

[Как Майкрософт строит свою быструю и надежную глобальную сеть](https://azure.microsoft.com/blog/how-microsoft-builds-its-fast-and-reliable-global-network/)

[Блог, посвященный сетям для Office 365](https://techcommunity.microsoft.com/t5/office-365-networking/bd-p/Office365Networking)

[Подключение Office 365 для удаленных пользователей с помощью раздельного VPN-туннелинга](https://docs.microsoft.com/microsoft-365/enterprise/microsoft-365-vpn-split-tunnel)


