---
title: Ключ клиента для Microsoft 365 на уровне клиента (общедоступная предварительная версия)
ms.author: krowley
author: kccross
manager: laurawi
ms.date: 2/17/2021
audience: ITPro
ms.topic: article
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- MET150
ms.collection:
- M365-security-compliance
- m365solution-mip
- m365initiative-compliance
description: Узнайте, как настроить ключ клиента для всех данных в клиенте Microsoft 365.
ms.openlocfilehash: f50986b4e72808d4a1cd4dc8ee0182eb9c0a2455
ms.sourcegitcommit: 27b2b2e5c41934b918cac2c171556c45e36661bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "50922693"
---
# <a name="overview-of-customer-key-for-microsoft-365-at-the-tenant-level-public-preview"></a>Обзор ключа клиента для Microsoft 365 на уровне клиента (общедоступный предварительный просмотр)

Используя ключи, которые вы предоставляете, можно создать политику шифрования данных (DEP) и назначить ее клиенту. DeP шифрует данные в клиенте для этих рабочих нагрузок:

- Командные сообщения чата (1:1 чаты, групповые чаты, чаты собраний и беседы на канале)
- Teams media messages (images, code snippets, video messages, audio messages, wiki images)
- Записи вызовов и собраний teams, хранимые в хранилище Teams
- Уведомления чата teams
- Предложения чата teams от Cortana
- Сообщения о состоянии команд
- Сведения о пользователях и сигналах для Exchange Online
- Почтовые ящики Exchange Online, которые еще не зашифрованы dePs ключа клиента на уровне приложения

Для Microsoft Teams ключ клиента на уровне клиента шифрует новые данные с того времени, как deP назначен клиенту. Общедоступный предварительный просмотр не поддерживает шифрование прошлых данных. Для Exchange Online ключ клиента шифрует все существующие и новые данные.

Можно создать несколько DEP на клиента, но в любой момент можно назначить только один deP. При назначении deP шифрование начинается автоматически, но может занять некоторое время в зависимости от размера клиента.

## <a name="tenant-level-policies-add-broader-control-to-customer-key-for-microsoft-365"></a>Политики уровня клиента добавляют более широкий контроль в ключ клиента для Microsoft 365

Если у вас уже есть клиентский ключ для Exchange Online и Sharepoint Online, вот как вписывается новый общедоступный предварительный просмотр на уровне клиента.

Политика шифрования на уровне клиента, которая создается, шифрует все данные для рабочих нагрузок Microsoft Teams и Exchange Online в Microsoft 365. Однако для Exchange Online, если для отдельных почтовых ящиков уже назначены DEP-адреса ключей клиента, политика уровня клиента не переопределит эти dePs. Политика уровня клиента шифрует только почтовые ящики, которые уже не назначены deP клиентского ключа уровня почтовых ящиков.

Например, файлы Microsoft Teams и некоторые записи вызовов и собраний Teams, сохраненные в OneDrive для бизнеса и SharePoint, шифруются deP SharePoint Online. Один DEP SharePoint Online шифрует контент в одном гео.

## <a name="set-up-customer-key-at-the-tenant-level-public-preview"></a>Настройка ключа клиента на уровне клиента (общедоступный предварительный просмотр)

Эти действия аналогичны, но не совпадают с действиями по настройке клиентского ключа на уровне приложения. Этот общедоступный предварительный просмотр следует использовать только с тест-данными в тестовых клиентах. Не используйте этот выпуск с производственными данными или в производственной среде. Если у вас уже есть производственное развертывание клиентского ключа, используйте эти действия, чтобы настроить клиентский ключ на уровне клиента в тестовой среде. После присвоения клиенту deP уровня клиента вы можете начать процесс проверки и связаться с m365ck@microsoft.com вопросами или вопросами. Вы также можете найти документированные шаги проверки в общедоступный предварительный просмотр инструкций проверки для шифрования данных на отдыхе [для Microsoft 365](https://aka.ms/CustomerKey/PublicPreviewValidation).

Большинство этих задач можно выполнить, удаленно подключившись к Azure PowerShell. Для наилучших результатов используйте версию 4.4.0 или более поздней версии Azure PowerShell.

Перед началом работы убедитесь в следующем:

- Чтобы настроить клиентский ключ на уровне клиента, необходимо использовать учетную запись для работы или учебной учетной записи, которая имеет роль администратора соответствия требованиям.
- Убедитесь, что у вас есть соответствующее лицензирование для вашей организации. Используйте платную подписку Azure с Соглашение Enterprise или поставщика облачных служб. Подписки Azure, приобретенные с помощью планов Pay As You Go или с помощью кредитной карты, не поддерживаются для ключа клиента. С 1 апреля 2020 г. ключ клиента в Office 365 предлагается в Office 365 E5, M365 E5, M365 E5 Compliance и M365 E5 Information Protection & Governance SKUs. Office 365 Advanced Compliance SKU больше не доступен для получения новых лицензий. Существующие лицензии на расширенный соответствие Office 365 будут по-прежнему поддерживаться. Хотя служба может быть включена с как минимум одной лицензией под клиентом, который имеет соответствующую лицензию, необходимо убедиться, что все пользователи, пользующиеся услугами службы, имеют соответствующие лицензии.

### <a name="create-two-new-azure-subscriptions"></a>Создание двух новых подписок Azure

Ключ клиента требует двух ключей для каждой политики шифрования данных (DEP). Для этого необходимо создать две подписки Azure. В качестве наилучшей практики Корпорация Майкрософт рекомендует, чтобы отдельные члены организации настраивали один ключ в каждой подписке. Используйте эти подписки Azure только для администрирования ключей шифрования для Microsoft 365. Это защищает организацию, если один из операторов случайно, намеренно или злонамеренно удаляет или иным образом неправильно передает ключи, за которые они несут ответственность.

Практические ограничения на количество подписок Azure, которые можно создать для вашей организации, не ограничиваются. Следуя этой наилучшей практике, можно свести к минимуму влияние человеческой ошибки, помогая управлять ресурсами, используемыми клиентской клавишей.

### <a name="register-azure-subscriptions-to-use-a-mandatory-retention-period"></a>Регистрация подписки Azure для использования обязательного периода хранения

Временная или постоянная потеря ключей корневого шифрования может привести к нарушению работы службы или даже к катастрофическим последствиям, что может привести к потере данных. По этой причине ресурсы, используемые с ключом клиента, требуют сильной защиты. Все ресурсы Azure, используемые с помощью ключа клиента, предлагают механизмы защиты за пределами конфигурации по умолчанию. Подписки Azure могут быть помечены или зарегистрированы таким образом, чтобы предотвратить немедленную и невозвратную отмену. Это называется регистрацией на обязательный период хранения. Действия, необходимые для регистрации подписки Azure на обязательный период хранения, требуют совместной работы с Корпорацией Майкрософт. Этот процесс может занять до пяти бизнес-дней. Ранее это иногда называлось "Не отменять".
  
Прежде чем связаться с командой Microsoft 365, необходимо выполнить следующие действия для каждой подписки Azure, используемой с помощью клиентского ключа. Убедитесь, что перед запуском установлен модуль [Azure PowerShell Az.](/powershell/azure/new-azureps-module-az)

1. Во входе в Azure PowerShell. Инструкции см. в [документе Вход с Azure PowerShell.](/powershell/azure/authenticate-azureps)

2. Запустите Register-AzProviderFeature для регистрации подписок, чтобы использовать обязательный период хранения. Выполните это действие для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Register-AzProviderFeature -FeatureName mandatoryRetentionPeriodEnabled -ProviderNamespace Microsoft.Resources
   ```

3. Свяжитесь с Корпорацией Майкрософт, чтобы завершить процесс в [m365ck@microsoft.com.](mailto:m365ck@microsoft.com) Включите в электронную почту следующее:

   **Тема:** Ключ клиента для \<*Your tenant's fully-qualified domain name*\>

   **Body:** Подписные ID, для которых необходимо завершить обязательный период хранения.
   Выход Get-AzProviderFeature для каждой подписки.

   Соглашение об уровне обслуживания (SLA) для завершения этого процесса составляет пять бизнес-дней после уведомления (и проверки) Корпорации Майкрософт о том, что вы зарегистрировали подписки для использования обязательного периода хранения.

4. После получения уведомления от Корпорации Майкрософт о том, что регистрация завершена, проверьте состояние вашей регистрации, Get-AzProviderFeature команду следующим образом. В случае проверки Get-AzProviderFeature возвращает значение **Registered** for the **Registration State** property. Выполните это действие для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Get-AzProviderFeature -ProviderNamespace Microsoft.Resources -FeatureName mandatoryRetentionPeriodEnabled
   ```

5. Чтобы завершить процесс, выполните команду Register-AzResourceProvider. Выполните это действие для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Register-AzResourceProvider -ProviderNamespace Microsoft.KeyVault
   ```

### <a name="create-a-premium-azure-key-vault-in-each-subscription"></a>Создание хранилища ключей Azure премиум класса в каждой подписке

Действия по созданию хранилища ключей описаны в журнале [Getting Started with Azure Key Vault,](/azure/key-vault/general/overview)который поможет вам установить и запустить Azure PowerShell, подключиться к подписке Azure, создать группу ресурсов и создать хранилище ключей в этой группе ресурсов.
  
При создании хранилища ключей необходимо выбрать SKU: standard или Premium. Стандартный SKU позволяет защищать ключи хранилища ключей Azure с помощью программного обеспечения , не существует защиты ключей модуля безопасности оборудования (HSM), а SKU Premium позволяет использовать HSM для защиты ключей хранилища ключей. Ключ клиента принимает ключевые хранилища, которые используют либо SKU, но Корпорация Майкрософт настоятельно рекомендует использовать только SKU Premium. Стоимость операций с ключами обоих типов одна и та же, поэтому единственной разницей в стоимости является стоимость в месяц для каждого ключа, защищенного HSM. Подробные [сведения см. в расценки Key Vault.](https://azure.microsoft.com/pricing/details/key-vault/)
  
> [!IMPORTANT]
> Используйте хранилища ключей Премиум SKU и защищенные HSM-ключи для производственных данных и используйте только хранилища и ключи ключей standard SKU для тестирования и проверки.

Используйте общий префикс для ключевых сводов и включаем аббревиатура использования и области ключей и свода ключей. Например, для службы Contoso, где хранилища будут располагаться в Северной Америке, возможной парой имен являются Contoso-O365-NA-VaultA1 и Contoso-O365-NA-VaultA2. Имена Vault — это уникальные строки в Azure, поэтому вам может потребоваться попробовать варианты желаемых имен, если нужные имена уже заявлены другими клиентами Azure. После настройки имена хранилища не могут быть изменены, поэтому лучше всего иметь письменный план установки и использовать второго человека для проверки правильного выполнения плана.

По возможности создайте хранилища в непарных регионах. В парных регионах Azure обеспечивается высокая доступность для доменов сбоя службы. Поэтому региональные пары можно использовать как область резервного копирования друг друга. Это означает, что ресурс Azure, размещенный в одном регионе, автоматически получает переносимость ошибок через спаривную область. По этой причине выбор регионов для двух сводов, используемых в политике шифрования данных, где регионы сопряжены, означает, что используется только два региона доступности. В большинстве географических регионов только два региона, поэтому выбрать непарные регионы пока невозможно. По возможности выберите два непарных региона для двух сводов, используемых с политикой шифрования данных. Это дает в общей сложности четыре региона доступности. Дополнительные сведения см. в дополнительных сведениях о непрерывности бизнеса и аварийном восстановлении [(BCDR): Azure Paired Regions](/azure/best-practices-availability-paired-regions) для текущего списка региональных пар.

### <a name="assign-permissions-to-each-key-vault"></a>Назначение разрешений для каждого хранилища ключей

Для каждого хранилища ключей необходимо определить три отдельных набора разрешений для ключа клиента в зависимости от вашей реализации. Например, необходимо определить один набор разрешений для каждого из следующих ниже.
  
- **Администраторы ключей** хранилища, которые будут выполнять ежедневное управление вашим хранилищем ключей для вашей организации. Эти задачи включают резервное копирование, создание, получения, импорт, список и восстановление.

  > [!IMPORTANT]
  > Набор разрешений, присвоенных администраторам ключей хранилища, не включает разрешение на удаление ключей. Это является преднамеренной и важной практикой. Удаление ключей шифрования обычно не делается, так как это постоянно уничтожает данные. В качестве наилучшей практики не предоставлять это разрешение администраторам хранилища по умолчанию. Вместо этого зарезервировать это для ключевых участников хранилища и назначить его администратору только на краткосрочной основе после четкого понимания последствий.
  
  Чтобы назначить эти разрешения пользователю в организации, войдите в подписку Azure с помощью Azure PowerShell. Инструкции см. в [документе Вход с Azure PowerShell.](/powershell/azure/authenticate-azureps)

   Запустите Set-AzKeyVaultAccessPolicy, чтобы назначить необходимые разрешения.

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName <vault name> -UserPrincipalName <UPN of user> -PermissionsToKeys create,import,list,get,backup,restore
   ```

   Пример:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 -UserPrincipalName alice@contoso.com -PermissionsToKeys create,import,list,get,backup,restore
   ```

- **Ключевые вкладчики хранилища,** которые могут изменять разрешения в самом хранилище ключей Azure. Вам потребуется изменить эти разрешения по мере того, как сотрудники покидают или присоединяются к вашей команде, или в редких ситуациях, когда администраторам ключей хранилища на законных основаниях требуется разрешение на удаление или восстановление ключа. Этот набор ключевых участников хранилища должен быть предоставлен роль Contributor в вашем хранилище ключей. Эту роль можно назначить с помощью Azure Resource Manager. Подробные действия см. в [Role-Based Управление](/azure/active-directory/role-based-access-control-configure) доступом для управления доступом к ресурсам подписки Azure. Администратор, создавший подписку, имеет этот доступ по умолчанию и возможность назначать другим администраторам роль Автора.

- **Данные Microsoft 365 в службе шифрования** покоя, которая работает с ключом клиента на уровне клиента. Чтобы дать разрешение Microsoft 365, запустите кодлет **Set-AzKeyVaultAccessPolicy** с помощью следующего синтаксиса:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName <vault name> -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName <Microsoft 365 appID>
   ```

  Где:

  - *имя хранилища* — это имя созданного хранилища ключей.

  Пример: Для службы шифрования данных Microsoft 365 замените *приложение Microsoft 365 на*`c066d759-24ae-40e7-a56f-027002b5d3e4`

  ```powershell
  Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName c066d759-24ae-40e7-a56f-027002b5d3e4
  ```

### <a name="enable-and-then-confirm-soft-delete-on-your-key-vaults"></a>Включить и затем подтвердить мягкое удаление в хранилищах ключей

При быстром восстановлении ключей вероятность отключения расширенной службы будет меньше из-за случайного или злонамеренного удаления ключей. Включить эту конфигурацию, именуемую soft Delete, прежде чем использовать ключи с ключом клиента. Включение soft Delete позволяет восстановить ключи или хранилища в течение 90 дней после удаления, не восстанавливая их из резервного копирования.
  
Чтобы включить soft Delete в хранилищах ключей, выполните следующие действия:
  
1. Вопишите свою подписку Azure с помощью Windows PowerShell. Инструкции см. в [документе Вход с Azure PowerShell.](/powershell/azure/authenticate-azureps)

2. Запустите [кодлет Get-AzKeyVault.](/powershell/module/az.keyvault/get-azkeyvault) В этом примере *имя хранилища* — это имя хранилища ключей, для которого вы позволяете мягко удалять:

   ```powershell
   $v = Get-AzKeyVault -VaultName <vault name>
   $r = Get-AzResource -ResourceId $v.ResourceId
   $r.Properties | Add-Member -MemberType NoteProperty -Name enableSoftDelete -Value 'True'
   Set-AzResource -ResourceId $r.ResourceId -Properties $r.Properties
   ```

3. Подтвердите, что мягкое удаление настроено для хранилища ключей с помощью **cmdlet Get-AzKeyVault.** Если мягкое удаление настроено правильно для хранилища ключей, свойство _Soft Delete Enabled_ возвращает значение **True:**

   ```powershell
   Get-AzKeyVault -VaultName <vault name> | fl
   ```

### <a name="add-a-key-to-each-key-vault-either-by-creating-or-importing-a-key"></a>Добавление ключа в каждый хранилище ключей путем создания или импорта ключа

Существует два способа добавления ключей в хранилище ключей Azure; вы можете создать ключ непосредственно в Key Vault или импортировать ключ. Создание ключа непосредственно в Key Vault — это менее сложный метод, а импорт ключа обеспечивает полный контроль над тем, как создается ключ. Используйте клавиши RSA. Хранилище ключей Azure не поддерживает упаковку и разверивание с помощью ключей эллиптической кривой.
  
Чтобы создать ключ непосредственно в хранилище ключей, выполните [кодлет Add-AzKeyVaultKey](/powershell/module/az.keyvault/add-azkeyvaultkey) следующим образом:
  
```powershell
Add-AzKeyVaultKey -VaultName <vault name> -Name <key name> -Destination <HSM|Software> -KeyOps wrapKey,unwrapKey
```

Где:

- *имя хранилища* — это имя хранилища ключей, в котором необходимо создать ключ.

- *ключевое* имя — это имя, которое необходимо дать новому ключу.

  > [!TIP]
  > Клавиши имен, использующие аналогичную конвенцию именования, как описано выше, для ключевых сводов. Таким образом, в средствах, которые показывают только имя ключа, строка самоохвативна.
  
Если вы собираетесь защищать ключ с помощью HSM, убедитесь, что вы указываете **HSM** как значение параметра _Destination,_ в противном случае укажите **программное обеспечение.**

Пример.
  
```powershell
Add-AzKeyVaultKey -VaultName Contoso-O365EX-NA-VaultA1 -Name Contoso-O365EX-NA-VaultA1-Key001 -Destination HSM -KeyOps wrapKey,unwrapKey
```

### <a name="check-the-recovery-level-of-your-keys"></a>Проверьте уровень восстановления ключей

Microsoft 365 требует, чтобы подписка На хранилище ключей Azure была установлена подписка "Не отменяйте", а ключи, используемые клиентской клавишей, имеют возможность мягкого удаления. Вы можете подтвердить это, посмотрев на уровень восстановления на клавишах.
  
Чтобы проверить уровень восстановления ключа, в Azure PowerShell выполните Get-AzKeyVaultKey следующим образом:
  
```powershell
(Get-AzKeyVaultKey -VaultName <vault name> -Name <key name>).Attributes
```

Если свойство _Уровня_ восстановления возвращает что-либо, кроме значения **Recoverable+ProtectedSubscription,** вам потребуется просмотреть эту статью и убедиться, что вы следовали всем шагам, чтобы поместить подписку в список "Не отменять", и чтобы вы включили "мягкое удаление" на каждом из ключевых сводов. Далее отправьте скриншот вывода электронной почты в `(Get-AzKeyVaultKey -VaultName <vault name> -Name <key name>).Attributes` m365ck@microsoft.com.

### <a name="back-up-azure-key-vault"></a>Back up Azure Key Vault

Сразу после создания или изменения клавиши выполните резервное копирование и храните копии резервного копирования как в Интернете, так и в автономном режиме. Не подключайте автономные копии к какой-либо сети. Вместо этого храните их в физическом безопасном или коммерческом хранилище. По крайней мере одна копия резервного копирования должна храниться в месте, которое будет доступно в случае аварии. Blobs резервного копирования являются единственным средством восстановления ключевого материала в случае, если ключ Key Vault будет окончательно уничтожен или иным образом неоперабельным. Ключи, внешние для хранилища ключей Azure и импортируемые в Хранилище ключей Azure, не имеют права на резервное копирование, так как метаданные, необходимые для использования ключа клиента, не существуют с внешним ключом. Только резервная копия, взятая из хранилища ключей Azure, может использоваться для восстановления операций с ключом клиента. Поэтому необходимо создать резервную копию хранилища ключей Azure после отправки или создания ключа.
  
Чтобы создать резервную копию ключа Azure Key Vault, выполните кодлет [Backup-AzKeyVaultKey](/powershell/module/az.keyvault/backup-azkeyvaultkey) следующим образом:

```powershell
Backup-AzKeyVaultKey -VaultName <vault name> -Name <key name>
-OutputFile <filename.backup>
```

Убедитесь, что в файле вывода используется `.backup` суффикс.
  
Файл вывода, выдающийся из этого комлета, шифруется и не может использоваться за пределами хранилища ключей Azure. Резервное копирование может быть восстановлено только в подписке Azure, из которой была взята резервная копия.
  
Пример:
  
```powershell
Backup-AzKeyVaultKey -VaultName Contoso-O365EX-NA-VaultA1 -Name Contoso-O365EX-NA-VaultA1-Key001 -OutputFile Contoso-O365EX-NA-VaultA1-Key001-Backup-20170802.backup
```

### <a name="validate-azure-key-vault-configuration-settings"></a>Проверка параметров конфигурации хранилища ключей Azure

Выполнение проверки перед использованием ключей в DEP является необязательным, но настоятельно рекомендуется. В частности, при настройке ключей и сводов, помимо описанных в этой теме, необходимо проверить состояние ресурсов Хранилища ключей Azure перед настройкой ключа клиента.
  
Чтобы убедиться, что ваши ключи получили, wrapKey и unwrapKey операции включены:
  
Выполните [этот кодлет Get-AzKeyVault](/powershell/module/az.keyvault/get-azkeyvault) следующим образом:
  
```powershell
Get-AzKeyVault -VaultName <vault name>
```

В выходной записи см. соответствующую политику доступа и ID приложения Microsoft 365 (GUID). Все три операции, get, wrapKey и unwrapKey, должны быть показаны в статье Permissions to Keys.
  
Если конфигурация политики доступа неверна, выполните Set-AzKeyVaultAccessPolicy следующим образом:
  
```powershell
Set-AzKeyVaultAccessPolicy -VaultName <vault name> -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName <Microsoft 365 appID>
```

Пример: Для службы шифрования данных Microsoft 365 замените *приложение Microsoft 365 на*`c066d759-24ae-40e7-a56f-027002b5d3e4`

  ```powershell
  Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName c066d759-24ae-40e7-a56f-027002b5d3e4
  ```

Чтобы убедиться в том, что срок действия ключей не установлен, выполните кодлет [Get-AzKeyVaultKey](/powershell/module/az.keyvault/get-azkeyvault) следующим образом:
  
```powershell
Get-AzKeyVaultKey -VaultName <vault name>
```

Ключ с истекшим сроком действия не может использоваться ключом клиента, и операции с истекшим ключом сбой и, возможно, приведет к сбой в работе службы. Настоятельно рекомендуется, чтобы у ключей клиента не было срока действия. Дата истечения срока действия после набора не может быть удалена, но может быть изменена на другую дату. Если необходимо использовать ключ с набором сроков действия, измените значение срока действия на 12/31/9999. Ключи с истечением срока действия, задав дату, за исключением 12/31/9999, не будут проходить проверку Microsoft 365.
  
Чтобы изменить срок действия, установленный для любого значения, кроме 12/31/9999, выполните кодлет [Update-AzKeyVaultKey](/powershell/module/az.keyvault/update-azkeyvaultkey) следующим образом:
  
```powershell
Update-AzKeyVaultKey -VaultName <vault name> -Name <key name> -Expires (Get-Date -Date "12/31/9999")
```

### <a name="obtain-the-uri-for-each-azure-key-vault-key"></a>Получение URI для каждого ключа Azure Key Vault

После завершения всех действий в Azure, чтобы настроить хранилища ключей и добавить ключи, запустите следующую команду, чтобы получить URI для ключа в каждом хранилище ключей. Эти URL-адреса необходимо использовать при создании и назначении каждого deP позже, поэтому сохраните эти сведения в безопасном месте. Не забудьте выполнить эту команду один раз для каждого хранилища ключей.
  
В Azure PowerShell:
  
```powershell
(Get-AzKeyVaultKey -VaultName <vault name>).Id
```

## <a name="set-up-the-customer-key-encryption-policy-for-your-tenant"></a>Настройка политики шифрования ключа клиента для клиента

Для запуска этих кодлетов необходимо получить соответствующие разрешения. Хотя в этой статье перечислены все параметры для этих параметров, вы можете не иметь доступа к некоторым параметрам, если они не включены в назначенное вам разрешение. Сведения о необходимых разрешениях для запуска командлетов и использования параметров в организации см. в статье [Find the permissions required to run any Exchange cmdlet](/powershell/exchange/exchange-server/find-exchange-cmdlet-permissions).

### <a name="create-policy"></a>Создание политики

```powershell
   New-M365DataAtRestEncryptionPolicy [-Name] <String> -AzureKeyIDs <MultiValuedProperty> [-Description <String>]
```

Описание. Включить администратора соответствия требованиям для создания новой политики шифрования данных (DEP) с помощью двух корневых ключей AKV. После создания политика может быть назначена с помощью Set-M365DataAtRestEncryptionPolicyAssignment. При первом назначении ключей или после поворота клавиш может занять до 24 часов, чтобы новые ключи вступили в силу. Если новый deP вступает в силу более 24 часов, обратитесь в Корпорацию Майкрософт.

Пример.

```powershell
New-M365DataAtRestEncryptionPolicy -Name "Default_Policy" -AzureKeyIDs "https://contosoWestUSvault01.vault.azure.net/keys/Key_01","https://contosoEastUSvault01.vault.azure.net/keys/Key_02" -Description "Tenant default policy"
```

Параметры:

| Имя | Описание | Необязательный (Y/N) |
|----------|----------|---------|
|Имя|Удобное имя политики шифрования данных|N|
|AzureKeyIDs|Указывает два значения URI ключей хранилища Azure, разделенных запятой, для связи с политикой шифрования данных|N|
|Описание|Описание политики шифрования данных|N|

### <a name="assign-policy"></a>Назначение политики

```powershell
Set-M365DataAtRestEncryptionPolicyAssignment -DataEncryptionPolicy "<Default_PolicyName or Default_PolicyID>"
```

Описание. Этот комлет используется для настройки политики шифрования данных по умолчанию. Эта политика будет использоваться для шифрования данных во всех рабочих нагрузках поддержки. 

Пример.

```powershell
Set-M365DataAtRestEncryptionPolicyAssignment -DataEncryptionPolicy "Default_PolicyName"
```

Параметры:

| Имя | Описание | Необязательный (Y/N) |
|----------|----------|---------|
-DataEncryptionPolicy|Указывает политику шифрования данных, которая должна быть назначена; укажите имя политики или ИД политики.|N|

### <a name="modify-or-refresh-policy"></a>Изменение или обновление политики

```powershell
Set-M365DataAtRestEncryptionPolicy [-Identity] <M365DataAtRestEncryptionPolicy DataEncryptionPolicyIdParameter> -Refresh [-Enabled <Boolean>] [-Name <String>] [-Description <String>]
```

Описание. Этот комлет можно использовать для изменения или обновления существующей политики. Он также может использоваться для включить или отключить политику. При первом назначении ключей или после поворота клавиш может занять до 24 часов, чтобы новые ключи вступили в силу. Если новый deP вступает в силу более 24 часов, обратитесь в Корпорацию Майкрософт.

Примеры:

Отключить политику шифрования данных.

```powershell
Set-M365DataAtRestEncryptionPolicy -Identity "NAM Policy" -Enabled $false
```

Обновление политики шифрования данных.

```powershell
Set-M365DataAtRestEncryptionPolicy -Identity "EUR Policy" -Refresh
```

Параметры:

| Имя | Описание | Необязательный (Y/N) |
|----------|----------|---------|
|-Identity|Указывает политику шифрования данных, которую необходимо изменить.|N|
|-Обновление|Используйте переключатель "Обновление", чтобы обновить политику шифрования данных после поворота всех связанных ключей в хранилище ключей Azure. С этим параметром не нужно указывать значение.|Да|
|-Enabled|Параметр Включен включает или отключит политику шифрования данных. Перед отключением политики необходимо отогнать ее от клиента. Допустимые значения:</br > $true: политика включена</br > $true. Политика включена. Это значение задается по умолчанию.
|Да|
|– Name|Параметр Name задает уникальное имя политики шифрования данных.|Да|
|-Description|Параметр Description задает необязательное описание политики шифрования данных.|Да|

### <a name="get-policy-details"></a>Сведения о политике

```powershell
Get-M365DataAtRestEncryptionPolicy [-Identity] <M365DataAtRestEncryptionPolicy DataEncryptionPolicyIdParameter>
```

Описание. В этом списке перечислены все политики шифрования M365DataAtRest, созданные для клиента, или сведения о конкретной политике.

Примеры:

В этом примере возвращается сводный список политик шифрования M365DatAtRest в организации.

```powershell
Get-M365DataAtRestEncryptionPolicy
```

В этом примере возвращается подробная информация для политики шифрования данных с именем "Политика NAM".

```powershell
Get-M365DataAtRestEncryptionPolicy -Identity "NAM Policy"
```

Параметры:

| Имя | Описание | Необязательный (Y/N) |
|----------|----------|---------|
|-Identity|Указывает политику шифрования данных, для которую необходимо перечислить сведения.|Да|

### <a name="get-policy-assignment-info"></a>Сведения о назначении политики

```powershell
Get-M365DataAtRestEncryptionPolicyAssignment
```

Описание. В этом списке указана политика, назначенная в настоящее время клиенту.

## <a name="offboarding-from-customer-key"></a>Отключение от ключа клиента

Если вам нужно вернуться к клавишам с управлением Майкрософт, вы можете. При отключении данные повторно шифруются с помощью шифрования по умолчанию, поддерживаемого каждой отдельной рабочей нагрузкой. Например, Exchange Online поддерживает шифрование по умолчанию с помощью ключей, управляемых Корпорацией Майкрософт.

Если вы решили отключить клиента из клиентского ключа на уровне клиента, обратись в Корпорацию Майкрософт с просьбой по электронной почте "отключить" службу для клиента в [m365ck@microsoft.com](mailto:m365ck@microsoft.com).

> [!IMPORTANT]
> Offboarding — это не то же самое, что очистка данных. Очистка данных навсегда удаляет данные вашей организации из Microsoft 365, отключение не происходит. Вы не можете выполнить очистку данных для политики уровня клиента. Сведения о пути очистки данных см. в ссылке [Revoke your keys and start the data purge path process.](customer-key-manage.md#revoke-your-keys-and-start-the-data-purge-path-process)

## <a name="about-the-availability-key"></a>О ключе доступности

Сведения о ключе доступности см. в [сведениях о ключе доступности.](customer-key-availability-key-understand.md)

## <a name="key-rotation"></a>Поворот ключей

Сведения о вращающихся или прокатных клавишах, используемых с ключом клиента, см. в журнале [Roll or rotate a Customer Key or an availability key.](customer-key-availability-key-roll.md) При обновлении deP для использования новой версии ключей вы запустите Set-M365DataAtRestEncryptionPolicy, как описано выше в этой статье.

## <a name="related-articles"></a>Связанные статьи:

- [Шифрование службы с помощью ключа клиента](customer-key-overview.md)

- [Смена или ротация ключа клиента или ключа доступности](customer-key-availability-key-roll.md)

- [Узнайте о ключе доступности](customer-key-availability-key-understand.md)

- [Шифрование служб](office-365-service-encryption.md)