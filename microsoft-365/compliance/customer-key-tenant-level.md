---
title: Ключ клиента для Microsoft 365 на уровне клиента (предварительная версия)
ms.author: krowley
author: kccross
manager: laurawi
ms.date: 12/17/2020
audience: ITPro
ms.topic: article
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- MET150
ms.collection:
- M365-security-compliance
- m365solution-mip
- m365initiative-compliance
description: Узнайте, как настроить ключ клиента для всех данных в клиенте Microsoft 365.
ms.openlocfilehash: eedf0e8c9d56131016bc798af8ae471df3005bdc
ms.sourcegitcommit: 0867495cb02d0b38b439b16bdce97e6eda483ba9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/18/2020
ms.locfileid: "49712533"
---
# <a name="overview-of-customer-key-for-microsoft-365-at-the-tenant-level-public-preview"></a>Обзор ключа клиента для Microsoft 365 на уровне клиента (общая предварительная версия)

Используя ключи, вы можете создать политику шифрования данных (DEP) и назначить ее арендатору. DEP шифрует данные в клиенте для этих рабочих нагрузок:

- Сообщения чата Teams (чаты 1:1, групповые чаты, чаты собраний и беседы в каналах)
- Сообщения мультимедиа Teams (изображения, фрагменты кода, видео, вики-изображения)
- Записи вызовов и собраний Teams, хранимые в хранилище Teams
- Уведомления чата Teams
- Предложения в чате Teams от Кортаны
- Сообщения о состоянии Teams
- Сведения о пользователях и сигналах для Exchange Online

В Microsoft Teams ключ клиента на уровне клиента шифрует новые данные с того времени, когда DEP назначен клиенту. Общедоступный предварительный просмотр не поддерживает шифрование прошлых данных. В Exchange Online ключ клиента шифрует все существующие и новые данные.

Вы можете создать несколько DEP для каждого клиента, но в любой момент времени можно назначить только одну DEP. При назначении DEP шифрование начинается автоматически, но может занять некоторое время в зависимости от размера клиента.

## <a name="tenant-level-policies-add-broader-control-to-customer-key-for-microsoft-365"></a>Политики на уровне клиента добавляют более широкий контроль в ключ клиента для Microsoft 365

Если вы уже настроили ключ клиента для Exchange Online и Sharepoint Online, вот как подходит новая предварительная версия на уровне клиента.

Создаемая политика шифрования на уровне клиента шифрует все данные для рабочих нагрузок Microsoft Teams и Exchange Online в Microsoft 365. Эта политика не мешает точно настроенным DEP, уже созданным в ключе клиента.

Примеры:

Файлы Microsoft Teams и некоторые записи вызовов и собраний Teams, сохраненные в OneDrive для бизнеса и SharePoint, шифруются deP в SharePoint Online. Один deP в SharePoint Online шифрует контент в одном географическом области. DeP на уровне клиента снова зашифрует зашифрованные данные с помощью новой политики.

Для Exchange Online можно создать DEP, который шифрует один или несколько почтовых ящиков пользователей с помощью ключа клиента. При создании политики на уровне клиента эта политика не шифрует зашифрованные почтовые ящики. Однако ключ на уровне клиента шифрует почтовые ящики, на которые не влияет DEP.

## <a name="set-up-customer-key-at-the-tenant-level-public-preview"></a>Настройка ключа клиента на уровне клиента (общедоступный предварительный просмотр)

Эти действия похожи, но не идентичны шагам по настройке ключа клиента на уровне приложения. Этот общедоступный предварительный просмотр следует использовать только с тестовой версией в тестовых клиентах. Не используйте этот выпуск с производственными данными или в производственной среде. Если у вас уже есть производственное развертывание ключа клиента, с помощью этих действий можно настроить ключ клиента на уровне клиента в тестовой среде.

Большинство этих задач можно выполнить с помощью удаленного подключения к Azure PowerShell. Для наилучших результатов используйте Azure PowerShell версии 4.4.0 или более поздней.

Перед началом работы убедитесь в следующем:

- Чтобы настроить ключ клиента на уровне клиента, необходимо использовать учетную запись для работы или учебного заведения с ролью администратора соответствия требованиям.
- Убедитесь, что у вас есть соответствующее лицензирование для вашей организации. Используйте платную подписку Azure, выставленную с помощью Соглашение Enterprise или поставщика облачных служб. Подписки Azure, приобретенные с помощью планов Оплата по мере использования или с помощью кредитной карты, не поддерживаются для ключа клиента. С 1 апреля 2020 г. ключ клиента в Office 365 предлагается в office 365 E5, M365 E5, M365 E5 Compliance и M365 E5 Information Protection & Governance SKUs. Office 365 Advanced Compliance SKU больше не доступен для получения новых лицензий. Существующие лицензии Office 365 Advanced Compliance по-прежнему будут поддерживаться. Хотя службу можно включить как минимум с одной лицензией в клиенте с соответствующей лицензией, необходимо убедиться, что все пользователи, которые получают преимущества от этой службы, имеют соответствующие лицензии. Вам потребуется одна из следующих лицензий:

### <a name="create-two-new-azure-subscriptions"></a>Создание двух новых подписок Azure

Для ключа клиента требуются два ключа для каждой политики шифрования данных (DEP). Для этого необходимо создать две подписки Azure. Рекомендуется, чтобы у вас были отдельные члены вашей организации, которые могут настраивать один ключ в каждой подписке. Используйте только эти подписки Azure для администрирования ключей шифрования для Microsoft 365. Это защищает организацию на случай, если один из ваших операторов случайно, намеренно или злонамеренно удалит или неправильно укатит ключи, за которые они отвечают.

На практике нет ограничений на количество подписок Azure, которые можно создать для вашей организации. Следуя этой методике, вы сможете свести к минимуму влияние человеческих ошибок, а также управлять ресурсами, используемыми ключом клиента.

### <a name="register-azure-subscriptions-to-use-a-mandatory-retention-period"></a>Регистрация подписок Azure для использования обязательного периода хранения

Временная или постоянная потеря корневых ключей шифрования может нарушить работу службы или даже привести к катастрофическому сбою и потере данных. По этой причине ресурсы, используемые с ключом клиента, требуют сильной защиты. Все ресурсы Azure, используемые с ключом клиента, предлагают механизмы защиты за пределами конфигурации по умолчанию. Подписки Azure можно пометить или зарегистрировать таким образом, чтобы предотвратить немедленную и неупроверяемую отмену. Это называется регистрацией на обязательный период хранения. Действия, необходимые для регистрации подписок Azure на обязательный период хранения, требуют совместной работы с корпорацией Майкрософт. Этот процесс может занять до пяти дней. Раньше это иногда называлось "Не отменять".
  
Перед связью с командой Microsoft 365 необходимо выполнить следующие действия для каждой подписки Azure, которая используется с ключом клиента. Перед началом установки убедитесь, что у вас установлен модуль [Azure PowerShell Az.](https://docs.microsoft.com/powershell/azure/new-azureps-module-az)

1. Во входе с помощью Azure PowerShell. Инструкции см. в [документе "Вход с помощью Azure PowerShell".](https://docs.microsoft.com/powershell/azure/authenticate-azureps)

2. Запустите Register-AzProviderFeature, чтобы зарегистрировать подписки, чтобы использовать обязательный период хранения. Выполните это действие для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Register-AzProviderFeature -FeatureName mandatoryRetentionPeriodEnabled -ProviderNamespace Microsoft.Resources
   ```

3. Обратитесь в корпорацию Майкрософт, чтобы завершить процесс по [m365ck@microsoft.com.](mailto:m365ck@microsoft.com) Включите в сообщение электронной почты следующее:

   **Тема:** ключ клиента для \<*Your tenant's fully-qualified domain name*\>

   **Body**: Subscription IDs for which you want to have the mandatory retention period finalized.
   Выходные данные Get-AzProviderFeature для каждой подписки.

   Соглашение об уровне обслуживания (SLA) для завершения этого процесса составляет пять бизнес-дней после уведомления (и проверки) корпорации Майкрософт о том, что вы зарегистрировали подписки на использование обязательного периода хранения.

4. После получения уведомления от корпорации Майкрософт о том, что регистрация завершена, проверьте состояние регистрации, вы выполните команду Get-AzProviderFeature следующим образом. Если проверка подтверждена, Get-AzProviderFeature возвращает значение **Registered для** свойства **Registration State.** Выполните это действие для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Get-AzProviderFeature -ProviderNamespace Microsoft.Resources -FeatureName mandatoryRetentionPeriodEnabled
   ```

5. Чтобы завершить процесс, выполните команду Register-AzResourceProvider. Выполните это действие для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Register-AzResourceProvider -ProviderNamespace Microsoft.KeyVault
   ```

### <a name="create-a-premium-azure-key-vault-in-each-subscription"></a>Создание хранилища Azure Key Vault премиум-класса в каждой подписке

Действия по созданию хранилища ключей описаны в руководстве "Начало работы с [Azure Key Vault",](https://azure.microsoft.com/documentation/articles/key-vault-get-started/)в котором описана установка и запуск Azure PowerShell, подключение к подписке Azure, создание группы ресурсов и создание хранилища ключей в этой группе ресурсов.
  
При создании хранилища ключей необходимо выбрать SKU: Standard или Premium. Стандартный SKU позволяет защитить ключи Azure Key Vault программным обеспечением без защиты ключей аппаратного модуля безопасности (HSM), а SKU Premium позволяет использовать HSM для защиты ключей Key Vault. Ключ клиента принимает хранилища ключей, которые используют любой SKU, хотя Корпорация Майкрософт настоятельно рекомендует использовать только SKU Premium. Затраты на операции с ключами обоих типов одинаковы, поэтому единственное различие в стоимости — это стоимость каждого ключа, защищенного с помощью HSM. Подробные [сведения см. в ценах Key Vault.](https://azure.microsoft.com/pricing/details/key-vault/)
  
> [!IMPORTANT]
> Используйте хранилища ключей SKU Premium и ключи, защищенные HSM, для производственных данных и используйте только стандартные хранилища ключей SKU и ключи для тестирования и проверки.

Используйте общий префикс для хранилищ ключей и включаем аббревиатуру использования и область использования хранилища ключей и ключей. Например, для службы Contoso, где хранилища будут расположены в Северной Америке, возможной парой имен является Contoso-O365-NA-VaultA1 и Contoso-O365-NA-VaultA2. Имена хранилищ — это глобальные уникальные строки в Azure, поэтому вам может потребоваться попробовать варианты нужных имен, если нужные имена уже затверяются другими клиентами Azure. После настройки имена хранилищ нельзя изменить, поэтому лучше иметь письменный план установки и использовать второго человека для проверки правильности выполнения плана.

По возможности создайте хранилища в непарных регионах. Парные регионы Azure обеспечивают высокую доступность в доменах сбоев служб. Таким образом, региональные пары можно использовать в качестве резервной области друг друга. Это означает, что ресурс Azure, размещенный в одном регионе, автоматически получает сбой в парной области. По этой причине выбор областей для двух хранилищ, используемых в политике шифрования данных, где эти регионы сопряжены, означает, что используется всего два региона доступности. В большинстве географических регионов есть только две области, поэтому выбрать непарные регионы пока невозможно. По возможности выберите две непарные области для двух хранилищ, используемых с политикой шифрования данных. Это дает преимущества из четырех областей доступности. Дополнительные сведения см. в списке "Непрерывность бизнеса и аварийное [восстановление" (BCDR). Парные](https://docs.microsoft.com/azure/best-practices-availability-paired-regions) регионы Azure для текущего списка региональных пар.

### <a name="assign-permissions-to-each-key-vault"></a>Назначение разрешений каждому хранилищу ключей

Для каждого хранилища ключей необходимо определить три отдельных набора разрешений для ключа клиента в зависимости от вашей реализации. Например, необходимо определить один набор разрешений для каждого из следующих ок.
  
- **Администраторы хранилища ключей,** которые будут выполнять ежедневное управление хранилищем ключей для вашей организации. К этим задачам относятся резервное копирование, создание, get, импорт, список и восстановление.

  > [!IMPORTANT]
  > Набор разрешений, присвоенный администраторам хранилищ ключей, не включает разрешение на удаление ключей. Это сделано намеренно и важно. Удаление ключей шифрования обычно не делается, так как это окончательно уничтожает данные. По умолчанию не делайте этого разрешения администраторам хранилища ключей. Вместо этого следует зарезервировать это для участников хранилища ключей и назначить его администратору только на короткое время, только когда будет понято четкое понимание последствий.
  
  Чтобы назначить эти разрешения пользователю в организации, войдите в свою подписку Azure с помощью Azure PowerShell. Инструкции см. в [документе "Вход с помощью Azure PowerShell".](https://docs.microsoft.com/powershell/azure/authenticate-azureps)

   Запустите Set-AzKeyVaultAccessPolicy, чтобы назначить необходимые разрешения.

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName <vault name> -UserPrincipalName <UPN of user> -PermissionsToKeys create,import,list,get,backup,restore
   ```

   Пример:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 -UserPrincipalName alice@contoso.com -PermissionsToKeys create,import,list,get,backup,restore
   ```

- **Участники хранилища ключей,** которые могут изменять разрешения для самого хранилища Ключей Azure. Вам потребуется изменить эти разрешения по мере того, как сотрудники уйдут из группы или присоединятся к ней, или в редких случаях, когда администраторам хранилища ключей действительно требуется разрешение на удаление или восстановление ключа. Этому набору участников хранилища ключей необходимо предоставить роль "Участник" в хранилище ключей. Эту роль можно назначить с помощью Azure Resource Manager. Дополнительные сведения см. в Role-Based [управления доступом](https://docs.microsoft.com/azure/active-directory/role-based-access-control-configure) для управления доступом к ресурсам подписки Azure. Администратор, создавший подписку, имеет такой доступ по умолчанию и возможность назначать роли участника другим администраторам.

- Служба шифрования неанимных данных **Microsoft 365,** которая работает с ключом клиента на уровне клиента. Чтобы предоставить разрешение на доступ к  Microsoft 365, запустите следующий синтаксис:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName <vault name> -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName <Microsoft 365 appID>
   ```

  Где:

  - *имя хранилища* — это имя созданного хранилища ключей.

  Пример. Для службы шифрования данных Microsoft 365 в rest замените  *appID Microsoft 365* на `c066d759-24ae-40e7-a56f-027002b5d3e4`

  ```powershell
  Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName c066d759-24ae-40e7-a56f-027002b5d3e4
  ```

### <a name="enable-and-then-confirm-soft-delete-on-your-key-vaults"></a>Включить и подтвердить возможность мягкого удаления в хранилищах ключей

Если вы сможете быстро восстановить ключи, вы с меньшей вероятностью будете испытывать расширенный с выход из-за случайного или злонамеренного удаления ключей. Прежде чем использовать ключи с ключом клиента, в этой конфигурации необходимо включить эту конфигурацию, которая называется "Мягкое удаление". Включение функции soft Delete позволяет восстанавливать ключи или хранилища в течение 90 дней после удаления без необходимости восстановления их из резервной копии.
  
Чтобы включить soft Delete в хранилищах ключей, выполните следующие действия:
  
1. Sign in to your Azure subscription with Windows PowerShell. Инструкции см. в [документе "Вход с помощью Azure PowerShell".](https://docs.microsoft.com/powershell/azure/authenticate-azureps)

2. Запустите [cmdlet Get-AzKeyVault.](https://docs.microsoft.com/powershell/module/az.keyvault/get-azkeyvault) В этом примере *имя хранилища* — это имя хранилища ключей, для которого вы включите возможность мягкого удаления:

   ```powershell
   $v = Get-AzKeyVault -VaultName <vault name>
   $r = Get-AzResource -ResourceId $v.ResourceId
   $r.Properties | Add-Member -MemberType NoteProperty -Name enableSoftDelete -Value 'True'
   Set-AzResource -ResourceId $r.ResourceId -Properties $r.Properties
   ```

3. Подтвердите, что для хранилища ключей настроено мягкое удаление, вы можете с помощью **get-AzKeyVault.** Если мягкое удаление настроено правильно для хранилища ключей, свойство _Soft Delete Enabled_ возвращает значение **True:**

   ```powershell
   Get-AzKeyVault -VaultName <vault name> | fl
   ```

### <a name="add-a-key-to-each-key-vault-either-by-creating-or-importing-a-key"></a>Добавление ключа в каждое хранилище ключей путем создания или импорта ключа

Существует два способа добавления ключей в хранилище Azure Key Vault. вы можете создать ключ непосредственно в Хранилище Key Vault или импортировать ключ. Создание ключа непосредственно в Хранилище Key Vault является менее сложным методом, а импорт ключа обеспечивает полный контроль над тем, как создается ключ. Используйте ключи RSA. Хранилище Azure Key Vault не поддерживает перенос и развёртывание с помощью ключей эллиптических кривых.
  
Чтобы создать ключ непосредственно в хранилище [](https://docs.microsoft.com/powershell/module/az.keyvault/add-azkeyvaultkey) ключей, выполните его следующим образом:
  
```powershell
Add-AzKeyVaultKey -VaultName <vault name> -Name <key name> -Destination <HSM|Software> -KeyOps wrapKey,unwrapKey
```

Где:

- *имя хранилища* — это имя хранилища ключей, в котором необходимо создать ключ.

- *имя ключа* — это имя, которое вы хотите предоставить новому ключу.

  > [!TIP]
  > Клавиши имен, использующие аналогичное соглашение об именовом имени, как описано выше, для хранилищ ключей. Таким образом, в средствах, которые показывают только имя ключа, строка является самоо описанной.
  
Если вы собираетесь защитить ключ с помощью HSM, убедитесь, что в качестве значения параметра _Destination_ указывается **HSM,** в противном случае укажите **Программное обеспечение.**

Пример.
  
```powershell
Add-AzKeyVaultKey -VaultName Contoso-O365EX-NA-VaultA1 -Name Contoso-O365EX-NA-VaultA1-Key001 -Destination HSM -KeyOps wrapKey,unwrapKey
```

### <a name="check-the-recovery-level-of-your-keys"></a>Проверка уровня восстановления ключей

Microsoft 365 требует, чтобы для подписки Azure Key Vault было установлено значение "Не отменять" и что для ключей, используемых ключом клиента, включено мягкое удаление. Вы можете подтвердить это, изусмотрив уровень восстановления на ключах.
  
Чтобы проверить уровень восстановления ключа, в Azure PowerShell выполните Get-AzKeyVaultKey следующим образом:
  
```powershell
(Get-AzKeyVaultKey -VaultName <vault name> -Name <key name>).Attributes
```

Если свойство _уровня_ восстановления возвращает что-либо, кроме значения **Recoverable+ProtectedSubscription,** необходимо просмотреть эту статью и убедиться, что вы следовали всем шагам, чтобы поместить подписку в список "Не отменять" и что включено "мягкое удаление" в каждом хранилище ключей. Затем отправьте снимок экрана с выводом сообщения `(Get-AzKeyVaultKey -VaultName <vault name> -Name <key name>).Attributes` электронной почты m365ck@microsoft.com.

### <a name="back-up-azure-key-vault"></a>Back up Azure Key Vault

Сразу после создания или изменения ключа выполните резервное копирование и хранение копий резервного копирования как в сети, так и в автономном режиме. Не подключайте автономные копии к какой-либо сети. Вместо этого храните их в физическом безопасном или коммерческом хранилище. По крайней мере одна копия резервной копии должна храниться в расположении, которое будет доступно в случае аварии. Резервные BLOB-ели являются единственным средством восстановления материала ключа, если ключ Key Vault будет окончательно уничтожен или иным образом отрисовке неанимательным. Ключи, которые являются внешними по внешнему хранилищу Azure Key Vault и были импортироваться в Azure Key Vault, не являются резервными, так как метаданные, необходимые для использования ключа клиента, не существуют с внешним ключом. Для операций восстановления с помощью ключа клиента можно использовать только резервную копию, взятую из хранилища Azure Key Vault. Поэтому важно создать резервную копию хранилища Azure Key Vault после отправки или создания ключа.
  
Чтобы создать резервную копию ключа Azure Key Vault, выполните его с использованием резервного копирования [AzKeyVaultKey](https://docs.microsoft.com/powershell/module/az.keyvault/backup-azkeyvaultkey) следующим образом:

```powershell
Backup-AzKeyVaultKey -VaultName <vault name> -Name <key name>
-OutputFile <filename.backup>
```

Убедитесь, что выходной файл использует `.backup` суффикс.
  
Выходной файл, который является результатом этого cmdlet, шифруется и не может использоваться за пределами хранилища Azure Key Vault. Резервную копию можно восстановить только в подписке Azure, из которой была сделана резервная копия.
  
Пример:
  
```powershell
Backup-AzKeyVaultKey -VaultName Contoso-O365EX-NA-VaultA1 -Name Contoso-O365EX-NA-VaultA1-Key001 -OutputFile Contoso-O365EX-NA-VaultA1-Key001-Backup-20170802.backup
```

### <a name="validate-azure-key-vault-configuration-settings"></a>Проверка параметров конфигурации Azure Key Vault

Выполнение проверки перед использованием ключей в DEP является необязательным, но настоятельно рекомендуется. В частности, при использовании действий по настройке ключей и хранилищ, не описанных в этом разделе, необходимо проверить состояние ресурсов Azure Key Vault перед настройкой ключа клиента.
  
Чтобы убедиться, что для ваших ключей включены операции get, wrapKey и unwrapKey:
  
Запустите [cmdlet Get-AzKeyVault](https://docs.microsoft.com/powershell/module/az.keyvault/get-azkeyvault) следующим образом:
  
```powershell
Get-AzKeyVault -VaultName <vault name>
```

В выходных данных найди политику доступа и соответствующий guID приложения Microsoft 365. Все три операции, get, wrapKey и unwrapKey, должны быть показаны в области "Разрешения для ключей".
  
Если конфигурация политики доступа неправильная, выполните Set-AzKeyVaultAccessPolicy следующим образом:
  
```powershell
Set-AzKeyVaultAccessPolicy -VaultName <vault name> -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName <Microsoft 365 appID>
```

Пример. Для службы шифрования данных Microsoft 365 в rest замените  *appID Microsoft 365* на `c066d759-24ae-40e7-a56f-027002b5d3e4`

  ```powershell
  Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName c066d759-24ae-40e7-a56f-027002b5d3e4
  ```

Чтобы убедиться, что дата окончания срока действия ключей не установлена, выполните cmdlet [Get-AzKeyVaultKey](https://docs.microsoft.com/powershell/module/az.keyvault/get-azkeyvault) следующим образом:
  
```powershell
Get-AzKeyVaultKey -VaultName <vault name>
```

Ключ клиента не может использовать ключ клиента с истекшим сроком действия, что может привести к сбойу службы. Настоятельно рекомендуется, чтобы у ключей, используемых с ключом клиента, не было даты окончания срока действия. Установленную дату окончания срока действия невозможно удалить, но ее можно изменить на другую дату. Если необходимо использовать ключ с установленным сроком действия, измените значение срока действия на 31.01.9999. Ключи с датой окончания срока действия, задав не более 31.01.9999, не проходят проверку Microsoft 365.
  
Чтобы изменить дату окончания срока действия, которая была установлена на любое значение, кроме 31.01.9999, выполните этот запуск следующим образом: [](https://docs.microsoft.com/powershell/module/az.keyvault/update-azkeyvaultkey)
  
```powershell
Update-AzKeyVaultKey -VaultName <vault name> -Name <key name> -Expires (Get-Date -Date "12/31/9999")
```

### <a name="obtain-the-uri-for-each-azure-key-vault-key"></a>Получение URI для каждого ключа Azure Key Vault

После завершения всех действий в Azure по настройкам хранилищ ключей и добавлению ключей, запустите следующую команду, чтобы получить URI для ключа в каждом хранилище ключей. Эти ЮРИС потребуется использовать при создании и назначении каждого DEP позже, поэтому сохраните эти сведения в надежном месте. Не забудьте выполнить эту команду один раз для каждого хранилища ключей.
  
В Azure PowerShell:
  
```powershell
(Get-AzKeyVaultKey -VaultName <vault name>).Id
```

## <a name="set-up-the-customer-key-encryption-policy-for-your-tenant"></a>Настройка политики шифрования ключа клиента для клиента

Для запуска этих cmdlets необходимы соответствующие разрешения. Хотя в этой статье перечислены все параметры для этих параметров, некоторые параметры могут быть не доступны, если они не включены в соответствующие разрешения. Сведения о необходимых разрешениях для запуска командлетов и использования параметров в организации см. в статье [Find the permissions required to run any Exchange cmdlet](https://docs.microsoft.com/powershell/exchange/exchange-server/find-exchange-cmdlet-permissions).

### <a name="create-policy"></a>Создание политики

```powershell
   New-M365DataAtRestEncryptionPolicy [-Name] <String> -AzureKeyIDs <MultiValuedProperty> [-Description <String>] [-Enabled <Boolean>]
```

Описание: в этом случае администратор соответствия требованиям может создать новую политику шифрования данных (DEP) с помощью двух корневых ключей AKV. После создания политика может быть назначена с помощью Set-M365DataAtRestEncryptionPolicy управления. После первого назначения ключей или после вращения клавиш может занять до 24 часов, чтобы новые ключи вступили в силу. Если новый DEP вступает в силу более 24 часов, обратитесь в корпорацию Майкрософт.

Пример:

```powershell
New-M365DataAtRestEncryptionPolicy -Name "Default_Policy" -AzureKeyIDs "https://contosoWestUSvault01.vault.azure.net/keys/Key_01","https://contosoEastUSvault01.vault.azure.net/keys/Key_02" -Description "Tenant default policy"
```

Параметры:

| Имя | Описание | Необязательный (Y/N) |
|--|--|--|
|Имя|Удобное имя политики шифрования данных|N|
|AzureKeyIDs|Указывает два значения URI ключей хранилища ключей Azure, разделенных запятой, для связи с политикой шифрования данных|N|
|Описание|Описание политики шифрования данных|N|

### <a name="assign-policy"></a>Назначение политики

```powershell
Set-M365DataAtRestEncryptionPolicyAssignment -Policy “<Default_PolicyName or Default_PolicyID>”
```

Описание: этот cmdlet используется для настройки политики шифрования данных по умолчанию. Эта политика будет использоваться для шифрования данных во всех рабочих нагрузках поддержки. 

Пример:

```powershell
Set-M365DataAtRestEncryptionPolicyAssignment -Policy “Tenant default policy”
```

Параметры:
| Имя | Описание | Необязательный (Y/N) |
|--|--|--|
-Policy|Указывает политику шифрования данных, которую необходимо на назначенное; укажите имя политики или ИД политики.|N|

### <a name="modify-or-refresh-policy"></a>Изменение или обновление политики

```powershell
Set-M365DataAtRestEncryptionPolicy [-Identity] < M365DataAtRestEncryptionPolicy DataEncryptionPolicyIdParameter> -Refresh [-Enabled <Boolean>] [-Name <String>] [-Description <String>]
```

Описание: этот cmdlet можно использовать для изменения или обновления существующей политики. Его также можно использовать для включаемой или отключенной политики. После первого назначения ключей или после поворота клавиш может занять до 24 часов, чтобы новые ключи вступили в силу. Если новый DEP вступает в силу более 24 часов, обратитесь в корпорацию Майкрософт.

Примеры:

Отключать политику шифрования данных.

```powershell
Set-M365DataAtRestEncryptionPolicy -Identity "NAM Policy" -Enabled $false
```

Обновите политику шифрования данных.

```powershell
Set-M365DataAtRestEncryptionPolicy -Identity “EUR Policy” -Refresh
```

Параметры:
| Имя | Описание | Необязательный (Y/N) |
|--|--|--|
|-Identity|Указывает политику шифрования данных, которую необходимо изменить.|N|
|-Refresh|Используйте переключатель Refresh для обновления политики шифрования данных после поворота любых связанных ключей в хранилище Azure Key Vault. С этим параметром не нужно указывать значение.|Да|
|-Enabled|Параметр Enabled включает или отключать политику шифрования данных. Перед отключением политики необходимо отоименовать ее от клиента. Допустимые значения:</br > $true: политика включена</br > $true. Политика включена. Это значение задается по умолчанию.
|Да|
|-Name|Параметр Name задает уникальное имя политики шифрования данных.|Да
|-Description|Параметр Description задает необязательное описание политики шифрования данных.|Да|

### <a name="get-policy-details"></a>Получить сведения о политике

```powershell
Get-M365DataAtRestEncryptionPolicy [-Identity] < M365DataAtRestEncryptionPolicy DataEncryptionPolicyIdParameter>
```

Описание: этот cmdlet перечисляет все политики шифрования M365DataAtRest, созданные для клиента, или сведения о конкретной политике.

Примеры:

В этом примере возвращается сводный список политик шифрования M365DatRest в организации.

```powershell
Get-M365DataAtRestEncryptionPolicy
```

В этом примере возвращаются подробные сведения о политике шифрования данных с именем "Политика NAM".

```powershell
Get-M365DataAtRestEncryptionPolicy -Identity "NAM Policy"
```

Параметры:

| Имя | Описание | Необязательный (Y/N) |
|--|--|--|
|-Identity|Указывает политику шифрования данных, сведения о которую необходимо у вас получить.|Да|

### <a name="get-policy-assignment-info"></a>Получить сведения о назначении политики

```powershell
Get-M365DataAtRestEncryptionPolicyAssignment
```

Описание: этот cmdlet перечисляет политику, которая в настоящее время назначена для клиента.

## <a name="offboarding-from-customer-key"></a>Отключение ключа клиента

Если вам нужно вернуться к ключам, управляемым Майкрософт, вы можете. При отключении ваши данные повторно шифруются с использованием шифрования по умолчанию, поддерживаемого каждой отдельной рабочей нагрузкой. Например, Exchange Online поддерживает шифрование по умолчанию с помощью ключей, управляемых Майкрософт.

Если вы решили отключить клиент от ключа клиента на уровне клиента, отправьте корпорации Майкрософт запрос по электронной почте, чтобы "отключить" службу для клиента по [m365ck@microsoft.com.](mailto:m365ck@microsoft.com)

> [!IMPORTANT]
> Отключение — это не то же самое, что очистка данных. При очистке данных окончательно криптографическая очистка удаляет данные вашей организации из Microsoft 365, отключение не происходит. Вы не можете выполнить очистку данных для политики на уровне клиента. Сведения о пути очистки данных см. в переочистке ключей и начале процесса [очистки данных.](customer-key-manage.md#revoke-your-keys-and-start-the-data-purge-path-process)

## <a name="about-the-availability-key"></a>О ключе доступности

Сведения о ключе доступности см. в сведениях [о ключе доступности.](customer-key-availability-key-understand.md)

## <a name="key-rotation"></a>Поворот клавиш

Сведения о вращении или вращении ключей, используемых с ключом клиента, см. в подкатеголи или повороте ключа клиента или [ключа доступности.](customer-key-availability-key-roll.md) При обновлении DEP для использования новой версии ключей будет запускаться Set-M365DataAtRestEncryptionPolicy, как описано выше в этой статье.

## <a name="related-articles"></a>Связанные статьи:

- [Шифрование службы с помощью ключа клиента](customer-key-overview.md)

- [Смена или ротация ключа клиента или ключа доступности](customer-key-availability-key-roll.md)

- [Узнайте о ключе доступности](customer-key-availability-key-understand.md)

- [Шифрование службы](office-365-service-encryption.md)
