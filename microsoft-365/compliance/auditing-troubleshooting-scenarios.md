---
title: Поиск в журнале аудита для устранения неполадок распространенных сценариев
f1.keywords:
- NOCSH
ms.author: markjjo
author: markjjo
manager: laurawi
audience: Admin
ms.topic: troubleshooting
ms.service: O365-seccomp
localization_priority: Normal
ms.collection:
- Strat_O365_IP
- M365-security-compliance
search.appverid:
- MET150
- MOE150
ms.custom:
- seo-marvel-apr2020
description: Узнайте, как использовать средство поиска в журнале аудита Microsoft 365 для устранения распространенных проблем с поддержкой учетных записей электронной почты.
ms.openlocfilehash: a32633d401156e00a45d15e4b38622b13bcb87cf
ms.sourcegitcommit: 21c3e44862854c74e4008cfb661840f069c6b709
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/28/2020
ms.locfileid: "48787595"
---
# <a name="search-the-audit-log-to-investigate-common-support-issues"></a>Поиск в журнале аудита для изучения распространенных проблем поддержки

В этой статье описывается, как использовать средство поиска в журнале аудита для изучения распространенных проблем поддержки. Это включает использование журнала аудита для:

- Поиск IP-адреса компьютера, используемого для доступа к скомпрометированной учетной записи
- Определение того, кто настроил пересылку электронной почты для почтового ящика
- Определение того, удалил ли пользователь элементы электронной почты в своем почтовом ящике
- Определение того, создал ли пользователь правило для почтового ящика
- Изучение причины успешного входа пользователя за пределами организации
- Поиск действий почтовых ящиков, выполняемых пользователями с лицензиями, не относящемся к E5
- Поиск действий почтовых ящиков, выполняемых делегными пользователями

## <a name="using-the-audit-log-search-tool"></a>Использование средства поиска в журнале аудита

Каждый из сценариев устранения неполадок, описанных в этой статье, основан на использовании средства поиска в журнале аудита в Центре безопасности & соответствия требованиям. В этом разделе перечислены разрешения, необходимые для поиска в журнале аудита, а также описаны действия по доступу и запуску поиска в журнале аудита. В каждом разделе сценария объясняется, как настроить поисковый запрос журнала аудита и что искать в подробных сведениях в записях аудита, которые соответствуют условиям поиска.

### <a name="permissions-required-to-use-the-audit-log-search-tool"></a>Разрешения, необходимые для использования средства поиска в журнале аудита

Вам должна быть назначена роль View-Only или журналов аудита в Exchange Online для поиска в журнале аудита. Эти роли по умолчанию назначены группам ролей "Управление соответствием" и "Управление организацией" на странице **Разрешения** в Центре администрирования Exchange. Глобальные администраторы в Office 365 и Microsoft 365 автоматически добавляются в качестве членов группы ролей "Управление организацией" в Exchange Online. Дополнительные сведения см. в статье [Управление группами ролей в Exchange Online](https://go.microsoft.com/fwlink/p/?LinkID=730688).

### <a name="running-audit-log-searches"></a>Запуск поиска в журнале аудита

В этом разделе описаны основные принципы создания и запуска поиска в журнале аудита. Используйте эти инструкции в качестве отправной точки для каждого сценария устранения неполадок в этой статье. Более подробные пошаговая инструкция см. в описании поиска [в журнале аудита.](search-the-audit-log-in-security-and-compliance.md#step-1-run-an-audit-log-search)

1. Войдите [https://protection.office.com/unifiedauditlog](https://protection.office.com/unifiedauditlog) в учетную запись вашей работы или учебного заведения и войдите в нее.
    
    Откроется страница **Поиск в журнале аудита**. 
    
    ![Настройте критерии и выберите "Поиск для запуска поиска"](../media/8639d09c-2843-44e4-8b4b-9f45974ff7f1.png)
  
4. Можно настроить следующие условия поиска. Каждый сценарий устранения неполадок в этой статье рекомендует конкретные рекомендации по настройке этих полей.
    
    а. **Действия:** Выберите в выпадаемом списке действия, которые можно найти. После запуска поиска отображаются только записи аудита для выбранных действий. При выборе **"Показать результаты для всех действий"** отображаются результаты для всех действий, которые соответствуют другим условиям поиска. Кроме того, в некоторых сценариях устранения неполадок это поле необходимо оставить пустым.
    
    б. **Дата начала** и **дата окончания:** выберите диапазон дат и времени, чтобы отобразить события, произошедшие за этот период. Последние семь дней выбраны по умолчанию. Даты и время представлены в формате UTC. Максимальный диапазон дат, который можно указать, составляет 90 дней.

    в. **Пользователи:** Щелкните это поле и выберите одного или несколько пользователей для отображения результатов поиска. Записи аудита для выбранного действия, выполняемого пользователями, выбранными в этом поле, отображаются в списке результатов. Чтобы получить результаты для всех пользователей (и учетных записей служб) в организации, оставьте это поле пустым.
    
    г. **Файл, папка или сайт:** Введите имя файла или папки для поиска действий, связанных с файлом папки, содержащем указанное ключевое слово. Также можно указать URL-адрес файла или папки. Если вы используете URL-адрес, убедитесь, что указан полный путь к URL-адресу, или если вы введите только часть URL-адреса, не включайте специальные символы или пробелы. Чтобы получить результаты для всех файлов и папок в организации, оставьте это поле пустым. Это поле остается пустым во всех сценариях устранения неполадок в этой статье.
    
5. Выберите **"Поиск",** чтобы выполнить поиск, используя условия поиска. 
    
    Результаты поиска загружаются и через несколько секунд отображаются в  области результатов на странице поиска **в журнале аудита.** В каждом из разделов этой статьи содержится руководство по поиску в контексте конкретного сценария устранения неполадок.

    Дополнительные сведения о просмотре, фильтрации или экспорте результатов поиска в журнале аудита см. в:

    - [Просмотр результатов поиска](search-the-audit-log-in-security-and-compliance.md#step-2-view-the-search-results)
    - [Фильтрация результатов поиска](search-the-audit-log-in-security-and-compliance.md#step-3-filter-the-search-results)
    - [Экспорт результатов поиска](search-the-audit-log-in-security-and-compliance.md#step-4-export-the-search-results-to-a-file)

## <a name="find-the-ip-address-of-the-computer-used-to-access-a-compromised-account"></a>Поиск IP-адреса компьютера, используемого для доступа к скомпрометированной учетной записи

IP-адрес, соответствующий действию любого пользователя, включен в большинство записей аудита. Сведения об используемом клиенте также включаются в запись аудита.

Вот как настроить поисковый запрос журнала аудита для этого сценария:

**Действия:** Если это относится к вашему делу, выберите определенное действие для поиска. Для устранения неполадок компрометации  учетных записей выберите пользователя, который впислся в почтовый ящик, в **действиях почтовых** ящиков Exchange. Это возвращает записи аудита с IP-адресом, которые использовались при входе в почтовый ящик. В противном случае оставьте это поле пустым, чтобы вернуть записи аудита для всех действий. 

> [!TIP]
> Если оставить это поле пустым, будут возвращены действия **UserLoggedIn,** то есть действия Azure Active Directory, которые указывают на то, что кто-то вошел в учетную запись пользователя. Используйте фильтрацию в результатах поиска для отображения записей аудита **UserLoggedIn.**

**Дата начала** и **дата окончания:** выберите диапазон дат, применимый к вашему расследованию.

**Пользователи:** Если вы изучаете скомпрометированную учетную запись, выберите пользователя, учетная запись которого была скомпрометирована. Это возвращает записи аудита для действий, выполняемых этой учетной записью пользователя.

**Файл, папка или сайт:** Оставьте это поле пустым.

После запуска поиска IP-адрес для каждого действия отображается в **столбце IP-адреса** в результатах поиска. Выберите запись в результатах поиска, чтобы просмотреть более подробные сведения на странице flyout.

## <a name="determine-who-set-up-email-forwarding-for-a-mailbox"></a>Определение того, кто настроил пересылку электронной почты для почтового ящика

Если для почтового ящика настроена пересылаемая почта, сообщения электронной почты, отправленные в этот почтовый ящик, пересылаются в другой почтовый ящик. Сообщения можно переадружить пользователям в организации или за ее пределами. Если для почтового ящика настроена пересылаемая электронная почта, используется используемый ниже код exchange Online **Set-Mailbox.**

Вот как настроить поисковый запрос журнала аудита для этого сценария:

**Действия:** Оставьте это поле пустым, чтобы при поиске возвращались записи аудита для всех действий. Это необходимо для возврата любых записей аудита, связанных с этимлетом **Set-Mailbox.**

**Дата начала** и **дата окончания:** выберите диапазон дат, применимый к вашему расследованию.

**Пользователи:** Оставьте это поле пустым, если вы не изучаете проблему с переадной электронной почтой для определенного пользователя. Это помогает определить, настроена ли переадстройка электронной почты для какого-либо пользователя.

**Файл, папка или сайт:** Оставьте это поле пустым.

После запуска поиска выберите фильтр результатов **на** странице результатов поиска. В поле  под столбцом "Действие" введите **Set-Mailbox,** чтобы отображались только записи аудита, связанные с этимлетом. 

![Фильтрация результатов поиска в журнале аудита](../media/emailforwarding1.png)

На этом этапе необходимо и посмотреть сведения о каждой записи аудита, чтобы определить, связана ли эта активность с переадпределение электронной почты. Выберите запись аудита,  чтобы отобразить отображаемую страницу "Сведения", а затем выберите **"Дополнительные сведения".** На следующем снимке экрана и описания выделены сведения, которые указывают, что для почтового ящика была настроена пересылаемая почта.

![Подробные сведения из записи аудита](../media/emailforwarding2.png)

а. В поле **ObjectId** отображается псевдоним почтового ящика, для который была настроена пересылаемая почта. Этот почтовый ящик также отображается в столбце **"Элемент"** на странице результатов поиска.

б. В поле **"Параметры"** значение *ForwardingSmtpAddress* указывает, что для почтового ящика была настроена пересылаемая почта. В этом примере почта пересылается на адрес электронной почты mike@contoso.com, который находится за пределами alpinehouse.onmicrosoft.com организации.

в. Значение *True* для параметра *DeliverToMailboxAndForward* указывает, что копия сообщения доставляется  в sarad@alpinehouse.onmicrosoft.com и переадресуется на адрес электронной почты, указанный параметром *ForwardingSmtpAddress,* который в данном примере mike@contoso.com. Если для параметра *DeliverToMailboxAndForward* установлено значение *False,* то электронная почта переадресуется только на адрес, указанный параметром *ForwardingSmtpAddress.* Он не доставляется в почтовый ящик, указанный в поле **ObjectId.**

г. Поле **UserId указывает** пользователя, который настроил переадстройку электронной почты для почтового ящика, указанного в **поле ObjectId.** Этот пользователь также отображается в столбце **"Пользователь"** на странице результатов поиска. В этом случае кажется, что владелец почтового ящика настроит пересылку электронной почты для своего почтового ящика.

Если вы определили, что пересылание электронной почты не должно быть настроено для почтового ящика, вы можете удалить ее, выменив следующую команду в Exchange Online PowerShell:

```powershell
Set-Mailbox <mailbox alias> -ForwardingSmtpAddress $null 
```

Дополнительные сведения о параметрах, связанных с пересылке электронной почты, см. в статье [Set-Mailbox.](https://docs.microsoft.com/powershell/module/exchange/set-mailbox)

## <a name="determine-if-a-user-deleted-email-items"></a>Определение удаления пользователем элементов электронной почты

С января 2019 г. корпорация Майкрософт по умолчанию включит ведение журнала аудита почтовых ящиков для всех организаций Office 365 и Майкрософт. Это означает, что некоторые действия, выполняемые владельцами почтовых ящиков, регистрируются автоматически, и соответствующие записи аудита почтовых ящиков доступны при поиске в журнале аудита почтовых ящиков. Прежде чем аудит почтовых ящиков был включен по умолчанию, необходимо было вручную включить его для каждого почтового ящика пользователя в организации. 

Действия почтовых ящиков, зарегистрированные по умолчанию, включают действия с почтовыми ящиками SoftDelete и HardDelete, выполняемые владельцами почтовых ящиков. Это означает, что вы можете использовать следующие действия для поиска в журнале аудита событий, связанных с удаленными элементами электронной почты. Дополнительные сведения об аудите почтовых ящиков по умолчанию см. в под управлением [аудита почтовых ящиков.](enable-mailbox-auditing.md)

Вот как настроить поисковый запрос журнала аудита для этого сценария:

**Действия:** В **области действий почтовых ящиков Exchange** выберите одно или оба из следующих действий:

- **Удаленные сообщения из папки "Удаленные":** Это действие соответствует действию аудита почтового ящика **SoftDelete.** Это действие также регистрируется, когда пользователь окончательно удаляет элемент, выбирая его и нажимая **shift+Delete.** После окончательного удаления элемента пользователь может восстановить его, пока не истечет срок хранения удаленного элемента.

- **Сообщения, отправленные из почтового ящика:** Это действие соответствует действию аудита почтового ящика **HardDelete.** Это занося в журнал, когда пользователь очищает элемент из папки "Элементы с возможностью восстановления". Администраторы могут использовать средство "Поиск контента" в Центре безопасности и соответствия требованиям для поиска и восстановления удаленных элементов, пока не истечет или не истечет срок хранения удаленных элементов, если почтовый ящик пользователя находится на удержании.

**Дата начала** и **дата окончания:** выберите диапазон дат, применимый к вашему расследованию.

**Пользователи:** При выборе пользователя в этом поле средство поиска в журнале аудита возвращает записи аудита для элементов электронной почты, удаленных пользователем (SoftDeleted или HardDeleted). Иногда пользователь, удалявший сообщение электронной почты, не может быть владельцем почтового ящика.

**Файл, папка или сайт:** Оставьте это поле пустым.

После запуска поиска можно отфильтровать результаты поиска, чтобы отобразить записи аудита для элементов, удаленных с возможностью их удаления. Выберите запись аудита,  чтобы отобразить отображаемую страницу "Сведения", а затем выберите **"Дополнительные сведения".** Дополнительные сведения об удаленном элементе, например строка темы и расположение элемента при его удалении, отображаются в поле **AffectedItems.** На следующих снимках экрана приводится пример поля **AffectedItems** из мягко удаленного элемента и жестко удаленного элемента.

**Пример поля AffectedItems для удаленного элемента**

![Запись аудита для мягко удаленного элемента](../media/softdeleteditem.png)

**Пример поля AffectedItems для неустойки удаленного элемента**

![Запись аудита для неутвердимо удаленного элемента электронной почты](../media/harddeleteditem.png)

### <a name="recover-deleted-email-items"></a>Восстановление удаленных элементов электронной почты

Пользователи могут восстановить элементы с возможностью восстановления, если срок хранения удаленных элементов еще не истек. В Exchange Online срок хранения удаленных элементов по умолчанию составляет 14 дней, но администраторы могут увеличить этот параметр до 30 дней. Направь пользователей в статью "Восстановление удаленных элементов или сообщений электронной почты" в [Outlook в](https://support.office.com/article/Recover-deleted-items-or-email-in-Outlook-Web-App-C3D8FC15-EEEF-4F1C-81DF-E27964B7EDD4) Интернете, чтобы получить инструкции по восстановлению удаленных элементов.

Как объяснялось ранее, администраторы могут восстановить элементы, удаленные без возможности восстановления, если срок хранения удаленных элементов не истек или почтовый ящик находится на удержании. В этом случае элементы хранятся до истечения срока хранения. При запуске поиска контента в результатах поиска, если они соответствуют поисковому запросу, в результатах поиска возвращаются элементы из папки "Элементы с восстановления". Дополнительные сведения о поиске контента см. в под [управлением "Поиск контента" в Office 365.](content-search.md)

> [!TIP]
> Для поиска удаленных элементов электронной почты необходимо найти всю или часть строки темы, которая отображается в поле **AffectedItems** в записи аудита.

## <a name="determine-if-a-user-created-an-inbox-rule"></a>Определение того, создал ли пользователь правило для почтового ящика

Когда пользователи создают правило для почтового ящика Exchange Online, соответствующая запись аудита будет сохранена в журнале аудита. Дополнительные сведения о правилах для входящих сообщений см. в:

- [Использование правил для почтового ящика в Outlook в Интернете](https://support.office.com/article/use-inbox-rules-in-outlook-on-the-web-8400435c-f14e-4272-9004-1548bb1848f2)
- [Управление сообщениями электронной почты в Outlook с помощью правил](https://support.office.com/article/Manage-email-messages-by-using-rules-C24F5DEA-9465-4DF4-AD17-A50704D66C59)

Вот как настроить поисковый запрос журнала аудита для этого сценария:

**Действия:** В **области действий почтового ящика Exchange** выберите **new-InboxRule Create/modify/enable/disable inbox rule**.

**Дата начала** и **дата окончания:** выберите диапазон дат, применимый к вашему расследованию.

**Пользователи:** Если вы не изучаете конкретного пользователя, оставьте это поле пустым. Это помогает определить новые правила для почтового ящика, заданной любым пользователем.

**Файл, папка или сайт:** Оставьте это поле пустым.

После запуска поиска все записи аудита для этого действия отображаются в результатах поиска. Выберите запись аудита,  чтобы отобразить отображаемую страницу "Сведения", а затем выберите **"Дополнительные сведения".** Сведения о параметрах правила для почтового ящика отображаются в поле **"Параметры".** На следующем снимке экрана и описания выделены сведения о правилах для входящих сообщений.

![Запись аудита для нового правила для почтового ящика](../media/NewInboxRuleRecord.png)

а. В поле **ObjectId** отображается полное имя правила для почтового ящика. Это имя включает псевдоним почтового ящика пользователя (например, SaraD) и имя правила для входящих сообщений (например, "Перемещение сообщений от администратора").

б. В поле **"Параметры"** отображается условие правила для входящих сообщений. В этом примере условие задано параметром *From.* Значение, определенное для параметра *From,* указывает, что правило для почтового ящика действует на электронную почту, отправленную admin@alpinehouse.onmicrosoft.com. Полный список параметров, которые можно использовать для определения условий правил для входящих сообщений, см. в статье [New-InboxRule.](https://docs.microsoft.com/powershell/module/exchange/new-inboxrule)

в. Параметр *MoveToFolder* указывает действие для правила для почтового ящика. В этом примере сообщения, полученные от admin@alpinehouse.onmicrosoft.com, перемещаются в папку *AdminSearch.* Полный список параметров, которые можно использовать для определения действия правила для почтового ящика, см. также в статье [New-InboxRule.](https://docs.microsoft.com/powershell/module/exchange/new-inboxrule)

г. Поле **UserId** указывает пользователя, создавшего правило для входящих сообщений, указанное в **поле ObjectId.** Этот пользователь также отображается в столбце **"Пользователь"** на странице результатов поиска.

## <a name="investigate-why-there-was-a-successful-login-by-a-user-outside-your-organization"></a>Изучение причины успешного входа пользователя за пределами организации

При просмотре записей аудита в журнале аудита могут появиться записи, которые указывают, что внешний пользователь прошел проверку подлинности в Azure Active Directory и успешно выполнил вход в вашу организацию. Например, администратор в contoso.onmicrosoft.com может увидеть запись аудита, показывающая, что пользователь из другой организации (например, fabrikam.onmicrosoft.com) успешно вошел в contoso.onmicrosoft.com. Кроме того, можно увидеть записи аудита, которые указывают, что пользователи с учетной записью Майкрософт (MSA), например Outlook.com или Live.com, успешно вошли в вашу организацию. В таких ситуациях аудитом активности является вход пользователя в **систему.** 

Такое поведение является особенностью данного продукта. Служба каталогов Azure Active Directory (Azure AD)  позволяет пройти сквозную проверку подлинности, когда внешний пользователь пытается получить доступ к сайту SharePoint или расположению OneDrive в вашей организации. Когда внешний пользователь пытается сделать это, им будет предложено ввести свои учетные данные. Azure AD использует учетные данные для проверки подлинности пользователя, то есть только Azure AD проверяет, является ли он тем, за кого себя себя выдает. Индикатор успешного входа в запись аудита является результатом проверки подлинности пользователя в Azure AD. Успешный вход не означает, что пользователь смог получить доступ к любым ресурсам или выполнить другие действия в вашей организации. Это указывает только на то, что пользователь был аутентификацией с помощью Azure AD. Чтобы сквозной пользователь мог получить доступ к ресурсам SharePoint или OneDrive, пользователю в вашей организации необходимо явным образом поделиться ресурсом с внешним пользователем, отправив ему приглашение к совместному доступу или ссылку для анонимного общего доступа. 

> [!NOTE]
> Azure AD позволяет пройти сквозную проверку подлинности только для приложений первого *рода,* таких как SharePoint Online и OneDrive для бизнеса. Это запрещено для других сторонних приложений.

Ниже приводится пример и описания соответствующих свойств в записи аудита для пользователя, во время входа в систему, которое является результатом сквозной проверки подлинности.  Выберите запись аудита,  чтобы отобразить отображаемую страницу "Сведения", а затем выберите **"Дополнительные сведения".**

![Пример записи аудита для успешной проверки подлинности по протоколу pass-thru](../media/PassThroughAuth1.png)

   а. Это поле указывает, что пользователь, попытавшийся получить доступ к ресурсу в вашей организации, не найден в Azure AD вашей организации.

   б. В этом поле отображается имя upn внешнего пользователя, который попытался получить доступ к ресурсу в организации. Этот ИД пользователя также определен в **свойствах User** и **UserId** в записи аудита.

   в. Свойство **ApplicationId** определяет приложение, которое инициировало запрос на запуск. Значение 00000003-0000-0ff1-ce00-0000000000000, отображаемого в свойстве ApplicationId в этой записи аудита, указывает На SharePoint Online. OneDrive для бизнеса также имеет тот же applicationId.

   г. Это означает, что сквозная проверка подлинности прошла успешно. Другими словами, служба Azure AD успешно прошла проверку подлинности пользователя. 

   д. Значение **RecordType** **15** указывает, что зарегистрированное действие (UserLoggedIn) является событием для работы с службой маркеров безопасности (STS) в Azure AD.

Дополнительные сведения о других свойствах, отображаемой в записи аудита UserLoggedIn, см. в сведениях схемы, связанных с Azure AD, в схеме API действий управления [Office 365.](https://docs.microsoft.com/office/office-365-management-api/office-365-management-activity-api-schema#azure-active-directory-base-schema)

Вот два примера сценариев, которые могут  привести к успешному входу пользователя в аудит из-за сквозной проверки подлинности. 

  - Пользователь с учетной записью Майкрософт (например, SaraD@outlook.com) попытался получить доступ к документу в учетной записи OneDrive для бизнеса в fourthcoffee.onmicrosoft.com и нет соответствующей гостевой учетной записи для SaraD@outlook.com в fourthcoffee.onmicrosoft.com.

  - Пользователь с учетной записью на работе или в учебном зачете в организации (например, pilarp@fabrikam.onmicrosoft.com) попытался получить доступ к сайту SharePoint в contoso.onmicrosoft.com и в contoso.onmicrosoft.com нет соответствующей учетной записи гостевого pilarp@fabrikam.com в contoso.onmicrosoft.com.

### <a name="tips-for-investigating-successful-logins-resulting-from-pass-through-authentication"></a>Советы по исследованию успешных входов в систему в результате сквозной проверки подлинности

- Найдите в журнале аудита действия, выполняемые внешним пользователем, идентифицированным в записи **аудита.** Введите имя пользователя-пользователя для внешнего пользователя в поле **"Пользователи"** и используйте диапазон дат, если это относится к вашему сценарию. Например, вы можете создать поиск, используя следующие условия поиска:

   ![Поиск всех действий, выполняемых внешним пользователем](../media/PassThroughAuth2.png)

    Помимо действий, которые пользователь вошел в систему, могут быть возвращены другие записи аудита, например записи, которые указывают, что пользователь в организации поделился ресурсами с внешним пользователем, а также был ли внешний пользователь получил доступ, изменил или скачал документ, к нему был общий доступ. 

- Поиск действий общего доступа к SharePoint, которые указывают, что файл был общим для внешнего пользователя, идентифицированного пользователем, который вошел **в запись** аудита. Для получения дополнительной информации см. раздел [Использование аудита совместного использования в журнале аудита](use-sharing-auditing.md).

- Экспортировать результаты поиска в журнале аудита, содержащие записи, относящиеся к вашему расследованию, чтобы можно было использовать Excel для поиска других действий, связанных с внешним пользователем. Дополнительные сведения см. в записях журнала аудита экспорта, настройки и [просмотра.](export-view-audit-log-records.md)

## <a name="search-for-mailbox-activities-performed-by-users-with-non-e5-licenses"></a>Поиск действий почтовых ящиков, выполняемых пользователями с лицензиями, не относящемся к E5

Даже [](enable-mailbox-auditing.md) если аудит почтовых ящиков включен по умолчанию для вашей организации, вы можете заметить, что события аудита почтовых ящиков для некоторых пользователей не найдены в поиске в журнале аудита с помощью Центра соответствия требованиям, с помощью команды **Search-UnifiedAuditLog** или API действий управления Office 365. Причина этого заключается в том, что события аудита почтовых ящиков будут возвращаться только для пользователей с лицензиями E5, если вы одним из предыдущих способов поиска в едином журнале аудита.

Чтобы получить записи журнала аудита почтовых ящиков для пользователей, не входящих в E5, можно выполнить одно из следующих обходных пути:

- Вручную включить аудит почтовых ящиков для отдельных почтовых ящиков (запустите `Set-Mailbox -Identity <MailboxIdentity> -AuditEnabled $true` команду в Exchange Online PowerShell). После этого вы можете найти действия аудита почтовых ящиков с помощью Центра соответствия требованиям, с помощью команды **Search-UnifiedAuditLog** или API действий управления Office 365.
  
  > [!NOTE]
  > Если аудит почтовых ящиков уже включен для почтового ящика, но поиск не возвращает результатов, измените значение параметра _AuditEnabled_ на и `$false` `$true` обратно.
  
- Используйте следующие cmdlets в Exchange Online PowerShell:

  - [Search-MailboxAuditLog](https://docs.microsoft.com/powershell/module/exchange/search-mailboxauditlog) для поиска определенных пользователей в журнале аудита почтовых ящиков.

  - [New-MailboxAuditLogSearch](https://docs.microsoft.com/powershell/module/exchange/new-mailboxauditlogsearch) для поиска определенных пользователей в журнале аудита почтовых ящиков и отправки результатов по электронной почте указанным получателям.

## <a name="search-for-mailbox-activities-performed-in-a-specific-mailbox-including-shared-mailboxes"></a>Поиск действий в почтовом ящике, выполняемой в определенном почтовом ящике (включая общие почтовые ящики)

При использовании  списка "Пользователи" в средстве поиска по журналу аудита в Центре соответствия требованиям или команде **Search-UnifiedAuditLog -UserIds** в Exchange Online PowerShell можно выполнять поиск действий, выполняемых определенным пользователем. Для действий аудита почтовых ящиков этот тип поиска будет выполнять поиск действий, выполняемых указанным пользователем. Это не гарантирует, что все действия, выполняемые в одном почтовом ящике, будут возвращены в результатах поиска. Например, поиск в журнале аудита не возвращает записи аудита действий, выполняемых пользователем-делегатом, так как поиск действий в почтовых ящиках, выполняемых определенным пользователем, не возвращает действия, выполняемые пользователем-делегатом, которому назначены разрешения на доступ к почтовому ящику другого пользователя. (Пользователь-делегат — это пользователь, которому назначено разрешение sendAs, SendOnBehalf или FullAccess для почтового ящика другого пользователя.)

Кроме того,  при использовании списка "Пользователь" в средстве поиска в журнале аудита или в **средстве поиска -UnifiedAuditLog -UserIds** не возвращаются результаты действий, выполняемых в общем почтовом ящике.

Чтобы найти действия, выполняемые в определенном почтовом ящике, или найти действия, выполняемые в общем почтовом ящике, используйте следующий синтаксис при выполнении **cmdlet Search-UnifiedAuditLog:**

```powershell
Search-UnifiedAuditLog  -StartDate <date> -EndDate <date> -FreeText (Get-Mailbox <mailbox identity).ExchangeGuid
```

Например, следующая команда возвращает записи аудита действий, выполняемых в общем почтовом ящике группы соответствия требованиям Contoso в период с августа 2020 г. по октябрь 2020 г.:

```powershell
Search-UnifiedAuditLog  -StartDate 08/01/2020 -EndDate 10/31/2020 -FreeText (Get-Mailbox complianceteam@contoso.onmicrosoft.com).ExchangeGuid
```

Кроме того, можно использовать для поиска записей аудита действий, выполняемой в определенном почтовом ящике, с помощью выполнения **поиска-mailboxAuditLog.** Это включает поиск действий, выполняемых в общем почтовом ящике.

В следующем примере возвращаются записи журнала аудита почтовых ящиков для действий, которые выполняются в общем почтовом ящике группы соответствия требованиям Contoso:

```powershell
Search-MailboxAuditLog -Identity complianceteam@contoso.onmicrosoft.com -StartDate 08/01/2020 -EndDate 10/31/2020 -ShowDetails
```

В следующем примере возвращаются записи журнала аудита почтовых ящиков для действий, выполняемого в указанном почтовом ящике делегированием пользователей:

```powershell
Search-MailboxAuditLog -Identity <mailbox identity> -StartDate <date> -EndDate <date> -LogonTypes Delegate -ShowDetails
```

Вы также можете  использовать для поиска определенного почтового ящика в журнале аудита и отправки результатов по электронной почте указанным получателям.