---
title: Использование аудита общего доступа в журнале аудита
f1.keywords:
- NOCSH
ms.author: markjjo
author: markjjo
manager: laurawi
ms.date: ''
audience: Admin
ms.topic: article
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- SPO160
- MOE150
- BCS160
- MET150
ms.collection:
- M365-security-compliance
- SPO_Content
ms.assetid: 50bbf89f-7870-4c2a-ae14-42635e0cfc01
description: Администратор может узнать, как использовать аудит общего доступа в журнале аудита Microsoft 365 для идентификации ресурсов, к ним делиться с пользователями за пределами организации.
ms.custom: seo-marvel-apr2020
ms.openlocfilehash: d26a8022f8d59aeb56a03c50ae546777c882ef7a
ms.sourcegitcommit: 973f5449784cb70ce5545bc3cf57bf1ce5209218
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/19/2020
ms.locfileid: "44819299"
---
# <a name="use-sharing-auditing-in-the-audit-log"></a>Использование аудита общего доступа в журнале аудита

Общий доступ — это ключевая деятельность в SharePoint Online и OneDrive для бизнеса, которая широко используется в организациях. Администраторы могут использовать аудит общего доступа в журнале аудита, чтобы определить, как общий доступ используется в организации. 
  
## <a name="the-sharepoint-sharing-schema"></a>Схема общего доступа SharePoint

События общего доступа (не включая события, связанные с политикой общего доступа и ссылками для общего доступа) отличаются от событий, связанных с файлами и папками, одним основным способом: один пользователь выполняет действие, которое влияет на другого пользователя. Например, когда пользователь ресурса A предоставляет пользователю Б доступ к файлу. В этом примере пользователь А является действующим *пользователем,* а пользователь Б — *целевым пользователем.* В схеме файла SharePoint действие действующего пользователя влияет только на сам файл. Когда пользователь А открывает файл, единственная необходимая информация в событии **FileAccessed** — это действующий пользователь. Для устранения этой разницы существует отдельная схема, называемая схемой общего доступа  *SharePoint,* которая захватывает дополнительные сведения о событиях общего доступа. Это гарантирует, что администраторы могут быть в видимости того, кто поделился ресурсом и с кем ему был общий доступ. 
  
Схема общего доступа предоставляет два дополнительных поля в записи аудита, связанных с событиями общего доступа: 
  
- **TargetUserOrGroupType:** Указывает, является ли целевой пользователь или группа участником, гостем, SharePointGroup, SecurityGroup или Партнером.

- **TargetUserOrGroupName:** Сохраняет имя или имя целевого пользователя или группы, доступ к ресурсу которого был общим (пользователь Б в предыдущем примере). 

Эти два поля, в дополнение к другим свойствам схемы журнала аудита, таким как  "Пользователь",  "Операция" и "Дата", могут сообщить полную информацию о том, какой пользователь поделился ресурсом, с кем и *когда.*  
  
Существует еще одно свойство схемы, важное для общего доступа. При экспорте результатов поиска в журнале аудита в столбце **AuditData** в экспортируемом CSV-файле хранится информация о событиях общего доступа. Например, когда пользователь делится сайтом с другим пользователем, это достигается путем добавления целевого пользователя в группу SharePoint. В **столбце AuditData** фиксироваться эти сведения, чтобы предоставить администраторам контекст. Инструкции по разбиению данных в столбце **AuditData** см. в шаге [2.](#step-2-use-the-powerquery-editor-to-format-the-exported-audit-log)

## <a name="sharepoint-sharing-events"></a>События общего доступа SharePoint

Общий доступ определяется тем,  когда пользователь (действующий пользователь) хочет поделиться ресурсом с другим пользователем (целевым *пользователем).* Записи аудита, связанные с совместным использованием ресурса с внешним пользователем (пользователем, который находится за пределами вашей организации и не имеет гостевой учетной записи в Azure Active Directory вашей организации) идентифицированы следующими событиями, зарегистрированными в журнале аудита:

- **SharingInvitationCreated:** Пользователь в организации попытался поделиться ресурсом (скорее всего, сайтом) с внешним пользователем. В результате целевому пользователю отправляется приглашение к внешнему совместному доступу. На этом этапе доступ к ресурсу не предоставляется.

- **SharingInvitationAccepted:** Внешний пользователь принял приглашение к совместному доступу, отправленный действующим пользователем, и теперь имеет доступ к ресурсу.

- **AnonymousLinkCreated:** Для ресурса создается анонимная ссылка (также называемая ссылкой "Любой"). Так как анонимную ссылку можно создать, а затем скопировать, разумно предположить, что к любому документу с анонимной ссылкой был общий доступ целевому пользователю.

- **AnonymousLinkUsed:** Как следует из названия, это событие регистрируется, когда для доступа к ресурсу используется анонимная ссылка. 

- **SecureLinkCreated:** Пользователь создал ссылку "определенные люди", чтобы поделиться ресурсом с определенным человеком. Этим целевым пользователем может быть пользователь, не влиявший на вашу организацию. В записи аудита для события **AddedToSecureLink** определен человек, с которого передается ресурс. Отметки времени для этих двух событий практически идентичны.

- **AddedToSecureLink:** Пользователь был добавлен в определенную ссылку для людей. Используйте поле **TargetUserOrGroupName** в этом событии, чтобы определить пользователя, добавленного в соответствующую ссылку определенного пользователя. Этим целевым пользователем может быть пользователь, не влиявший на вашу организацию.

## <a name="sharing-auditing-work-flow"></a>Общий доступ к потоку аудита
  
Когда пользователь (действующий пользователь) хочет поделиться ресурсом с другим пользователем (конечным пользователем), SharePoint (или OneDrive для бизнеса) сначала проверяет, связан ли адрес электронной почты целевого пользователя с учетной записью пользователя в каталоге организации. Если целевой пользователь находится в каталоге (и имеет соответствующую гостевую учетную запись), SharePoint делает следующее:
  
-  Немедленно назначает целевому пользователю разрешения на доступ к ресурсу, добавляя целевого пользователя в соответствующую группу SharePoint, и регистрируется событие **AddedToGroup.** 
    
- Отправляет уведомление о совместном использовании на адрес электронной почты целевого пользователя.
    
- Занося в **журнал событие SharingSet.** Это событие имеет удобное имя "Общий файл, папка или сайт" в разделе Действия "Общий доступ" и запрос доступа в средстве "Выбор действий" средства поиска в журнале аудита.  См. снимок экрана на [шаге 1.](#step-1-search-for-sharing-events-and-export-the-results-to-a-csv-file) 
    
Если учетная запись целевого пользователя не есть в каталоге, SharePoint делает следующее: 
    
   - Занося в журнал одно из следующих событий в зависимости от того, как ресурс является общим:
   
      - **AnonymousLinkCreated**
   
      - **SecureLinkCreated**
   
      - **AddedToSecureLink** 

      - **SharingInvitationCreated** (это событие регистрируется в журнале, только если общий ресурс является сайтом)
    
   - Когда целевой пользователь принимает отправленное ему приглашение к совместному доступу (щелкнув ссылку в приглашении), SharePoint зановит в журнал событие **SharingInvitationAccepted** и назначит целевому пользователю разрешения на доступ к ресурсу. Если целевому пользователю отправляется анонимная ссылка, событие **AnonymousLinkUsed** регистрируется после того, как целевой пользователь использует эту ссылку для доступа к ресурсу. Для безопасных ссылок событие **FileAccessed** регистрируется, когда внешний пользователь использует ссылку для доступа к ресурсу.

В журнал также занося дополнительные сведения о целевом пользователе, например удостоверение пользователя, которому предлагается приглашение, и пользователь, который принимает приглашение. В некоторых случаях эти пользователи (или адреса электронной почты) могут быть разными. 

## <a name="how-to-identify-resources-shared-with-external-users"></a>Определение ресурсов, доступ к ним для внешних пользователей

Обычно администраторам необходимо создать список всех ресурсов, к которые были общими пользователям за пределами организации. С помощью аудита общего доступа в Office 365 администраторы могут создать этот список. Ниже приведено описание процедуры.
  
### <a name="step-1-search-for-sharing-events-and-export-the-results-to-a-csv-file"></a>Шаг 1. Поиск событий общего доступа и экспорт результатов в CSV-файл

Первый шаг — поиск событий общего доступа в журнале аудита. Дополнительные сведения (включая необходимые разрешения) о поиске в журнале аудита см. в журнале аудита в Центре безопасности [& соответствия требованиям.](search-the-audit-log-in-security-and-compliance.md)
  
1. Перейдите по ссылке [https://protection.office.com](https://protection.office.com).
    
2. Выполните вход с помощью рабочей или учебной учетной записи.
    
3. В левой панели центра безопасности & центр соответствия требованиям выберите **Поиск**  > **Поиск по журналу аудита**.
    
    Откроется страница **Поиск в журнале аудита**. 
    
4. В **разделе "Действия"** щелкните **действия "Общий доступ" и "Запрос доступа"** для поиска событий, связанных с совместным доступом. 
    
    ![В разделе "Действия" выберите действия с запросами на общий доступ и доступ](../media/46bb25b7-1eb2-4adf-903a-cc9ab58639f9.png)
  
5.  Выберите диапазон дат и времени, чтобы найти события общего доступа, произошедшие за этот период. 
    
6. Нажмите **кнопку** "Поиск", чтобы запустить поиск. 
    
7. После завершения поиска и отображения результатов нажмите кнопку **"Экспорт результатов** \> **скачать все результаты".**
    
    После выбора варианта экспорта в нижней части окна будет предложено открыть или сохранить CSV-файл.
    
8. Нажмите  \> **кнопку "Сохранить как"** и сохраните CSV-файл в папку на локальном компьютере. 

### <a name="step-2-use-the-powerquery-editor-to-format-the-exported-audit-log"></a>Шаг 2. Форматирование экспортируемой журнала аудита с помощью редактора PowerQuery

Далее необходимо использовать функцию преобразования JSON в редакторе Power Query в Excel, чтобы разделить каждое свойство в столбце **AuditData** (состоящее из объекта JSON с несколькими свойствами) на собственный столбец. Это позволяет фильтровать столбцы для просмотра записей, связанных с совместным доступом

Пошаговые инструкции см. в пункте "Этап 2. Форматирование экспортированного журнала аудита с помощью редактора Power Query" в разделе [Экспорт, настройка и просмотр записей журнала аудита](export-view-audit-log-records.md#step-2-format-the-exported-audit-log-using-the-power-query-editor).

### <a name="step-3-filter-the-csv-file-for-resources-shared-with-external-users"></a>Шаг 3. Фильтрация CSV-файла для ресурсов, к ним внешним пользователям

Далее необходимо отфильтровать CSV-файл для различных событий общего доступа, описанных ранее в разделе событий общего доступа [SharePoint.](#sharepoint-sharing-events) Кроме того, можно отфильтровать **столбец TargetUserOrGroupType,** чтобы отобразить все записи, для которых значение этого свойства **— Guest.** 

После того как вы следуйте инструкциям на предыдущем шаге для подготовки CSV-файла с помощью редактора PowerQuery, сделайте следующее:
    
1. Откройте файл Excel, созданный на шаге 2. 

2. На **вкладке "Главная"** **щелкните "Сортировка & фильтра"** и выберите **"Фильтр".**
    
3. В списке **сортировки &** фильтра  в столбце "Операции" сберите все выбранные события, а затем выберите одно или несколько следующих событий, связанных с совместным доступом, и нажмите кнопку **"ОК".**
 
   - **SharingInvitationCreated**
   
   - **AnonymousLinkCreated**
   
   - **SecureLinkCreated**
   
   - **AddedToSecureLink** 
    
    Excel отображает строки выбранных событий.
    
4. Перейдите в столбец **TargetUserOrGroupType** и выберите его. 
    
5. В **списке сортировки & фильтра** сняйте все выбранные объекты, выберите **TargetUserOrGroupType:Guest** и нажмите кнопку **"ОК".**
    
    Теперь Excel отображает строки для событий общего доступа, а целевой пользователь находится за пределами вашей организации, так как внешние пользователи идентифицированы **значением TargetUserOrGroupType:Guest.** 
  
> [!TIP]
> Для отображаемой записи аудита столбец **ObjectId** определяет ресурс, к котором был общий доступ целевому пользователю; например. `ObjectId:https:\/\/contoso-my.sharepoint.com\/personal\/sarad_contoso_com\/Documents\/Southwater Proposal.docx`
