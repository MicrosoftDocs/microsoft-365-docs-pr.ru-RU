---
title: Шифрование с двойным ключом (DKE)
description: DKE позволяет защищать высокочувствительные данные, сохраняя полный контроль над ключом.
author: kccross
ms.author: krowley
manager: laurawi
ms.date: 01/29/2021
ms.topic: conceptual
ms.service: information-protection
audience: Admin
ms.reviewer: esaggese
localization_priority: Normal
ms.collection:
- M365-security-compliance
ms.openlocfilehash: 10b29220e49dcb5fda8b1f7d18e52e10513fc599
ms.sourcegitcommit: 30c3054004ddc9d6059c11d55577552aa2464810
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "50939660"
---
# <a name="double-key-encryption-for-microsoft-365"></a>Шифрование двойных ключей для Microsoft 365

> *Применяется к: Двойное шифрование ключей для Microsoft 365, [Microsoft 365 Compliance,](https://www.microsoft.com/microsoft-365/business/compliance-management) [Azure Information Protection](https://azure.microsoft.com/pricing/details/information-protection)*
>
> *Инструкции по: [клиент унифицированной маркировки Azure Information Protection для Windows](/azure/information-protection/faqs#whats-the-difference-between-the-azure-information-protection-classic-and-unified-labeling-clients)*
>
> *Описание службы: [Соответствие требованиям Microsoft 365](/office365/servicedescriptions/microsoft-365-service-descriptions/microsoft-365-tenantlevel-services-licensing-guidance/microsoft-365-security-compliance-licensing-guidance)*

Двойное шифрование ключей (DKE) использует два ключа для доступа к защищенного контента. Microsoft хранит один ключ в Microsoft Azure, а другой — у вас. Вы поддерживаете полный контроль над одним из ключей с помощью службы шифрования двойных ключей. Защита применяется с помощью клиента единой маркировки Azure Information Protection к вашему высокочувствительному контенту.

Шифрование двойных ключей поддерживает как облачные, так и локальное развертывание. Эти развертывания помогают гарантировать, что зашифрованные данные остаются непрозрачной везде, где хранятся защищенные данные.

Дополнительные сведения о корневых клавишах клиента по умолчанию, основанных на облачных решениях, см. в сведениях [Planning and implementing your Azure Information Protection tenant key.](/azure/information-protection/plan-implement-tenant-key)

## <a name="when-your-organization-should-adopt-dke"></a>Когда ваша организация должна принять DKE

Двойное шифрование ключей предназначено для наиболее конфиденциальных данных, которые подчиняются самым строгим требованиям защиты. DKE не предназначен для всех данных. В общем, для защиты только небольшой части общих данных используется шифрование двойных ключей. Перед развертыванием необходимо тщательно определить нужные данные для покрытия с помощью этого решения. В некоторых случаях может потребоваться сузить область действия и использовать другие решения для большинства данных, таких как Microsoft Information Protection с помощью ключей под управлением Майкрософт или BYOK. Этих решений достаточно для документов, которые не подлежат усиленной защите и нормативным требованиям. Кроме того, эти решения позволяют использовать самые мощные службы Office 365; службы, которые нельзя использовать с зашифрованным контентом DKE. Пример:

- Правила транспорта, в том числе анти-вредоносные программы и спам, которые требуют видимости вложения
- Microsoft Delve
- Обнаружение электронных данных (eDiscovery)
- Поиск и индексация контента
- Веб-приложения Office, включая функции совместной работы

Любые внешние приложения или службы, которые не интегрированы с DKE через SDK MIP, не смогут выполнять действия на зашифрованных данных.

Microsoft Information Protection SDK 1.7+ поддерживает шифрование двойных ключей; Приложения, которые интегрируются с нашим SDK, смогут аргументировать эти данные достаточными разрешениями и интеграцией на месте.

Мы рекомендуем организациям использовать возможности microsoft Information Protection (классификация и маркировка) для защиты большей части конфиденциальных данных и использовать DKE только для критически важных данных. Шифрование двойных ключей актуально для конфиденциальных данных в строго регулируемых отраслях, таких как финансовые службы и здравоохранение.

Если у организаций есть какие-либо из следующих требований, вы можете использовать DKE для защиты контента:

- Необходимо обеспечить, чтобы *только* вы могли расшифровать защищенный контент при любых обстоятельствах.
- Корпорация Майкрософт не должна иметь доступ к защищенным данным самостоятельно.
- У вас есть нормативные требования для удержания ключей в пределах географической границы. Все ключи, которые вы сохраняете для шифрования и расшифровки данных, сохраняются в центре обработки данных.

## <a name="system-and-licensing-requirements-for-dke"></a>Требования к системе и лицензированию для DKE

**Двойное шифрование ключей для Microsoft 365 поставляется** с Microsoft 365 E5. Если у вас нет лицензии Microsoft 365 E5, вы можете зарегистрироваться для [пробной пробной записи.](https://aka.ms/M365E5ComplianceTrial) Дополнительные сведения об этих лицензиях см. в руководстве по лицензированию [Microsoft 365](/office365/servicedescriptions/microsoft-365-service-descriptions/microsoft-365-tenantlevel-services-licensing-guidance/microsoft-365-security-compliance-licensing-guidance)для & соответствия требованиям.

**Azure Information Protection**. DKE работает с метами конфиденциальности и требует Azure Information Protection.

Метки чувствительности DKE доступны конечным пользователям с помощью ленты конфиденциальности в Office Desktop Apps. Установите эти необходимые условия на каждый клиентский компьютер, на котором необходимо защищать и потреблять защищенные документы.

**Microsoft Office для корпоративной** версии 2009 или более поздней версии (настольные версии Word, PowerPoint и Excel) в Windows.

**Azure Information Protection Unified Labeling Client** versions 2.7.93.0 or later. Скачайте и установите клиент единой маркировки из [центра загрузки Майкрософт.](https://www.microsoft.com/download/details.aspx?id=53018)

## <a name="supported-environments-for-storing-and-viewing-dke-protected-content"></a>Поддерживаемые среды для хранения и просмотра контента, защищенного от DKE

**Поддерживаемые приложения.** [Приложения Microsoft 365 для корпоративных](https://www.microsoft.com/microsoft-365/business/microsoft-365-apps-for-enterprise-product) клиентов в Windows, включая Word, Excel и PowerPoint.

**Поддержка контента в Интернете.** Вы можете хранить документы и файлы, защищенные с помощью шифрования двойных ключей в Интернете в Microsoft SharePoint и OneDrive для бизнеса. Перед отправкой в эти места необходимо маркировать и защищать документы и файлы с помощью DKE поддерживаемых приложений. Вы можете обмениваться зашифрованным контентом по электронной почте, но вы не можете просматривать зашифрованные документы и файлы в Интернете. Вместо этого необходимо просматривать защищенный контент с помощью поддерживаемых настольных приложений и клиентов на локальном компьютере.

## <a name="overview-of-deploying-dke"></a>Обзор развертывания DKE

Вы выполните эти общие действия, чтобы настроить DKE. После завершения этих действий конечные пользователи смогут защищать высокочувствительные данные с помощью шифрования двойных ключей.

1. Развертывание службы DKE, как описано в этой статье.

2. Создайте метку с двойным шифрованием ключей. Перейдите к защите информации в центре соответствия [требованиям Microsoft 365](https://compliance.microsoft.com) и создайте новую метку с двойным шифрованием ключей. См. [ограничение доступа к содержимому с помощью меток конфиденциальности для применения шифрования.](./encryption-sensitivity-labels.md)

3. Используйте метки шифрования двойных ключей. Защитите данные, выбрав метку Double Key Encrypted из ленты "Чувствительность" в Microsoft Office.

Существует несколько способов выполнения некоторых действий по развертыванию шифрования двойных ключей. В этой статье описаны подробные инструкции, чтобы менее опытные администраторы успешно развертывали службу. Если вам это удобно, вы можете использовать собственные методы.

## <a name="deploy-dke"></a>Развертывание DKE

В этой статье и видео развертывания Azure используется в качестве назначения развертывания для службы DKE. При развертывании в другом расположении необходимо предоставить собственные значения.

Просмотрите [видео развертывания шифрования](https://youtu.be/vDWfHN_kygg) двойных ключей, чтобы просмотреть пошаговую обзор концепций в этой статье. Видео занимает около 18 минут.

Вы выполните эти общие действия, чтобы настроить шифрование двойных ключей для вашей организации.

1. [Установка необходимых условий программного обеспечения для службы DKE](#install-software-prerequisites-for-the-dke-service)
1. [Клонировать репозиторий шифрования двух ключей GitHub](#clone-the-dke-github-repository)
1. [Изменение параметров приложения](#modify-application-settings)
1. [Создание тестовых ключей](#generate-test-keys)
1. [Сборка проекта](#build-the-project)
1. [Развертывание службы DKE и публикация магазина ключей](#deploy-the-dke-service-and-publish-the-key-store)
1. [Проверка развертывания](#validate-your-deployment)
1. [Регистрация магазина ключей](#register-your-key-store)
1. [Создание меток конфиденциальности с помощью DKE](#create-sensitivity-labels-using-dke)
1. [Включить DKE в клиенте](#enable-dke-in-your-client)
1. [Перенос защищенных файлов с меток HYOK на метки DKE](#migrate-protected-files-from-hyok-labels-to-dke-labels)

После этого можно шифровать документы и файлы с помощью DKE. Сведения см. в [материалах Apply sensitivity labels to your files and email in Office.](https://support.microsoft.com/office/2f96e7cd-d5a4-403b-8bd7-4cc636bae0f9)

### <a name="install-software-prerequisites-for-the-dke-service"></a>Установка необходимых условий программного обеспечения для службы DKE

Установите эти необходимые условия на компьютер, на котором необходимо установить службу DKE.

**.NET Core 3.1 SDK**. Скачайте и установите SDK из [Download .NET Core 3.1](https://dotnet.microsoft.com/download/dotnet-core/3.1).

**Visual Studio код**. Скачайте Visual Studio код из [https://code.visualstudio.com/](https://code.visualstudio.com) . После установки запустите Visual Studio код и выберите **расширения** \> **представления.** Установите эти расширения.

- C# для Visual Studio кода

- NuGet диспетчер пакетов

**Ресурсы Git**. Скачайте и установите один из следующих.

- [Git](https://git-scm.com/downloads)

- [Рабочий стол GitHub](https://desktop.github.com/)

- [GitHub Enterprise](https://github.com/enterprise)

**OpenSSL** Необходимо установить [OpenSSL для](https://slproweb.com/products/Win32OpenSSL.html) создания [тестовых ключей](#generate-test-keys) после развертывания DKE. Убедитесь, что вы правильно назовите его с пути переменных среды. Например, дополнительные сведения см. в материале "Добавление каталога установки в [https://www.osradar.com/install-openssl-windows/](https://www.osradar.com/install-openssl-windows/) PATH".

### <a name="clone-the-dke-github-repository"></a>Клонировать репозиторий DKE GitHub

Корпорация Майкрософт поставляет исходные файлы DKE в репозитории GitHub. Вы клонировали репозиторий для локальной сборки проекта для использования в организации. Репозиторий DKE GitHub расположен по адресу [https://github.com/Azure-Samples/DoubleKeyEncryptionService](https://github.com/Azure-Samples/DoubleKeyEncryptionService) .

Следующие инструкции предназначены для неопытных пользователей git или Visual Studio кода:

1. В браузере перейдите к: [https://github.com/Azure-Samples/DoubleKeyEncryptionService](https://github.com/Azure-Samples/DoubleKeyEncryptionService) .

2. В правой части экрана выберите **Код**. В вашей версии пользовательского интерфейса может быть кнопка **клонирования или скачивания.** Затем в выпадаемом фрагменте выберите значок копирования, чтобы скопировать URL-адрес в буфер обмена.

    Пример:

   > [!div class="mx-imgBorder"]
   > ![Клонировать репозиторий службы шифрования двойных ключей из GitHub](../media/dke-clone.png)

3. В Visual Studio выберите **палитру команд представления** и \>  выберите **Git: Clone**. Чтобы перейти к параметру в списке, начните вводить для фильтрации записей, а затем выберите его из `git: clone` выпадаемого. Пример:

   > [!div class="mx-imgBorder"]
   > ![Visual Studio код GIT:Clone](../media/dke-vscode-clone.png)

4. В текстовом окне вите URL-адрес, скопированный из Git, и выберите **Клон из GitHub.**

5. В **диалоговом окте Select Folder,** который отображается, просмотрите и выберите расположение для хранения репозитория. В запросе выберите **Открыть**.

    Репозиторий открывается в Visual Studio коде и отображает текущую ветвь Git в левом нижнем конце. Например, ветвь должна быть **основной**. Пример:

   ![Снимок экрана репо DKE в Visual Studio коде, отображающий главную ветвь](../media/dke-vscode-main-branch.jpg)

6. Если вы не в основном филиале, вам необходимо выбрать его. В Visual Studio коде выберите ветвь и **выберите** главную из списка ветвей, которые отображаются.

   > [!IMPORTANT]
   > Выбор основной ветви гарантирует, что у вас есть правильные файлы для создания проекта. Если вы не выберете правильную ветвь, развертывание не будет работать.

Теперь исходный репозиторий DKE настроен локально. Затем [измените параметры приложений](#modify-application-settings) для организации.

### <a name="modify-application-settings"></a>Изменение параметров приложения

Чтобы развернуть службу DKE, необходимо изменить следующие типы параметров приложений:

- [Параметры ключевого доступа](#key-access-settings)
- [Параметры клиента и ключей](#tenant-and-key-settings)

Вы измените параметры приложения в appsettings.jsфайле. Этот файл расположен в репо DoubleKeyEncryptionService, клонированном локально в магазине DoubleKeyEncryptionService\src\customer-key-store. Например, в Visual Studio коде можно просмотреть файл, как показано на следующем рисунке.

![Поиск appsettings.jsфайла для DKE.](../media/dke-appsettingsjson.png)

#### <a name="key-access-settings"></a>Параметры ключевого доступа

Выберите, следует ли использовать авторизацию электронной почты или роли. DKE поддерживает только один из этих методов проверки подлинности одновременно.

- **Авторизация электронной почты.** Позволяет вашей организации разрешить доступ к ключам только на основе адресов электронной почты.

- **Авторизация ролей**. Позволяет организации авторизировать доступ к клавишам на основе групп Active Directory и требует, чтобы веб-служба запрашивала LDAP.

**Настройка параметров доступа к ключам для DKE с помощью авторизации электронной почты**

1. Откройтеappsettings.js **файл** и найдите `AuthorizedEmailAddress` параметр.

2. Добавьте адрес электронной почты или адреса, которые необходимо авторизовать. Разделять несколько адресов электронной почты с двойными кавычками и запятой. Пример:

   ```json
   "AuthorizedEmailAddress": ["email1@company.com", "email2@company.com ", "email3@company.com"]
   ```

3. Найдите `LDAPPath` параметр и удалите текст между `If you use role authorization (AuthorizedRoles) then this is the LDAP path.` двойными кавычками. Оставьте двойные котировки на месте. Когда вы закончите, параметр должен выглядеть так.

   ```json
   "LDAPPath": ""
   ```

4. Найдите `AuthorizedRoles` параметр и удалите всю строку.

На этом изображении **показанappsettings.jsв** файле, правильно отформатированный для авторизации электронной почты.

   ![В appsettings.jsфайле отображается метод авторизации электронной почты](../media/dke-email-accesssetting.png)

**Настройка параметров доступа к ключам для DKE с помощью авторизации ролей**

1. Откройтеappsettings.js **файл** и найдите `AuthorizedRoles` параметр.

2. Добавьте имена групп Active Directory, которые необходимо авторизировать. Разделим несколько имен групп с двойными кавычками и запятой. Пример:

   ```json
   "AuthorizedRoles": ["group1", "group2", "group3"]
   ```

3. Найдите `LDAPPath` параметр и добавьте домен Active Directory. Пример:

   ```json
   "LDAPPath": "contoso.com"
   ```

4. Найдите `AuthorizedEmailAddress` параметр и удалите всю строку.

На этом изображении **показанappsettings.jsв** файле, правильно отформатированный для авторизации ролей.

   ![appsettings.jsв файле с указанием метода авторизации ролей](../media/dke-role-accesssetting.png)

#### <a name="tenant-and-key-settings"></a>Параметры клиента и ключей

Клиент DKE и параметры ключей находятся вappsettings.js **файле.**

**Настройка параметров клиента и ключей для DKE**

1. Откройтеappsettings.js **файл.**

2. Найдите `ValidIssuers` параметр и `<tenantid>` замените его ид клиента. Вы можете найти свой ID клиента, переехав на портал Azure и просмотрев [свойства клиента.](https://aad.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Properties) Пример:

   ```json
   "ValidIssuers": [
     "https://sts.windows.net/9c99431e-b513-44be-a7d9-e7b500002d4b/"
   ]
   ```

Найдите `JwtAudience` . Замените `<yourhostname>` имя хост-компьютера, на котором будет работать служба DKE. Пример:

  > [!IMPORTANT]
  > Значение должно `JwtAudience` точно совпадать с именем вашего хоста. При **отладе можно использовать localhost:5001.** Однако после отладки не забудьте обновить это значение до имени хост-сервера.

- `TestKeys:Name`. Введите имя ключа. Пример: `TestKey1`
- `TestKeys:Id`. Создайте GUID и введите его в качестве `TestKeys:ID` значения. Например, `DCE1CC21-FF9B-4424-8FF4-9914BD19A1BE`. Для случайного создания GUID можно использовать такой сайт, как [Генератор GUID](https://guidgenerator.com/) в Интернете.

На этом изображении показан правильный формат параметров клиента и ключей в **appsettings.js.** `LDAPPath` настраивается для авторизации ролей.

![Отображает правильные параметры клиента и ключей для DKE в appsettings.jsфайле.](../media/dke-appsettingsjson-tenantkeysettings.png)

### <a name="generate-test-keys"></a>Создание тестовых ключей

После определения параметров приложения вы будете готовы создавать общедоступные и закрытые тестовые ключи.

Для создания ключей:

1. Из меню "Пуск Windows" запустите командную подсказку OpenSSL.

2. Измените папку, в которой необходимо сохранить тестовые ключи. Файлы, которые вы создаете после выполнения действий в этой задаче, хранятся в одной папке.

3. Создание нового тестового ключа.

   ```console
   openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 365
   ```

4. Создание закрытого ключа.

   ```console
   openssl rsa -in key.pem -out privkeynopass.pem
   ```

5. Создание общедоступных ключей.

   ```console
   openssl rsa -in key.pem -pubout > pubkeyonly.pem
   ```

6. В текстовом редакторе откройте **pubkeyonly.pem**. Скопируйте все содержимое в **файле pubkeyonly.pem,** за исключением первой и последней строк, в разделappsettings.js`PublicPem` **файле.**

7. В текстовом редакторе откройте **privkeynopass.pem**. Скопируйте все содержимое в **файле privkeynopass.pem,** за исключением первой и последней строк, в разделappsettings.js`PrivatePem` **файла.**

8. Удалите все пробелы и новые линии как в разделах, `PublicPem` так и `PrivatePem` в разделах.

    > [!IMPORTANT]
    > При копировании этого контента не удаляйте данные PEM.

9. В Visual Studio коде просмотрите **файл Startup.cs.** Этот файл расположен в репо DoubleKeyEncryptionService, клонированном локально в DoubleKeyEncryptionService\src\customer-key-store\.

10. Найдите следующие строки:

    ```csharp
        #if USE_TEST_KEYS
        #error !!!!!!!!!!!!!!!!!!!!!! Use of test keys is only supported for testing,
        DO NOT USE FOR PRODUCTION !!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        services.AddSingleton<ippw.IKeyStore, ippw.TestKeyStore>();
        #endif
    ```

11. Замените эти строки следующим текстом:

    ```csharp
    services.AddSingleton<ippw.IKeyStore, ippw.TestKeyStore>();
    ```

    Конечные результаты должны выглядеть так же, как и следующие.

    ![файл startup.cs для общего просмотра](../media/dke-startupcs-usetestkeys.png)

Теперь вы готовы к созданию [проекта DKE.](#build-the-project)

### <a name="build-the-project"></a>Построение проекта

Для локальной сборки проекта DKE используйте следующие инструкции:

1. В Visual Studio коде в репозитории службы DKE выберите **палитру** команд представления и введите сборку \>  по  запросу.

2. Из списка выберите **Задачи: Выполнить задачу сборки.**

   Если задачи сборки не найдены, выберите **Настройте** задачу сборки и создайте ее для ядра .NET следующим образом.

   ![Настройка отсутствующих задач сборки для .NET](../media/dke-configurebuildtask.png)

   1. Выберите **Создать tasks.jsиз шаблона**.

      ![Создание tasks.jsфайла из шаблона для DKE](../media/dke-createtasksjsonfromtemplate.png)

   2. Из списка типов шаблонов выберите **.NET Core**.

      ![Выберите правильный шаблон для DKE](../media/dke-tasksjsontemplate.png)

   3. В разделе сборка найдите путь к **файлу customerkeystore.csproj.** Если его нет, добавьте следующую строку:

      ```json
      "${workspaceFolder}/src/customer-key-store/customerkeystore.csproj",
      ```

   4. Запустите сборку снова.

3. Убедитесь, что в окне вывода нет красных ошибок.

   При красных ошибках проверьте выход консоли. Убедитесь, что вы выполнили все предыдущие действия правильно и правильные версии сборки присутствуют.

4. Выберите **отладку** запуска запуска для \>  отладки процесса. Если вам предложено выбрать среду, выберите **ядро .NET.**

   Отладка ядра .NET обычно запускается в `https://localhost:5001` . Чтобы просмотреть тестовый ключ, перейдите к и придайте форвардную полосу `https://localhost:5001` (/) и имя ключа. Пример:

   ```https
   https://localhost:5001/TestKey1
   ```

   Ключ должен отображаться в формате JSON.

Ваша настройка завершена. Перед публикацией магазина ключей в appsettings.jsв параметре JwtAudience убедитесь, что значение имени хост-имени точно соответствует имени хост-службы приложения. Возможно, вы изменили его на localhost для устранения неполадок сборки.

### <a name="deploy-the-dke-service-and-publish-the-key-store"></a>Развертывание службы DKE и публикация магазина ключей

Для развертывания производства разверни службу либо в сторонном облаке, либо опубликуй в [локальной системе.](/aspnet/core/tutorials/publish-to-iis?preserve-view=true&tabs=netcore-cli&view=aspnetcore-3.1)

Вы можете использовать другие методы для развертывания ключей. Выберите метод, который лучше всего работает для вашей организации.

В пилотных развертываниях можно развернуться в Azure и сразу же начать работу.

**Создание экземпляра Azure Web App для размещения развертывания DKE**

Чтобы опубликовать хранилище ключей, создадим экземпляр службы приложений Azure для размещения развертывания DKE. Далее вы опубликуйте созданные ключи в Azure.

1. В браузере войдите на портал [Microsoft Azure](https://ms.portal.azure.com)и перейдите к добавлению **служб**  >  **Приложений.**

2. Выберите подписку и группу ресурсов и определите сведения об экземпляре.

   - Введите имя хозяина компьютера, на котором необходимо установить службу DKE. Убедитесь, что это то же имя, что и имя, определенное для параметра JwtAudience вappsettings.js [**файле.**](#tenant-and-key-settings) Значение, которое вы предоставляете для имени, также является WebAppInstanceName.

   - Для **публикации** выберите **код** и стек **runtime** выберите **.NET Core 3.1**.

   Пример:

   > [!div class="mx-imgBorder"]
   > ![Добавление службы приложений](../media/dke-azure-add-app-service.png)

3. В нижней части страницы выберите **Обзор + создайте,** а затем выберите **Добавить**.

4. У одного из следующих публикации созданных ключей:

   - [Публикация с помощью ZipDeployUI](#publish-via-zipdeployui)
   - [Публикация с помощью FTP](#publish-via-ftp)
   - [Публикация в Visual Studio 2019 г. или более поздней](/aspnet/core/tutorials/)

#### <a name="publish-via-zipdeployui"></a>Публикация с помощью ZipDeployUI

1. Перейдите на сайт `https://<WebAppInstanceName>.scm.azurewebsites.net/ZipDeployUI`.

   Пример: https://dkeservice.scm.azurewebsites.net/ZipDeployUI

2. В базе кода для магазина ключей перейдите в папку **customer-key-store\src\customer-key-store** и убедитесь, что эта папка содержит файл **customerkeystore.csproj.**

3. Запуск: **публикация dotnet**

   В окне вывода отображается каталог, в котором была развернута публикация.

   Пример: `customer-key-store\src\customer-key-store\bin\Debug\netcoreapp3.1\publish\`

4. Отправьте все файлы в каталог публикации в файл .zip. При создании файла .zip убедитесь, что все файлы в каталоге находятся на корневом уровне файла .zip.

5. Перетащите и сбросите файл .zip, который вы создаете, на открытый выше сайт ZipDeployUI. Пример: https://dkeservice.scm.azurewebsites.net/ZipDeployUI

Развертывается DKE, и вы можете просмотреть созданные тестовые ключи. Продолжить [проверку развертывания ниже.](#validate-your-deployment)

#### <a name="publish-via-ftp"></a>Публикация с помощью FTP

1. Подключение к созданной выше службе [приложений.](#deploy-the-dke-service-and-publish-the-key-store)

   В браузере перейдите к панели **мониторинга**  >    >    >    >  **ftP-мониторинга**  >  развертывания центра ручного развертывания службы приложений Azure.

2. Скопируйте строки подключения, отображаемые в локальном файле. Вы будете использовать эти строки для подключения к службе веб-приложений и отправки файлов с помощью FTP.

   Пример:

   ![Копирование строк подключения с панели мониторинга FTP](../media/dke-ftp-dashboard.png)

3. В базе кода для хранилища ключей перейдите в каталог магазина ключа **клиента\src\customer-key-store.**

4. Убедитесь, что этот каталог содержит **файл customerkeystore.csproj.**

5. Запуск: **публикация dotnet**

   Вывод содержит каталог, в котором была развернута публикация.

   Пример: `customer-key-store\src\customer-key-store\bin\Debug\netcoreapp3.1\publish\`

6. Отправьте все файлы в каталоге публикации в почтовый файл. При создании файла .zip убедитесь, что все файлы в каталоге находятся на корневом уровне файла .zip.

7. В клиенте FTP используйте скопированные сведения о подключении к службе приложений. Загрузите файл .zip, созданный на предыдущем шаге, в корневой каталог веб-приложения.

Развертывается DKE, и вы можете просмотреть созданные тестовые ключи. Далее проверьте [развертывание.](#validate-your-deployment)

### <a name="validate-your-deployment"></a>Проверка развертывания

После развертывания DKE с помощью одного из описанных выше методов проверьте параметры развертывания и хранения ключей.

Выполните команду: 

```powershell
src\customer-key-store\scripts\key_store_tester.ps1 dkeserviceurl/mykey
```

Пример:

```powershell
key_store_tester.ps1 https://mydkeservice.com/mykey
```

Убедитесь, что в выходе не отображаются ошибки. Когда вы будете готовы, [зарегистрируйте свой магазин ключей.](#register-your-key-store)

Ключевое имя — деликатный случай. Введите имя ключа, как оно отображается в appsettings.jsфайле.

## <a name="register-your-key-store"></a>Регистрация магазина ключей

Следующие действия позволяют зарегистрировать службу DKE. Регистрация службы DKE — это последний шаг в развертывании DKE перед началом создания меток.

Чтобы зарегистрировать службу DKE:

1. В браузере откройте портал [Microsoft Azure](https://ms.portal.azure.com/)  и перейдите на регистрацию приложений идентификации \>  \> **всех служб.**

2. Выберите **новую регистрацию** и введите содержательное имя.

3. Выберите тип учетной записи из отображаемого параметра.

   Если вы используете Microsoft Azure с нестандартным доменом, например **onmicrosoft.com,** выберите учетные записи только в этом организационном каталоге **(только Microsoft - Один клиент).**

   Пример:

   > [!div class="mx-imgBorder"]
   > ![Регистрация новых приложений](../media/dke-app-registration.png)

4. В нижней части страницы выберите **Регистрация** для создания новой регистрации приложений.

5. В новой регистрации приложений в левой области в **статье Управление** выберите **проверку подлинности.**

6. Выберите **Добавить платформу.**

7. В **всплывающее всплывающее всплывающее устройство** Настройка платформ выберите **Веб.**

8. В **статье Перенаправление** URL-адресов введите URI службы шифрования двойных ключей. Введите URL-адрес службы приложений, включая имя и домен хост-сайта.

   Пример: https://mydkeservicetest.com

   - Url-адрес, который вы вводите, должен соответствовать имени хост-адреса, в котором развернута служба DKE.
   - Если вы тестируете локально с Visual Studio, используйте **https://localhost:5001** .
   - Во всех случаях схема должна быть **https**.

   Убедитесь, что имя хост-хозяйки точно соответствует имени хост-имени службы приложений. Возможно, вы изменили его на `localhost` устранение неполадок сборки. В **appsettings.js,** это значение является имям хост-код, заданной `JwtAudience` для .

9. В **рамках неявного** гранта выберите почтовый ящик **маркеров ID.**

10. Нажмите кнопку **Сохранить**, чтобы сохранить изменения.

11. На левой области выберите **Expose aPI,** а затем рядом с URI ID приложения выберите **Set**.

12. Все еще на странице **Expose aPI** в области, определенные этой областью **API,** выберите **Добавить область**. В новой области:

    1. Определите имя области **как user_impersonation**.

    2. Выберите администраторов и пользователей, которые могут дать согласие.

    3. Определите все необходимые оставшиеся значения.

    4. Нажмите кнопку **Добавить область**.

    5. Выберите **Сохранить** в верхней части, чтобы сохранить изменения.

13. Все еще на странице **Expose aPI** в области **авторизованного** клиентского приложения выберите **Добавить клиентскую заявку.**

    В новом клиентской приложении:

    1. Определите ИД клиента как `d3590ed6-52b3-4102-aeff-aad2292ab01c` . Это значение является Microsoft Office и позволяет Office получить маркер доступа для вашего магазина ключей.

    2. В **уполномоченных сферах** выберите область **user_impersonation** области.

    3. Нажмите кнопку **Добавить приложение**.

    4. Выберите **Сохранить** в верхней части, чтобы сохранить изменения.

    5. Повторите эти действия, но на этот раз определите ИД клиента как `c00e9d32-3c8d-4a7d-832b-029040e7db99` . Это значение — унифицированный ИД клиента azure Information Protection. 

Ваша служба DKE теперь зарегистрирована. Продолжить создание [меток с помощью DKE](#create-sensitivity-labels-using-dke).

## <a name="create-sensitivity-labels-using-dke"></a>Создание меток конфиденциальности с помощью DKE

В центре соответствия требованиям Microsoft 365 создайте новую метку конфиденциальности и применяйте шифрование так, как в противном случае. Выберите **использование двойного шифрования** ключей и введите URL-адрес конечной точки для ключа.

Пример:

> [!div class="mx-imgBorder"]
> ![Выберите использование шифрования двойных ключей в центре соответствия требованиям Microsoft 365](../media/dke-use-dke.png)

Все добавленные метки DKE начнут отображаться для пользователей в последних версиях Microsoft 365 Apps для предприятия.

> [!NOTE]
> Обновление новых меток может занять до 24 часов.

### <a name="enable-dke-in-your-client"></a>Включить DKE в клиенте

Если вы инсайдер Office, DKE включен для вас. В противном случае включить DKE для клиента, добавив следующие клавиши реестра:

```console
   [HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\MSIPC\flighting]
   "DoubleKeyProtection"=dword:00000001

   [HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\MSIPC\flighting]
   "DoubleKeyProtection"=dword:00000001
```

## <a name="migrate-protected-files-from-hyok-labels-to-dke-labels"></a>Перенос защищенных файлов с меток HYOK на метки DKE

Если вы хотите, по завершению настройки DKE можно перенести защищенный контент с помощью меток HYOK на метки DKE. Для миграции используется сканер AIP. Чтобы начать работу со сканером, см. в этой ленте "Что такое сканер единой маркировки [Azure Information Protection"?](/azure/information-protection/deploy-aip-scanner).

Если вы не переносите контент, защищенный контент HYOK останется без изменений.
