---
title: Настройка ключа клиента
ms.author: krowley
author: kccross
manager: laurawi
audience: ITPro
ms.topic: article
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- MET150
ms.collection:
- M365-security-compliance
description: Узнайте, как настроить ключ клиента для Microsoft 365.
ms.openlocfilehash: e187c01a355cc9b926e892cb3326b5a527c714a4
ms.sourcegitcommit: 94e64afaf12f3d8813099d8ffa46baba65772763
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/12/2021
ms.locfileid: "52344678"
---
# <a name="set-up-customer-key"></a>Настройка ключа клиента

С помощью ключа клиента вы управляете ключами шифрования организации, а затем Microsoft 365 использовать их для шифрования данных в центрах обработки данных Майкрософт. Другими словами, клиентский ключ позволяет клиентам добавлять принадлежащий им уровень шифрования с помощью ключей.

Настройка Azure перед использованием ключа клиента для Office 365. В этой статье описываются действия, которые необходимо предпринять для создания и настройки необходимых ресурсов Azure, а затем описываются действия по настройке ключа клиента в Office 365. После настройка Azure определите, какую политику и, следовательно, какие ключи назначить для шифрования данных по различным Microsoft 365 рабочих нагрузок в организации. Дополнительные сведения о ключе клиента или общем обзоре см. в сообщении [Service encryption with Customer Key in Office 365.](customer-key-overview.md)
  
> [!IMPORTANT]
> Мы настоятельно рекомендуем вам следовать рекомендациям в этой статье. Они называются **TIP и** **IMPORTANT**. Ключ клиента позволяет управлять ключами корневого шифрования, область которых может быть не больше всей организации. Это означает, что ошибки, допущенные с помощью этих ключей, могут иметь широкий эффект и привести к перебоям в работе службы или к безвозвратной потере данных.
  
## <a name="before-you-set-up-customer-key"></a>Перед настройками ключа клиента

Перед началом работы убедитесь, что у вас есть соответствующие подписки и лицензирование Azure для вашей организации. Используйте платные подписки Azure с Соглашение Enterprise или поставщика облачных служб. Платежи на основе кредитных карт не принимаются. Утверждение и настройка потребностей учетной записи для вычета. Подписки, которые вы получили через бесплатные, пробные, спонсорские, msDN-подписки, а также подписки, которые находятся под поддержкой Legacy, не имеют права.

Office 365 E5, Microsoft 365 E5, Соответствие требованиям Microsoft 365 E5 и Microsoft 365 E5 защиты & управления skUs предлагают ключ клиента. Office 365 Advanced Compliance SKU больше не доступен для получения новых лицензий. Существующие Office 365 Advanced Compliance лицензии будут по-прежнему поддерживаться.

Чтобы понять понятия и процедуры в этой статье, просмотрите документацию [Azure Key Vault.](/azure/key-vault/) Кроме того, ознакомьтесь с терминами, используемыми в Azure, например, [клиентом Azure AD.](/previous-versions/azure/azure-services/jj573650(v=azure.100)#what-is-an-azure-ad-tenant)
  
Если требуется больше поддержки за пределами документации, обратитесь за помощью к Microsoft Consulting Services (MCS), Premier Field Engineering (PFE) или партнеру Майкрософт. Чтобы предоставить отзывы о ключе клиента, включая документацию, отправьте свои идеи, предложения и перспективы в customerkeyfeedback@microsoft.com.
  
## <a name="overview-of-steps-to-set-up-customer-key"></a>Обзор действий по настройкам ключа клиента

Чтобы настроить ключ клиента, выполните эти задачи в перечисленом порядке. В остальной части этой статьи данная статья содержит подробные инструкции для каждой задачи или ссылается на дополнительные сведения для каждого шага процесса.
  
**В Azure и Microsoft FastTrack:**
  
Большинство этих задач вы выполните, удаленно подключившись к Azure PowerShell. Для наилучших результатов используйте версию 4.4.0 или более поздний Azure PowerShell.
  
- [Создание двух новых подписок Azure](#create-two-new-azure-subscriptions)

- [Отправьте запрос на активацию ключа клиента для Office 365](#submit-a-request-to-activate-customer-key-for-office-365)
 
- [Регистрация подписки Azure для использования обязательного периода хранения](#register-azure-subscriptions-to-use-a-mandatory-retention-period)

  Регистрация может занять от одного до пяти бизнес-дней.

- [Создание хранилища ключей Azure премиум класса в каждой подписке](#create-a-premium-azure-key-vault-in-each-subscription)

- [Назначение разрешений для каждого хранилища ключей](#assign-permissions-to-each-key-vault)

- [Убедитесь, что в хранилищах ключей включено мягкое удаление](#make-sure-soft-delete-is-enabled-on-your-key-vaults)

- [Добавление ключа в каждый хранилище ключей путем создания или импорта ключа](#add-a-key-to-each-key-vault-either-by-creating-or-importing-a-key)

- [Проверьте уровень восстановления ключей](#check-the-recovery-level-of-your-keys)

- [Back up Azure Key Vault](#back-up-azure-key-vault)

- [Проверка параметров конфигурации хранилища ключей Azure](#validate-azure-key-vault-configuration-settings)

- [Получение URI для каждого ключа Azure Key Vault](#obtain-the-uri-for-each-azure-key-vault-key)
  
## <a name="complete-tasks-in-azure-key-vault-and-microsoft-fasttrack-for-customer-key"></a>Выполнение задач в хранилище ключей Azure и Microsoft FastTrack для ключа клиента

Выполните эти задачи в Хранилище ключей Azure. Вам потребуется выполнить эти действия для всех dePs, которые вы используете с помощью ключа клиента.
  
### <a name="create-two-new-azure-subscriptions"></a>Создание двух новых подписок Azure

Для ключа клиента требуется две подписки Azure. В качестве наилучшей практики Корпорация Майкрософт рекомендует создавать новые подписки Azure для использования с помощью ключа клиента. Ключи хранилища ключей Azure можно разрешить только для приложений в том же клиенте Azure Active Directory (Microsoft Azure Active Directory), необходимо создать новые подписки с помощью того же клиента Azure AD, используемого в организации, где будут назначены dePs. Например, использование учетной записи для работы или учебного заведения с глобальными привилегиями администратора в организации. Подробные действия см. [в документе Sign up for Azure as an organization.](/azure/active-directory/fundamentals/sign-up-organization)
  
> [!IMPORTANT]
> Ключ клиента требует двух ключей для каждой политики шифрования данных (DEP). Для этого необходимо создать две подписки Azure. В качестве наилучшей практики Корпорация Майкрософт рекомендует, чтобы отдельные члены организации настраивали один ключ в каждой подписке. Эти подписки Azure следует использовать только для администрирования ключей шифрования для Office 365. Это защищает организацию, если один из операторов случайно, намеренно или злонамеренно удаляет или иным образом неправильно передает ключи, за которые они несут ответственность.

Практические ограничения на количество подписок Azure, которые можно создать для вашей организации, не ограничиваются. Следуя этим лучшим практикам, свести к минимуму влияние человеческой ошибки, помогая управлять ресурсами, используемыми клиентской клавишей.
  
### <a name="submit-a-request-to-activate-customer-key-for-office-365"></a>Отправьте запрос на активацию ключа клиента для Office 365

После создания двух новых подписок Azure необходимо отправить соответствующий запрос на предложение ключа клиента на [портале Microsoft FastTrack.](https://fasttrack.microsoft.com/) Выборы, которые вы делаете в форме предложения о авторизованном обозначении в вашей организации, имеют решающее значение и необходимы для завершения регистрации клиентского ключа. Сотрудники в выбранных ролях в организации обеспечивают подлинность любого запроса на отвод и уничтожение всех ключей, используемых с помощью политики шифрования данных "Ключ клиента". Этот шаг необходимо сделать один раз для каждого типа DEP ключа клиента, который вы собираетесь использовать для организации.

**Команда FastTrack не предоставляет помощь с ключом клиента. Office 365 просто использует портал FastTrack для отправки формы и отслеживания соответствующих предложений для клиента. После отправки запроса FastTrack вы можете связаться с соответствующей командой бортового ключа клиента, чтобы запустить процесс бортовой обработки.**
  
Чтобы отправить предложение по активации ключа клиента, выполните следующие действия:
  
1. Используя учетную запись для работы или школы, которая имеет глобальные разрешения администратора в организации, вопишитесь на [портал Microsoft FastTrack.](https://fasttrack.microsoft.com/)

2. После входа в систему выберите соответствующий домен.

3. Для выбранного домена выберите **службы запроса** из верхней панели навигации и просмотрите список доступных предложений.

4. Выберите информационную карточку для предложения, которое применяется к вам:

   - **Несколько Microsoft 365 рабочих нагрузок:** Выберите **справку по шифрованию запроса для Microsoft 365** предложения.

   - **Exchange Online и Skype для бизнеса:** Выберите **справку по шифрованию запроса для Exchange** предложения.

   - **SharePoint, OneDrive и Teams файлы:** Выберите **справку по шифрованию** запроса для SharePoint и OneDrive для бизнеса предложения.

5. После просмотра сведений о предложении выберите **Продолжить шаг 2**.

6. Заполните все применимые сведения и запрашиваемые сведения в форме предложения. Уделите особое внимание выборам, для которых сотрудникам вашей организации необходимо разрешить постоянное и необратимое уничтожение ключей шифрования и данных. После завершения формы выберите **Отправить**.

### <a name="register-azure-subscriptions-to-use-a-mandatory-retention-period"></a>Регистрация подписки Azure для использования обязательного периода хранения

Временная или постоянная потеря ключей корневого шифрования может привести к нарушению работы службы или даже к катастрофическим последствиям, что может привести к потере данных. По этой причине ресурсы, используемые с ключом клиента, требуют сильной защиты. Все ресурсы Azure, используемые с помощью ключа клиента, предлагают механизмы защиты за пределами конфигурации по умолчанию. Вы можете отметить или зарегистрировать подписки Azure на *обязательный период хранения.* Обязательный период хранения не позволяет немедленно и безвозвратно отменить подписку на Azure. Действия, необходимые для регистрации подписки Azure на обязательный период хранения, требуют совместной работы с Microsoft 365 командой. Этот процесс может занять от одного до пяти бизнес-дней. Ранее обязательный период хранения иногда назывался "Не отменять".
  
Прежде чем связаться с Microsoft 365, необходимо сделать следующие действия для каждой подписки Azure, используемой с помощью клиентского ключа. Убедитесь, что [перед началом Azure PowerShell установлен модуль Az.](/powershell/azure/new-azureps-module-az)
  
1. Во входе Azure PowerShell. Инструкции см. в [Azure PowerShell.](/powershell/azure/authenticate-azureps)

2. Запустите Register-AzProviderFeature для регистрации подписок, чтобы использовать обязательный период хранения. Выполните это действие для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Register-AzProviderFeature -FeatureName mandatoryRetentionPeriodEnabled -ProviderNamespace Microsoft.Resources
   ```

3. Свяжитесь с Корпорацией Майкрософт, чтобы завершить этот процесс.

   - Для включения ключа клиента для назначения deP отдельным почтовым Exchange Online почтовым ящикам свяжитесь с [exock@microsoft.com](mailto:exock@microsoft.com).

   - Для включения ключа клиента для назначения dePs для шифрования SharePoint Online и OneDrive для бизнеса контента (в том числе Teams файлов) для всех пользователей клиента, свяжитесь с spock@microsoft.com [.](mailto:spock@microsoft.com)

   - Для включения ключа клиента для назначения dePs для шифрования контента в нескольких Microsoft 365 рабочих нагрузках (Exchange Online, Teams, MIP EDM) для всех пользователей-клиентов свяжитесь с [m365-ck@service.microsoft.com](mailto:m365-ck@service.microsoft.com).

- Включите в электронную почту следующие сведения:

   **Тема:** Ключ клиента для \<*Your tenant's fully qualified domain name*\>

   **Body.** Включай подписные ИД, для которых необходимо завершить обязательный период хранения, и Get-AzProviderFeature для каждой подписки.

   Соглашение об уровне обслуживания (SLA) для завершения этого процесса составляет пять бизнес-дней после уведомления (и проверки) Корпорации Майкрософт о том, что вы зарегистрировали подписки для использования обязательного периода хранения.

4. После получения уведомления от Корпорации Майкрософт о том, что регистрация завершена, проверьте состояние вашей регистрации, Get-AzProviderFeature команду следующим образом. В случае проверки Get-AzProviderFeature возвращает значение **Registered** for the **Registration State** property. Выполните этот шаг для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Get-AzProviderFeature -ProviderNamespace Microsoft.Resources -FeatureName mandatoryRetentionPeriodEnabled
   ```

5. Чтобы завершить процесс, выполните команду Register-AzResourceProvider. Выполните этот шаг для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Register-AzResourceProvider -ProviderNamespace Microsoft.KeyVault
   ```

### <a name="create-a-premium-azure-key-vault-in-each-subscription"></a>Создание хранилища ключей Azure премиум класса в каждой подписке

Действия по созданию хранилища ключей описаны в журнале [Getting Started with Azure Key Vault,](/azure/key-vault/general/overview)который поможет вам установить и запустить Azure PowerShell, подключиться к подписке Azure, создать группу ресурсов и создать хранилище ключей в этой группе ресурсов.
  
При создании хранилища ключей необходимо выбрать SKU: стандартный или Premium. Стандартный SKU позволяет защищать ключи хранилища ключей Azure с помощью программного обеспечения , не существует защиты ключей модуля безопасности оборудования (HSM), а Premium SKU позволяет использовать HSM для защиты ключей Vault. Ключ клиента принимает ключевые хранилища, которые используют либо SKU, но Корпорация Майкрософт настоятельно рекомендует использовать только Premium SKU. Стоимость операций с ключами обоих типов одна и та же, поэтому единственной разницей в стоимости является стоимость в месяц для каждого ключа, защищенного HSM. Подробные [сведения см. в расценки Key Vault.](https://azure.microsoft.com/pricing/details/key-vault/)
  
> [!IMPORTANT]
> Используйте хранилища Premium SKU и защищенные HSM-ключи для производственных данных, а для тестирования и проверки используйте только ключевые хранилища и ключи standard SKU.
  
Для каждой Microsoft 365 службы, с помощью которой вы будете использовать ключ клиента, создайте хранилище ключей в каждой из двух созданных вами подписок Azure. Например, чтобы включить ключ клиента для использования dePs для сценариев Exchange Online, SharePoint Online и нескольких рабочих нагрузок, вы создайте три пары ключевых сводов.
  
Используйте конвенцию именования для ключевых сводов, которая отражает предназначенное использование deP, с которым вы будете связывать хранилища. Ниже см. раздел Рекомендации по рекомендациям по найму конвенции.
  
Создайте отдельный парный набор сводов для каждой политики шифрования данных. Для Exchange Online область политики шифрования данных выбирается вами при назначении политики почтовому ящику. В почтовом ящике может быть назначена только одна политика, и можно создать до 50 политик. Область политики SharePoint Online включает все данные в организации в географическом расположении или _в geo_. Область для политики с несколькими рабочими нагрузками включает все данные по поддерживаемой рабочей нагрузке для всех пользователей.

Создание ключевых сводов также требует создания групп ресурсов Azure, так как ключевые хранилища нуждаются в емкости хранения (хотя и небольшой), а ведение журнала Key Vault, если включено, также создает хранимые данные. В качестве наилучшей практики Корпорация Майкрософт рекомендует использовать отдельных администраторов для управления каждой группой ресурсов с администрированием, которое соответствует набору администраторов, которые будут управлять всеми связанными ресурсами клиентского ключа.
  
> [!IMPORTANT]
> Чтобы обеспечить максимальную доступность, раз поместите ключевые хранилища в регионах, близких к службе Microsoft 365, например, если ваша Exchange Online организация находится в Северной Америке, поместите ключевые хранилища в Северной Америке. Если ваша Exchange Online организация находится в Европе, поместите ключевые хранилища в Европе.
>
> Используйте общую префикс для ключевых сводов и включаем аббревиатура использования и области ключей и сводов ключей (например, для службы Contoso SharePoint, где хранилища будут располагаться в Северной Америке, возможной парой имен являются Contoso-CK-SP-NA-VaultA1 и Contoso-CK-SP-NA-VaultA2. Имена Vault — это уникальные строки в Azure, поэтому вам может потребоваться попробовать варианты желаемых имен, если нужные имена уже заявлены другими клиентами Azure. По данным на июль 2017 г. имена хранилища не могут быть изменены, поэтому лучше всего иметь письменный план установки и использовать второго человека для проверки правильности выполнения плана.
>
> По возможности создайте хранилища в непарных регионах. В парных регионах Azure обеспечивается высокая доступность для доменов сбоя службы. Поэтому региональные пары можно использовать как область резервного копирования друг друга. Это означает, что ресурс Azure, размещенный в одном регионе, автоматически получает переносимость ошибок через спаривную область. По этой причине выбор регионов для двух сводов, используемых в политике шифрования данных, где регионы сопряжены, означает, что используется только два региона доступности. В большинстве географических регионов только два региона, поэтому выбрать непарные регионы пока невозможно. По возможности выберите два непарных региона для двух сводов, используемых с политикой шифрования данных. Это дает в общей сложности четыре региона доступности. Дополнительные сведения см. в дополнительных сведениях о непрерывности бизнеса и аварийном восстановлении [(BCDR): Azure Paired Regions](/azure/best-practices-availability-paired-regions) для текущего списка региональных пар.
  
### <a name="assign-permissions-to-each-key-vault"></a>Назначение разрешений для каждого хранилища ключей

В зависимости от реализации необходимо определить три отдельных набора разрешений для каждого хранилища ключей. Например, необходимо определить один набор разрешений для каждого из следующих ниже.
  
- **Администраторы ключей хранилища,** которые ежедневно руководствуют вашим хранилищем ключей для вашей организации. Эти задачи включают резервное копирование, создание, получения, импорт, список и восстановление.

  > [!IMPORTANT]
  > Набор разрешений, присвоенных администраторам ключей хранилища, не включает разрешение на удаление ключей. Это является преднамеренной и важной практикой. Удаление ключей шифрования обычно не делается, так как это постоянно уничтожает данные. В качестве наилучшей практики не предоставлять это разрешение администраторам хранилища по умолчанию. Вместо этого зарезервировать это для ключевых участников хранилища и назначить его администратору только на краткосрочной основе после четкого понимания последствий.
  
  Чтобы назначить эти разрешения пользователю в организации, впишитесь в подписку Azure с Azure PowerShell. Инструкции см. в [Azure PowerShell.](/powershell/azure/authenticate-azureps)

- Запустите Set-AzKeyVaultAccessPolicy, чтобы назначить необходимые разрешения.

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName <vault name> -UserPrincipalName <UPN of user> -PermissionsToKeys create,import,list,get,backup,restore
   ```

   Например:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName Contoso-CK-EX-NA-VaultA1 -UserPrincipalName alice@contoso.com -PermissionsToKeys create,import,list,get,backup,restore
   ```

- **Ключевые вкладчики хранилища,** которые могут изменять разрешения в самом хранилище ключей Azure. Эти разрешения необходимо изменить по мере того, как сотрудники покидают команду или присоединяются к ней. В редких случаях, когда администраторам ключей хранилища на законных основаниях требуется разрешение на удаление или восстановление ключа, необходимо также изменить разрешения. Этот набор ключевых участников хранилища должен быть предоставлен роль **Contributor** в вашем хранилище ключей. Эту роль можно назначить с помощью Azure Resource Manager. Подробные действия см. в Role-Based Access Control для управления доступом [к ресурсам подписки Azure.](/azure/active-directory/role-based-access-control-configure) Администратор, создавший подписку, имеет этот доступ неявно, а также возможность назначать другим администраторам роль Автора.

- **Разрешения** на Microsoft 365 для каждого хранилища ключей, которые вы используете для ключа клиента, необходимо предоставить wrapKey, unwrapKey и получить разрешения соответствующему Microsoft 365 директору службы. 

Чтобы разрешить Microsoft 365 службы, запустите комлет **Set-AzKeyVaultAccessPolicy** с помощью следующего синтаксиса:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName <vault name> -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName <Office 365 appID>
   ```

   Где:

   - *имя хранилища* — это имя созданного хранилища ключей.
   - Для Exchange Online и Skype для бизнеса замените *Office 365 appID*`00000002-0000-0ff1-ce00-000000000000`
   - Для SharePoint Online, OneDrive для бизнеса и Teams файлы замените *Office 365 appID* на`00000003-0000-0ff1-ce00-000000000000`
   - Для политики нескольких рабочих нагрузок (Exchange, Teams, MIP EDM), которая применяется ко всем пользователям клиента, замените Office 365 *appID*`c066d759-24ae-40e7-a56f-027002b5d3e4`

  Пример: Настройка разрешений для Exchange Online и Skype для бизнеса:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName Contoso-CK-EX-NA-VaultA1 -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000002-0000-0ff1-ce00-000000000000
   ```

  Пример: Настройка разрешений для SharePoint, OneDrive для бизнеса и Teams файлов:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName Contoso-CK-SP-NA-VaultA1 -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000003-0000-0ff1-ce00-000000000000
   ```

### <a name="make-sure-soft-delete-is-enabled-on-your-key-vaults"></a>Убедитесь, что в хранилищах ключей включено мягкое удаление

При быстром восстановлении ключей вероятность отключения расширенной службы будет меньше из-за случайного или злонамеренного удаления ключей. Включить эту конфигурацию, именуемую soft Delete, прежде чем использовать ключи с ключом клиента. Включение soft Delete позволяет восстановить ключи или хранилища в течение 90 дней после удаления, не восстанавливая их из резервного копирования.
  
Чтобы включить soft Delete в хранилищах ключей, выполните следующие действия:
  
1. Вопишите в свою подписку Azure с помощью Windows PowerShell. Инструкции см. в [Azure PowerShell.](/powershell/azure/authenticate-azureps)

2. Запустите [кодлет Get-AzKeyVault.](/powershell/module/az.keyvault/get-azkeyvault) В этом примере *имя хранилища* — это имя хранилища ключей, для которого вы позволяете мягко удалять:

   ```powershell
   $v = Get-AzKeyVault -VaultName <vault name>
   $r = Get-AzResource -ResourceId $v.ResourceId
   $r.Properties | Add-Member -MemberType NoteProperty -Name enableSoftDelete -Value 'True'
   Set-AzResource -ResourceId $r.ResourceId -Properties $r.Properties
   ```

3. Подтвердите, что мягкое удаление настроено для хранилища ключей с помощью **cmdlet Get-AzKeyVault.** Если мягкое удаление настроено правильно для хранилища ключей, свойство _Soft Delete Enabled_ возвращает значение **True:**

   ```powershell
   Get-AzKeyVault -VaultName <vault name> | fl
   ```

### <a name="add-a-key-to-each-key-vault-either-by-creating-or-importing-a-key"></a>Добавление ключа в каждый хранилище ключей путем создания или импорта ключа

Существует два способа добавления ключей в хранилище ключей Azure; вы можете создать ключ непосредственно в Key Vault или импортировать ключ. Создание ключа непосредственно в key Vault менее сложно, но импорт ключа обеспечивает полный контроль над тем, как создается ключ. Используйте клавиши RSA. Хранилище ключей Azure не поддерживает упаковку и разверивание с помощью ключей эллиптической кривой.
  
Чтобы создать ключ непосредственно в хранилище ключей, выполните [кодлет Add-AzKeyVaultKey](/powershell/module/az.keyvault/add-azkeyvaultkey) следующим образом:
  
```powershell
Add-AzKeyVaultKey -VaultName <vault name> -Name <key name> -Destination <HSM|Software> -KeyOps wrapKey,unwrapKey
```

Где:

- *имя хранилища* — это имя хранилища ключей, в котором необходимо создать ключ.

- *ключевое* имя — это имя, которое необходимо дать новому ключу.

  > [!TIP]
  > Клавиши имен, использующие аналогичную конвенцию именования, как описано выше, для ключевых сводов. Таким образом, в средствах, которые показывают только имя ключа, строка самоохвативна.
  
Если вы собираетесь защищать ключ с помощью HSM, убедитесь, что вы указываете **HSM** как значение параметра _Destination,_ в противном случае укажите **программное обеспечение.**

Пример.
  
```powershell
Add-AzKeyVaultKey -VaultName Contoso-CK-EX-NA-VaultA1 -Name Contoso-CK-EX-NA-VaultA1-Key001 -Destination HSM -KeyOps wrapKey,unwrapKey
```

Чтобы импортировать ключ непосредственно в хранилище ключей, необходимо иметь модуль безопасности nCipher nShield hardware.
  
Некоторые организации предпочитают этот подход, чтобы установить происхождение ключей, а затем этот метод также предоставляет следующие проверки:
  
- Инструментарий, используемый для импорта, включает в себя проверку из nCipher, что ключ ключа Exchange (KEK), используемый для шифрования генерируемого ключа, не является экспортируемым и создается внутри подлинного HSM, который был изготовлен nCipher.

- Набор инструментов включает проверку из nCipher, что мир безопасности Azure Key Vault также был создан на подлинном HSM, изготовленном nCipher. Это подтверждает, что Корпорация Майкрософт также использует подлинное оборудование nCipher.

Обратитесь к группе безопасности, чтобы определить, необходимы ли вышеуказанные проверки. Подробные действия по созданию локального ключа и его импорту в хранилище ключей см. в инструкции по созданию и передаче ключей, защищенных [HSM для Хранилища ключей Azure.](/azure/key-vault/keys/hsm-protected-keys) Используйте инструкции Azure для создания ключа в каждом хранилище ключей.
  
### <a name="check-the-recovery-level-of-your-keys"></a>Проверьте уровень восстановления ключей

Microsoft 365, что подписка На хранилище ключей Azure установлена подписка "Не отменяйте", а клавиши, используемые клиентской клавишей, имеют возможность мягкого удаления. Вы можете подтвердить параметры подписки, посмотрев уровень восстановления на клавишах.
  
Чтобы проверить уровень восстановления ключа, в Azure PowerShell выполните Get-AzKeyVaultKey следующим образом:
  
```powershell
(Get-AzKeyVaultKey -VaultName <vault name> -Name <key name>).Attributes
```

Если свойство _Уровня_ восстановления возвращает что-либо, кроме значения **Recoverable+ProtectedSubscription,** убедитесь, что подписка включена в список "Не отменяйте", и в каждом из ключевых сводов включено мягкое удаление.
  
### <a name="back-up-azure-key-vault"></a>Back up Azure Key Vault

Сразу после создания или изменения клавиши выполните резервное копирование и храните копии резервного копирования как в Интернете, так и в автономном режиме. Не подключайте автономные копии к какой-либо сети. Вместо этого храните их в автономном расположении, например в физическом безопасном или коммерческом хранилище. По крайней мере одна копия резервного копирования должна храниться в месте, доступном в случае возникновения аварии. Blobs резервного копирования являются единственным средством восстановления ключевого материала в случае, если ключ Key Vault будет окончательно уничтожен или иным образом неоперабельным. Ключи, внешние для хранилища ключей Azure и импортируемые в Хранилище ключей Azure, не могут быть резервными, так как метаданные, необходимые для использования ключа клиента, не существуют с внешним ключом. Только резервная копия, взятая из хранилища ключей Azure, может использоваться для восстановления операций с ключом клиента. Поэтому необходимо создать резервную копию хранилища ключей Azure после загрузки или создания ключа.
  
Чтобы создать резервную копию ключа Azure Key Vault, выполните кодлет [Backup-AzKeyVaultKey](/powershell/module/az.keyvault/backup-azkeyvaultkey) следующим образом:

```powershell
Backup-AzKeyVaultKey -VaultName <vault name> -Name <key name>
-OutputFile <filename.backup>
```

Убедитесь, что в файле вывода используется `.backup` суффикс.
  
Файл вывода, выдающийся из этого комлета, шифруется и не может использоваться за пределами хранилища ключей Azure. Резервное копирование может быть восстановлено только в подписке Azure, из которой была взята резервная копия.
  
> [!TIP]
> Для файла вывода выберите сочетание имени хранилища и имени ключа. Это сделает само описание имени файла. Это также гарантирует, что имена файлов резервного копирования не сталкиваются.
  
Например:
  
```powershell
Backup-AzKeyVaultKey -VaultName Contoso-CK-EX-NA-VaultA1 -Name Contoso-CK-EX-NA-VaultA1-Key001 -OutputFile Contoso-CK-EX-NA-VaultA1-Key001-Backup-20170802.backup
```

### <a name="validate-azure-key-vault-configuration-settings"></a>Проверка параметров конфигурации хранилища ключей Azure

Проверка перед использованием ключей в DEP необязательна, но рекомендуется. Если вы используете шаги для настройки ключей и сводов, помимо описанных в этой статье, проверьте состояние ресурсов Хранилища ключей Azure перед настройкой ключа клиента.
  
Чтобы убедиться, что у ваших ключей `get` `wrapKey` включена и `unwrapKey` включена операция:
  
Выполните [этот кодлет Get-AzKeyVault](/powershell/module/az.keyvault/get-azkeyvault) следующим образом:
  
```powershell
Get-AzKeyVault -VaultName <vault name>
```

В выходных данных см. соответствующую политику доступа и удостоверение Exchange Online (GUID) или идентификатор SharePoint Online (GUID). Все три из вышеуказанных разрешений должны быть показаны в статье Permissions to Keys.
  
Если конфигурация политики доступа неверна, выполните Set-AzKeyVaultAccessPolicy следующим образом:
  
```powershell
Set-AzKeyVaultAccessPolicy -VaultName <vault name> -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName <Office 365 appID>
```

Например, для Exchange Online и Skype для бизнеса:
  
```powershell
Set-AzKeyVaultAccessPolicy -VaultName Contoso-CK-EX-NA-VaultA1 
-PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000002-0000-0ff1-ce00-000000000000
```

Например, для SharePoint Online и OneDrive для бизнеса:
  
```powershell
Set-AzKeyVaultAccessPolicy -VaultName Contoso-CK-SP-NA-VaultA1
-PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000003-0000-0ff1-ce00-000000000000
```

Чтобы убедиться, что срок действия ключей не установлен, выполните [кодлет Get-AzKeyVaultKey](/powershell/module/az.keyvault/get-azkeyvault) следующим образом:
  
```powershell
Get-AzKeyVaultKey -VaultName <vault name>
```

Ключ клиента не может использовать истекаемую клавишу. Операции с истекшим ключом сбой, и, возможно, приведет к отключению службы. Настоятельно рекомендуется, чтобы у ключей клиента не было срока действия. Дата истечения срока действия после набора не может быть удалена, но может быть изменена на другую дату. Если необходимо использовать ключ с набором сроков действия, измените значение срока действия на 12/31/9999. Ключи с датой истечения срока действия, задав другую дату 12/31/9999, не проходят проверку Microsoft 365 проверки.
  
Чтобы изменить срок действия, установленный для любого значения, кроме 12/31/9999, выполните кодлет [Update-AzKeyVaultKey](/powershell/module/az.keyvault/update-azkeyvaultkey) следующим образом:
  
```powershell
Update-AzKeyVaultKey -VaultName <vault name> -Name <key name> -Expires (Get-Date -Date "12/31/9999")
```

> [!CAUTION]
> Не устанавливайте сроки действия ключей шифрования, которые вы используете с помощью ключа клиента.
  
### <a name="obtain-the-uri-for-each-azure-key-vault-key"></a>Получение URI для каждого ключа Azure Key Vault

После того как вы настроите хранилища ключей и добавите ключи, запустите следующую команду, чтобы получить URI для ключа в каждом хранилище ключей. Эти URL-адреса будут применяться при создании и назначении каждого deP позже, поэтому сохраните эти сведения в безопасном месте. Запустите эту команду один раз для каждого хранилища ключей.
  
В Azure PowerShell:
  
```powershell
(Get-AzKeyVaultKey -VaultName <vault name>).Id
```

## <a name="next-steps"></a>Дальнейшие действия

После завершения действий в этой статье вы будете готовы создать и назначить dePs. Инструкции см. в [инструкции "Управление ключом клиента".](customer-key-manage.md)

## <a name="related-articles"></a>Связанные статьи

- [Шифрование службы с помощью ключа клиента](customer-key-overview.md)

- [Управление ключом клиента](customer-key-manage.md)

- [Смена или ротация ключа клиента или ключа доступности](customer-key-availability-key-roll.md)

- [Узнайте о ключе доступности](customer-key-availability-key-understand.md)

- [Шифрование служб](office-365-service-encryption.md)