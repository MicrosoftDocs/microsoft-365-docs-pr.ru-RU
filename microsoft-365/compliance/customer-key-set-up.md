---
title: Настройка ключа клиента на уровне приложения
ms.author: krowley
author: kccross
manager: laurawi
ms.date: 02/05/2020
audience: ITPro
ms.topic: article
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- MET150
ms.collection:
- M365-security-compliance
description: Узнайте, как настроить ключ клиента для Файлов Microsoft 365 для Exchange Online, Skype для бизнеса, SharePoint Online, OneDrive для бизнеса и Teams.
ms.openlocfilehash: a89b5cb4144de3b548c7ac328f0be775b4262cdc
ms.sourcegitcommit: 8a6540df9d63db1ffb69711381dc44fc2fdaf547
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/29/2020
ms.locfileid: "49736068"
---
# <a name="set-up-customer-key-at-the-application-level"></a>Настройка ключа клиента на уровне приложения

С помощью ключа клиента вы управляете ключами шифрования вашей организации, а затем настраивает Microsoft 365 так, чтобы они использовали их для шифрования неавтовых данных в центрах обработки данных Майкрософт. Другими словами, ключ клиента позволяет клиентам добавлять к своим ключам уровень шифрования, принадлежащий им. К ним относятся данные из Exchange Online и Skype для бизнеса, хранящиеся в почтовых ящиках, а также файлы, хранящиеся в SharePoint Online и OneDrive для бизнеса.

Прежде чем использовать ключ клиента для Office 365, необходимо настроить Azure. В этом разделе описываются действия, которые необходимо предпринять для создания и настройки необходимых ресурсов Azure, а затем описаны действия по настройке ключа клиента в Office 365. После завершения настройки Azure необходимо определить, какую политику и, следовательно, какие ключи назначить почтовым ящикам и файлам в организации. Почтовые ящики и файлы, для которых вы не назначите политику, будут использовать политики шифрования, контролируемые и управляемые корпорацией Майкрософт. Дополнительные сведения о ключе клиента или общие сведения см. в сообщении о шифровании службы с помощью ключа клиента [в Office 365.](customer-key-overview.md)
  
> [!IMPORTANT]
> Настоятельно рекомендуется следовать рекомендациям в этом разделе. Они называются **подсказками и важными.**  Ключ клиента позволяет контролировать корневые ключи шифрования, область действия которых может быть не больше, чем вся организация. Это означает, что ошибки, сделанные с помощью этих ключей, могут иметь широкое влияние и привести к перебоям в обслуживании или необрастимой потере данных.
  
## <a name="before-you-set-up-customer-key"></a>Перед настройками ключа клиента

Перед началом работы убедитесь, что у вас есть соответствующее лицензирование для вашей организации. Используйте платную подписку Azure, выставленную с помощью Соглашение Enterprise или поставщика облачных служб. Подписки Azure, приобретенные с помощью планов Оплата по мере использования или с помощью кредитной карты, не поддерживаются для ключа клиента. С 1 апреля 2020 г. ключ клиента в Office 365 предлагается в office 365 E5, M365 E5, M365 E5 Compliance и M365 E5 Information Protection & Governance SKUs. Office 365 Advanced Compliance SKU больше не доступен для получения новых лицензий. Существующие лицензии Office 365 Advanced Compliance по-прежнему будут поддерживаться.

Чтобы понять концепции и процедуры, рассмотренные в этом разделе, просмотрите документацию [по Azure Key Vault.](https://docs.microsoft.com/azure/key-vault/) Кроме того, ознакомьтесь с терминами, используемыми в Azure, например с [клиентом Azure AD.](https://docs.microsoft.com/previous-versions/azure/azure-services/jj573650(v=azure.100)#what-is-an-azure-ad-tenant)

FastTrack используется только для сбора необходимых сведений о конфигурации клиента и службы, используемых для регистрации ключа клиента. Предложения по ключам клиентов публикуются через FastTrack, чтобы вам и нашим партнерам было удобно отправлять требуемую информацию с помощью того же метода. FastTrack также упрощает архивировать данные, которые вы предоставляете в предложении.
  
Если вам нужна дополнительная поддержка помимо документации, обратитесь за помощью к microsoft Consulting Services (MCS), Premier Field Engineering (PFE) или партнеру Майкрософт. Чтобы отправить отзыв о ключе клиента, включая документацию, отправьте свои идеи, предложения и перспективы customerkeyfeedback@microsoft.com.
  
## <a name="overview-of-steps-to-set-up-customer-key"></a>Обзор действий по настройкам ключа клиента

Чтобы настроить ключ клиента, выполните эти задачи в списке. Остальная часть этой статьи содержит подробные инструкции по каждой задаче или ссылки на дополнительные сведения для каждого шага процесса.
  
**В Azure и Microsoft FastTrack:**
  
Большинство этих задач можно выполнить с помощью удаленного подключения к Azure PowerShell. Для наилучших результатов используйте Azure PowerShell версии 4.4.0 или более поздней.
  
- [Создание двух новых подписок Azure](#create-two-new-azure-subscriptions)

- [Регистрация подписок Azure для использования обязательного периода хранения](#register-azure-subscriptions-to-use-a-mandatory-retention-period)

  Регистрация может занять от одного до пяти бизнес-дней.

- [Отправка запроса на активацию ключа клиента для Office 365](#submit-a-request-to-activate-customer-key-for-office-365)

После создания двух новых подписок Azure необходимо отправить соответствующий запрос на предложение ключа клиента, заполнив веб-форму, которая находится на портале Microsoft FastTrack. **Команда FastTrack не предоставляет помощь с ключом клиента. Office просто использует портал FastTrack для** отправки формы и отслеживания соответствующих предложений для ключа клиента.

- [Создание хранилища Azure Key Vault премиум-класса в каждой подписке](#create-a-premium-azure-key-vault-in-each-subscription)

- [Назначение разрешений каждому хранилищу ключей](#assign-permissions-to-each-key-vault)

- [Включить и подтвердить возможность мягкого удаления в хранилищах ключей](#enable-and-then-confirm-soft-delete-on-your-key-vaults)

- [Добавление ключа в каждое хранилище ключей путем создания или импорта ключа](#add-a-key-to-each-key-vault-either-by-creating-or-importing-a-key)

- [Проверка уровня восстановления ключей](#check-the-recovery-level-of-your-keys)

- [Back up Azure Key Vault](#back-up-azure-key-vault)

- [Проверка параметров конфигурации Azure Key Vault](#validate-azure-key-vault-configuration-settings)

- [Получение URI для каждого ключа Azure Key Vault](#obtain-the-uri-for-each-azure-key-vault-key)

**В Office 365:**
  
Exchange Online и Skype для бизнеса:
  
- [Создание политики шифрования данных (DEP) для использования с Exchange Online и Skype для бизнеса](#create-a-data-encryption-policy-dep-for-use-with-exchange-online-and-skype-for-business)

- [Назначение DEP почтовому ящику](#assign-a-dep-to-a-mailbox)

- [Проверка шифрования почтовых ящиков](#validate-mailbox-encryption)

SharePoint Online и OneDrive для бизнеса:
  
- [Создание политики шифрования данных (DEP) для каждого географического центра SharePoint Online и OneDrive для бизнеса](#create-a-data-encryption-policy-dep-for-each-sharepoint-online-and-onedrive-for-business-geo)

- [Проверка шифрования файлов SharePoint Online, OneDrive для бизнеса и Teams](#validate-file-encryption)

## <a name="complete-tasks-in-azure-key-vault-and-microsoft-fasttrack-for-customer-key"></a>Выполнение задач в Azure Key Vault и Microsoft FastTrack для ключа клиента

Выполните эти задачи в Azure Key Vault. Эти действия необходимо выполнить независимо от того, собираетесь ли вы настроить ключ клиента для Exchange Online, Skype для бизнеса или для файлов SharePoint Online, OneDrive для бизнеса и Teams, а также для всех поддерживаемых служб в Office 365.
  
### <a name="create-two-new-azure-subscriptions"></a>Создание двух новых подписок Azure

Для ключа клиента требуются две подписки Azure. Корпорация Майкрософт рекомендует создавать новые подписки Azure для использования с ключом клиента. Ключи Azure Key Vault можно авторизировать только для приложений в одном клиенте Azure Active Directory (Microsoft Azure Active Directory). Необходимо создать новые подписки с помощью того же клиента Azure AD, который используется в вашей организации, где будут назначены DEP. Например, используя свою учетную запись для работы или учебного заведения, которая имеет права глобального администратора в вашей организации. Дополнительные сведения [см. в описании регистрации в Azure как организации.](https://azure.microsoft.com/documentation/articles/sign-up-organization/)
  
> [!IMPORTANT]
> Для ключа клиента требуются два ключа для каждой политики шифрования данных (DEP). Для этого необходимо создать две подписки Azure. Рекомендуется, чтобы у вас были отдельные члены вашей организации, которые настраивали по одному ключу в каждой подписке. Эти подписки Azure следует использовать только для администрирования ключей шифрования для Office 365. Это защищает организацию на случай, если один из ваших операторов случайно, намеренно или злонамеренно удалит или неправильно укатит ключи, за которые они отвечают.
>

На практике нет ограничений на количество подписок Azure, которые можно создать для вашей организации. Следуя этим методикам, можно свести к минимуму влияние ошибок на человека, а также управлять ресурсами, используемыми ключом клиента.
  
### <a name="submit-a-request-to-activate-customer-key-for-office-365"></a>Отправка запроса на активацию ключа клиента для Office 365

После завершения действий Azure вам потребуется отправить запрос на предложение на [портале Microsoft FastTrack.](https://fasttrack.microsoft.com/) После отправки запроса на веб-портале FastTrack корпорация Майкрософт проверяет данные конфигурации Azure Key Vault и предоставленные вами контактные данные. Выбор в форме предложения, касающейся уполномоченных сотрудников организации, является критически важным и необходим для завершения регистрации ключа клиента. Сотрудники вашей организации, выбранные в форме, будут использоваться для проверки подлинности любого запроса на отозов и уничтожения всех ключей, используемых с политикой шифрования данных ключа клиента. Вам потребуется один раз активировать ключ клиента для Exchange Online и Skype для бизнеса, а второй — для активации ключа клиента для SharePoint Online и OneDrive для бизнеса.
  
Чтобы отправить предложение по активации ключа клиента, выполните следующие действия:
  
1. Используя учетную запись для работы или учебного заведения с разрешениями глобального администратора в организации, войдите на портал [Microsoft FastTrack.](https://fasttrack.microsoft.com/)

2. После входа перейдите на панель **мониторинга.**

3. Choose **Deploy** from the navigation bar **OR** select View all **deployment resources** on the **Deploy** information card, and review the list of current offers.

4. Выберите информационную карточку для предложения, которое к вам применимо:

   - **Exchange Online и Skype для бизнеса:** Выберите **справку по ключу шифрования запроса для предложения Exchange Online.**

   - **Файлы SharePoint Online, OneDrive и Teams:** Выберите **справку по ключу шифрования запроса для предложения SharePoint и OneDrive.**

5. После просмотра сведений о предложении выберите **"Продолжить до шага 2".**

6. Заполните все применимые сведения и запрашиваемые сведения в форме предложения. Уделите особое внимание выбору сотрудников вашей организации, которым вы хотите разрешить утверждать окончательное и окончательное уничтожение ключей шифрования и данных. После завершения формы выберите **"Отправить".**

### <a name="register-azure-subscriptions-to-use-a-mandatory-retention-period"></a>Регистрация подписок Azure для использования обязательного периода хранения

Временная или постоянная потеря корневых ключей шифрования может нарушить работу службы или даже привести к катастрофическому сбою и потере данных. По этой причине ресурсы, используемые с ключом клиента, требуют сильной защиты. Все ресурсы Azure, используемые с ключом клиента, предлагают механизмы защиты за пределами конфигурации по умолчанию. Подписки Azure можно пометить или зарегистрировать таким образом, чтобы предотвратить немедленную и неупроверяемую отмену. Это называется регистрацией на обязательный период хранения. Действия, необходимые для регистрации подписок Azure на обязательный период хранения, требуют совместной работы с командой Microsoft 365. Этот процесс может занять от одного до пяти бизнес-дней. Раньше это иногда называлось "Не отменять".
  
Перед связью с командой Microsoft 365 необходимо выполнить следующие действия для каждой подписки Azure, которая используется с ключом клиента. Перед началом установки убедитесь, что у вас установлен модуль [Azure PowerShell Az.](https://docs.microsoft.com/powershell/azure/new-azureps-module-az)
  
1. Во входе с помощью Azure PowerShell. Инструкции см. в [документе "Вход с помощью Azure PowerShell".](https://docs.microsoft.com/powershell/azure/authenticate-azureps)

2. Запустите Register-AzProviderFeature, чтобы зарегистрировать подписки, чтобы использовать обязательный период хранения. Выполните это действие для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Register-AzProviderFeature -FeatureName mandatoryRetentionPeriodEnabled -ProviderNamespace Microsoft.Resources
   ```

3. Обратитесь в корпорацию Майкрософт, чтобы завершить процесс. Для команды SharePoint и OneDrive для бизнеса свяжитесь [с](mailto:spock@microsoft.com)spock@microsoft.com. Для Exchange Online и Skype для бизнеса свяжитесь [с](mailto:exock@microsoft.com)exock@microsoft.com. Включите в сообщение электронной почты следующее:

   **Тема:** ключ клиента для \<*Your tenant's fully-qualified domain name*\>

   **Body**: Subscription IDs for which you want to have the mandatory retention period finalized.
   Выходные данные Get-AzProviderFeature для каждой подписки.

   Соглашение об уровне обслуживания (SLA) для завершения этого процесса составляет пять бизнес-дней после уведомления (и проверки) корпорации Майкрософт о том, что вы зарегистрировали подписки на использование обязательного периода хранения.

4. После получения уведомления от корпорации Майкрософт о том, что регистрация завершена, проверьте состояние регистрации, вы выполните команду Get-AzProviderFeature следующим образом. Если проверка подтверждена, Get-AzProviderFeature возвращает значение **Registered для** свойства **Registration State.** Выполните это действие для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Get-AzProviderFeature -ProviderNamespace Microsoft.Resources -FeatureName mandatoryRetentionPeriodEnabled
   ```

5. Чтобы завершить процесс, выполните команду Register-AzResourceProvider. Выполните это действие для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Register-AzResourceProvider -ProviderNamespace Microsoft.KeyVault
   ```

### <a name="create-a-premium-azure-key-vault-in-each-subscription"></a>Создание хранилища Azure Key Vault премиум-класса в каждой подписке

Действия по созданию хранилища ключей описаны в руководстве "Начало работы с [Azure Key Vault",](https://azure.microsoft.com/documentation/articles/key-vault-get-started/)в котором описана установка и запуск Azure PowerShell, подключение к подписке Azure, создание группы ресурсов и создание хранилища ключей в этой группе ресурсов.
  
При создании хранилища ключей необходимо выбрать SKU: Standard или Premium. Стандартный SKU позволяет защитить ключи Azure Key Vault программным обеспечением без защиты ключей аппаратного модуля безопасности (HSM), а SKU Premium позволяет использовать HSM для защиты ключей Key Vault. Ключ клиента принимает хранилища ключей, которые используют любой SKU, хотя Корпорация Майкрософт настоятельно рекомендует использовать только SKU Premium. Стоимость операций с ключами обоих типов не отличается, поэтому единственная разница в стоимости — это стоимость каждого ключа, защищенного с помощью HSM, в месяц. Подробные [сведения см. в](https://azure.microsoft.com/pricing/details/key-vault/) ценах Key Vault.
  
> [!IMPORTANT]
> Используйте хранилища ключей SKU Premium и ключи, защищенные HSM, для производственных данных и используйте только стандартные хранилища ключей sKU и ключи для тестирования и проверки.
  
Для каждой службы Microsoft 365, с которой вы будете использовать ключ клиента, создайте хранилище ключей в каждой из двух созданных вами подписок Azure. Например, только для Exchange Online и Skype для бизнеса или SharePoint Online и OneDrive для бизнеса создается только одна пара хранилищ. Чтобы включить ключ клиента для Exchange Online и SharePoint Online, необходимо создать две пары хранилищ ключей.
  
Используйте соглашение об именах для хранилищ ключей, которое отражает предполагаемый метод использования политики шифрования данных, с которой будут связываться хранилища. Рекомендации по соглашению об именованиях см. в разделе "Рекомендации" ниже.
  
Создайте отдельный сопряженный набор хранилищ для каждой политики шифрования данных. Для Exchange Online область политики шифрования данных выбирается вами при назначении политики почтовому ящику. Для почтового ящика может быть назначена только одна политика, и вы можете создать до политик. Для SharePoint Online областью политики является все данные в организации в географическом расположении или _географическом регионе._

Для создания хранилищ ключей также требуется создание групп ресурсов Azure, так как хранилищам ключей требуется емкость хранилища (хотя и очень небольшая), а ведение журнала Key Vault, если включено, также создает хранимые данные. Корпорация Майкрософт рекомендует использовать отдельных администраторов для управления каждой группой ресурсов, при этом администрирование согласуется с набором администраторов, которые будут управлять всеми связанными ресурсами ключа клиента.
  
> [!IMPORTANT]
> Для максимальной доступности хранилища ключей должны быть в регионах, близких к вашей службе Microsoft 365. Например, если ваша организация Exchange Online находится в Северной Америке, раз поместите хранилища ключей в Северную Америку. Если ваша организация Exchange Online находится в Европе, раз поместите хранилища ключей в Европу.
> 
> Используйте общий префикс для хранилищ ключей и включаем сокращение использования и области использования хранилища ключей и ключей (например, для службы Contoso SharePoint, где хранилища будут расположены в Северной Америке, возможной парой имен является Contoso-O365SP-NA-VaultA1 и Contoso-O365SP-NA-VaultA2. Имена хранилищ — это глобальные уникальные строки в Azure, поэтому вам может потребоваться попробовать варианты нужных имен, если нужные имена уже затверяются другими клиентами Azure. С июля 2017 г. имена хранилищ нельзя изменить, поэтому для проверки правильности выполнения плана лучше всего написать план установки и использовать второго человека.
> 
> По возможности создайте хранилища в непарных регионах. Парные регионы Azure обеспечивают высокую доступность в доменах сбоев служб. Таким образом, региональные пары можно использовать в качестве резервной области друг друга. Это означает, что ресурс Azure, размещенный в одном регионе, автоматически получает сбой в парной области. По этой причине выбор областей для двух хранилищ, используемых в политике шифрования данных, где эти регионы сопряжены, означает, что используется всего два региона доступности. В большинстве географических регионов есть только две области, поэтому выбрать непарные регионы пока невозможно. По возможности выберите две непарные области для двух хранилищ, используемых с политикой шифрования данных. Это дает преимущества из четырех областей доступности. Дополнительные сведения см. в списке "Непрерывность бизнеса и аварийное [восстановление" (BCDR). Парные](https://docs.microsoft.com/azure/best-practices-availability-paired-regions) регионы Azure для текущего списка региональных пар.
  
### <a name="assign-permissions-to-each-key-vault"></a>Назначение разрешений каждому хранилищу ключей

Для каждого хранилища ключей необходимо определить три отдельных набора разрешений для ключа клиента в зависимости от вашей реализации. Например, необходимо определить один набор разрешений для каждого из следующих ок.
  
- **Администраторы хранилища ключей,** которые будут выполнять ежедневное управление хранилищем ключей для вашей организации. К этим задачам относятся резервное копирование, создание, get, импорт, список и восстановление.

  > [!IMPORTANT]
  > Набор разрешений, присвоенный администраторам хранилищ ключей, не включает разрешение на удаление ключей. Это сделано намеренно и важно. Удаление ключей шифрования обычно не делается, так как это окончательно уничтожает данные. По умолчанию не делайте этого разрешения администраторам хранилища ключей. Вместо этого следует зарезервировать это значение для участников хранилища ключей и назначить его администратору только на короткое время, только когда будет понято четкое понимание последствий.
  
  Чтобы назначить эти разрешения пользователю в организации, войдите в свою подписку Azure с помощью Azure PowerShell. Инструкции см. в [документе "Вход с помощью Azure PowerShell".](https://docs.microsoft.com/powershell/azure/authenticate-azureps)

- Запустите Set-AzKeyVaultAccessPolicy, чтобы назначить необходимые разрешения.

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName <vault name> -UserPrincipalName <UPN of user> -PermissionsToKeys create,import,list,get,backup,restore
   ```

   Например:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 -UserPrincipalName alice@contoso.com -PermissionsToKeys create,import,list,get,backup,restore
   ```

- **Участники хранилища ключей,** которые могут изменять разрешения для самого хранилища Ключей Azure. Вам потребуется изменить эти разрешения, когда сотрудники уйдут из группы или присоединятся к ней, или в крайне редких случаях, когда администраторам хранилища ключей действительно требуется разрешение на удаление или восстановление ключа. Этому набору участников хранилища ключей необходимо  предоставить роль "Участник" в хранилище ключей. Эту роль можно назначить с помощью Azure Resource Manager. Дополнительные сведения см. в Role-Based управления доступом для управления доступом к ресурсам [подписки Azure.](https://docs.microsoft.com/azure/active-directory/role-based-access-control-configure) Администратор, создавший подписку, имеет такой доступ неявно, а также возможность назначать другим администраторам роль "Участник".

- Если вы собираетесь использовать ключ клиента с Exchange Online и Skype для бизнеса, необходимо предоставить разрешение Microsoft 365 на использование хранилища ключей от имени Exchange Online и Skype для бизнеса. Аналогичным образом, если вы собираетесь использовать ключ клиента с SharePoint Online и OneDrive для бизнеса, необходимо добавить разрешение для Microsoft 365 на использование хранилища ключей от имени SharePoint Online и OneDrive для бизнеса. Чтобы предоставить разрешение microsoft 365, запустите следующий синтаксис:  

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName <vault name> -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName <Office 365 appID>
   ```

   Где:

    - *имя хранилища* — это имя созданного хранилища ключей.

    - Для Exchange Online и Skype для бизнеса замените  *AppID Office 365* на `00000002-0000-0ff1-ce00-000000000000`

    - Для файлов SharePoint Online, OneDrive для бизнеса и Teams замените  *AppID Office 365* на `00000003-0000-0ff1-ce00-000000000000`

  Пример: установка разрешений для Exchange Online и Skype для бизнеса:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000002-0000-0ff1-ce00-000000000000
   ```

  Пример: установка разрешений для файлов SharePoint Online, OneDrive для бизнеса и Teams:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365SP-NA-VaultA1 -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000003-0000-0ff1-ce00-000000000000
   ```

### <a name="enable-and-then-confirm-soft-delete-on-your-key-vaults"></a>Включить и подтвердить возможность мягкого удаления в хранилищах ключей

Если вы сможете быстро восстановить ключи, вы с меньшей вероятностью будете испытывать расширенный с выход из-за случайного или злонамеренного удаления ключей. Прежде чем использовать ключи с ключом клиента, необходимо включить эту конфигурацию, которая называется "Soft Delete". Включение функции soft Delete позволяет восстановить ключи или хранилища в течение 90 дней после удаления, не восстанавливая их из резервной копии.
  
Чтобы включить soft Delete в хранилищах ключей, выполните следующие действия:
  
1. Sign in to your Azure subscription with Windows PowerShell. Инструкции см. в [документе "Вход с помощью Azure PowerShell".](https://docs.microsoft.com/powershell/azure/authenticate-azureps)

2. Запустите [cmdlet Get-AzKeyVault.](https://docs.microsoft.com/powershell/module/az.keyvault/get-azkeyvault) В этом примере *имя хранилища* — это имя хранилища ключей, для которого вы включите возможность мягкого удаления:

   ```powershell
   $v = Get-AzKeyVault -VaultName <vault name>
   $r = Get-AzResource -ResourceId $v.ResourceId
   $r.Properties | Add-Member -MemberType NoteProperty -Name enableSoftDelete -Value 'True'
   Set-AzResource -ResourceId $r.ResourceId -Properties $r.Properties
   ```

3. Подтвердите, что для хранилища ключей настроено мягкое удаление, вы можете с помощью **get-AzKeyVault.** Если мягкое удаление настроено правильно для хранилища ключей, свойство _Soft Delete Enabled_ возвращает значение **True:**

   ```powershell
   Get-AzKeyVault -VaultName <vault name> | fl
   ```

### <a name="add-a-key-to-each-key-vault-either-by-creating-or-importing-a-key"></a>Добавление ключа в каждое хранилище ключей путем создания или импорта ключа

Существует два способа добавления ключей в хранилище Azure Key Vault. вы можете создать ключ непосредственно в Хранилище Key Vault или импортировать ключ. Создание ключа непосредственно в Хранилище Key Vault — менее сложный метод, а импорт ключа обеспечивает полный контроль над тем, как создается ключ. Необходимо использовать ключи RSA. Хранилище Azure Key Vault не поддерживает перенос и развёртывание с помощью ключей эллиптических кривых.
  
Чтобы создать ключ непосредственно в хранилище [](https://docs.microsoft.com/powershell/module/az.keyvault/add-azkeyvaultkey) ключей, выполните его следующим образом:
  
```powershell
Add-AzKeyVaultKey -VaultName <vault name> -Name <key name> -Destination <HSM|Software> -KeyOps wrapKey,unwrapKey
```

Где:

- *имя хранилища* — это имя хранилища ключей, в котором необходимо создать ключ.

- *имя ключа* — это имя, которое вы хотите предоставить новому ключу.

  > [!TIP]
  > Клавиши имен, использующие аналогичное соглашение об именовом имени, как описано выше, для хранилищ ключей. Таким образом, в средствах, которые показывают только имя ключа, строка описывается самостоятельно.
  
Если вы собираетесь защитить ключ с помощью HSM, убедитесь, что в качестве значения параметра _Destination_ указывается **HSM,** в противном случае укажите **Программное обеспечение.**

Пример.
  
```powershell
Add-AzKeyVaultKey -VaultName Contoso-O365EX-NA-VaultA1 -Name Contoso-O365EX-NA-VaultA1-Key001 -Destination HSM -KeyOps wrapKey,unwrapKey
```

Чтобы импортировать ключ непосредственно в хранилище ключей, необходимо иметь модуль NCipher nShield Hardware Security Module.
  
В некоторых организациях такой подход используется для установления своего ключа, а затем этот метод также предоставляет следующие возможности:
  
- Используемый для импорта инструментарий включает в себя проверку из nCipher, что ключ ключа Exchange (KEK), используемый для шифрования генерируемого ключа, не является экспортируемым и создается в подлинной HSM, которая была произведена nCipher.

- Набор инструментов включает в себя проверку из nCipher, что мир безопасности Azure Key Vault также был создан на подлинном HSM, который был создан nCipher. Это подтверждает, что корпорация Майкрософт также использует подлинное оборудование nCipher.

Обратитесь в группу безопасности, чтобы определить, требуются ли вышеуказанные проверки. Дополнительные сведения о создании ключа в локальной службе и его импорте в хранилище ключей см. в описании создания и передачи ключей, защищенных с использованием [HSM,](https://azure.microsoft.com/documentation/articles/key-vault-hsm-protected-keys/)для Azure Key Vault. Используйте инструкции Azure для создания ключа в каждом хранилище ключей.
  
### <a name="check-the-recovery-level-of-your-keys"></a>Проверка уровня восстановления ключей

Microsoft 365 требует, чтобы для подписки Azure Key Vault было установлено значение "Не отменять" и что для ключей, используемых ключом клиента, включено мягкое удаление. Вы можете подтвердить это, изусмотрив уровень восстановления на ключах.
  
Чтобы проверить уровень восстановления ключа, в Azure PowerShell выполните Get-AzKeyVaultKey следующим образом:
  
```powershell
(Get-AzKeyVaultKey -VaultName <vault name> -Name <key name>).Attributes
```

Если свойство _уровня_ восстановления возвращает что-либо, кроме значения **Recoverable+ProtectedSubscription,** вам потребуется просмотреть эту статью и убедиться, что вы следовали всем шагам, чтобы поместить подписку в список "Не отменять" и что в каждом хранилище ключей включено мягкое удаление.
  
### <a name="back-up-azure-key-vault"></a>Back up Azure Key Vault

Сразу после создания или изменения ключа выполните резервное копирование и хранение копий резервного копирования как в сети, так и в автономном режиме. Автономные копии не должны быть подключены к какой-либо сети, например к физическому безопасному или коммерческому хранилищу. По крайней мере одна копия резервной копии должна храниться в расположении, доступном в случае аварии. Резервные BLOB-ели являются единственным средством восстановления материала ключа, если ключ Key Vault будет окончательно уничтожен или иным образом отрисовке неоперабельно. Ключи, которые являются внешними по внешнему хранилищу Azure Key Vault и были импортироваться в Azure Key Vault, не являются резервными, так как метаданные, необходимые для использования ключа клиента, не существуют с внешним ключом. Для операций восстановления с помощью ключа клиента можно использовать только резервную копию, взятую из хранилища Azure Key Vault. Поэтому важно создать резервную копию хранилища Azure Key Vault после отправки или создания ключа.
  
Чтобы создать резервную копию ключа Azure Key Vault, выполните его с использованием резервного копирования [AzKeyVaultKey](https://docs.microsoft.com/powershell/module/az.keyvault/backup-azkeyvaultkey) следующим образом:

```powershell
Backup-AzKeyVaultKey -VaultName <vault name> -Name <key name>
-OutputFile <filename.backup>
```

Убедитесь, что выходной файл использует `.backup` суффикс.
  
Выходной файл, который является результатом этого cmdlet, шифруется и не может использоваться за пределами хранилища Azure Key Vault. Резервную копию можно восстановить только в подписке Azure, из которой была сделана резервная копия.
  
> [!TIP]
> В выходном файле выберите сочетание имени хранилища и имени ключа. В этом случае имя файла будет самоо описано. Это также гарантирует, что имена файлов резервных копий не будут скомпоряться.
  
Например:
  
```powershell
Backup-AzKeyVaultKey -VaultName Contoso-O365EX-NA-VaultA1 -Name Contoso-O365EX-NA-VaultA1-Key001 -OutputFile Contoso-O365EX-NA-VaultA1-Key001-Backup-20170802.backup
```

### <a name="validate-azure-key-vault-configuration-settings"></a>Проверка параметров конфигурации Azure Key Vault

Выполнение проверки перед использованием ключей в DEP является необязательным, но настоятельно рекомендуется. В частности, при использовании действий по настройке ключей и хранилищ, не описанных в этом разделе, необходимо проверить состояние ресурсов Azure Key Vault перед настройкой ключа клиента.
  
Чтобы убедиться, что для ваших ключей включены операции get, wrapKey и unwrapKey:
  
Запустите [cmdlet Get-AzKeyVault](https://docs.microsoft.com/powershell/module/az.keyvault/get-azkeyvault) следующим образом:
  
```powershell
Get-AzKeyVault -VaultName <vault name>
```

В выходных данных найди политику доступа и идентификатор Exchange Online (GUID) или идентификатор SharePoint Online (GUID) соответствующим образом. Все три вышеуказанных разрешения должны быть показаны в области "Разрешения для ключей".
  
Если конфигурация политики доступа неправильная, выполните Set-AzKeyVaultAccessPolicy следующим образом:
  
```powershell
Set-AzKeyVaultAccessPolicy -VaultName <vault name> -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName <Office 365 appID>
```

Например, для Exchange Online и Skype для бизнеса:
  
```powershell
Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 
-PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000002-0000-0ff1-ce00-000000000000
```

Например, для SharePoint Online и OneDrive для бизнеса:
  
```powershell
Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365SP-NA-VaultA1
-PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000003-0000-0ff1-ce00-000000000000
```

Чтобы убедиться, что дата окончания срока действия ключей не установлена, выполните cmdlet [Get-AzKeyVaultKey](https://docs.microsoft.com/powershell/module/az.keyvault/get-azkeyvault) следующим образом:
  
```powershell
Get-AzKeyVaultKey -VaultName <vault name>
```

Ключ клиента не может использовать ключ клиента с истекшим сроком действия, что приведет к сбойу операций с ключом с истекшим сроком действия, что может привести к сбойу службы. Настоятельно рекомендуется, чтобы у ключей, используемых с ключом клиента, не было даты окончания срока действия. Установленную дату окончания срока действия невозможно удалить, но ее можно изменить на другую дату. Если необходимо использовать ключ с установленным сроком действия, измените значение срока действия на 31.01.9999. Ключи с датой окончания срока действия, задав не более 31.01.9999, не проходят проверку Microsoft 365.
  
Чтобы изменить дату окончания срока действия, задав любое значение, кроме 31.01.9999, выполните этот запуск следующим образом: [](https://docs.microsoft.com/powershell/module/az.keyvault/update-azkeyvaultkey)
  
```powershell
Update-AzKeyVaultKey -VaultName <vault name> -Name <key name> -Expires (Get-Date -Date "12/31/9999")
```

> [!CAUTION]
> Не устанавливайте срок действия ключей шифрования, которые вы используете с ключом клиента.
  
### <a name="obtain-the-uri-for-each-azure-key-vault-key"></a>Получение URI для каждого ключа Azure Key Vault

После завершения всех действий в Azure по настройкам хранилищ ключей и добавлению ключей, запустите следующую команду, чтобы получить URI для ключа в каждом хранилище ключей. Эти ЮРИС потребуется использовать при создании и назначении каждого DEP позже, поэтому сохраните эти сведения в надежном месте. Не забудьте выполнить эту команду один раз для каждого хранилища ключей.
  
В Azure PowerShell:
  
```powershell
(Get-AzKeyVaultKey -VaultName <vault name>).Id
```

## <a name="office-365-setting-up-customer-key-for-exchange-online-and-skype-for-business"></a>Office 365: настройка ключа клиента для Exchange Online и Skype для бизнеса

Перед началом убедитесь, что выполнены задачи, необходимые для задания Хранилища Azure Key Vault. Сведения см. в подробной информации о задачах в Azure Key Vault и [Microsoft FastTrack для ключа](#complete-tasks-in-azure-key-vault-and-microsoft-fasttrack-for-customer-key) клиента.
  
Чтобы настроить ключ клиента для Exchange Online и Skype для бизнеса, необходимо выполнить эти действия, удаленно подключившись к Exchange Online с помощью Windows PowerShell.
  
### <a name="create-a-data-encryption-policy-dep-for-use-with-exchange-online-and-skype-for-business"></a>Создание политики шифрования данных (DEP) для использования с Exchange Online и Skype для бизнеса

DeP связан с набором ключей, хранимой в хранилище Azure Key Vault. Вы назначаете DEP почтовому ящику в Microsoft 365. Затем Microsoft 365 будет использовать ключи, выявленные в политике, для шифрования почтового ящика. Для создания DEP необходимы полученные ранее URIS хранилища Ключей. Инструкции см. в инструкциях по получению URI для каждого ключа [Azure Key Vault.](#obtain-the-uri-for-each-azure-key-vault-key)
  
Помните! При создании DEP вы указываете два ключа, которые находятся в двух разных хранилищах Azure Key Vault. Убедитесь, что эти ключи расположены в двух отдельных регионах Azure, чтобы обеспечить геоизбытную избыточность.
  
Чтобы создать DEP, выполните следующие действия:
  
1. На локальном компьютере, используя учетную запись для работы или учебного заведения с разрешениями глобального администратора в организации, подключите к [Exchange Online PowerShell](https://docs.microsoft.com/powershell/exchange/connect-to-exchange-online-powershell) в Windows PowerShell окна.

2. Чтобы создать DEP, используйте командлет New-DataEncryptionPolicy, введя следующую команду.

   ```powershell
   New-DataEncryptionPolicy -Name <PolicyName> -Description "Policy Description" -AzureKeyIDs <KeyVaultURI1>, <KeyVaultURI2>
   ```

   Где:

   - *PolicyName* — это имя, которое вы хотите использовать для политики. Имена не могут содержать пробелы. Например, USA_mailboxes.

   - *Описание политики* — это удобное описание политики, которое поможет вам запомнить, для чего она нужна. В описание можно включить пробелы. Например, "Корневой ключ для почтовых ящиков в США и его территории".

   - *KeyVaultURI1* — это URI для первого ключа в политике. Например, <https://contoso_EastUSvault01.vault.azure.net/keys/USA_key_01>.

   - *KeyVaultURI2* — это URI для второго ключа политики. Например, <https://contoso_EastUS2vault01.vault.azure.net/keys/USA_Key_02>. Разделять два URIS запятой и пробелом.

   Пример:
  
   ```powershell
   New-DataEncryptionPolicy -Name USA_mailboxes -Description "Root key for mailboxes in USA and its territories" -AzureKeyIDs https://contoso_EastUSvault01.vault.azure.net/keys/USA_key_01, https://contoso_EastUS2vault01.vault.azure.net/keys/USA_Key_02
   ```

Подробные сведения о синтаксисах и параметрах см. в описании [New-DataEncryptionPolicy.](https://docs.microsoft.com/powershell/module/exchange/new-data-encryptionpolicy)

### <a name="assign-a-dep-to-a-mailbox"></a>Назначение DEP почтовому ящику

Назначьте DEP почтовому ящику с помощью Set-Mailbox управления. После назначения политики Microsoft 365 может зашифровать почтовый ящик с помощью ключа, назначенного в DEP.
  
```powershell
Set-Mailbox -Identity <MailboxIdParameter> -DataEncryptionPolicy <PolicyName>
```

Где *MailboxIdParameter* указывает почтовый ящик. Дополнительные сведения о Set-Mailbox см. в [подстроке Set-Mailbox.](https://docs.microsoft.com/powershell/module/exchange/set-mailbox)

Для почтовых ящиков, использующих Outlook для [iOS](https://docs.microsoft.com/exchange/clients/outlook-for-ios-and-android/use-hybrid-modern-auth)и Android с гибридной современной проверкой подлинности, данные локального почтового ящика, синхронизируются с клиентом Exchange Online, могут иметь назначенную DEP с помощью Set-MailUser.

```powershell
Set-MailUser -Identity <MailUserIdParameter> -DataEncryptionPolicy <PolicyName>
```

Где *MailUserIdParameter* указывает пользователя почты (также известного как пользователь с включенной поддержкой почты). Дополнительные сведения о Set-MailUser см. в [подстроке Set-MailUser.](https://docs.microsoft.com/powershell/module/exchange/set-mailuser)
  
### <a name="validate-mailbox-encryption"></a>Проверка шифрования почтовых ящиков

Шифрование почтового ящика может занять некоторое время. При первом назначении политики почтовый ящик также должен полностью перемещаться из одной базы данных в другую, прежде чем служба сможет зашифровать почтовый ящик. Рекомендуется подождать 72 часа, прежде чем пытаться проверить шифрование после изменения DEP или при первом назначении DEP почтовому ящику.
  
Используйте Get-MailboxStatistics, чтобы определить, зашифрован ли почтовый ящик.
  
```powershell
Get-MailboxStatistics -Identity <GeneralMailboxOrMailUserIdParameter> | fl IsEncrypted
```

Свойство IsEncrypted возвращает значение **true,** если почтовый ящик зашифрован, и значение **false,** если почтовый ящик не зашифрован.

Время завершения перемещения почтовых ящиков зависит от количества почтовых ящиков, которым в первый раз назначается DEP, а также от размера почтовых ящиков. Если почтовые ящики не были зашифрованы через неделю с того времени, когда вы написали DEP, обратитесь в корпорацию Майкрософт.

## <a name="office-365-setting-up-customer-key-for-sharepoint-online-onedrive-for-business-and-teams-files"></a>Office 365: настройка ключа клиента для файлов SharePoint Online, OneDrive для бизнеса и Teams

Перед началом убедитесь, что выполнены задачи, необходимые для задания Хранилища Azure Key Vault. Сведения см. в подробной информации о задачах в Azure Key Vault и [Microsoft FastTrack для ключа](#complete-tasks-in-azure-key-vault-and-microsoft-fasttrack-for-customer-key) клиента.
  
Чтобы настроить ключ клиента для файлов SharePoint Online, OneDrive для бизнеса и Teams, необходимо выполнить эти действия, удаленно подключившись к SharePoint Online с помощью Windows PowerShell.
  
### <a name="create-a-data-encryption-policy-dep-for-each-sharepoint-online-and-onedrive-for-business-geo"></a>Создание политики шифрования данных (DEP) для каждого географического центра SharePoint Online и OneDrive для бизнеса

DeP связывается с набором ключей, хранимой в хранилище Azure Key Vault. DeP применяется к всем данным в одном географическом расположении, также называемом географической областью. Если вы используете функцию Office 365 с несколькими географическими службами, вы можете создать одну DEP для каждого географического уровня с возможностью использования разных ключей для каждого географического. Если вы не используете несколько географических точки, вы можете создать в своей организации одну deP для использования с файлами SharePoint Online, OneDrive для бизнеса и Teams. Microsoft 365 использует ключи, выявленные в DEP, для шифрования данных в этом географическом области. Для создания DEP необходимы полученные ранее URIS хранилища Ключей. Инструкции см. в инструкциях по получению URI для каждого ключа [Azure Key Vault.](#obtain-the-uri-for-each-azure-key-vault-key)
  
Помните! При создании DEP вы указываете два ключа, которые находятся в двух разных хранилищах Azure Key Vault. Убедитесь, что эти ключи расположены в двух отдельных регионах Azure, чтобы обеспечить геоизбытную избыточность.
  
Чтобы создать DEP, необходимо удаленно подключиться к SharePoint Online с помощью Windows PowerShell.
  
1. На локальном компьютере, используя учетную запись для работы или учебного заведения с разрешениями глобального администратора в организации, подключитесь [к SharePoint Online PowerShell.](https://docs.microsoft.com/powershell/sharepoint/sharepoint-online/connect-sharepoint-online?view=sharepoint-ps&preserve-view=true)

2. В microsoft SharePoint Online Management Shell выполните Register-SPODataEncryptionPolicy следующим образом:

   ```powershell
   Register-SPODataEncryptionPolicy -Identity <adminSiteCollectionURL> -PrimaryKeyVaultName <PrimaryKeyVaultName> -PrimaryKeyName <PrimaryKeyName> -PrimaryKeyVersion <PrimaryKeyVersion> -SecondaryKeyVaultName <SecondaryKeyVaultName> -SecondaryKeyName <SecondaryKeyName> -SecondaryKeyVersion <SecondaryKeyVersion>
   ```

   Пример:
  
   ```powershell
   Register-SPODataEncryptionPolicy -Identity https://contoso.sharepoint.com -PrimaryKeyVaultName 'stageRG3vault' -PrimaryKeyName 'SPKey3' -PrimaryKeyVersion 'f635a23bd4a44b9996ff6aadd88d42ba' -SecondaryKeyVaultName 'stageRG5vault' -SecondaryKeyName 'SPKey5' -SecondaryKeyVersion '2b3e8f1d754f438dacdec1f0945f251a’
   ```

   При регистрации DEP шифрование начинается с данных в географическом области. Это может занять некоторое время. Дополнительные сведения об использовании этого параметра см. в записи [Register-SPODataEncryptionPolicy.](https://docs.microsoft.com/powershell/module/sharepoint-online/register-spodataencryptionpolicy?view=sharepoint-ps&preserve-view=true)

### <a name="validate-file-encryption"></a>Проверка шифрования файлов

 Чтобы проверить шифрование файлов SharePoint Online, OneDrive для бизнеса и Teams, подключитесь к [SharePoint Online PowerShell,](https://docs.microsoft.com/powershell/exchange/connect-to-exchange-online-powershell)а затем с помощью командлета Get-SPODataEncryptionPolicy проверьте состояние клиента. Свойство _State_ возвращает значение  зарегистрированного, если шифрование ключа клиента включено и все файлы на всех сайтах были зашифрованы. Если шифрование еще не завершено, этот cmdlet предоставляет сведения о том, какой процент сайтов завершен.

## <a name="related-articles"></a>Статьи по теме

- [Шифрование службы с помощью ключа клиента](customer-key-overview.md)

- [Управление ключом клиента](customer-key-manage.md)

- [Смена или ротация ключа клиента или ключа доступности](customer-key-availability-key-roll.md)

- [Узнайте о ключе доступности](customer-key-availability-key-understand.md)

- [Шифрование службы](office-365-service-encryption.md)
