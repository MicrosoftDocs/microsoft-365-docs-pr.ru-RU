---
title: Настройка ключа клиента на уровне приложения
ms.author: krowley
author: kccross
manager: laurawi
ms.date: 02/05/2020
audience: ITPro
ms.topic: article
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- MET150
ms.collection:
- M365-security-compliance
description: Узнайте, как настроить ключ клиента для Microsoft 365 для Exchange Online, Skype для бизнеса, SharePoint Online, OneDrive для бизнеса и команд.
ms.openlocfilehash: a7a0c807b8778960d423d6b7d8afc20430ba89ad
ms.sourcegitcommit: 27b2b2e5c41934b918cac2c171556c45e36661bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "50922723"
---
# <a name="set-up-customer-key-at-the-application-level"></a>Настройка ключа клиента на уровне приложения

С помощью ключа клиента вы управляете ключами шифрования организации, а затем настраивает Microsoft 365, чтобы использовать их для шифрования данных в центрах обработки данных Майкрософт. Другими словами, клиентский ключ позволяет клиентам добавлять принадлежащий им уровень шифрования с помощью ключей. К ним относятся данные из Exchange Online и Skype для бизнеса, хранящиеся в почтовых ящиках, а также файлы, хранящиеся в SharePoint Online и OneDrive для бизнеса.

Прежде чем использовать ключ клиента для Office 365, необходимо настроить Azure. В этой статье описываются действия, которые необходимо предпринять для создания и настройки необходимых ресурсов Azure, а затем следуют действия по настройке ключа клиента в Office 365. После завершения установки Azure определите, какую политику и, следовательно, какие ключи назначить почтовым ящикам и файлам в организации. Почтовые ящики и файлы, для которых не назначается политика, будут использовать политики шифрования, контролируемые и управляемые Корпорацией Майкрософт. Дополнительные сведения о ключе клиента или общие сведения см. в сообщении шифрования службы с ключом клиента [в Office 365.](customer-key-overview.md)
  
> [!IMPORTANT]
> Мы настоятельно рекомендуем вам следовать рекомендациям в этой статье. Они называются **TIP и** **IMPORTANT**. Ключ клиента позволяет управлять ключами корневого шифрования, область которых может быть не больше всей организации. Это означает, что ошибки, допущенные с помощью этих ключей, могут иметь широкий эффект и привести к перебоям в работе службы или к безвозвратной потере данных.
  
## <a name="before-you-set-up-customer-key"></a>Перед настройками ключа клиента

Перед началом работы убедитесь, что у вас есть соответствующее лицензирование для вашей организации. Используйте платную подписку Azure с Соглашение Enterprise или поставщика облачных служб. Подписки Azure, приобретенные с помощью планов Pay As You Go или с помощью кредитной карты, не поддерживаются для ключа клиента. С 1 апреля 2020 г. ключ клиента в Office 365 предлагается в Office 365 E5, M365 E5, M365 E5 Compliance и M365 E5 Information Protection & Governance SKUs. Office 365 Advanced Compliance SKU больше не доступен для получения новых лицензий. Существующие лицензии на расширенный соответствие Office 365 будут по-прежнему поддерживаться.

Чтобы понять понятия и процедуры в этой статье, просмотрите документацию [Azure Key Vault.](/azure/key-vault/) Кроме того, ознакомьтесь с терминами, используемыми в Azure, например, [клиентом Azure AD.](/previous-versions/azure/azure-services/jj573650(v=azure.100)#what-is-an-azure-ad-tenant)

FastTrack используется только для сбора необходимых сведений о конфигурации клиента и службы, используемых для регистрации ключа клиента. Предложения ключа клиента публикуются через FastTrack, чтобы вам и нашим партнерам было удобно отправлять необходимые сведения с помощью того же метода. FastTrack также упрощает архивировать данные, которые вы предоставляете в Предложении.
  
Если требуется больше поддержки за пределами документации, обратитесь за помощью к Microsoft Consulting Services (MCS), Premier Field Engineering (PFE) или партнеру Майкрософт. Чтобы предоставить отзывы о ключе клиента, включая документацию, отправьте свои идеи, предложения и перспективы в customerkeyfeedback@microsoft.com.
  
## <a name="overview-of-steps-to-set-up-customer-key"></a>Обзор действий по настройкам ключа клиента

Чтобы настроить ключ клиента, выполните эти задачи в перечисленом порядке. В остальной части этой статьи данная статья содержит подробные инструкции для каждой задачи или ссылается на дополнительные сведения для каждого шага процесса.
  
**В Azure и Microsoft FastTrack:**
  
Большинство этих задач можно выполнить, удаленно подключившись к Azure PowerShell. Для наилучших результатов используйте версию 4.4.0 или более поздней версии Azure PowerShell.
  
- [Создание двух новых подписок Azure](#create-two-new-azure-subscriptions)

- [Регистрация подписки Azure для использования обязательного периода хранения](#register-azure-subscriptions-to-use-a-mandatory-retention-period)

  Регистрация может занять от одного до пяти бизнес-дней.

- [Отправка запроса на активацию ключа клиента для Office 365](#submit-a-request-to-activate-customer-key-for-office-365)

После создания двух новых подписок Azure необходимо отправить соответствующий запрос на предложение Ключ клиента, заполнив веб-форму, которая находится на портале Microsoft FastTrack. **Команда FastTrack не предоставляет помощь с ключом клиента. Office просто использует портал FastTrack для** отправки формы и отслеживания соответствующих предложений для клиента.

- [Создание хранилища ключей Azure премиум класса в каждой подписке](#create-a-premium-azure-key-vault-in-each-subscription)

- [Назначение разрешений для каждого хранилища ключей](#assign-permissions-to-each-key-vault)

- [Включить и затем подтвердить мягкое удаление в хранилищах ключей](#enable-and-then-confirm-soft-delete-on-your-key-vaults)

- [Добавление ключа в каждый хранилище ключей путем создания или импорта ключа](#add-a-key-to-each-key-vault-either-by-creating-or-importing-a-key)

- [Проверьте уровень восстановления ключей](#check-the-recovery-level-of-your-keys)

- [Back up Azure Key Vault](#back-up-azure-key-vault)

- [Проверка параметров конфигурации хранилища ключей Azure](#validate-azure-key-vault-configuration-settings)

- [Получение URI для каждого ключа Azure Key Vault](#obtain-the-uri-for-each-azure-key-vault-key)

**В Office 365:**
  
Exchange Online и Skype для бизнеса:
  
- [Создание политики шифрования данных (DEP) для использования в Exchange Online и Skype для бизнеса](#create-a-data-encryption-policy-dep-for-use-with-exchange-online-and-skype-for-business)

- [Назначение deP почтовому ящику](#assign-a-dep-to-a-mailbox)

- [Проверка шифрования почтовых ящиков](#validate-mailbox-encryption)

SharePoint Online и OneDrive для бизнеса:
  
- [Создание политики шифрования данных (DEP) для каждого geo SharePoint Online и OneDrive для бизнеса](#create-a-data-encryption-policy-dep-for-each-sharepoint-online-and-onedrive-for-business-geo)

- [Проверка шифрования файлов для файлов SharePoint Online, OneDrive для бизнеса и Teams](#validate-file-encryption)

## <a name="complete-tasks-in-azure-key-vault-and-microsoft-fasttrack-for-customer-key"></a>Выполнение задач в хранилище ключей Azure и Microsoft FastTrack для ключа клиента

Выполните эти задачи в Хранилище ключей Azure. Вам необходимо выполнить эти действия независимо от того, собираетесь ли вы настроить ключ клиента для Exchange Online и Skype для бизнеса или для файлов SharePoint Online, OneDrive для бизнеса и Teams или для всех поддерживаемых служб в Office 365.
  
### <a name="create-two-new-azure-subscriptions"></a>Создание двух новых подписок Azure

Для ключа клиента требуется две подписки Azure. В качестве наилучшей практики Корпорация Майкрософт рекомендует создавать новые подписки Azure для использования с помощью ключа клиента. Ключи хранилища ключей Azure можно разрешить только для приложений в том же клиенте Azure Active Directory (Microsoft Azure Active Directory), необходимо создать новые подписки с помощью того же клиента Azure AD, используемого в организации, где будут назначены dePs. Например, использование учетной записи для работы или учебного заведения с глобальными привилегиями администратора в организации. Подробные действия см. [в документе Sign up for Azure as an organization.](/azure/active-directory/fundamentals/sign-up-organization)
  
> [!IMPORTANT]
> Ключ клиента требует двух ключей для каждой политики шифрования данных (DEP). Для этого необходимо создать две подписки Azure. В качестве наилучшей практики Корпорация Майкрософт рекомендует, чтобы отдельные члены организации настраивали один ключ в каждой подписке. Эти подписки Azure следует использовать только для администрирования ключей шифрования для Office 365. Это защищает организацию, если один из операторов случайно, намеренно или злонамеренно удаляет или иным образом неправильно передает ключи, за которые они несут ответственность.
>

Практические ограничения на количество подписок Azure, которые можно создать для вашей организации, не ограничиваются. Следуя этим лучшим практикам, свести к минимуму влияние человеческой ошибки, помогая управлять ресурсами, используемыми клиентской клавишей.
  
### <a name="submit-a-request-to-activate-customer-key-for-office-365"></a>Отправка запроса на активацию ключа клиента для Office 365

После завершения действий Azure необходимо отправить запрос на предложение на [портале Microsoft FastTrack.](https://fasttrack.microsoft.com/) После отправки запроса через веб-портал FastTrack Корпорация Майкрософт проверяет данные конфигурации Хранилища ключей Azure и предоставленные вами контактные данные. Выборы, которые вы делаете в форме предложения о уполномоченных должностных лиц вашей организации, имеют решающее значение и необходимы для завершения регистрации клиентского ключа. Сотрудники вашей организации обеспечивают подлинность любого запроса на отвод и уничтожение всех ключей, используемых с помощью политики шифрования данных "Ключ клиента". Этот шаг необходимо сделать один раз, чтобы активировать клиентский ключ для exchange Online и Skype для бизнеса, а второй раз — для активации ключа клиента для SharePoint Online и OneDrive для бизнеса.
  
Чтобы отправить предложение по активации ключа клиента, выполните следующие действия:
  
1. Используя учетную запись для работы или школы, которая имеет глобальные разрешения администратора в организации, вопишитесь на [портал Microsoft FastTrack.](https://fasttrack.microsoft.com/)

2. После входа в систему просмотрите панель **мониторинга.**

3. Выберите **Развертывание** из панели навигации **или** выберите **Просмотр** всех ресурсов развертывания на информационной карте **Развертывание** и просмотрите список текущих предложений.

4. Выберите информационную карточку для предложения, которое применяется к вам:

   - **Exchange Online и Skype для бизнеса:** Выберите **справку по шифрованию запроса для предложения Exchange online.**

   - **Файлы SharePoint Online, OneDrive и Teams:** Выберите **справку по шифрованию запроса для предложения Sharepoint и OneDrive.**

5. После просмотра сведений о предложении выберите **Продолжить шаг 2**.

6. Заполните все применимые сведения и запрашиваемые сведения в форме предложения. Уделите особое внимание выборам, для которых сотрудникам вашей организации необходимо разрешить постоянное и необратимое уничтожение ключей шифрования и данных. После завершения формы выберите **Отправить**.

### <a name="register-azure-subscriptions-to-use-a-mandatory-retention-period"></a>Регистрация подписки Azure для использования обязательного периода хранения

Временная или постоянная потеря ключей корневого шифрования может привести к нарушению работы службы или даже к катастрофическим последствиям, что может привести к потере данных. По этой причине ресурсы, используемые с ключом клиента, требуют сильной защиты. Все ресурсы Azure, используемые с помощью ключа клиента, предлагают механизмы защиты за пределами конфигурации по умолчанию. Вы можете отметить или зарегистрировать подписки Azure на *обязательный период хранения.* Обязательный период хранения не позволяет немедленно и безвозвратно отменить подписку на Azure. Действия, необходимые для регистрации подписки Azure на обязательный период хранения, требуют совместной работы с командой Microsoft 365. Этот процесс может занять от одного до пяти бизнес-дней. Ранее обязательный период хранения иногда назывался "Не отменять".
  
Прежде чем связаться с командой Microsoft 365, необходимо сделать следующие действия для каждой подписки Azure, используемой с помощью ключа клиента. Убедитесь, что перед запуском установлен модуль [Azure PowerShell Az.](/powershell/azure/new-azureps-module-az)
  
1. Во входе в Azure PowerShell. Инструкции см. в [документе Вход с Azure PowerShell.](/powershell/azure/authenticate-azureps)

2. Запустите Register-AzProviderFeature для регистрации подписок, чтобы использовать обязательный период хранения. Выполните это действие для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Register-AzProviderFeature -FeatureName mandatoryRetentionPeriodEnabled -ProviderNamespace Microsoft.Resources
   ```

3. Свяжитесь с Корпорацией Майкрософт, чтобы завершить этот процесс. Для группы SharePoint и OneDrive для бизнеса свяжитесь [с](mailto:spock@microsoft.com)spock@microsoft.com. Для Exchange Online и Skype для бизнеса свяжитесь [с](mailto:exock@microsoft.com)exock@microsoft.com . Включите в электронную почту следующие сведения:

   **Тема:** Ключ клиента для \<*Your tenant's fully qualified domain name*\>

   **Body.** Включай подписные ИД, для которых необходимо завершить обязательный период хранения, и Get-AzProviderFeature для каждой подписки.

   Соглашение об уровне обслуживания (SLA) для завершения этого процесса составляет пять бизнес-дней после уведомления (и проверки) Корпорации Майкрософт о том, что вы зарегистрировали подписки для использования обязательного периода хранения.

4. После получения уведомления от Корпорации Майкрософт о том, что регистрация завершена, проверьте состояние вашей регистрации, Get-AzProviderFeature команду следующим образом. В случае проверки Get-AzProviderFeature возвращает значение **Registered** for the **Registration State** property. Выполните этот шаг для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Get-AzProviderFeature -ProviderNamespace Microsoft.Resources -FeatureName mandatoryRetentionPeriodEnabled
   ```

5. Чтобы завершить процесс, выполните команду Register-AzResourceProvider. Выполните этот шаг для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Register-AzResourceProvider -ProviderNamespace Microsoft.KeyVault
   ```

### <a name="create-a-premium-azure-key-vault-in-each-subscription"></a>Создание хранилища ключей Azure премиум класса в каждой подписке

Действия по созданию хранилища ключей описаны в журнале [Getting Started with Azure Key Vault,](/azure/key-vault/general/overview)который поможет вам установить и запустить Azure PowerShell, подключиться к подписке Azure, создать группу ресурсов и создать хранилище ключей в этой группе ресурсов.
  
При создании хранилища ключей необходимо выбрать SKU: standard или Premium. Стандартный SKU позволяет защищать ключи хранилища ключей Azure с помощью программного обеспечения , а защита ключей модуля безопасности оборудования (HSM) не обеспечивается, а SKU Premium позволяет использовать HSM для защиты ключей хранилища ключей. Ключ клиента принимает ключевые хранилища, которые используют либо SKU, но Корпорация Майкрософт настоятельно рекомендует использовать только SKU Premium. Стоимость операций с ключами обоих типов одна и та же, поэтому единственной разницей в стоимости является стоимость в месяц для каждого ключа, защищенного HSM. Подробные [сведения см. в расценки Key Vault.](https://azure.microsoft.com/pricing/details/key-vault/)
  
> [!IMPORTANT]
> Используйте хранилища ключей Премиум SKU и защищенные HSM-ключи для производственных данных и используйте только хранилища и ключи ключей standard SKU для тестирования и проверки.
  
Для каждой службы Microsoft 365, с помощью которой вы будете использовать ключ клиента, создайте хранилище ключей в каждой из двух созданных подписок Azure. Например, только для Exchange Online и Skype для бизнеса или SharePoint Online и OneDrive для бизнеса создается только одна пара сводов. Чтобы включить ключ клиента для Exchange Online и SharePoint Online, вы создайте две пары ключевых сводов.
  
Используйте конвенцию именования для ключевых сводов, которая отражает предназначенное использование deP, с которым вы будете связывать хранилища. Ниже см. раздел Рекомендации по рекомендациям по найму конвенции.
  
Создайте отдельный парный набор сводов для каждой политики шифрования данных. Для Exchange Online область политики шифрования данных выбирается вами при назначении политики почтовому ящику. В почтовом ящике может быть назначена только одна политика, и можно создать до 50 политик. Область политики SharePoint Online включает все данные в организации в географическом расположении или _в гео._

Создание ключевых сводов также требует создания групп ресурсов Azure, так как ключевые хранилища нуждаются в емкости хранения (хотя и небольшой), а ведение журнала Key Vault, если включено, также создает хранимые данные. В качестве наилучшей практики Корпорация Майкрософт рекомендует использовать отдельных администраторов для управления каждой группой ресурсов с администрированием, которое соответствует набору администраторов, которые будут управлять всеми связанными ресурсами клиентского ключа.
  
> [!IMPORTANT]
> Чтобы обеспечить максимальную доступность, ваши хранилища ключей должны быть в регионах, близких к службе Microsoft 365. Например, если ваша организация Exchange Online находится в Северной Америке, поместите ключевые хранилища в Северной Америке. Если ваша организация Exchange Online находится в Европе, поместите ключевые хранилища в Европе.
> 
> Используйте общую префикс для ключевых сводов и включаем аббревиатура использования и области ключей и хранилища ключей (например, для службы Contoso SharePoint, где хранилища будут расположены в Северной Америке, возможной парой имен является Contoso-O365SP-NA-VaultA1 и Contoso-O365SP-NA-VaultA2. Имена Vault — это уникальные строки в Azure, поэтому вам может потребоваться попробовать варианты желаемых имен, если нужные имена уже заявлены другими клиентами Azure. По данным на июль 2017 г. имена хранилища не могут быть изменены, поэтому лучше всего иметь письменный план установки и использовать второго человека для проверки правильности выполнения плана.
> 
> По возможности создайте хранилища в непарных регионах. В парных регионах Azure обеспечивается высокая доступность для доменов сбоя службы. Поэтому региональные пары можно использовать как область резервного копирования друг друга. Это означает, что ресурс Azure, размещенный в одном регионе, автоматически получает переносимость ошибок через спаривную область. По этой причине выбор регионов для двух сводов, используемых в политике шифрования данных, где регионы сопряжены, означает, что используется только два региона доступности. В большинстве географических регионов только два региона, поэтому выбрать непарные регионы пока невозможно. По возможности выберите два непарных региона для двух сводов, используемых с политикой шифрования данных. Это дает в общей сложности четыре региона доступности. Дополнительные сведения см. в дополнительных сведениях о непрерывности бизнеса и аварийном восстановлении [(BCDR): Azure Paired Regions](/azure/best-practices-availability-paired-regions) для текущего списка региональных пар.
  
### <a name="assign-permissions-to-each-key-vault"></a>Назначение разрешений для каждого хранилища ключей

В зависимости от реализации необходимо определить три отдельных набора разрешений для каждого хранилища ключей. Например, необходимо определить один набор разрешений для каждого из следующих ниже.
  
- **Администраторы ключей хранилища,** которые ежедневно руководствуют вашим хранилищем ключей для вашей организации. Эти задачи включают резервное копирование, создание, получения, импорт, список и восстановление.

  > [!IMPORTANT]
  > Набор разрешений, присвоенных администраторам ключей хранилища, не включает разрешение на удаление ключей. Это является преднамеренной и важной практикой. Удаление ключей шифрования обычно не делается, так как это постоянно уничтожает данные. В качестве наилучшей практики не предоставлять это разрешение администраторам хранилища по умолчанию. Вместо этого зарезервировать это для ключевых участников хранилища и назначить его администратору только на краткосрочной основе после четкого понимания последствий.
  
  Чтобы назначить эти разрешения пользователю в организации, впишитесь в подписку Azure с помощью Azure PowerShell. Инструкции см. в [документе Вход с Azure PowerShell.](/powershell/azure/authenticate-azureps)

- Запустите Set-AzKeyVaultAccessPolicy, чтобы назначить необходимые разрешения.

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName <vault name> -UserPrincipalName <UPN of user> -PermissionsToKeys create,import,list,get,backup,restore
   ```

   Пример:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 -UserPrincipalName alice@contoso.com -PermissionsToKeys create,import,list,get,backup,restore
   ```

- **Ключевые вкладчики хранилища,** которые могут изменять разрешения в самом хранилище ключей Azure. Эти разрешения необходимо изменить по мере того, как сотрудники покидают команду или присоединяются к ней. В редких случаях, когда администраторам ключей хранилища на законных основаниях требуется разрешение на удаление или восстановление ключа, необходимо также изменить разрешения. Этот набор ключевых участников хранилища должен быть предоставлен роль **Contributor** в вашем хранилище ключей. Эту роль можно назначить с помощью Azure Resource Manager. Подробные действия см. в Role-Based Access Control для управления доступом [к ресурсам подписки Azure.](/azure/active-directory/role-based-access-control-configure) Администратор, создавший подписку, имеет этот доступ неявно, а также возможность назначать другим администраторам роль Автора.

- Если вы собираетесь использовать ключ клиента в Exchange Online и Skype для бизнеса, необходимо предоставить разрешение Microsoft 365 на использование ключа хранилища от имени Exchange Online и Skype для бизнеса. Кроме того, если вы собираетесь использовать ключ клиента с SharePoint Online и OneDrive для бизнеса, необходимо добавить разрешение для Microsoft 365 использовать хранилище ключей от имени SharePoint Online и OneDrive для бизнеса. Чтобы дать разрешение Microsoft 365, запустите кодлет **Set-AzKeyVaultAccessPolicy** с помощью следующего синтаксиса:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName <vault name> -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName <Office 365 appID>
   ```

   Где:

    - *имя хранилища* — это имя созданного хранилища ключей.

    - Для Exchange Online и Skype для бизнеса замените *приложение Office 365 на*`00000002-0000-0ff1-ce00-000000000000`

    - Для файлов SharePoint Online, OneDrive для бизнеса и Teams  *замените приложение Office 365* на `00000003-0000-0ff1-ce00-000000000000`

  Пример: Настройка разрешений для Exchange Online и Skype для бизнеса:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000002-0000-0ff1-ce00-000000000000
   ```

  Пример: Настройка разрешений для файлов SharePoint Online, OneDrive для бизнеса и Teams:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365SP-NA-VaultA1 -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000003-0000-0ff1-ce00-000000000000
   ```

### <a name="enable-and-then-confirm-soft-delete-on-your-key-vaults"></a>Включить и затем подтвердить мягкое удаление в хранилищах ключей

При быстром восстановлении ключей вероятность отключения расширенной службы будет меньше из-за случайного или злонамеренного удаления ключей. Необходимо включить эту конфигурацию, именуемую soft Delete, прежде чем использовать ключи с ключом клиента. Включение soft Delete позволяет восстановить ключи или хранилища в течение 90 дней после удаления, не восстанавливая их из резервного копирования.
  
Чтобы включить soft Delete в хранилищах ключей, выполните следующие действия:
  
1. Вопишите свою подписку Azure с помощью Windows PowerShell. Инструкции см. в [документе Вход с Azure PowerShell.](/powershell/azure/authenticate-azureps)

2. Запустите [кодлет Get-AzKeyVault.](/powershell/module/az.keyvault/get-azkeyvault) В этом примере *имя хранилища* — это имя хранилища ключей, для которого вы позволяете мягко удалять:

   ```powershell
   $v = Get-AzKeyVault -VaultName <vault name>
   $r = Get-AzResource -ResourceId $v.ResourceId
   $r.Properties | Add-Member -MemberType NoteProperty -Name enableSoftDelete -Value 'True'
   Set-AzResource -ResourceId $r.ResourceId -Properties $r.Properties
   ```

3. Подтвердите, что мягкое удаление настроено для хранилища ключей с помощью **cmdlet Get-AzKeyVault.** Если мягкое удаление настроено правильно для хранилища ключей, свойство _Soft Delete Enabled_ возвращает значение **True:**

   ```powershell
   Get-AzKeyVault -VaultName <vault name> | fl
   ```

### <a name="add-a-key-to-each-key-vault-either-by-creating-or-importing-a-key"></a>Добавление ключа в каждый хранилище ключей путем создания или импорта ключа

Существует два способа добавления ключей в хранилище ключей Azure; вы можете создать ключ непосредственно в Key Vault или импортировать ключ. Создание ключа непосредственно в Key Vault — это менее сложный метод, а импорт ключа обеспечивает полный контроль над тем, как создается ключ. Используйте клавиши RSA. Хранилище ключей Azure не поддерживает упаковку и разверивание с помощью ключей эллиптической кривой.
  
Чтобы создать ключ непосредственно в хранилище ключей, выполните [кодлет Add-AzKeyVaultKey](/powershell/module/az.keyvault/add-azkeyvaultkey) следующим образом:
  
```powershell
Add-AzKeyVaultKey -VaultName <vault name> -Name <key name> -Destination <HSM|Software> -KeyOps wrapKey,unwrapKey
```

Где:

- *имя хранилища* — это имя хранилища ключей, в котором необходимо создать ключ.

- *ключевое* имя — это имя, которое необходимо дать новому ключу.

  > [!TIP]
  > Клавиши имен, использующие аналогичную конвенцию именования, как описано выше, для ключевых сводов. Таким образом, в средствах, которые показывают только имя ключа, строка самоохвативна.
  
Если вы собираетесь защищать ключ с помощью HSM, убедитесь, что вы указываете **HSM** как значение параметра _Destination,_ в противном случае укажите **программное обеспечение.**

Пример.
  
```powershell
Add-AzKeyVaultKey -VaultName Contoso-O365EX-NA-VaultA1 -Name Contoso-O365EX-NA-VaultA1-Key001 -Destination HSM -KeyOps wrapKey,unwrapKey
```

Чтобы импортировать ключ непосредственно в хранилище ключей, необходимо иметь модуль безопасности nCipher nShield hardware.
  
Некоторые организации предпочитают этот подход, чтобы установить происхождение ключей, а затем этот метод также предоставляет следующие проверки:
  
- Инструментарий, используемый для импорта, включает в себя проверку из nCipher, что ключ key Exchange (KEK), используемый для шифрования генерируемого ключа, не является экспортируемым и создается внутри подлинного HSM, который был изготовлен nCipher.

- Набор инструментов включает проверку из nCipher, что мир безопасности Azure Key Vault также был создан на подлинном HSM, изготовленном nCipher. Это подтверждает, что Корпорация Майкрософт также использует подлинное оборудование nCipher.

Обратитесь к группе безопасности, чтобы определить, необходимы ли вышеуказанные проверки. Подробные действия по созданию локального ключа и его импорту в хранилище ключей см. в инструкции по созданию и передаче ключей, защищенных [HSM для Хранилища ключей Azure.](/azure/key-vault/keys/hsm-protected-keys) Используйте инструкции Azure для создания ключа в каждом хранилище ключей.
  
### <a name="check-the-recovery-level-of-your-keys"></a>Проверьте уровень восстановления ключей

Microsoft 365 требует, чтобы подписка На хранилище ключей Azure была установлена подписка "Не отменяйте", а ключи, используемые клиентской клавишей, имеют возможность мягкого удаления. Вы можете подтвердить параметры подписки, посмотрев уровень восстановления на клавишах.
  
Чтобы проверить уровень восстановления ключа, в Azure PowerShell выполните Get-AzKeyVaultKey следующим образом:
  
```powershell
(Get-AzKeyVaultKey -VaultName <vault name> -Name <key name>).Attributes
```

Если свойство _Уровня_ восстановления возвращает что-либо, кроме значения **Recoverable+ProtectedSubscription,** убедитесь, что подписка включена в список "Не отменяйте", и в каждом из ключевых сводов включено мягкое удаление.
  
### <a name="back-up-azure-key-vault"></a>Back up Azure Key Vault

Сразу после создания или изменения клавиши выполните резервное копирование и храните копии резервного копирования как в Интернете, так и в автономном режиме. Автономные копии не должны подключаться к какой-либо сети, например в физическом безопасном или коммерческом хранилище. По крайней мере одна копия резервного копирования должна храниться в месте, доступном в случае аварии. Blobs резервного копирования являются единственным средством восстановления ключевого материала в случае, если ключ Key Vault будет окончательно уничтожен или иным образом неоперабельным. Ключи, внешние для хранилища ключей Azure и импортируемые в Хранилище ключей Azure, не имеют права на резервное копирование, так как метаданные, необходимые для использования ключа клиента, не существуют с внешним ключом. Только резервная копия, взятая из хранилища ключей Azure, может использоваться для восстановления операций с ключом клиента. Поэтому необходимо создать резервную копию хранилища ключей Azure после загрузки или создания ключа.
  
Чтобы создать резервную копию ключа Azure Key Vault, выполните кодлет [Backup-AzKeyVaultKey](/powershell/module/az.keyvault/backup-azkeyvaultkey) следующим образом:

```powershell
Backup-AzKeyVaultKey -VaultName <vault name> -Name <key name>
-OutputFile <filename.backup>
```

Убедитесь, что в файле вывода используется `.backup` суффикс.
  
Файл вывода, выдающийся из этого комлета, шифруется и не может использоваться за пределами хранилища ключей Azure. Резервное копирование может быть восстановлено только в подписке Azure, из которой была взята резервная копия.
  
> [!TIP]
> Для файла вывода выберите сочетание имени хранилища и имени ключа. Это сделает само описание имени файла. Это также гарантирует, что имена файлов резервного копирования не сталкиваются.
  
Пример:
  
```powershell
Backup-AzKeyVaultKey -VaultName Contoso-O365EX-NA-VaultA1 -Name Contoso-O365EX-NA-VaultA1-Key001 -OutputFile Contoso-O365EX-NA-VaultA1-Key001-Backup-20170802.backup
```

### <a name="validate-azure-key-vault-configuration-settings"></a>Проверка параметров конфигурации хранилища ключей Azure

Проверка перед использованием ключей в DEP необязательна, но рекомендуется. Если вы используете шаги для настройки ключей и сводов, помимо описанных в этой статье, проверьте состояние ресурсов Хранилища ключей Azure перед настройкой ключа клиента.
  
Чтобы убедиться, что у ваших ключей `get` `wrapKey` включена и `unwrapKey` включена операция:
  
Выполните [этот кодлет Get-AzKeyVault](/powershell/module/az.keyvault/get-azkeyvault) следующим образом:
  
```powershell
Get-AzKeyVault -VaultName <vault name>
```

В выводах см. раздел Политика доступа и идентификатор Exchange Online (GUID) или идентификатор SharePoint Online (GUID). Все три из вышеуказанных разрешений должны быть показаны в статье Permissions to Keys.
  
Если конфигурация политики доступа неверна, выполните Set-AzKeyVaultAccessPolicy следующим образом:
  
```powershell
Set-AzKeyVaultAccessPolicy -VaultName <vault name> -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName <Office 365 appID>
```

Например, для Exchange Online и Skype для бизнеса:
  
```powershell
Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 
-PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000002-0000-0ff1-ce00-000000000000
```

Например, для SharePoint Online и OneDrive для бизнеса:
  
```powershell
Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365SP-NA-VaultA1
-PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000003-0000-0ff1-ce00-000000000000
```

Чтобы убедиться, что срок действия ключей не установлен, выполните [кодлет Get-AzKeyVaultKey](/powershell/module/az.keyvault/get-azkeyvault) следующим образом:
  
```powershell
Get-AzKeyVaultKey -VaultName <vault name>
```

Ключ клиента не может использовать истекаемую клавишу. Операции с истекшим ключом сбой, и, возможно, приведет к отключению службы. Настоятельно рекомендуется, чтобы у ключей клиента не было срока действия. Дата истечения срока действия после набора не может быть удалена, но может быть изменена на другую дату. Если необходимо использовать ключ с набором сроков действия, измените значение срока действия на 12/31/9999. Ключи с истечением срока действия, задав дату, за исключением 12/31/9999, не будут проходить проверку Microsoft 365.
  
Чтобы изменить срок действия, установленный для любого значения, кроме 12/31/9999, выполните кодлет [Update-AzKeyVaultKey](/powershell/module/az.keyvault/update-azkeyvaultkey) следующим образом:
  
```powershell
Update-AzKeyVaultKey -VaultName <vault name> -Name <key name> -Expires (Get-Date -Date "12/31/9999")
```

> [!CAUTION]
> Не устанавливайте сроки действия ключей шифрования, которые вы используете с помощью ключа клиента.
  
### <a name="obtain-the-uri-for-each-azure-key-vault-key"></a>Получение URI для каждого ключа Azure Key Vault

После того как вы настроите хранилища ключей и добавите ключи, запустите следующую команду, чтобы получить URI для ключа в каждом хранилище ключей. Эти URL-адреса необходимо использовать при создании и назначении каждого deP позже, поэтому сохраните эти сведения в безопасном месте. Запустите эту команду один раз для каждого хранилища ключей.
  
В Azure PowerShell:
  
```powershell
(Get-AzKeyVaultKey -VaultName <vault name>).Id
```

## <a name="office-365-setting-up-customer-key-for-exchange-online-and-skype-for-business"></a>Office 365: настройка ключа клиента для Exchange Online и Skype для бизнеса

Перед началом работы убедитесь, что вы выполнили задачи, необходимые для набора хранилища ключей Azure. Сведения [см. в своде ключей Azure и Microsoft FastTrack для ключа](#complete-tasks-in-azure-key-vault-and-microsoft-fasttrack-for-customer-key) клиента.
  
Чтобы настроить ключ клиента для Exchange Online и Skype для бизнеса, выполните эти действия, удаленно подключившись к Exchange Online с помощью Windows PowerShell.
  
### <a name="create-a-data-encryption-policy-dep-for-use-with-exchange-online-and-skype-for-business"></a>Создание политики шифрования данных (DEP) для использования в Exchange Online и Skype для бизнеса

DeP связан с набором ключей, хранимых в хранилище ключей Azure. Вы назначаете deP почтовому ящику в Microsoft 365. Затем Microsoft 365 использует ключи, выявленные в политике, для шифрования почтового ящика. Чтобы создать DEP, вам нужны URL-адреса key Vault, полученные ранее. Узнайте, [как получить URI для каждого ключа Хранилища ключей Azure](#obtain-the-uri-for-each-azure-key-vault-key) для инструкций.
  
Помните! При создании DEP укажите два ключа в двух разных хранилищах ключей Azure. Создайте эти клавиши в двух отдельных регионах Azure для обеспечения избыточности геоизбытки.
  
Чтобы создать DEP, выполните следующие действия:
  
1. На локальном компьютере с помощью учетной записи работы или школы, которая имеет глобальные разрешения администратора в организации, подключите к [Exchange Online PowerShell](/powershell/exchange/connect-to-exchange-online-powershell) в Windows PowerShell окне.

2. Чтобы создать deP, используйте командлет New-DataEncryptionPolicy, введя следующую команду.

   ```powershell
   New-DataEncryptionPolicy -Name <PolicyName> -Description "Policy Description" -AzureKeyIDs <KeyVaultURI1>, <KeyVaultURI2>
   ```

   Где:

   - *PolicyName* — это имя, которое необходимо использовать для политики. Имена не могут содержать пробелы. Например, USA_mailboxes.

   - *Описание политики* — это удобное описание политики, которое поможет вам вспомнить, для чего нужна политика. В описании можно включить пробелы. Например, "Корневой ключ для почтовых ящиков в США и на ее территориях".

   - *KeyVaultURI1* — это URI для первого ключа в политике. Например, <https://contoso_EastUSvault01.vault.azure.net/keys/USA_key_01>.

   - *KeyVaultURI2* — это URI для второго ключа в политике. Например, <https://contoso_EastUS2vault01.vault.azure.net/keys/USA_Key_02>. Разделять два URL-адреса на запятую и пробел.

   Пример.
  
   ```powershell
   New-DataEncryptionPolicy -Name USA_mailboxes -Description "Root key for mailboxes in USA and its territories" -AzureKeyIDs https://contoso_EastUSvault01.vault.azure.net/keys/USA_key_01, https://contoso_EastUS2vault01.vault.azure.net/keys/USA_Key_02
   ```

Подробные сведения о синтаксисах и параметрах см. [в обзоре New-DataEncryptionPolicy.](/powershell/module/exchange/new-data-encryptionpolicy)

### <a name="assign-a-dep-to-a-mailbox"></a>Назначение deP почтовому ящику

Назначение deP почтовому ящику с помощью Set-Mailbox. После назначения политики Microsoft 365 может шифровать почтовый ящик ключом, идентифицированным в deP.
  
```powershell
Set-Mailbox -Identity <MailboxIdParameter> -DataEncryptionPolicy <PolicyName>
```

Где *MailboxIdParameter* указывает почтовый ящик пользователя. Дополнительные сведения о Set-Mailbox см. в [списке Set-Mailbox.](/powershell/module/exchange/set-mailbox)

В гибридных средах можно назначить deP данным локального почтового ящика, синхронизированным с клиентом Exchange Online. Чтобы назначить deP этим синхронизированным данным почтовых ящиков, вы будете использовать Set-MailUser. Дополнительные сведения о данных почтовых ящиков в гибридной среде см. в локальном почтовом ящике с помощью Outlook для iOS и Android с гибридной современной проверкой [подлинности.](/exchange/clients/outlook-for-ios-and-android/use-hybrid-modern-auth)

```powershell
Set-MailUser -Identity <MailUserIdParameter> -DataEncryptionPolicy <PolicyName>
```

Где *MailUserIdParameter* указывает пользователя почты (также известного как пользователь с включенной почтой). Дополнительные сведения о Set-MailUser см. в [списке Set-MailUser.](/powershell/module/exchange/set-mailuser)
  
### <a name="validate-mailbox-encryption"></a>Проверка шифрования почтовых ящиков

Шифрование почтового ящика может занять некоторое время. Для назначения политики в первый раз почтовый ящик должен полностью перемещаться из одной базы данных в другую, прежде чем служба сможет шифровать почтовый ящик. Рекомендуется подождать 72 часа, прежде чем попытаться проверить шифрование после изменения deP или при первом назначении deP в почтовый ящик.
  
Используйте Get-MailboxStatistics, чтобы определить, зашифрован ли почтовый ящик.
  
```powershell
Get-MailboxStatistics -Identity <GeneralMailboxOrMailUserIdParameter> | fl IsEncrypted
```

Свойство IsEncrypted возвращает значение  true, если почтовый ящик зашифрован, и значение **false,** если почтовый ящик не зашифрован. Время выполнения ходов почтовых ящиков зависит от количества почтовых ящиков, которым вы назначаете deP впервые, и размера почтовых ящиков. Если почтовые ящики не были зашифрованы через неделю с того времени, как вы назначены deP, обратитесь в Корпорацию Майкрософт.

## <a name="office-365-setting-up-customer-key-for-sharepoint-online-onedrive-for-business-and-teams-files"></a>Office 365: настройка ключа клиента для файлов SharePoint Online, OneDrive для бизнеса и teams

Перед началом работы убедитесь, что вы выполнили задачи, необходимые для набора хранилища ключей Azure. Сведения [см. в своде ключей Azure и Microsoft FastTrack для ключа](#complete-tasks-in-azure-key-vault-and-microsoft-fasttrack-for-customer-key) клиента.
  
Чтобы настроить клиентский ключ для файлов SharePoint Online, OneDrive для бизнеса и Teams, выполните эти действия, удаленно подключившись к SharePoint Online с помощью Windows PowerShell.
  
### <a name="create-a-data-encryption-policy-dep-for-each-sharepoint-online-and-onedrive-for-business-geo"></a>Создание политики шифрования данных (DEP) для каждого geo SharePoint Online и OneDrive для бизнеса

Вы связываете deP с набором ключей, хранимых в хранилище ключей Azure. Для всех данных в одном географическом расположении, называемом также гео, применяется deP. Если вы используете многофункциональный элемент Office 365, можно создать один DEP на один гео с возможностью использования различных ключей на один гео. Если вы не используете multi-geo, вы можете создать один DEP в организации для использования с файлами SharePoint Online, OneDrive для бизнеса и Teams. Microsoft 365 использует ключи, идентифицированные в deP, чтобы шифровать данные в этом гео. Чтобы создать DEP, вам нужны URL-адреса key Vault, полученные ранее. Узнайте, [как получить URI для каждого ключа Хранилища ключей Azure](#obtain-the-uri-for-each-azure-key-vault-key) для инструкций.
  
Помните! При создании DEP укажите два ключа в двух разных хранилищах ключей Azure. Создайте эти клавиши в двух отдельных регионах Azure для обеспечения избыточности геоизбытки.
  
Чтобы создать deP, необходимо удаленно подключиться к SharePoint Online с помощью Windows PowerShell.
  
1. На локальном компьютере с помощью учетной записи работы или учебного заведения с глобальными разрешениями администратора в организации подключитесь [к SharePoint Online PowerShell.](/powershell/sharepoint/sharepoint-online/connect-sharepoint-online?preserve-view=true&view=sharepoint-ps)

2. В microsoft SharePoint Online Management Shell выполните Register-SPODataEncryptionPolicy следующим образом:

   ```powershell
   Register-SPODataEncryptionPolicy -Identity <adminSiteCollectionURL> -PrimaryKeyVaultName <PrimaryKeyVaultName> -PrimaryKeyName <PrimaryKeyName> -PrimaryKeyVersion <PrimaryKeyVersion> -SecondaryKeyVaultName <SecondaryKeyVaultName> -SecondaryKeyName <SecondaryKeyName> -SecondaryKeyVersion <SecondaryKeyVersion>
   ```

   Пример.
  
   ```powershell
   Register-SPODataEncryptionPolicy -Identity https://contoso.sharepoint.com -PrimaryKeyVaultName 'stageRG3vault' -PrimaryKeyName 'SPKey3' -PrimaryKeyVersion 'f635a23bd4a44b9996ff6aadd88d42ba' -SecondaryKeyVaultName 'stageRG5vault' -SecondaryKeyName 'SPKey5' -SecondaryKeyVersion '2b3e8f1d754f438dacdec1f0945f251a’
   ```

   При регистрации deP шифрование начинается с данных в гео. Шифрование может занять некоторое время. Дополнительные сведения об использовании этого параметра см. в [сайте Register-SPODataEncryptionPolicy.](/powershell/module/sharepoint-online/register-spodataencryptionpolicy?preserve-view=true&view=sharepoint-ps)

### <a name="validate-file-encryption"></a>Проверка шифрования файлов

 Чтобы проверить шифрование файлов SharePoint Online, OneDrive для бизнеса и Teams, подключитесь к [SharePoint Online PowerShell,](/powershell/exchange/connect-to-exchange-online-powershell)а затем используйте командлет Get-SPODataEncryptionPolicy, чтобы проверить состояние клиента. Свойство _state_ возвращает значение  зарегистрированного, если включено шифрование ключа клиента и зашифрованы все файлы на всех сайтах. Если шифрование еще продолжается, этот кодлет возвращает значение **регистрации.**

## <a name="related-articles"></a>Статьи по теме

- [Шифрование службы с помощью ключа клиента](customer-key-overview.md)

- [Управление ключом клиента](customer-key-manage.md)

- [Смена или ротация ключа клиента или ключа доступности](customer-key-availability-key-roll.md)

- [Узнайте о ключе доступности](customer-key-availability-key-understand.md)

- [Шифрование служб](office-365-service-encryption.md)