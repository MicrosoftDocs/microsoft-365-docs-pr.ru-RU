---
title: Настройка ключа клиента
ms.author: krowley
author: kccross
manager: laurawi
ms.date: 02/05/2020
audience: ITPro
ms.topic: article
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- MET150
ms.collection:
- M365-security-compliance
description: Узнайте, как настроить ключ клиента для Microsoft 365 для Exchange Online, Skype для бизнеса, SharePoint Online, OneDrive для бизнеса и файлов Teams.
ms.openlocfilehash: 87c18c1695d2963fc8a0c064d34d2b6cdc14199c
ms.sourcegitcommit: 260bbb93bbda62db9e88c021ccccfa75ac39a32e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/21/2020
ms.locfileid: "46845837"
---
# <a name="set-up-customer-key"></a>Настройка ключа клиента

С помощью ключа клиента вы управляете ключами шифрования в организации, а затем настраиваюте Microsoft 365 для шифрования неиспользуемых данных в центрах обработки данных Майкрософт. Другими словами, ключ клиента позволяет клиентам добавить слой шифрования, принадлежащий им, с ключами. К ним относятся данные из Exchange Online и Skype для бизнеса, хранящиеся в почтовых ящиках, а также файлы, хранящиеся в SharePoint Online и OneDrive для бизнеса.

Прежде чем вы сможете использовать ключ клиента для Office 365, необходимо настроить Azure. В этой статье описаны действия, которые необходимо выполнить для создания и настройки необходимых ресурсов Azure, а также инструкции по настройке ключа клиента в Office 365. После завершения настройки Azure определите политику, а значит, какие ключи нужно назначить почтовым ящикам и файлам в организации. Почтовые ящики и файлы, которым вы не назначите политику, будут использовать политики шифрования, контролируемые и управляемые Майкрософт. Дополнительные сведения о ключе клиента или общие сведения см. в статье [шифрование службы с помощью ключа клиента в Office 365.](customer-key-overview.md)
  
> [!IMPORTANT]
> Настоятельно рекомендуем следовать рекомендациям, приведенным в этом разделе. Они называются советами **и** **важными.** Ключ клиента предоставляет контроль над корневыми ключами шифрования, область действия которых не может превышать всю организацию. Это означает, что ошибка в этих ключах может оказать широкое влияние, что может привести к нарушению работы служб или потере данных.
  
## <a name="before-you-set-up-customer-key"></a>Подготовка к настройке ключа клиента

Перед началом работы убедитесь, что у вас есть подходящие лицензии для вашей организации. Ключ клиента в Microsoft 365 доступен в Плане Office 365 E5 или SKU Advanced Compliance. Чтобы понять основные понятия и процедуры, описанные в этой статье, [изучите документацию по Azure Key Vault.](https://docs.microsoft.com/azure/key-vault/) Кроме того, ознакомьтесь с полагаемыми терминами, используемыми в Azure, например [клиентом.](https://docs.microsoft.com/previous-versions/azure/azure-services/jj573650(v=azure.100))

FastTrack используется только для сбора необходимых сведений о конфигурации клиента и службы, которые используются для регистрации с ключом клиента. Предложения клиентов публикуются через FastTrack, чтобы вам было легче облегчить вам и нашим партнерам отправлять необходимую информацию, используя тот же метод. Кроме того, специалисты FastTrack упрощают архивацию данных, предоставляемых в предложении.
  
Если вам нужна поддержка помех документации, обратитесь за помощью к службам консультаций Майкрософт (MCS), инженерам Premier Field Engineering (PFE) или к партнеру Майкрософт. Чтобы оставить отзыв по ключу клиента, включая документацию, отправьте свои идеи, предложения и перспективы customerkeyfeedback@microsoft.com.
  
## <a name="overview-of-steps-to-set-up-customer-key"></a>Обзор действий по настройке ключа клиента

Чтобы настроить ключ клиента, выполните приведенные ниже задачи в приведенном порядке. В оставшейся части этой статьи представлены подробные инструкции по каждой задаче либо приведены ссылки на дополнительные сведения о каждом шаге данного процесса.
  
**В Azure и Microsoft FastTrack:**
  
Большинство этих задач подключаются удаленно к Azure PowerShell. Для получения наилучших результатов используйте Azure PowerShell версии 4.4.0 или более поздней.
  
- [Создание двух новых подписок на Azure](#create-two-new-azure-subscriptions)

- [Регистрация подписок Azure для использования обязательных периодов хранения](#register-azure-subscriptions-to-use-a-mandatory-retention-period)

  Регистрация может занимать от одного до пяти рабочих дней.

- [Отправка запроса на активацию ключа клиента для Office 365](#submit-a-request-to-activate-customer-key-for-office-365)

После создания двух подписок Azure необходимо отправить соответствующий запрос на предоставление ключа клиента, заполнив веб-форму, размещенную на портале Microsoft FastTrack. **Команда FastTrack не предоставляет помощь по ключу клиента. Office просто использует портал FastTrack для отправки**формы и отслеживать соответствующие предложения с ключом клиента.

- [Создание хранилища ключей Azure премиум в каждой подписке](#create-a-premium-azure-key-vault-in-each-subscription)

- [Назначение разрешений для каждого хранилищ ключей](#assign-permissions-to-each-key-vault)

- [Включите, а затем подтвердите мягкое удаление в основных молях](#enable-and-then-confirm-soft-delete-on-your-key-vaults)

- [Добавление ключа в каждое хранение ключей путем создания или импорта ключа](#add-a-key-to-each-key-vault-either-by-creating-or-importing-a-key)

- [Проверьте уровень восстановления ключей](#check-the-recovery-level-of-your-keys)

- [Создание резервной копии хранилища ключей Azure](#back-up-azure-key-vault)

- [Проверка параметров конфигурации хранилища ключей Azure](#validate-azure-key-vault-configuration-settings)

- [Получите URI для каждого ключа хранилища Azure Key Vault](#obtain-the-uri-for-each-azure-key-vault-key)

**В Office 365:**
  
Exchange Online и Skype для бизнеса:
  
- [Создание политики шифрования данных (DEP) для использования с Exchange Online и Skype для бизнеса](#create-a-data-encryption-policy-dep-for-use-with-exchange-online-and-skype-for-business)

- [Назначение DEP почтовому ящику](#assign-a-dep-to-a-mailbox)

- [Проверка шифрования почтовых ящиков](#validate-mailbox-encryption)

SharePoint Online и OneDrive для бизнеса:
  
- [Создание политики шифрования данных (DEP) для каждого географического расположения SharePoint Online и OneDrive для бизнеса](#create-a-data-encryption-policy-dep-for-each-sharepoint-online-and-onedrive-for-business-geo)

- [Проверка шифрования файлов в SharePoint Online, OneDrive для бизнеса и Teams](#validate-file-encryption)

## <a name="complete-tasks-in-azure-key-vault-and-microsoft-fasttrack-for-customer-key"></a>Выполнять задачи в хранилище Azure Key Vault и Microsoft FastTrack для ключа клиента

Эти задачи можно выполнить в Хранилище Azure Key Vault. Выполните эти действия независимо от того, собираетесь ли вам настроить ключ клиента для Exchange Online и Skype для бизнеса, для SharePoint Online, OneDrive для бизнеса и файлов Teams либо для всех поддерживаемых служб в Office 365.
  
### <a name="create-two-new-azure-subscriptions"></a>Создание двух новых подписок на Azure

Ключу клиента требуются две подписки Azure. Корпорация Майкрософт рекомендует создавать новые подписки На Azure для использования с ключом клиента. Ключи хранилища Azure Key Vault можно разрешать только для приложений в том же клиенте Azure Active Directory (AAD). Необходимо создать новые подписки с помощью того же клиента Azure AD, который используется в вашей организации, для которой будут назначены DEP. Например, используя рабочую или учебную учетную запись с правами глобального администратора в вашей организации. Подробные инструкции см. в [статье "Регистрация в Azure в качестве организации".](https://azure.microsoft.com/documentation/articles/sign-up-organization/)
  
> [!IMPORTANT]
> Для ключа клиента требуется два ключа для каждой политики шифрования данных (DEP). Для этого необходимо создать две подписки Azure. Корпорация Майкрософт рекомендует вам настроить в каждой подписке отдельных участников вашей организации по одному ключу. Кроме того, эти подписки Azure следует использовать только для администрирования ключей шифрования Office 365. Это защитит организацию на случай случайно, преднамеренного или злонамеренного удаления или неправильного управления ключами, за которые они ответственны. <br/> Рекомендуем настроить новые подписки Azure, используемые исключительно для управления ресурсами Хранилища ключей Azure для использования с ключом клиента. Количество подписок Azure, которое можно создать в организации, не ограничено. Приведенные ниже рекомендации покажут влияние ошибок человеческих ошибок и поможет управлять ресурсами, используемыми ключом клиента.
  
### <a name="submit-a-request-to-activate-customer-key-for-office-365"></a>Отправка запроса на активацию ключа клиента для Office 365

После выполнения шагов в Azure необходимо отправить запрос на предложение на [портале Microsoft FastTrack.](https://fasttrack.microsoft.com/) После отправки запроса через веб-портал FastTrack корпорация Майкрософт проверяет данные конфигурации Хранилища Azure Key Vault и контактные данные, которые вы предоставили. Параметры, выбранные в форме предложения относительно авторизованных сотрудников организации, критически важны и необходимы для регистрации ключа клиента. Лица вашей организации, которые выбирают в форме, будут использоваться для проверки подлинности любого запроса на отзыв или уничтожении всех ключей, используемых с политикой шифрования данных с ключом клиента. Это необходимо сделать один раз, чтобы активировать ключ клиента для Exchange Online и Skype для бизнеса, а затем повторно активировать ключ клиента для SharePoint Online и OneDrive для бизнеса.
  
Чтобы отправить предложение для активации ключа клиента, выполните следующие действия.
  
1. Используя рабочую или учебную учетную запись с правами глобального администратора в организации, войдите на [портал Microsoft FastTrack.](https://fasttrack.microsoft.com/)

2. После входа перейдите на панель **мониторинга.**

3. Нажмите **кнопку "Развернуть"** на панели **навигации ИЛИ выберите** **"Просмотреть все ресурсы развертывания"** на информационной карточке **"Развернуть"** и просмотрите список текущих предложений.

4. Выберите информационную карточку для предложения, которое применяется к вам:

   - **Exchange Online и Skype для бизнеса:** Choose the **Request encryption key help for Exchange Online** offer.

   - **Файлы в SharePoint Online, OneDrive и Teams:** Choose the **Request encryption key help for Sharepoint and OneDrive** offer.

5. Просмотрев сведения о предложении, нажмите **"Переперейдите к шагу 2".**

6. Укажите все необходимые сведения в форме предложения и запрошенные сведения. Уделите особым особенностям выбранных лиц вашей организации, чтобы утвердить постоянные и необратимое уничтожение ключей и данных шифрования. Завершив форму, нажмите кнопку **"Отправить".**

### <a name="register-azure-subscriptions-to-use-a-mandatory-retention-period"></a>Регистрация подписок Azure для использования обязательных периодов хранения

Временная или постоянная потеря ключей шифрования может быть очень нарушена или даже катастрофой к работе службы и может привести к потере данных. По этой причине ресурсы, используемые с ключом клиента, обязаны требовать надежной защиты. Все ресурсы Azure, используемые с платформами защиты клиента, помимо конфигурации по умолчанию. Подписки Azure можно отметить или зарегистрировать так, чтобы они предотвращали мгновенную и невозможность отмены. Это называется регистрацией в тот или иной период хранения. Чтобы зарегистрировать подписки Azure в течение обязательного периода хранения, требуется совместная работа с командой Microsoft 365. Этот процесс может занимать от одного до пяти рабочих дней. Ранее это иногда называют "Не отменять".
  
Прежде чем обращаться к команде Microsoft 365, необходимо выполнить указанные ниже действия для каждой подписки Azure, которая используется с ключом клиента. Перед началом убедитесь в том, что у вас установлен модуль [Az Azure PowerShell.](https://docs.microsoft.com/powershell/azure/new-azureps-module-az)
  
1. Войдите в систему с помощью Azure PowerShell. Инструкции см. в статье ["Вход с помощью Azure PowerShell".](https://docs.microsoft.com/powershell/azure/authenticate-azureps)

2. Выполните командлет Register-AzProviderFeature, чтобы зарегистрировать подписки на обязательный период хранения. Выполните это действие для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Register-AzProviderFeature -FeatureName mandatoryRetentionPeriodEnabled -ProviderNamespace Microsoft.Resources
   ```

3. Обратитесь в корпорацию Майкрософт за завершением процесса. Связаться с командой SharePoint и OneDrive для бизнеса, [свяжитесь с spock@microsoft.com.](mailto:spock@microsoft.com) В Exchange Online и Skype для бизнеса обратитесь [exock@microsoft.com.](mailto:exock@microsoft.com) Включите в сообщение следующее:

   **Subject**: Ключ клиента для \<*Your tenant's fully-qualified domain name*\>

   **Body**— идентификаторы подписки, для которых требуется завершить обязательный период хранения.
   Результат get-AzProviderFeature для каждой подписки.

   Соглашение об уровне обслуживания (SLA) для этого процесса — пять рабочих дней с уведомлением (и проверки), что вы зарегистрировали подписки на обязательный период хранения.

4. Получив уведомление от Майкрософт о завершении регистрации, проверьте состояние вашей регистрации, выполнив команду Get-AzProviderFeature, как показано ниже. Если он проверен, команда Get-AzProviderFeature возвращает значение **Registered для** **свойства Registration State.** Выполните это действие для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Get-AzProviderFeature -ProviderNamespace Microsoft.Resources -FeatureName mandatoryRetentionPeriodEnabled
   ```

5. Чтобы завершить процесс, выполните команду Register-AzResourceProvider. Выполните это действие для каждой подписки.

   ```powershell
   Set-AzContext -SubscriptionId <SubscriptionId>
   Register-AzResourceProvider -ProviderNamespace Microsoft.KeyVault
   ```

### <a name="create-a-premium-azure-key-vault-in-each-subscription"></a>Создание хранилища ключей Azure премиум в каждой подписке

Инструкции по созданию хранилища ключей описаны в разделе ["Начало работы с хранилищем Azure Key Vault".](https://azure.microsoft.com/documentation/articles/key-vault-get-started/)В этой статье приводятся инструкции по установке и запуску Azure PowerShell, подключению к подписке Azure, созданию группы ресурсов и созданию хранилища ключей в этой группе ресурсов.
  
При создании key vault необходимо выбрать SKU: Standard или Premium. Стандартная SKU позволяет обеспечить защиту ключей хранилища azure Key Vault с помощью программного обеспечения — нет защиты ключа аппаратного модуля безопасности (HSM), а SKU с расширенными данными позволяет использовать аппаратные ключи для защиты хранилищ ключей Ключей. Ключ клиента принимает ключевые характеристики, использующие любую SKU, хотя Майкрософт настоятельно рекомендует использовать только SKU premium. Затраты на операции с ключами любого типа одинаковы, поэтому единственной отличием в затратах является затраты в месяц на каждый ключ, защищенный HSM. Дополнительные [сведения см. в статье с торгового хранилищ Key Vaulting.](https://azure.microsoft.com/pricing/details/key-vault/)
  
> [!IMPORTANT]
> Используйте для производственных данных хранилищ ключей SKU Premium и ключи, защищенные HSM, а для тестирования и проверки — только хранилищ ключей SKU и ключей.
  
Для каждой службы Microsoft 365, в которой будет использоваться ключ клиента, создайте хранилище ключей в каждой из двух созданных подписок Azure. Например, только для Exchange Online и Skype для бизнеса либо только для SharePoint Online и OneDrive для бизнеса необходимо создать только одну пару малых служб. Чтобы включить ключ клиента для Exchange Online и SharePoint Online, необходимо создать две пары хранилищ ключей.
  
Используйте соглашение об именовании для хранилищ ключей, отражающих назначение политики шифрования данных, с которой необходимо связать хранилищ. Рекомендации по использованию соглашений об именовании см. в разделе "Рекомендации" ниже.
  
Создайте отдельный парный набор хранилищ для каждой политики шифрования данных. Для Exchange Online область политики шифрования данных определяется при назначении этой политики почтовому ящику. Почтовый ящик может иметь только одну политику, и вы можете создать до пяти политик. Для SharePoint Online область действия политики — это все данные организации в географическом регионе или географическом _регионе._

Для создания хранилищ ключей также необходимо создать группы ресурсов Azure, так как хранилища ключей необходимы для хранилища (хотя очень небольшой объем) и ведение журнала хранилища ключей (если они включены) также создает хранимые данные. Корпорация Майкрософт рекомендует использовать отдельных администраторов для управления каждой группой ресурсов при администрировании в сочетании с набором администраторов, которые будут управлять всеми связанными ресурсами ключей клиента.
  
> [!IMPORTANT]
> Для повышения доступности основные халмы должны быть в регионах, близких к службе Microsoft 365. Например, если организация Exchange Online находится в Северной Америке, разместите хранилище ключей в Северной Америке. Если ваша организация Exchange Online находится в Европе, разместите основные хранилищ в Европе.<br/>Общий префикс для хранилищ ключей. Включите сокращение использования и области применения хранилищ ключей и ключей (например, для службы Contoso SharePoint, где поставщики будут расположены в Северной Америке, возможные пары имен: Contoso-O365SP-NA-VaultA1 и Contoso-O365SP-NA-VaultA2. Имена мозги являются глобальными уникальными строками в Azure, поэтому может потребоваться попробовать заполнить нужные имена на требуемых именах на тот случай, если нужные имена уже присвоены другими клиентами Azure. Названия за июль 2017 года нельзя изменить, поэтому рекомендуется составить план настройки и использовать второго человека для проверки правильности выполнения плана.<br/>По возможности создайте хранилищ в несвязываемых регионах. Сопряженные регионы Azure обеспечивают высокую доступность в нескольких доменах отказа служб. Поэтому региональные пары можно считать резервным регионом друг друга. Это означает, что ресурс Azure, размещенный в одном регионе, автоматически загружает отказоустойчивость для области сопряженного региона. По этой причине выбор регионов для двух хранилищ, используемых в политике шифрования данных, где регионы используются в связывающем режиме, значит используются только два области доступности. В большинстве регионов есть только две области, поэтому еще недоступен регион. По возможности выберите два несвязываемых региона для двух хранилищ, использующихся с политикой шифрования данных. Это преимущество дается в общих объемах доступности из четырех регионов. Дополнительные сведения см. в статье о [непрерывности бизнеса и аварийном восстановлении (BCDR): парные](https://docs.microsoft.com/azure/best-practices-availability-paired-regions) области Azure для текущего списка региональных пар.
  
### <a name="assign-permissions-to-each-key-vault"></a>Назначение разрешений для каждого хранилищ ключей

Для каждого хранилищ ключей потребуется определить три отдельных набора разрешений для ключа клиента в зависимости от реализации. Например, необходимо задать один набор разрешений для каждого из следующих параметров:
  
- **Основные хранилищ администраторы,** которые будут повседневно управлять основными хранилищами для вашей организации. К этим задачам относятся резервное копирование, создание, получение, импорт, список и восстановление.

  > [!IMPORTANT]
  > В набор разрешений, назначенных администраторам хранилищ ключей, нет разрешения на удаление ключей. Это намеренный и важный метод. Удаление ключей шифрования обычно не выполняется, так как это необходимо окончательно уничтожить данные. Рекомендуется не предоставлять это разрешение основным администраторам мелких служб по умолчанию. Вместо этого следует организовать его для основных авторств, назначая его администратору только на коротком уровне, только когда понятно необходимо понимать последствия.
  
  Чтобы назначить эти разрешения пользователю в вашей организации, войдите в свою подписку на Azure с помощью Azure PowerShell. Инструкции см. в статье ["Вход с помощью Azure PowerShell".](https://docs.microsoft.com/powershell/azure/authenticate-azureps)

- Выполните командлет Set-AzKeyVaultAccessPolicy, чтобы назначить необходимые разрешения.

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName <vault name> -UserPrincipalName <UPN of user> -PermissionsToKeys create,import,list,get,backup,restore
   ```

   Например:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 -UserPrincipalName alice@contoso.com -PermissionsToKeys create,import,list,get,backup,restore
   ```

- **Ключевой хранилищ, который** может изменить разрешения для самого хранилища Azure Key Vault. Эти разрешения необходимо изменить, когда сотрудники покидают или участвуют в команде, либо в крайне редких случаях, когда ключевые решения необходимы администраторам законно для удаления или восстановления ключа. Этому набору хранилищ нужно предоставить роль **участника** в хранилищключе. Вы можете назначить эту роль с помощью Диспетчер ресурсов Azure. Дополнительные сведения см. в статье ["Управление доступом на основе ролей" для управления доступом к ресурсам подписки Azure.](https://docs.microsoft.com/azure/active-directory/role-based-access-control-configure) Администратор, создающий подписку, неявно имеет такого доступа, а также может назначать других администраторов роли участника.

- Если вы планировали использовать ключ клиента с Exchange Online и Skype для бизнеса, вам необходимо предоставить Microsoft 365 разрешение на использование хранилищ ключей от имени Exchange Online и Skype для бизнеса. Аналогичным образом, если вы планируете использовать ключ клиента с SharePoint Online и OneDrive для бизнеса, необходимо добавить в Microsoft 365 разрешение на использование хранилищ ключей от имени SharePoint Online и OneDrive для бизнеса. Чтобы предоставить разрешения Microsoft 365, **запустите командлет Set-AzKeyVaultAccessPolicy,** используя следующий синтаксис: 

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName <vault name> -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName <Office 365 appID>
   ```

   Где:

    - *vault name* is the name of the key vault created.

    - Замените appID в Exchange Online и Skype для *бизнеса на номер приложения Office 365*`00000002-0000-0ff1-ce00-000000000000`

    - Для файлов SharePoint Online, OneDrive для бизнеса и Teams замените  *AppID Office 365 на идентификатор приложения Office 365* на идентификатор приложения `00000003-0000-0ff1-ce00-000000000000`

  Пример. Установка разрешений для Exchange Online и Skype для бизнеса:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000002-0000-0ff1-ce00-000000000000
   ```

  Пример. Настройка разрешений для файлов SharePoint Online, OneDrive для бизнеса и Teams:

   ```powershell
   Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365SP-NA-VaultA1 -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000003-0000-0ff1-ce00-000000000000
   ```

### <a name="enable-and-then-confirm-soft-delete-on-your-key-vaults"></a>Включите, а затем подтвердите мягкое удаление в основных молях

При быстром восстановлении ключей у вас меньше вероятности простоя расширенной службы вследствие случаененного или злонального удаления ключей. Чтобы использовать ключи с ключом клиента, вам нужно включить эту конфигурацию (обратимо удалить). После включения обратимого удаления вы можете восстановить ключи или хранилищ в течение 90 дней с недостатка удаления из резервной копии.
  
Чтобы включить функцию обратичного удаления в основных молях, выполните указанные ниже действия.
  
1. Войдите в подписку на Azure с помощью Windows Powershell. Инструкции см. в статье ["Вход с помощью Azure PowerShell".](https://docs.microsoft.com/powershell/azure/authenticate-azureps)

2. Запустите [командлет Get-AzKeyVault.](https://docs.microsoft.com/powershell/module/az.keyvault/get-azkeyvault) В этом примере *имя хранилищ представляет* собой имя хранилищ ключей, для которого включается мягкое удаление:

   ```powershell
   $v = Get-AzKeyVault -VaultName <vault name>
   $r = Get-AzResource -ResourceId $v.ResourceId
   $r.Properties | Add-Member -MemberType NoteProperty -Name enableSoftDelete -Value 'True'
   Set-AzResource -ResourceId $r.ResourceId -Properties $r.Properties
   ```

3. Убедитесь, что для хроном было настроено мягкое удаление, выполнив **командлет Get-AzKeyVault.** Если функция обратимого удаления настроена надлежащим образом для хранилищ ключей, свойство _Soft Delete Enabled_ возвращает значение **True:**

   ```powershell
   Get-AzKeyVault -VaultName <vault name> | fl
   ```

### <a name="add-a-key-to-each-key-vault-either-by-creating-or-importing-a-key"></a>Добавление ключа в каждое хранение ключей путем создания или импорта ключа

Существует два способа добавления ключей в хранилище Azure Key Vault. можно создать ключ непосредственно в Key Vault или импортировать ключ. Создание ключа непосредственно в Key Vault — менее сложный метод, а импорт ключа дает возможность управлять методом генерирования ключа.
  
Чтобы создать ключ непосредственно в хранилище ключей, выполните [командлет Add-AzKeyVaultKey](https://docs.microsoft.com/powershell/module/az.keyvault/add-azkeyvaultkey) следующим образом.
  
```powershell
Add-AzKeyVaultKey -VaultName <vault name> -Name <key name> -Destination <HSM|Software> -KeyOps wrapKey,unwrapKey
```

Где:

- *vault name* is the name of the key vault in which you want to create the key.

- *Имя —* это имя нового ключа.

  > [!TIP]
  > Именуйте ключи, используя схожую процедуру именования, описанную выше для хранилищ ключей. Таким образом, в средствах, отображающих только имя ключа, строка будет описана самостоятельно.
  
- Если вы хотите защитить ключ с помощью HSM, убедитесь, что **вы указали HSM** в качестве _значения параметра Destination,_ в противном **случае укажите Software.**

Пример.
  
```powershell
Add-AzKeyVaultKey -VaultName Contoso-O365EX-NA-VaultA1 -Name Contoso-O365EX-NA-VaultA1-Key001 -Destination Software -KeyOps wrapKey,unwrapKey
```

Чтобы импортировать ключ непосредственно в хранилищ ключей, необходимо использовать мошенничество nCipher nShield Hardware Security Module.
  
В некоторых организациях этот подход предпочитает подтвердить подтверждение их ключей, после чего этот метод также предоставляет следующие возможности:
  
- Набор инструментов, используемый для импорта, включает аттестацию от nCipher, что ключ Exchange (KEK), используемый для шифрования созданного ключа, недоступен для шифрования создаваемого ключа, недоступен для экспорта и генерируется в генераторе HSM, созданном изготовителем nCipher.

- Набор инструментов включает аттестацию от nCipher, что мир службы безопасности Azure Key Vault также генерируется погашенным изготовителем HSM. Эта аттестация доказывало, что корпорация Майкрософт использует полинаническое четкое оборудование.

Уведомитесь в группе безопасности, чтобы определить, требуются ли вышеа требуемые аттестации. Подробные инструкции по созданию ключа в локальной среде и его импорте в хранилище ключей см. в статье, [посвященной созданию](https://azure.microsoft.com/documentation/articles/key-vault-hsm-protected-keys/)и переносу ключей, защищенных HSM, для хранилища ключей Azure. Следуйте инструкциям для Azure, чтобы создать ключ в каждом хранилище ключей.
  
### <a name="check-the-recovery-level-of-your-keys"></a>Проверьте уровень восстановления ключей

Для использования Microsoft 365 необходимо, чтобы для подписки Azure Key Vault было установлено значение "Не отмена" и ключи, используемые ключом клиента, были включены мягкие удаления. Для этого просмотрите уровень восстановления на ключах.
  
Чтобы проверить уровень восстановления ключа, в Azure PowerShell выполните командлет Get-AzKeyVaultKey следующим образом.
  
```powershell
(Get-AzKeyVaultKey -VaultName <vault name> -Name <key name>).Attributes
```

Если свойство _уровня восстановления_ возвращает значение, отличное от **значения Recoverable+ProtectedSubscription,** просмотрите данную статью и убедитесь, что следовать всем инструкциям, чтобы включить подписку в список "Не отменить операцию", и что для каждого из хранилищ ключей было включено обратимое удаление.
  
### <a name="back-up-azure-key-vault"></a>Создание резервной копии хранилища ключей Azure

Немедленно за созданием или любым изменением ключа, выполните резервные копии и сохраните резервные копии, как подключенные к сети, так и автономно. Автономные копии не должны быть подключены к какой-либо сети, например в физической надежности или коммерческом хранилище. По крайней мере одна копия резервной копии резервной копии должна храниться в расположении, которое будет доступно в случае аварии. The backup blobs are the sole means of restoring key material should a Key Vault key be permanently destroyed or otherwise rendered inoperable. Ключи, которые являются внешними по использованию хранилища ключей Azure и были импортированы в хранилище ключей Azure, не считаются резервные, так как метаданные, необходимые ключу клиента для использования ключа, не существуют с внешним ключом. Для операций восстановления с помощью ключа клиента можно использовать только резервную копию, выполненную из хранилища Azure Key Vault. Поэтому важно создать резервную копию хранилища Azure Key Vault после отправки или создания ключа.
  
Чтобы создать резервную копию ключа Azure Key Vault Key, запустите [командлет Backup-AzKeyVaultKey](https://docs.microsoft.com/powershell/module/az.keyvault/backup-azkeyvaultkey) следующим образом.

```powershell
Backup-AzKeyVaultKey -VaultName <vault name> -Name <key name>
-OutputFile <filename.backup>
```

Убедитесь, что в выходном файле используется суффикс. `.backup`
  
Выходной файл, выходной файл, полученный с помощью этого командлета, зашифрован и не может использоваться вне хранилища Azure Key Vault. Резервную копию можно восстановить только в той, которая была создана для резервной копии.
  
> [!TIP]
> В выходном файле выберите сочетание имени хранилищ и имени ключа. Это позволит сделать файл самостоятельно описательной. Кроме того, при этом имена файлов резервной копии не будут конфликтовать.
  
Например:
  
```powershell
Backup-AzKeyVaultKey -VaultName Contoso-O365EX-NA-VaultA1 -Name Contoso-O365EX-NA-VaultA1-Key001 -OutputFile Contoso-O365EX-NA-VaultA1-Key001-Backup-20170802.backup
```

### <a name="validate-azure-key-vault-configuration-settings"></a>Проверка параметров конфигурации хранилища ключей Azure

Выполнение проверки перед использованием ключей в DEP необязательно, но настоятельно рекомендуется. В частности, если вы используете действия для настройки ключей и хранилищ, отличных от описанных в этой статье, необходимо проверить работоспособность ресурсов хранилища ключей Azure перед настройкой ключа клиента.
  
Чтобы убедиться, что для ключей включены операции get, wrapKey и unwrapKey, выполните следующие действия.
  
Запустите [командлет Get-AzKeyVault,](https://docs.microsoft.com/powershell/module/az.keyvault/get-azkeyvault) как показано ниже.
  
```powershell
Get-AzKeyVault -VaultName <vault name>
```

В выходных данных найдите политику доступа и соответствующим образом идентификатор Exchange Online (GUID) или удостоверение SharePoint Online . Все три разрешения выше должны быть показаны в разделе "Разрешения для ключей".
  
Если же конфигурация политики доступа неправильна, запустите командлет Set-AzKeyVaultAccessPolicy, как показано ниже.
  
```powershell
Set-AzKeyVaultAccessPolicy -VaultName <vault name> -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName <Office 365 appID>
```

Например, для Exchange Online и Skype для бизнеса:
  
```powershell
Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 
-PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000002-0000-0ff1-ce00-000000000000
```

Например, для SharePoint Online и OneDrive для бизнеса:
  
```powershell
Set-AzKeyVaultAccessPolicy -VaultName Contoso-O365SP-NA-VaultA1
-PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000003-0000-0ff1-ce00-000000000000
```

Чтобы проверить, что для ключей не задана дата окончания срока действия, выполните командлет [Get-AzKeyVaultKey](https://docs.microsoft.com/powershell/module/az.keyvault/get-azkeyvault) следующим образом:
  
```powershell
Get-AzKeyVaultKey -VaultName <vault name>
```

Неудачный ключ нельзя использовать для ключа клиента, и операции, пытавшиеся с просроченным ключом, закончится с боящей сроком действия и, возможно, приведет к простою службы. Настоятельно рекомендуется, чтобы ключи, используемые с ключом клиента, не имели даты окончания срока действия. Дата окончания срока действия, после установки, невозможно удалить, но при этом можно указать другую дату. Если необходимо использовать ключ с установленной датой окончания срока действия, измените значение срока действия на 31 декабря 9999 г. Дата окончания срока действия ключей с датой, отличной от 31 марта 9999 г., не пройдут проверку Microsoft 365.
  
Чтобы изменить дату окончания срока действия, для которой было задано любое значение, отличное от 12/31/9999, выполните командлет [Update-AzKeyVaultKey](https://docs.microsoft.com/powershell/module/az.keyvault/update-azkeyvaultkey) следующим образом:
  
```powershell
Update-AzKeyVaultKey -VaultName <vault name> -Name <key name> -Expires (Get-Date -Date "12/31/9999")
```

> [!CAUTION]
> Не задавайте даты окончания срока действия ключей шифрования, которые используются с ключом клиента.
  
### <a name="obtain-the-uri-for-each-azure-key-vault-key"></a>Получите URI для каждого ключа хранилища Azure Key Vault

После того как вы выполните все действия, описанные в Azure, чтобы настроить хранилище ключей и добавить ключи, выполните указанную ниже команду, чтобы получить URI ключа в каждом хранилище ключей в хранилище ключей. Вам придется использовать эти URI при создании и назначении каждой дескрипторной очереди позже, поэтому сохраните эти данные в надежном месте. Не забудьте выполнить эту команду один раз для каждого хранилищключа ключей.
  
В Azure PowerShell:
  
```powershell
(Get-AzKeyVaultKey -VaultName <vault name>).Id
```

## <a name="office-365-setting-up-customer-key-for-exchange-online-and-skype-for-business"></a>Office 365: настройка ключа клиента для Exchange Online и Skype для бизнеса

Прежде чем начать, убедитесь, что вы выполнили все необходимые задачи для настройки хранилища Azure Key Vault. Сведения о [выполнении полных задач см. в хранилище Azure Key Vault и Microsoft FastTrack для получения информации](#complete-tasks-in-azure-key-vault-and-microsoft-fasttrack-for-customer-key) о получении данных клиента.
  
Чтобы настроить ключ клиента для Exchange Online и Skype для бизнеса, необходимо выполнить эти действия, подключившись к Exchange Online с помощью Windows PowerShell.
  
### <a name="create-a-data-encryption-policy-dep-for-use-with-exchange-online-and-skype-for-business"></a>Создание политики шифрования данных (DEP) для использования с Exchange Online и Skype для бизнеса

DEP связан с набором ключей, хранящихся в хранилище ключей Azure. Вы назначаете DEP почтовому ящику в Microsoft 365. После этого Microsoft 365 использует ключи, указанные в политике, для шифрования почтового ящика. Чтобы создать DEP, потребуются URI-адреса Key Vault, полученные ранее. Инструкции [см. в разделе «URI для каждого ключа Azure Key Vault».](#obtain-the-uri-for-each-azure-key-vault-key)
  
Помните, что! При создании DEP указывайте два ключа, которые найдены в двух разных хранилищах ключей Azure. Убедитесь, что эти ключи расположены в двух отдельных регионах Azure для обеспечения геоизбыточности.
  
Чтобы создать DEP, выполните следующие действия.
  
1. На локальном компьютере, используя рабочую или учебную учетную запись с правами глобального администратора в вашей организации, [подключитесь](https://docs.microsoft.com/powershell/exchange/exchange-online/connect-to-exchange-online-powershell/connect-to-exchange-online-powershell) к Exchange Online PowerShell в окне Windows PowerShell.

2. Чтобы создать DEP, используйте командлет New-DataEncryptionPolicy, введя следующую команду:

   ```powershell
   New-DataEncryptionPolicy -Name <PolicyName> -Description "Policy Description" -AzureKeyIDs <KeyVaultURI1>, <KeyVaultURI2>
   ```

   Где:

   - *PolicyName* — это имя политики. Имена не могут содержать пробелы. Например, USA_mailboxes.

   - *Описание политики* представляет собой понятное описание политики, которая помогает запоминать назначение политики. В описание можно включать пробелы. Пример: "Корневой ключ для почтовых ящиков в США и его серийные сайты".

   - *KeyVaultURI1 —* URI первичного ключа в политике. Например, <https://contoso_EastUSvault01.vault.azure.net/keys/USA_key_01>.

   - *KeyVaultURI2* — URI второго ключа в политике. Например, <https://contoso_EastUS2vault01.vault.azure.net/keys/USA_Key_02>. Два URI отделяются запятыми и пробелом.

   Пример.
  
   ```powershell
   New-DataEncryptionPolicy -Name USA_mailboxes -Description "Root key for mailboxes in USA and its territories" -AzureKeyIDs https://contoso_EastUSvault01.vault.azure.net/keys/USA_key_01, https://contoso_EastUS2vault01.vault.azure.net/keys/USA_Key_02
   ```

Дополнительные сведения о синтаксисе и параметрах [см. в разделе New-DataEncryptionPolicy.](https://docs.microsoft.com/powershell/module/exchange/new-data-encryptionpolicy)

### <a name="assign-a-dep-to-a-mailbox"></a>Назначение DEP почтовому ящику

Назначьте DEP почтовому ящику с помощью командлета Set-Mailbox. После назначения политики Microsoft 365 сможет зашифровать почтовый ящик с ключом, указанным в DEP.
  
```powershell
Set-Mailbox -Identity <MailboxIdParameter> -DataEncryptionPolicy <PolicyName>
```

Где *MailboxIdParameter* определяет почтовый ящик. Дополнительные сведения о командлете Set-Mailbox см. в [статье Set-Mailbox.](https://docs.microsoft.com/powershell/module/exchange/set-mailbox)

В [случае локальных почтовых ящиков с использованием Outlook для iOS и Android](https://docs.microsoft.com/exchange/clients/outlook-for-ios-and-android/use-hybrid-modern-auth)с гибридной современной проверкой подлинности данные локальных почтовых ящиков, синхронизированные с клиентом Exchange Online, могут назначить функцию DEP с помощью командлета Set-MailUser.

```powershell
Set-MailUser -Identity <MailUserIdParameter> -DataEncryptionPolicy <PolicyName>
```

Где *параметр MailUserIdParameter* задает пользователя почты (также известного как пользователь с включенной поддержкой почты). Дополнительные сведения о командлете Set-MailUser см. в [статье Set-MailUser.](https://docs.microsoft.com/powershell/module/exchange/set-mailuser)
  
### <a name="validate-mailbox-encryption"></a>Проверка шифрования почтовых ящиков

Шифрование почтового ящика может занять некоторое время. При первом назначении политики почтовый ящик также должен полностью переместиться из одной базы данных в другую, прежде чем служба сможет зашифровать почтовый ящик. Рекомендуем подождать 72 часа, прежде чем попытаться проверить шифрование после того, как вы перемените DEP или при первом назначении DEP для почтового ящика.
  
Используйте командлет Get-MailboxStatistics, чтобы определить, зашифрован ли почтовый ящик.
  
```powershell
Get-MailboxStatistics -Identity <GeneralMailboxOrMailUserIdParameter> | fl IsEncrypted
```

Если почтовый ящик не зашифрован, свойство IsEncrypted возвращает **значение true,** а значение **false** , если почтовый ящик не зашифрован.

Время для завершения перемещения почтовых ящиков зависит от количества почтовых ящиков, которым в первый раз назначается DEP, а также размер почтовых ящиков. Если почтовые ящики не шифровались через неделю с момента назначение DEP, свяжитесь с корпорацией Майкрософт.

## <a name="office-365-setting-up-customer-key-for-sharepoint-online-onedrive-for-business-and-teams-files"></a>Office 365: настройка ключа клиента для файлов SharePoint Online, OneDrive для бизнеса и Teams

Прежде чем начать, убедитесь, что вы выполнили все необходимые задачи для настройки хранилища Azure Key Vault. Сведения о [выполнении полных задач см. в хранилище Azure Key Vault и Microsoft FastTrack для получения информации](#complete-tasks-in-azure-key-vault-and-microsoft-fasttrack-for-customer-key) о получении данных клиента.
  
Чтобы настроить ключ клиента для файлов SharePoint Online, OneDrive для бизнеса и Teams, вам потребуется выполнить эти действия, удаленно подключившись к SharePoint Online с помощью Windows PowerShell.
  
### <a name="create-a-data-encryption-policy-dep-for-each-sharepoint-online-and-onedrive-for-business-geo"></a>Создание политики шифрования данных (DEP) для каждого географического расположения SharePoint Online и OneDrive для бизнеса

DEP связывается с набором ключей, хранящихся в хранилище Ключей Azure. КО всем вашим данным в одном географическом расположении применяется DEP. Если вы используете функцию поддержки нескольких регионов Office 365, вы можете создать одну DEP для каждого геообъекта с возможностью использования разных ключей для каждого геообъекта. Если вы не используете поддержку нескольких регионов, вы можете создать один DEP в своей организации для работы с файлами SharePoint Online, OneDrive для бизнеса и Teams. В Microsoft 365 используются ключи, определенные в DEP, для шифрования ваших данных в этом географическом расположении. Чтобы создать DEP, потребуются URI-адреса Key Vault, полученные ранее. Инструкции [см. в разделе «URI для каждого ключа Azure Key Vault».](#obtain-the-uri-for-each-azure-key-vault-key)
  
Помните, что! При создании DEP указывайте два ключа, которые найдены в двух разных хранилищах ключей Azure. Убедитесь, что эти ключи расположены в двух отдельных регионах Azure для обеспечения геоизбыточности.
  
Чтобы создать DEP, необходимо удаленно подключаться к SharePoint Online с помощью Windows PowerShell.
  
1. На локальном компьютере, используя рабочую или учебную учетную запись с правами глобального администратора в вашей организации [подключитесь к PowerShell в SharePoint Online.](https://docs.microsoft.com/powershell/sharepoint/sharepoint-online/connect-sharepoint-online?view=sharepoint-ps)

2. В командной консоли Microsoft SharePoint Online выполните командлет Register-SPODataEncryptionPolicy следующим образом.

   ```powershell
   Register-SPODataEncryptionPolicy -Identity <SPOAdminSiteUrl> -PrimaryKeyVaultName <PrimaryKeyVaultName> -PrimaryKeyName <PrimaryKeyName> -PrimaryKeyVersion <PrimaryKeyVersion> -SecondaryKeyVaultName <SecondaryKeyVaultName> -SecondaryKeyName <SecondaryKeyName> -SecondaryKeyVersion <SecondaryKeyVersion>
   ```

   При регистрации DEP шифрование начинается с данных в географическом расположении. На это может потребоваться некоторое время.

### <a name="validate-file-encryption"></a>Проверка шифрования файлов

 Чтобы проверить шифрование файлов SharePoint Online, OneDrive для бизнеса и Teams, [подключитесь к SharePoint Online PowerShell](https://docs.microsoft.com/powershell/exchange/exchange-online/connect-to-exchange-online-powershell/connect-to-exchange-online-powershell?view=exchange-ps)и проверьте состояние своего клиента с помощью командлета Get-SPODataEncryptionPolicy. Свойство _State_ возвращает значение, зарегистрированное, если **включено** шифрование с ключом клиента и все файлы на всех сайтах были зашифрованы. Если шифрование еще выполняется, этот командлет предоставляет сведения о том, какой процент завершен.

## <a name="related-articles"></a>Статьи по теме

- [Шифрование службы с помощью ключа клиента](customer-key-overview.md)

- [Управление ключом клиента](customer-key-manage.md)

- [Смена или ротация ключа клиента или ключа доступности](customer-key-availability-key-roll.md)

- [Сведения о ключе доступности](customer-key-availability-key-understand.md)

- [Шифрование служб](office-365-service-encryption.md)
